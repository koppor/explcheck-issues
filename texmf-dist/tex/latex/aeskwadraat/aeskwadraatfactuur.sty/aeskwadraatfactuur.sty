%%
%% This is file `aeskwadraatfactuur.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% aeskwadraat.dtx  (with options: `factuur')
%% 
%% Copyright (c) 2024- TeXniCie A-Eskwadraat (voorheen HekTeX) <texnicie@a-eskwadraat.nl>
%% 
%% This program is free software: you can redistribute it and/or modify
%% it under the terms of the GNU General Public License as published by
%% the Free Software Foundation, either version 3 of the License, or
%% (at your option) any later version.
%% 
%% This program is distributed in the hope that it will be useful,
%% but WITHOUT ANY WARRANTY; without even the implied warranty of
%% MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%% GNU General Public License for more details.
%% 
%% You should have received a copy of the GNU General Public License
%% along with this program.  If not, see <https://www.gnu.org/licenses/>.
%% 
%% The current maintainer of this work is Jesse Sraat.
%% 
%% This work consists of the main file aeskwadraat.dtx
%% and the derived files
%%     aeskwadraat.sty, aes.sty, aeskwadraat.pdf, aeskwadraat.ins, aeskwadraatbrief.cls, aeskwadraatfactuur.sty, aeskwadraatnotulen.cls,
%%     aeskwadraatnotulen.sty, aeskwadraattaal.sty, beamerthemeaeskwadraat.sty, beamerthemeaes2.sty
%% 
%% If you are looking for comments or documentation, you won't find
%% any in the source. These packages make use of literate programming, which means
%% that the documentation is given in the form of a pdf file. You can
%% probably find aeskwadraat.pdf in this folder, by running "texdoc --view aeskwadraat"
%% in the command line, or Googling
%% "[your distribution] how to find package documentation".
%% If you're using MiKTeX, open MiKTeX console, go to
%% "Documentation" and look for "aeskwadraat".
%% If you're still unsure, contact the TeXniCie at <texnicie@a-eskwadraat.nl>
%% 

%% Copyright (C) 2008-2015 TeXniCie A-Eskwadraat
%% <hektex@a-eskwadraat.nl>

\NeedsTeXFormat{LaTeX2e}[2020/10/01]
\ProvidesPackage{aeskwadraatfactuur}[2025/06/13 v1.0.1
                    Simple invoices with aeskwadraatbrief integration]

\RequirePackage{aeskwadraattaal}
\RequirePackage{substr}
\RequirePackage{ifthen}
\RequirePackage{calc}
\newcommand\FactuurError@verdwaald[1]{%
\PackageError{aeskwadraatfactuur} {Runaway #1 command}%
          {This command may only be used within the
           factuur environment.\MessageBreak%
           put #1\space between \protect\begin{factuur}
           and \protect\end{factuur}.}%
}
\newcommand\aes@fonttitel{\fontsize{18}{20}\selectfont\bfseries}
\newcommand\newnepboolean[1]{%
  \settrue{#1}%
}
\newcommand\settrue[1]{%
  \expandafter\gdef\csname if#1\endcsname##1##2{##1}%
}
\newcommand\setfalse[1]{%
  \expandafter\gdef\csname if#1\endcsname##1##2{##2}%
}
\newcounter{factuur@aantalPosten}
\setcounter{factuur@aantalPosten}{0}

\newboolean{factuur@meerderePaginas}
\setboolean{factuur@meerderePaginas}{false}
\newcommand{\meerpaginas}{\setboolean{factuur@meerderePaginas}{true}}
\let\meerPaginas\meerpaginas
\newcounter{factuur@maxPosten}
\setcounter{factuur@maxPosten}{19}

\newcounter{factuur@maxPostenTweedePagina}
\setcounter{factuur@maxPostenTweedePagina}{25}

\newboolean{factuur@tweedePagina}
\setboolean{factuur@tweedePagina}{false}
\NewDocumentCommand{\valuta}{ m }{%
  \renewcommand\factuur@valutasym{#1}%
}
\newcommand\factuur@valutasym{\euro}
\NewDocumentCommand{\nieuwepagina}{}{%
  \setboolean{factuur@tweedePagina}{true}%
  \setcounter{factuur@maxPosten}{\value{factuur@maxPostenTweedePagina}}%
  % The following counter needs to be set to zero
  % because tabular hates empty commands at the end
  % of a table
  \setcounter{factuur@aantalPosten}{0} & \vspace{-12pt}\\%
  \subtotaal%
  \end{factuur@subfactuur}%
  \begin{center}%
  \TAALpaginaGaatVerder%
  \end{center}%
  \newpage%
  \begin{factuur@subfactuur}%
}
\let\nieuwePagina\nieuwepagina
\newcommand\factuur@post@err[2]{%
  \FactuurError@verdwaald{\protect\post}%
}
\let\post\factuur@post@err
\newcommand\factuur@procent@err[2]{%procent buiten factuur
  \FactuurError@verdwaald{\protect\procent}%
}
\let\procent\factuur@procent@err
\newcommand\factuur@invul[1]{%
  \settrue{factuur@TotaalVerbokt}%
  \factuur@zetpostnep{#1}{\dotfill}%
}
\newcommand\factuur@invul@err[1]{%
\FactuurError@verdwaald{\protect\invul}%
}
\let\invul\factuur@invul@err
\newcommand\factuur@subtotaal@err{%
\FactuurError@verdwaald{\protect\subtotaal}%
}
\let\subtotaal\factuur@subtotaal@err
\newnepboolean{factuur@TotaalVerbokt}%
\newcommand\factuur@zetpostnep[2]{%
  \factuur@zetpostraw{#1}{\multicolumn{5}{r}{#2}}%
}
\newcommand\factuur@zetpostraw[2]{%
  \vspace{2mm}
  \parbox[b]{\textwidth*3/4}{#1} & #2 \\
}
\ExplSyntaxOn
\fp_new:N \g_aes_total_fp
\NewDocumentEnvironment{factuur}{}{% \begin
  \fp_gset:Nn \g_aes_total_fp { 0 }
  \setfalse{factuur@TotaalVerbokt}
  %
  \let\post\factuur@post
  \let\procent\factuur@procent
  \let\invul\factuur@invul
  \let\subtotaal\factuur@subtotaal
  \begin{factuur@subfactuur}
}{% \end
  \hline\hline\\[-2mm]
  % Display total, or dots if verbokt
  \iffactuur@TotaalVerbokt{%
    \bfseries\TAALtotaal & \multicolumn{5}{r}{\dotfill}
  }{%
    \factuur@zetpost{ \bfseries\TAALtotaal }{
      \g_aes_total_fp
    }
  } \\
  \end{factuur@subfactuur}
  \let\post\factuur@post@err
  \let\procent\factuur@procent@err
  \let\invul\factuur@invul@err
  \let\subtotaal\factuur@subtotaal@err
}
\newenvironment{factuur@subfactuur}{% \begin
  % tabel: desc, minus, currency, wholes, decimal sep, cents
  \begin{tabular}{lc@{}c@{}r@{}c@{}l}
  \bfseries \TAALomschrijving & \multicolumn{5}{r}{\bfseries \TAALbedrag}
  \\
  \hline\hline \\[-2mm]
}{% \end
  \end{tabular}
}
\newcommand\factuur@iftotalnegative[2]{
  \fp_compare:nNnTF { \g_aes_total_fp } < { 0 } { #1 } { #2 }
}
\newcommand\factuur@subtotaal{
  \iffactuur@TotaalVerbokt{
    \PackageError{aeskwadraatfactuur}{\protect\subtotaal\space
        kan~niet~meer~na~\protect\invul}{}
  }{
    \hline\\[-2mm]
    \factuur@zetpost{ \bfseries\TAALsubtotaal }{
      \g_aes_total_fp
    }
  }
}
\newcommand\factuur@post[2]{
  \ifthenelse{
    \value{factuur@aantalPosten} = \value{factuur@maxPosten}
  }{\nieuwepagina}{}
  \addtocounter{factuur@aantalPosten}{1}
  % We want decimal point, not comma
  \tl_set:Nn \__aeskwadraatfactuur_factuur_input_tl { #2 }
  \tl_replace_once:Nnn \__aeskwadraatfactuur_factuur_input_tl { , } { . }
  %
  \fp_gadd:Nn \g_aes_total_fp { \__aeskwadraatfactuur_factuur_input_tl }
  \factuur@zetpost { #1 } { \__aeskwadraatfactuur_factuur_input_tl }
}
\newcommand\factuur@procent[2]{
  % We want decimal point, not comma
  \tl_set:Nn \__aeskwadraatfactuur_factuur_input_tl { #2 }
  \tl_replace_once:Nnn \__aeskwadraatfactuur_factuur_input_tl { , } { . }
  %
  \fp_set:Nn \__aeskwadraatfactuur_percent_output_fp {
    \__aeskwadraatfactuur_factuur_input_tl * \g_aes_total_fp / 100 }
  \fp_gadd:Nn \g_aes_total_fp { \__aeskwadraatfactuur_percent_output_fp }
  % Convert percentage to match regional decimal seperator
  \tl_replace_once:Nnn \__aeskwadraatfactuur_factuur_input_tl { . } { \TAALdecimaalsym }
  \factuur@zetpost{ #1~(\__aeskwadraatfactuur_factuur_input_tl\%) }{ \__aeskwadraatfactuur_percent_output_fp }
}
\tl_new:N \__aeskwadraatfactuur_factuur_input_tl
\fp_new:N \__aeskwadraatfactuur_percent_output_fp
\newcommand\factuur@zetpost[2]{
  \fp_gset:Nn \__aeskwadraatfactuur_post_val_fp {#2}
  \factuur@zetpostraw{ #1 }{
    \__aeskwadraatfactuur_fp_display_value:N \__aeskwadraatfactuur_post_val_fp
  }
}
\fp_new:N \__aeskwadraatfactuur_post_val_fp
\cs_new:Nn \__aeskwadraatfactuur_fp_display_value:N {
  % Round value to whole cents
  \fp_gset:Nn \__aeskwadraatfactuur_display_fp { \fp_eval:n { round ( #1 , 2 ) } }
  % Get the sign
  \fp_gset:Nn \__aeskwadraatfactuur_display_sign_fp { \fp_sign:n { \__aeskwadraatfactuur_display_fp } }
  % Get the wholes
  \int_gset:Nn \__aeskwadraatfactuur_display_wholes_int { \fp_to_int:n { \fp_eval:n {
    abs ( trunc ( \__aeskwadraatfactuur_display_fp ) ) } } }
  % Get the cents
  \int_gset:Nn \__aeskwadraatfactuur_display_cents_int { \fp_eval:n {
    ( abs ( \__aeskwadraatfactuur_display_fp ) - \__aeskwadraatfactuur_display_wholes_int )*100 } }
  % gsets are necessary because the & ends groups, therefore
  % cancelling the definitions!
  %
  \fp_compare:nNnT { \__aeskwadraatfactuur_display_sign_fp } = { -1 } { -- }
  &
  \factuur@valutasym~
  &
  \__aeskwadraatfactuur_int_to_thousands:N \__aeskwadraatfactuur_display_wholes_int
  &
  \TAALdecimaalsym
  &
  \__aeskwadraatfactuur_display_cents:N \__aeskwadraatfactuur_display_cents_int
}
\fp_new:N \__aeskwadraatfactuur_display_sign_fp
\int_new:N \__aeskwadraatfactuur_display_wholes_int
\int_new:N \__aeskwadraatfactuur_display_cents_int
\fp_new:N \__aeskwadraatfactuur_display_fp
\cs_new:Nn \__aeskwadraatfactuur_int_to_thousands:N {
  \int_set_eq:NN \__aeskwadraatfactuur_thousands_split_int #1
  \int_while_do:nNnn { \__aeskwadraatfactuur_thousands_split_int } > { 999 } {
    \int_set:Nn \__aeskwadraatfactuur_thousands_split_next_int {
      \int_div_truncate:nn { \__aeskwadraatfactuur_thousands_split_int } { 1000 } }
    \tl_put_left:Ne \__aeskwadraatfactuur_thousands_tl {
      \TAALduizendsym \__aeskwadraatfactuur_pad_to_three:n {
        \__aeskwadraatfactuur_thousands_split_int - \__aeskwadraatfactuur_thousands_split_next_int*1000 } }
    \int_set_eq:NN \__aeskwadraatfactuur_thousands_split_int \__aeskwadraatfactuur_thousands_split_next_int
  }
  \tl_put_left:Ne \__aeskwadraatfactuur_thousands_tl {
    \int_to_arabic:n { \__aeskwadraatfactuur_thousands_split_int } }
  \__aeskwadraatfactuur_thousands_tl
}
\int_new:N \__aeskwadraatfactuur_thousands_split_int
\int_new:N \__aeskwadraatfactuur_thousands_split_next_int
\tl_new:N \__aeskwadraatfactuur_thousands_tl
\cs_new:Nn \__aeskwadraatfactuur_pad_to_three:n {
  \int_compare:nNnTF { #1 } < { 100 }
  {
  \int_compare:nNnTF { #1 } < { 10 }
  {
    00\int_to_arabic:n { #1 }
  }
  {
    0\int_to_arabic:n { #1 }
  }
  }
  {
    \int_to_arabic:n { #1 }
  }
}

\cs_new:Nn \__aeskwadraatfactuur_display_cents:N {
  \int_compare:nNnTF{ #1 } < { 10 }
  {
    0\int_use:N #1
  }
  {
    \int_use:N #1
  }
}
\ExplSyntaxOff
\newcommand\factuur@geenaeskwadraatbrief{
  \newenvironment{factuurbrief}[1]{
    \PackageError{aeskwadraatfactuur}{%
      Alleen gedefinieerd binnen de aeskwadraatbrief-class}
      {Gebruik \protect\documentclass{aeskwadraatbrief}.}
  }{}
}
\newcommand\factuur@welaeskwadraatbrief{
  \newboolean{factuur@teruggave}
  \setboolean{factuur@teruggave}{false}
  \newcommand{\creditnota}{\setboolean{factuur@teruggave}{true}}
  \newcommand\aes@betalingstermijn{28}
  \NewDocumentCommand{\betalingstermijn}{ m }{%
    \renewcommand\aes@betalingstermijn{##1}%
  }
  \newboolean{factuur@buitenland}
  \NewDocumentCommand{\buitenlandbetaling}{}{%
    \setboolean{factuur@buitenland}{true}}
  \NewDocumentCommand{\binnenlandbetaling}{}{%
    \setboolean{factuur@buitenland}{false}}
  \newboolean{factuur@btwverlegd}
  \newcommand\btwverlegd{\setboolean{factuur@btwverlegd}{true}}
  \newcommand\aes@betaalinstructie{}
  \NewDocumentCommand{\betaalinstructie}{ m }{%
    \renewcommand\aes@betaalinstructie{##1}}
  \NewDocumentCommand\autobetaalinstructie{}{
    \renewcommand\aes@betaalinstructie{
      \ifthenelse{\boolean{factuur@teruggave}}{
        \TAALterugkrijginstructie
      }{
        \ifthenelse{\boolean{factuur@buitenland}}{
          \def\@IBANspul{, BIC:~\aes@BIC}
        }{
          \def\@IBANspul{}
        }
        \TAALbetaalinstructie{\aes@betalingstermijn}{\aes@bank}
          {\aes@IBAN}{\@IBANspul}{\aes@rekeninghouder}{\factuur@ovv}
      }
    }
  }
  \autobetaalinstructie
  \newboolean{factuur@herinnering}
  \newboolean{factuur@aanmaning}
  \setboolean{factuur@herinnering}{false}
  \setboolean{factuur@aanmaning}{false}
  \newcommand\factuur@ovv{\aes@onsk}
  \newcommand\factuur@titel{}
  \newcommand\ovv[1]{\renewcommand\factuur@ovv{##1}}
  % Reset ovv to automatic (same as our payment reference)
  \newcommand\autoovv{\ovv{\aes@onsk}}
  \newcommand\herinnering{%
    \setboolean{factuur@herinnering}{true}%
    \setboolean{factuur@aanmaning}{false}}
  \newcommand\geenherinnering{\setboolean{factuur@herinnering}{false}}
  \newcommand\aanmaning{%
    \setboolean{factuur@aanmaning}{true}%
    \setboolean{factuur@herinnering}{false}}
  \newcommand\geenaanmaning{\setboolean{factuur@aanmaning}{false}}
  \newcommand\factuurtitel[1]{\renewcommand\factuur@titel{##1}}
  \newcommand\autofactuurtitel{\factuurtitel{}}

  \newcommand\@autofactuurtitel{
    \ifthenelse{\boolean{factuur@teruggave}}{%
      \TAALteruggave%
    }{%
      \ifthenelse{\boolean{factuur@herinnering}}{%
        \TAALherinnering%
      }{%
      %
   \ifthenelse{\boolean{factuur@aanmaning}}{%
   \TAALaanmaning%
   }{  \TAALfactuur%
      }
     }%
    }%
  }
  \newcounter{factuur@brief}
  \NewDocumentEnvironment{factuurbrief}{ m }{
    \global\def\factuur@briefadres{##1}
    \ifcsname factuur@brief\thefactuur@brief teruggave\endcsname
      \csname factuur@brief\thefactuur@brief teruggave\endcsname
    \else
      \setboolean{factuur@teruggave}{false}
      \PackageWarning{aeskwadraatfactuur}{factuurbrief title may be wrong,
      please rerun the file.}
    \fi
    %
    \begin{brief}{\factuur@briefadres}
    \geenopening
    {\aes@fonttitel\ifthenelse{\equal{\factuur@titel}{}}{%
        \@autofactuurtitel%
      }{%
        \factuur@titel%
      }%
    }%
    \par
    \begin{factuur}
  }{
    \end{factuur}
    \par
    % Remember whether total is negative, write to aux
    \factuur@iftotalnegative{%
      \def\factuur@tempbool{true}%
    }{%
      \def\factuur@tempbool{false}%
    }
    % TODO: Check if teruggave has changed and throw warning
    \newcommand\factuur@auxoutput{%
      \string\expandafter\string\gdef\noexpand\csname
      factuur@brief\thefactuur@brief teruggave\string\endcsname%
      {\string\setboolean{factuur@teruggave}{\factuur@tempbool}}%
    }%
    \setboolean{factuur@teruggave}{\factuur@tempbool}
    \write\@auxout{%
      \factuur@auxoutput%
    }%
    \bigskip
    \ifthenelse{\boolean{factuur@btwverlegd}}{
      \textbf{\TAALbtwverlegd}
    }{}
    \aes@betaalinstructie
    \end{brief}
    \stepcounter{factuur@brief}
  }
}

\provideboolean{aes@inbrief}
\ifthenelse{\boolean{aes@inbrief}}{
  \factuur@welaeskwadraatbrief
}{
  \factuur@geenaeskwadraatbrief
}
\endinput
%%
%% End of file `aeskwadraatfactuur.sty'.
