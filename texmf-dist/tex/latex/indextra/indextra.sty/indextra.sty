%%
%% This is file `indextra.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% indextra.dtx  (with options: `package')
%% 
%% This is a generated file.
%% 
%% Copyright (C) 2025 Alan J. Cain
%% 
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either
%% version 1.3c of this license or (at your option) any later
%% version. The latest version of this license is in:
%% 
%% http://www.latex-project.org/lppl.txt
%% 
%% and version 1.3c or later is part of all distributions of
%% LaTeX version 2008-05-04 or later.
%% 
\NeedsTeXFormat{LaTeX2e}[2020-02-02]
\ProvidesExplPackage{indextra}{2025-10-26}{0.21.6}
  {Enhanced index typesetting}
\keys_define:nn { indextra }
{
  before~code .tl_set:N = \l__indextra_before_code_tl,
  after~code .tl_set:N = \l__indextra_after_code_tl,
  before~code .initial:n = {\begin{theindex}},
  after~code .initial:n = {\end{theindex}},
}
\keys_define:nn { indextra }
{
  level~0~style .tl_set:c = {l__indextra_level_0_style_tl},
  level~1~style .tl_set:c = {l__indextra_level_1_style_tl},
  level~2~style .tl_set:c = {l__indextra_level_2_style_tl},
  level~0~style .initial:n = {\parindent=0em\hangindent=3.75em},
  level~1~style .initial:n = {\parindent=1.5em\hangindent=5.25em},
  level~2~style .initial:n = {\parindent=3em\hangindent=6.75em},
}
\keys_define:nn { indextra }
{
  separator~keyword~crossref .tl_set:N = \l__indextra_separator_kw_cr_tl,
  separator~keyword~location .tl_set:N = \l__indextra_separator_kw_loc_tl,
  separator~crossref~crossref .tl_set:N = \l__indextra_separator_cr_cr_tl,
  separator~crossref~location .tl_set:N = \l__indextra_separator_cr_loc_tl,
  separator~location~location .tl_set:N = \l__indextra_separator_loc_loc_tl,
  separator~keyword~crossref .initial:n = {\break},
  separator~keyword~location .initial:n = {\space\space},
  separator~crossref~crossref .initial:n = {\break},
  separator~crossref~location .initial:n = {\break},
  separator~location~location .initial:n = {,~},
}
\keys_define:nn { indextra }
{
  crossref~macros .tl_set:N = \l__indextra_crossref_macros_tl,
  crossref~macros .initial:n = {\see\seealso},
}
\keys_define:nn { indextra }
{
  hyperindex .bool_set:N = \l__indextra_hyperindex_bool,
  hyperindex .initial:n = {true},
}
\keys_define:nn { indextra }
{
  bookmarks .bool_set:N = \l__indextra_bookmarks_bool,
  bookmarks .initial:n = {true},
}
\keys_define:nn { indextra }
{
  headings .bool_set:N = \l__indextra_headings_bool,
  headings .initial:n = {true},
}
\NewDocumentCommand{\indextrasetup}{ m }
{
  \keys_set:nn{ indextra }{ #1 }
}
\NewDocumentEnvironment{theindextra}{}
  { \__indextra_main_begin: }
  { \__indextra_main_end: }
\cs_new:Npn \__indextra_main_begin:
{
  \group_begin:
  \tl_use:N\l__indextra_before_code_tl
  \int_zero:N\clubpenalty
  \int_zero:N\widowpenalty
  \dim_gset:Nn\g__indextra_remaining_space_dim{\@colht}
  \dim_set:Nn\splittopskip{.7\baselineskip}
  \dim_set:Nn\topskip{.7\baselineskip}
  \dim_set:Nn\parskip{0pt}
  \cs_set_eq:NN\indextrastyleversion\__indextra_style_version:n
  \cs_set_eq:NN\indextraprocessortype\__indextra_processor_type:n
  \cs_set_eq:NN\indextraspace\__indextra_space:
  \cs_set_eq:NN\indextragroup\__indextra_group:n
  \cs_set_eq:NN\indextraentry\__indextra_entry:nnn
  \bool_if:nF
    { \l__indextra_bookmarks_bool && \cs_if_exist_p:N\belowpdfbookmark }
    {
      \cs_set_eq:NN\__indextra_bookmark_stored_group:\prg_do_nothing:
    }
  \bool_if:NF\l__indextra_headings_bool
    {
      \cs_set_eq:NN\__indextra_typeset_stored_group_heading:\prg_do_nothing:
    }
  \bool_if:nT{ \l__indextra_hyperindex_bool && \cs_if_exist_p:N\hyperpage }
    {
      \cs_if_eq:NNT\indextrapage\__indextra_page_basic:nn
        {
          \cs_set_eq:NN\indextrapage\__indextra_page_hyperref:nn
        }
      \cs_if_eq:NNT\indextrarange\__indextra_range_basic:nnn
        {
          \cs_set_eq:NN\indextrarange\__indextra_range_hyperref:nnn
        }
    }
}
\cs_new:Npn \__indextra_main_end:
{
  \tl_use:N\l__indextra_after_code_tl
  \group_end:
}
\msg_new:nnn{ indextra }{ incompatible_version }
  { The~.ind~file~was~generated~using~a~style~from~a~different~version~of~indextra. }
\cs_new:Npn\__indextra_style_version:n #1
{
  \str_if_eq:nnF{#1}{0.1}
    {
      \msg_error:nn{ indextra }{ incompatible_version }
    }
}
\cs_new:Npn\__indextra_processor_type:n #1
{
  \cs_set_eq:Nc\__indextra_typeset_aux_location:n
    { __indextra_typeset_#1_location:n }
}
\dim_new:N\g__indextra_remaining_space_dim
\cs_new:Npn\__indextra_new_column:
  {
    \vfill
    \newpage
    \dim_gset:Nn\g__indextra_remaining_space_dim{\@colht}
  }
\cs_new:Npn\__indextra_space:
  {
    \dim_compare:nNnT{\g__indextra_remaining_space_dim}<{\baselineskip}{
      \__indextra_new_column:
    }
    \vbox_set:Nn\l__indextra_buffer_box{\leavevmode\strut\par}
    \__indextra_typeset_buffer:
  }
\tl_new:N\l__indextra_group_tl
\cs_new:Npn\__indextra_group:n #1
  {
    \tl_set:Nn\l__indextra_group_tl{#1}
  }
\int_new:N\g__indextra_group_bookmark_int
\cs_new:Npn\__indextra_bookmark_stored_group:
  {
    \tl_if_empty:NF\l__indextra_group_tl
      {
        \int_gincr:N\g__indextra_group_bookmark_int
        \belowpdfbookmark
          {\tl_use:N\l__indextra_group_tl}
          {pdf:indextra:\int_value:w\g__indextra_group_bookmark_int}
      }
  }
\cs_new:Npn\__indextra_typeset_stored_group_heading:
  {
    \tl_if_empty:NF\l__indextra_group_tl
      {
        \group_begin:
        \noindent\strut
        \indextramakegroupheading{\tl_use:N\l__indextra_group_tl}
        \strut\par
        \group_end:
      }
  }
\cs_new:Npn\indextramakegroupheading #1
  {
    \textbf{#1}
  }
\int_new:N\l__indextra_level_int
\tl_new:c{l__indextra_saved_keyword_0}
\tl_new:c{l__indextra_saved_keyword_1}
\tl_new:c{l__indextra_saved_keyword_2}
\seq_new:N\l__indextra_crossref_seq
\seq_new:N\l__indextra_location_seq
\cs_new:Npn\__indextra_entry:nnn #1#2#3
  {
    \int_set:Nn\l__indextra_level_int{#1}
    \tl_set:cn{l__indextra_saved_keyword_#1}{#2}
    \__indextra_filter_crossref_location_seqs:n{#3}
    \vbox_set:Nn\l__indextra_buffer_box{
      \__indextra_bookmark_stored_group:
      \__indextra_typeset_stored_group_heading:
      \group_begin:
      \__indextra_set_style:n{#1}
      \leavevmode
      \strut
      \indextrakeyword{#1}{#2}
      \__indextra_typeset_between:
      \__indextra_typeset_locations:
      \strut
      \par
      \goodbreak
      \group_end:
    }
    \vbox_set:Nn\l_tmpa_box{
      \__indextra_typeset_stored_group_heading:
      \group_begin:
      \__indextra_set_style:n{#1}
      \leavevmode
      \strut
      \indextrakeyword{#1}{#2}
      \__indextra_typeset_between:
      \__indextra_typeset_first_location:
      \strut
      \par
      \group_end:
    }
    \vbox_set:Nn\l_tmpb_box{
      \__indextra_typeset_stored_group_heading:
    }
    \dim_compare:nNnT
      {\g__indextra_remaining_space_dim}
      <
      {
        \dim_min:nn{
          \dim_max:nn{
            \box_ht:N\l_tmpa_box
            +\box_dp:N\l_tmpa_box
          }{
            \box_ht:N\l_tmpb_box
            +\box_dp:N\l_tmpb_box
            +2\baselineskip
          }
        }{
          \box_ht:N\l__indextra_buffer_box
          +\box_dp:N\l__indextra_buffer_box
        }
      }
      {
        \__indextra_new_column:
        \int_compare:nNnT{#1}>{0}{
          \__indextra_vbox_prepend:Nn\l__indextra_buffer_box{
            \__indextra_make_continuation:n{\l__indextra_level_int-1}
          }
        }
      }
    \group_begin:
    \int_set:Nn\vbadness{10000}
    \__indextra_typeset_buffer:
    \group_end:
    \tl_clear:N\l__indextra_group_tl
  }
\cs_new:Npn\__indextra_filter_crossref_location_seqs:n #1
  {
    \seq_clear:N\l__indextra_crossref_seq
    \seq_clear:N\l__indextra_location_seq

    \clist_map_inline:nn{#1}
      {
        \tl_if_in:NoTF
          \l__indextra_crossref_macros_tl{ \tl_head:w ##1 {} \q_stop }
          {
            \seq_put_right:Nn\l__indextra_crossref_seq{##1}
          }
          {
            \seq_put_right:Nn\l__indextra_location_seq{##1}
          }
      }
  }
\cs_new:Npn \__indextra_set_style:n #1
  {
    \tl_use:c{l__indextra_level_#1_style_tl}
  }
\cs_new:Npn\indextrakeyword #1#2
  {
    #2
  }
\cs_new:Npn\__indextra_typeset_between:
  {
    \seq_if_empty:NTF\l__indextra_crossref_seq
      {
        \seq_if_empty:NF\l__indextra_location_seq
          { \tl_use:N\l__indextra_separator_kw_loc_tl }
      }
      {
        \tl_use:N\l__indextra_separator_kw_cr_tl
        \seq_use:Nn
          \l__indextra_crossref_seq
          { \tl_use:N\l__indextra_separator_cr_cr_tl }
        \seq_if_empty:NF\l__indextra_location_seq
          { \tl_use:N\l__indextra_separator_cr_loc_tl }
      }
  }
\bool_new:N\l__indextra_first_item_bool
\cs_new:Npn\__indextra_typeset_locations:
  {
    \bool_set_true:N\l__indextra_first_item_bool
    \seq_map_inline:Nn\l__indextra_location_seq
      {
        \bool_if:nF{\l__indextra_first_item_bool}
          { \tl_use:N\l__indextra_separator_loc_loc_tl }
        \__indextra_typeset_aux_location:n{##1}
        \bool_set_false:N\l__indextra_first_item_bool
      }
  }
\cs_new:Npn\__indextra_typeset_first_location:
  {
    \exp_args:Ne\__indextra_typeset_aux_location:n
      {\seq_item:Nn\l__indextra_location_seq{1}}
  }
\cs_new:Npn\__indextra_is_nonrange_p:w #1--#2\q_stop
  {
    \tl_if_empty_p:n{#2}
  }
\cs_new:Npn\__indextra_typeset_ist_location:n #1
  {
    \tl_if_head_eq_catcode:nNTF{#1}\prg_do_nothing:
      {
        \__indextra_typeset_ist_encap_page_or_range:Nn #1
      }
      {
        \__indextra_typeset_ist_encap_page_or_range:Nn \prg_do_nothing:{#1}
      }
  }
\cs_new:Npn\__indextra_typeset_ist_encap_page_or_range:Nn #1#2
  {
    \bool_if:nTF{\__indextra_is_nonrange_p:w #2--\q_stop}
      {
        \indextrapage{#1}{#2}
      }
      {
        \__indextra_typeset_ist_encap_range:w#1\q_mark #2\q_stop
      }
  }
\cs_new:Npn\__indextra_typeset_ist_encap_range:w #1\q_mark #2--#3\q_stop
  {
    \indextrarange{#1}{#2}{#3}
  }
\cs_new:Npn\__indextra_typeset_xdy_location:n #1
  {
    \bool_if:nTF{\__indextra_is_nonrange_p:w #1--\q_stop}
      {
        \tl_if_head_eq_catcode:nNTF{#1}\prg_do_nothing:
          {
            \indextrapage #1
          }
          {
            \indextrapage \prg_do_nothing:{#1}
          }
      }
      {
        \__indextra_typeset_xdy_range:w #1\q_stop
      }
  }
\cs_new:Npn\__indextra_typeset_xdy_range:w #1--#2\q_stop
  {
    \tl_if_head_eq_catcode:nNTF{#1}\prg_do_nothing:
      {
        \__indextra_typeset_xdy_encap_range:NnNn #1#2
      }
      {
        \indextrarange\prg_do_nothing:{#1}{#2}
      }
  }
\cs_new:Npn\__indextra_typeset_xdy_encap_range:NnNn #1#2#3#4
  {
    \indextrarange{#1}{#2}{#4}
  }
\cs_new:Npn\__indextra_page_basic:nn #1#2
  {
    #1{#2}
  }
\cs_new:Npn\__indextra_range_basic:nnn #1#2#3
  {
    #1{#2}--#1{#3}
  }
\cs_new:Npn\__indextra_page_hyperref:nn #1#2
  {
    #1{\hyperpage{#2}}
  }
\cs_new:Npn\__indextra_range_hyperref:nnn #1#2#3
  {
    #1{\hyperpage{#2}}--#1{\hyperpage{#3}}
  }
\cs_set_eq:NN\indextrapage\__indextra_page_basic:nn
\cs_set_eq:NN\indextrarange\__indextra_range_basic:nnn
\cs_new:Npn\__indextra_make_continuation:n #1
  {
    \int_step_inline:nnn{0}{#1}{
      \group_begin:
      \__indextra_set_style:n{##1}
      \leavevmode\strut
      \indextramakecontinuation{##1}{\tl_use:c{l__indextra_saved_keyword_##1}}
      \strut\par
      \group_end:
    }
  }
\cs_new:Npn\indextramakecontinuation #1#2
  {
    #2~(cont.)
  }
\mark_new_class:n{indextra}
\cs_new:Npn\__indextra_mark_insert:
  {
    \mark_insert:nn{indextra}{\tl_use:c{l__indextra_saved_keyword_0}}
  }
\cs_new:Npn\indextramakemark #1
  {
    #1
  }
\cs_new:Npn\indextrafirstmark
  {
    \indextramakemark{ \mark_use_first:nn{page}{indextra} }
  }
\cs_new:Npn\indextralastmark
  {
    \indextramakemark{ \mark_use_last:nn{page}{indextra} }
  }
\box_new:N\l__indextra_buffer_box
\cs_new:Npn\__indextra_typeset_buffer:
  {
    \__indextra_mark_insert:
    \dim_compare:nNnT
    {\g__indextra_remaining_space_dim}
    <
    {\box_ht:N\l__indextra_buffer_box+\box_dp:N\l__indextra_buffer_box}
      {
        \dim_set:Nn
          \l_tmpa_dim{\g__indextra_remaining_space_dim-.3\baselineskip}
        \vbox_set_split_to_ht:NNn
          \l_tmpa_box\l__indextra_buffer_box{\l_tmpa_dim}
        \vbox_set:Nn
          \l_tmpa_box{\vbox_unpack_drop:N\l_tmpa_box}
        \dim_gset:Nn\g__indextra_remaining_space_dim
          {
            \g__indextra_remaining_space_dim
            -\box_ht:N\l_tmpa_box
            -\box_dp:N\l_tmpa_box
          }
        \vbox_unpack_drop:N\l_tmpa_box
        \__indextra_vbox_prepend:Nn
          \l__indextra_buffer_box
          {\__indextra_make_continuation:n{\l__indextra_level_int}}
        \__indextra_new_column:
        \__indextra_typeset_buffer:
      }
      {
        \dim_gset:Nn\g__indextra_remaining_space_dim
          {
            \g__indextra_remaining_space_dim
            -\box_ht:N\l__indextra_buffer_box
            -\box_dp:N\l__indextra_buffer_box
          }
        \vbox_unpack_drop:N\l__indextra_buffer_box
      }
  }
\cs_new:Npn\__indextra_vbox_prepend:Nn #1#2
{
  \vbox_set:Nn #1{
    \vbox{#2}
    \vbox_unpack_drop:N #1
  }
}
