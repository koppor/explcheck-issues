%%
%% This is file `thermodynamics.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% thermodynamics.dtx  (with options: `package')
%% 
%% This is a generated file.
%% 
%% Copyright (C) 2022-2024 by Karl D. Hammond
%% 
%% Karl D. Hammond,
%% Department of Chemical Engineering
%% University of Missouri
%% Contact: hammondkd@missouri.edu
%% 
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
\NeedsTeXFormat{LaTeX2e}
\RequirePackage{expl3}
\ProvidesPackage{thermodynamics}
    [2024/06/14 v2.02 thermodynamics notation]
\ExplSyntaxOn
\cs_generate_variant:Nn \tl_if_eq:nnTF { xxTF }
\RequirePackage{amstext}
\AtBeginDocument{
    \@ifpackageloaded{pxfonts}{%
        \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-10mu d}
    }{}
    \@ifpackageloaded{newpxmath}{%
        \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-10mu d}
    }{}
    \@ifpackageloaded{txfonts}{%
        \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-11mu d}
    }{}
    \@ifpackageloaded{mathptmx}{%
        \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-10mu d}
    }{}
    \@ifpackageloaded{newtxmath}{%
        \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-11mu d}
    }{}
    \@ifpackageloaded{mathdesign}{%
        \tl_const:Nn \c__thermodynamics_charter_tl {mdbch}
        \tl_const:Nn \c__thermodynamics_utopia_tl {mdput}
        \tl_const:Nn \c__thermodynamics_garamond_tl {mdugm}
        \tl_if_eq:NNT \MD@default@family \c__thermodynamics_utopia_tl
        { \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-20mu d}
        }
        \tl_if_eq:NNT \MD@default@family \c__thermodynamics_charter_tl
        { \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-15mu d}
        }
        \tl_if_eq:NNT \MD@default@family \c__thermodynamics_garamond_tl
        { \ProvideDocumentCommand{\dbar}{}
            {\mkern5mu\mathchar'26\mkern-17mu d}
        }
    }{}
    % Defaults to Computer Modern
    \ProvideDocumentCommand{\dbar}{}
        {\mkern3mu\mathchar'26\mkern-12mu d}
}
\tl_new:N \g__thermodynamics_total_energy_symbol
\tl_new:N \g__thermodynamics_internal_energy_symbol
\tl_new:N \g__thermodynamics_Helmholtz_symbol
\tl_new:N \g__thermodynamics_Gibbs_symbol
\tl_new:N \g__thermodynamics_Landau_symbol
\tl_new:N \g__thermodynamics_enthalpy_symbol
\tl_new:N \g__thermodynamics_entropy_symbol
\tl_new:N \g__thermodynamics_area_symbol
\tl_new:N \g__thermodynamics_volume_symbol
\tl_new:N \g__thermodynamics_mole_symbol
\tl_new:N \g__thermodynamics_heat_symbol
\tl_new:N \g__thermodynamics_work_symbol
\tl_new:N \g__thermodynamics_temperature_symbol
\tl_new:N \g__thermodynamics_pressure_symbol

\tl_gset:Nn \g__thermodynamics_total_energy_symbol E
\tl_gset:Nn \g__thermodynamics_internal_energy_symbol U
\tl_gset:Nn \g__thermodynamics_Helmholtz_symbol A
\tl_gset:Nn \g__thermodynamics_Gibbs_symbol G
\cs_if_exist:NTF \Omegait
{ \tl_gset:Nn \g__thermodynamics_Landau_symbol \Omegait }
{ \tl_gset:Nn \g__thermodynamics_Landau_symbol \Omega }
\tl_gset:Nn \g__thermodynamics_enthalpy_symbol H
\tl_gset:Nn \g__thermodynamics_entropy_symbol S
\tl_gset:Nn \g__thermodynamics_area_symbol a
\tl_gset:Nn \g__thermodynamics_volume_symbol V
\tl_gset:Nn \g__thermodynamics_mole_symbol n
\tl_gset:Nn \g__thermodynamics_heat_symbol Q
\tl_gset:Nn \g__thermodynamics_work_symbol W
\tl_gset:Nn \g__thermodynamics_temperature_symbol T
\tl_gset:Nn \g__thermodynamics_pressure_symbol P
\cs_new:Nn \__thermodynamics_underline:n
{ \mkern1mu\underline{\mkern-1mu #1\mkern-4mu}\mkern4mu }
\cs_new:Nn \__thermodynamics_overline:n
{ \mkern2mu\overline{\mkern-2mu #1\mkern-1mu}\mkern1mu }
\tl_new:N \l__thermodynamics_PartialOpen_tl
\tl_new:N \l__thermodynamics_PartialEmptyClose_tl
\tl_new:N \l__thermodynamics_PartialClose_tl

\tl_set:Nn \l__thermodynamics_PartialOpen_tl {(}
\tl_set:Nn \l__thermodynamics_PartialClose_tl {)}
\tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {)}
\DeclareOption{EUAGHan}{}% the default
\DeclareOption{EUAGHaN}{\tl_gset:Nn \g__thermodynamics_mole_symbol N}%
\DeclareOption{EUHAGan}{\ExecuteOptions{EUAGHan}}
\DeclareOption{EUHAGaN}{\ExecuteOptions{EUAGHaN}}
\DeclareOption{EUFGHAn}{%
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
  \tl_gset:Nn \g__thermodynamics_area_symbol A
}
\DeclareOption{EUFGHAN}{%
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
  \tl_gset:Nn \g__thermodynamics_area_symbol A
  \tl_gset:Nn \g__thermodynamics_mole_symbol N
}
\DeclareOption{EEFGHAn}{%
  \tl_gset:Nn \g__thermodynamics_total_energy_symbol {\mathcal{E}}
  \tl_gset:Nn \g__thermodynamics_internal_energy_symbol E
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
  \tl_gset:Nn \g__thermodynamics_area_symbol A
}
\DeclareOption{EEFGHAN}{%
  \tl_gset:Nn \g__thermodynamics_total_energy_symbol {\mathcal{E}}
  \tl_gset:Nn \g__thermodynamics_internal_energy_symbol E
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
  \tl_gset:Nn \g__thermodynamics_area_symbol A
  \tl_gset:Nn \g__thermodynamics_mole_symbol N
}
\DeclareOption{EEFGHan}{%
  \tl_gset:Nn \g__thermodynamics_total_energy_symbol {\mathcal{E}}
  \tl_gset:Nn \g__thermodynamics_internal_energy_symbol E
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
}
\DeclareOption{EEFGHaN}{%
  \tl_gset:Nn \g__thermodynamics_total_energy_symbol {\mathcal{E}}
  \tl_gset:Nn \g__thermodynamics_internal_energy_symbol E
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
  \tl_gset:Nn \g__thermodynamics_mole_symbol N
}
\DeclareOption{EEAGHan}{%
  \tl_gset:Nn \g__thermodynamics_total_energy_symbol {\mathcal{E}}
  \tl_gset:Nn \g__thermodynamics_internal_energy_symbol E
}
\DeclareOption{EEAGHaN}{%
  \tl_gset:Nn \g__thermodynamics_total_energy_symbol {\mathcal{E}}
  \tl_gset:Nn \g__thermodynamics_internal_energy_symbol E
  \tl_gset:Nn \g__thermodynamics_mole_symbol N
}
\DeclareOption{EUAGHAn}{%
  \tl_gset:Nn \g__thermodynamics_area_symbol {\mathcal{A}}
}
\DeclareOption{EUAGHAN}{%
  \tl_gset:Nn \g__thermodynamics_area_symbol {\mathcal{A}}
  \tl_gset:Nn \g__thermodynamics_mole_symbol N
}
\DeclareOption{EUFGHan}{%
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
}
\DeclareOption{EUFGHaN}{%
  \tl_gset:Nn \g__thermodynamics_Helmholtz_symbol F
  \tl_gset:Nn \g__thermodynamics_mole_symbol N
}
\DeclareOption{delta}{ \cs_set_eq:NN \dbar \delta }
\cs_new:Nn \__thermodynamics_extensive:n {#1}
\cs_new:Nn \__thermodynamics_intensive:n {#1}
\cs_new:Nn \__thermodynamics_specific:n {\hat{#1}}

\cs_new:Npn \__thermodynamics_set_intensive_plain
{
  \cs_set:Nn \__thermodynamics_extensive:n {\__thermodynamics_underline:n{##1}}
  \cs_set:Nn \__thermodynamics_intensive:n {##1}
}
\cs_new:Npn \__thermodynamics_set_extensive_plain
{
  \cs_set:Nn \__thermodynamics_extensive:n {##1}
  \cs_set:Nn \__thermodynamics_intensive:n {\__thermodynamics_underline:n{##1}}
}
\cs_new:Npn \__thermodynamics_set_lowercase_pms
{
  \RenewDocumentCommand{\partialmolar}{m}
  {
    \tl_set:Nn \l__thermodynamics_pm_symbol_tl {\text_lowercase:n {##1}}
    \__thermodynamics_generic_pm:
  }
}
\cs_new:Npn \__thermodynamics_set_intensive_lowercase
{
  \cs_set:Nn \__thermodynamics_extensive:n {\text_uppercase:n {##1}}
  \cs_set:Nn \__thermodynamics_intensive:n {\text_lowercase:n {##1}}
  \cs_set:Nn \__thermodynamics_specific:n {\hat{\text_lowercase:n {##1}}}
}
\cs_new:Npn \__thermodynamics_set_extensive_superscripts
{
  \cs_set:Nn \__thermodynamics_extensive_one:n
  { \c_math_superscript_token {##1\l__thermodynamics_super_separator_tl t} }
  \cs_set:Nn \__thermodynamics_extensive:n
  {
     \peek_catcode_remove:NTF \c_math_superscript_token
     { ##1 \__thermodynamics_extensive_one:n }
     { ##1 \c_math_superscript_token t }
  }
  \cs_set:Nn \__thermodynamics_intensive:n {##1}
}
\DeclareOption{extensive-plain}{\__thermodynamics_set_extensive_plain}
\DeclareOption{intensive-plain}{\__thermodynamics_set_intensive_plain} % the default
\DeclareOption{intensive-lowercase}{% PLEASE don't use this!
  \__thermodynamics_set_intensive_lowercase
  \AtEndOfPackage{
    \__thermodynamics_set_lowercase_pms
  }
}
\DeclareOption{extensive-superscript}{%
  \__thermodynamics_set_extensive_superscripts
}
\bool_new:N \l__thermodynamics_longpm_bool
\DeclareOption{longpm}{\bool_set_true:N \l__thermodynamics_longpm_bool}
\cs_set_eq:NN \__thermodynamics_overline_copy:n \__thermodynamics_overline:n
\DeclareOption{shortpm}{
  \bool_set_false:N \l__thermodynamics_longpm_bool
  \AtEndOfPackage{
    \RenewDocumentCommand{\cPpm}{}
    {
      \cs_set:Nn \__thermodynamics_overline:n {##1}
      \partialmolar{\cPpmshort}
    }
    \RenewDocumentCommand{\cVpm}{}
    {
      \cs_set:Nn \__thermodynamics_overline:n {##1}
      \partialmolar{\cVpmshort}
    }
  }
}
\NewDocumentEnvironment{thermolongpm}{}{%
  \bool_set_true:N \l__thermodynamics_longpm_bool
}{}
\NewDocumentEnvironment{thermoshortpm}{}{%
  \bool_set_false:N \l__thermodynamics_longpm_bool
     \RenewSubscriptedSymbol{\cPpm}{\__thermodynamics_overline:n \heatcapacitysymbol}
        {\g__thermodynamics_pressure_symbol}
     \RenewSubscriptedSymbol{\cVpm}{\__thermodynamics_overline:n \heatcapacitysymbol}
        {\g__thermodynamics_volume_symbol}
}{}
\bool_new:N \l__thermodynamics_subscripted_bool
\bool_set_true:N \l__thermodynamics_subscripted_bool
\DeclareOption{subscripts}{\bool_set_true:N \l__thermodynamics_subscripted_bool}
\DeclareOption{nosubscripts}{\bool_set_false:N \l__thermodynamics_subscripted_bool}
\DeclareOption{parentheses}{}
\DeclareOption{brackets}{%
  \tl_set:Nn \l__thermodynamics_PartialOpen_tl {[}
  \tl_set:Nn \l__thermodynamics_PartialClose_tl {]}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {]}
}
\DeclareOption{braces}{%
  \tl_set:Nn \l__thermodynamics_PartialOpen_t1 {\{}
  \tl_set:Nn \l__thermodynamics_PartialClose_t1 {\}}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {\}}
}
\DeclareOption{bar}{%
  \tl_set:Nn \l__thermodynamics_PartialOpen_tl {.}
  \tl_set:Nn \l__thermodynamics_PartialClose_tl {\rvert}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {.}
}
\DeclareOption{plain-derivatives}{% This implies dU(S,V,N)/dS notation
  \tl_set:Nn \l__thermodynamics_PartialOpen_tl {.}
  \tl_set:Nn \l__thermodynamics_PartialClose_tl {.}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {.}
  \ExecuteOptions{nosubscripts}
}
\NewExpandableDocumentCommand \ncomponents {} {C}
\NewDocumentCommand{\allNs}{O{i}}{\allcomponents[#1]{\Nt}}
\NewDocumentCommand{\allXs}{O{i}}{\allcomponents[#1]{x}}
\NewDocumentCommand{\allYs}{O{i}}{\allcomponents[#1]{y}}
\NewDocumentCommand{\allmus}{O{i}}{\allcomponents[#1]{\mu}}
\NewDocumentCommand{\allMs}{O{i}}{\allcomponents[#1]{m}}
\NewDocumentCommand{\allWs}{O{i}}{\allcomponents[#1]{w}}
\NewDocumentCommand{\allNsbut}{O{j} m} {\allbut[#1]{#2}{\Nt}}
\NewDocumentCommand{\allXsbut}{O{j} m} {\allbutlastand[#1]{#2}{x}}
\NewDocumentCommand{\allYsbut}{O{j} m} {\allbutlastand[#1]{#2}{y}}
\NewDocumentCommand{\allmusbut}{O{j} m} {\allbut[#1]{#2}{\mu}}
\NewDocumentCommand{\allMsbut}{O{j} m} {\allbut[#1]{#2}{m}}
\NewDocumentCommand{\allWsbut}{O{j} m} {\allbutlastand[#1]{#2}{w}}
\NewDocumentCommand{\allcomponents}{O{} m}{\vec{#2}}
\NewDocumentCommand{\allbut}{O{j} m m}
{ \tl_if_eq:nnTF {#1} {#2}
  { {#3}\c_math_subscript_token{k \neq #2} }
  { {#3}\c_math_subscript_token{#1 \neq #2} }
}
\NewDocumentCommand{\allbutlastand}{O{j} m m}
{ \tl_if_eq:xxTF {#2} {\ncomponents}
  { {#3}\c_math_subscript_token{#1 \neq #2} }
  { \tl_if_eq:nnTF {#1} {#2}
    { {#3}\c_math_subscript_token{k \neq #2,\ncomponents} }
    { {#3}\c_math_subscript_token{#1 \neq #2,\ncomponents} }
  }
}
\DeclareOption{moles-index}{}
\DeclareOption{moles-range}{ \__thermodynamics_set_moles_range }
\cs_new:Npn \__thermodynamics_set_moles_range {%
  \RenewDocumentCommand{\allcomponents}{O{} m}
  { {##2}\c_math_subscript_token 1,\dots,
        {##2}\c_math_subscript_token{\ncomponents} }
  \RenewDocumentCommand{\allbut}{O{j} m m}
  { \tl_if_eq:nnTF {##2} {1}
    { {##3}\c_math_subscript_token 2,\dots,
        {##3}\c_math_subscript_token{\ncomponents} }
    { \tl_if_eq:xxTF {##2} {\ncomponents}
      { {##3}\c_math_subscript_token 1,\dots,
          {##3}\c_math_subscript_token{\ncomponents-1} }
      { {##3}\c_math_subscript_token 1,\dots,
            [{##3}\c_math_subscript_token{##2}],
            \dots,{##3}\c_math_subscript_token{\ncomponents} }
    }
  }
  \RenewDocumentCommand{\allbutlastand}{O{j} m m}
  { \tl_if_eq:nnTF {##2} {1}
    { {##3}\c_math_subscript_token 2,\dots,
        {##3}\c_math_subscript_token{\ncomponents-1} }
    { \tl_if_eq:xxTF {##2} {\ncomponents}
      { {##3}\c_math_subscript_token 1,\dots,
        {##3}\c_math_subscript_token{\ncomponents-1}
      }
      { \tl_if_eq:xxTF {##2} {\ncomponents-1}
        { {##3}\c_math_subscript_token 1,\dots,
          {##3}\c_math_subscript_token{\ncomponents-2} }
        {
          {##3}\c_math_subscript_token 1,\dots,
          [{##3}\c_math_subscript_token{##2}],\dots,
           {##3}\c_math_subscript_token{\ncomponents-1}
        }
      }
    }
  }
}
\DeclareOption{Bejan}{
  \ExecuteOptions{EUFGHAN,intensive-lowercase,delta,shortpm}
  \AtEndOfPackage{
    \cs_set:Nn \__thermodynamics_specific:n {\text_lowercase:n {#1}}
    \cs_set:Nn \__thermodynamics_intensive:n {\bar{\text_lowercase:n {#1}}}
    \cs_set:Nn \__thermodynamics_extensive:n {\text_uppercase:n {#1}}
    \tl_gset:Nn \g__thermodynamics_volume_symbol v
    \RenewExpandableDocumentCommand{\ncomponents}{}{n}
    \RenewSubscriptedSymbol{\Lt}{\g__thermodynamics_Helmholtz_symbol}{\mu}
    \RenewSubscriptedSymbol{\Lm}
        {\bar{\text_lowercase:n \g__thermodynamics_Helmholtz_symbol}}{\mu}
    \RenewSubscriptedSymbol{\Ls}
        {\text_lowercase:n \g__thermodynamics_Helmholtz_symbol}{\mu}
    \cs_new:Npn \Delta_vap_sym {} {}
    \NewSubscriptedSymbol{\Delta_vap}{\Delta_vap_sym}{{fg}}
    \RenewDocumentCommand{\Deltavap}{m}{
      \cs_set:Npn \Delta_vap_sym {} {#1}
      \Delta_vap
    }
    \cs_new:Npn \Delta_fus_sym {} {}
    \NewSubscriptedSymbol{\Delta_fus}{\Delta_fus_sym}{{sf}}
    \RenewDocumentCommand{\Deltafus}{m}{
      \cs_set:Npn \Delta_fus_sym {} {#1}
      \Delta_fus
    }
    \cs_new:Npn \Delta_sub_sym {} {}
    \NewSubscriptedSymbol{\Delta_sub}{\Delta_sub_sym}{{sg}}
    \RenewDocumentCommand{\Deltasub}{m}{
      \cs_set:Npn \Delta_sub_sym {} {#1}
      \Delta_sub
    }
    \RenewExpandableDocumentCommand{\heatcapacitysymbol}{}{c}
    \RenewSubscriptedSymbol{\cV}{\__thermodynamics_intensive:n {\heatcapacitysymbol}}
        {\text_lowercase:n \g__thermodynamics_volume_symbol}
    \RenewSubscriptedSymbol{\cVt}{\__thermodynamics_extensive:n {\heatcapacitysymbol}}
        {\text_uppercase:n \g__thermodynamics_volume_symbol}
    \RenewSubscriptedSymbol{\cVpm}{\heatcapacitysymbol}
        {\text_lowercase:n \g__thermodynamics_volume_symbol}
    \RenewSubscriptedSymbol{\cPpm}{\heatcapacitysymbol}
        {\text_lowercase:n \g__thermodynamics_pressure_symbol}
    \RenewExpandableDocumentCommand{\xrxn}{}{\zeta}
    \RenewDocumentCommand{\fmix}{}{f}
    \RenewDocumentCommand{\Qm}{}{Q}
    \RenewDocumentCommand{\Qs}{}{Q}
    \RenewExpandableDocumentCommand{\kappaT}{}{\compressibilitysymbol}
    \RenewExpandableDocumentCommand{\expansivitysymbol}{}{\beta}
    \RenewExpandableDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewSubscriptedSymbol{\muJT}{\JTsymbol}{J}
    \RenewDocumentCommand{\Deltaf}{m}
    { \tl_set:Nn \l__thermodynamics_Deltaf_sym_tl {#1} \__thermodynamics_Deltaf }
    \RenewDocumentCommand{\Pstd}{}{P\c_math_subscript_token 0}
    \RenewDocumentCommand{\Wm}{}{W}
    \RenewDocumentCommand{\Ws}{}{W}
    \cs_new:Nn \__thermodynamics_fpure_one:n
    {
      f\c_math_subscript_token{#1}
      \peek_catcode_remove:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \RenewDocumentCommand{\fpure}{}
    {
      \peek_catcode_remove:NTF \c_math_subscript_token
      { \__thermodynamics_fpure_one:n }
      { f }
    }
    \cs_new:Nn \__thermodynamics_phipure_one:n
    {
      \phi\c_math_subscript_token{#1}
      \peek_catcode:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \RenewDocumentCommand{\phipure}{}
    {
      \peek_catcode_remove:NTF \c_math_subscript_token
      {
        \__thermodynamics_phipure_one:n
      }
      {\phi}
    }
    \RenewDocumentCommand{\phimix}{}{\phi}
  }
}
\DeclareOption{CBK}{
  \ExecuteOptions{EUAGHAN,intensive-lowercase,delta,shortpm}
  \AtEndOfPackage{
    \cs_set:Nn \__thermodynamics_overline:n {\widetilde #1}
    \cs_set:Nn \__thermodynamics_overline_copy:n {\widetilde #1}
    \cs_set:Nn \__thermodynamics_specific:n {\text_lowercase:n {#1}}
    \cs_set:Nn \__thermodynamics_intensive:n {\bar{\text_lowercase:n{#1}}}
    \tl_gset:Nn \g__thermodynamics_area_symbol A
    \RenewExpandableDocumentCommand{\reaction}{}{R}
    \cs_new:Npn \Delta_vap_sym {} {}
    \NewSubscriptedSymbol{\Delta_vap}{\Delta_vap_sym}{{fg}}
    \RenewDocumentCommand{\Deltavap}{m}{
      \cs_set:Npn \Delta_vap_sym {} {#1}
      \Delta_vap
    }
    \cs_new:Npn \Delta_fus_sym {} {}
    \NewSubscriptedSymbol{\Delta_fus}{\Delta_fus_sym}{{sf}}
    \RenewDocumentCommand{\Deltafus}{m}{
      \cs_set:Npn \Delta_fus_sym {} {#1}
      \Delta_fus
    }
    \cs_new:Npn \Delta_sub_sym {} {}
    \NewSubscriptedSymbol{\Delta_sub}{\Delta_sub_sym}{{sg}}
    \RenewDocumentCommand{\Deltasub}{m}{
      \cs_set:Npn \Delta_sub_sym {} {#1}
      \Delta_sub
    }
    \tl_gset:Nn \g__thermodynamics_pressure_symbol p
    \RenewExpandableDocumentCommand{\compressibilitysymbol}{}{\alpha}
    \RenewExpandableDocumentCommand{\expansivitysymbol}{}{\beta}
    \RenewExpandableDocumentCommand{\kappaT}{}{\compressibilitysymbol}
    \RenewExpandableDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewSuperscriptedSymbol{\Psat}{P}{v}
    \RenewDocumentCommand{\Deltaf}{m}
    { \tl_set:Nn \l__thermodynamics_Deltaf_sym_tl {#1}
      \__thermodynamics_Deltaf
    }
    \RenewDocumentCommand{\Pstd}{}{P\c_math_subscript_token 0}
    \RenewDocumentCommand{\Lm}{}{\__thermodynamics_intensive:n\omega}
    \RenewDocumentCommand{\Ls}{}{\__thermodynamics_specific:n\omega}
  }
}
\DeclareOption{ElliottLira}{
  \ExecuteOptions{shortpm}
  \AtEndOfPackage{
    \cs_gset_eq:NN \__thermodynamics_specific:n \__thermodynamics_intensive:n
    %^^A\RenewDocumentCommand{\partialmolar}{m}{\__thermodynamics_overline:n #1}
    \RenewDocumentCommand{\allcomponents}{O{} m}{#2}
    \RenewDocumentCommand{\Deltarxn}{m}{\Delta #1}
    \RenewDocumentCommand{\fusion}{}{{fus}}
    \RenewDocumentCommand{\sublimation}{}{{sub}}
    \RenewDocumentCommand{\vaporization}{}{{vap}}
    \RenewDocumentCommand{\sat}{}{{sat}}
    %^^A\RenewSubscriptedSymbol{\Henrymol}{/K}{H} %^^A FIXME
    \RenewDocumentCommand{\IG}{}{{ig}}
    \RenewDocumentCommand{\IGM}{}{{ig}}
    \RenewDocumentCommand{\IS}{}{{is}}
    \RenewDocumentCommand{\Cstd}{}{m\c_math_superscript_token \std}
    \RenewDocumentCommand{\muJT}{}{\mu\c_math_subscript_token{JT}}
  }
}
\DeclareOption{KlotzRosenberg}{
  \ExecuteOptions{delta}
  \AtEndOfPackage{
    \tl_set:Nn \l__thermodynamics_sub_separator_tl {}
    \cs_set:Nn \__thermodynamics_extensive:n {#1}
    \cs_new:Nn \__thermodynamics_intensive_one:n
    {
      \c_math_superscript_token {#1}
      \peek_catcode_remove:NTF \c_math_subscript_token
      { \__thermodynamics_intensive_three:n }
      { \c_math_subscript_token{\mathrm{m}} }
    }
    \cs_new:Nn \__thermodynamics_intensive_three:n
    { \c_math_subscript_token{\mathrm{m}\l__thermodynamics_sub_separator_tl #1} }
    \cs_new:Nn \__thermodynamics_intensive_two:n
    {
      \c_math_subscript_token{\mathrm{m}\l__thermodynamics_sub_separator_tl #1}
      \peek_catcode:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \cs_set:Nn \__thermodynamics_intensive:n
    {
      #1
      \peek_catcode_remove:NTF \c_math_superscript_token
      { \__thermodynamics_intensive_one:n }
      { \peek_catcode_remove:NTF \c_math_subscript_token
        { \__thermodynamics_intensive_two:n }
        { \c_math_subscript_token{\mathrm{m}} }
      }
    }
    \cs_new:Nn \__thermodynamics_fpure_one:n
    {
      f\c_math_subscript_token{#1}
      \peek_catcode_remove:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \RenewDocumentCommand{\fpure}{}
    {
      \peek_catcode_remove:NTF \c_math_subscript_token
      { \__thermodynamics_fpure_one:n }
      { f }
    }
    \cs_new:Nn \__thermodynamics_phipure_one:n
    {
      \gamma\c_math_subscript_token{#1}
      \peek_catcode_remove:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \RenewDocumentCommand{\phipure}{}
    {
      \peek_catcode_remove:NTF \c_math_subscript_token
      { \__thermodynamics_phipure_one:n }
      { \gamma }
    }
    \RenewDocumentCommand{\fmix}{}{f}
    \RenewDocumentCommand{\phimix}{}{\gamma}
    \RenewDocumentCommand{\phisat}{}{\gamma^\sat}
    \cs_if_exist:NTF \gammaup
    { \RenewDocumentCommand{\gamma}{}{\gammaup} }
    { \cs_if_exist:NT \upgamma
        { \RenewDocumentCommand{\gamma}{}{\upgamma} }
    }
    \RenewDocumentCommand{\gammarat}{}{\gamma}
    \RenewDocumentCommand{\gammamol}{}{\gamma}
    \cs_if_exist:NTF \muup
      {\RenewDocumentCommand{\mu}{}{\muup}}
      {\cs_if_exist:NT \upmu
          {\RenewDocumentCommand{\mu}{}{\upmu}}
      }
    \cs_if_exist:NTF \alphaup
      {\RenewExpandableDocumentCommand{\expansivitysymbol}{}{\alphaup}}
      {\cs_if_exist:NTF \upalpha
        {\RenewExpandableDocumentCommand{\compressibilitysymbol}{}{\alphaup}}
        {\RenewExpandableDocumentCommand{\compressibilitysymbol}{}{\alpha}}
      }
    \cs_if_exist:NTF \betaup
      {\RenewExpandableDocumentCommand{\compressibilitysymbol}{}{\betaup}}
      {\cs_if_exist:NTF \upbeta
        {\RenewExpandableDocumentCommand{\compressibilitysymbol}{}{\betaup}}
        {\RenewExpandableDocumentCommand{\compressibilitysymbol}{}{\beta}}
      }
    \cs_if_exist:NTF \xiup
      {\RenewDocumentCommand{\xrxn}{}{\xiup}}
      {\cs_if_exist:NT \upxi
          {\RenewDocumentCommand{\xrxn}{}{\upxi}}
      }
    \RenewDocumentCommand{\kappaT}{}{\compressibilitysymbol}
    \RenewDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewSubscriptedSymbol{\muJT}{\JTsymbol}{\text{J.T.}}
    \RenewDocumentCommand{\Deltarxn}{m}{\Delta #1}
    \RenewDocumentCommand{\Deltaf}{}{\Delta\c_math_subscript_token\formation}
    \RenewDocumentCommand{\Deltafus}{}{\Delta}
    \RenewDocumentCommand{\Deltavap}{}{\Delta}
    \RenewDocumentCommand{\Deltasub}{}{\Delta}
    \RenewDocumentCommand{\Deltamix}{m}{
      \tl_set:Nn \l__thermodynamics_sub_separator_tl {,}
      \Delta #1\c_math_subscript_token{\mixing}
    }
    \RenewDocumentCommand{\excess}{}{{\mathrm{E}}}
    \RenewDocumentCommand{\residual}{}{{\mathrm{R}}}
    \cs_set:Nn \__thermodynamics_overline:n {#1}
    \RenewDocumentCommand{\IS}{}{{\mathrm{I}}}
    \RenewDocumentCommand{\Psat}{}
    {
      \peek_catcode:NTF \c_math_subscript_token
        {p\c_math_superscript_token\bullet}
        {p}
    }
    \RenewDocumentCommand{\Cstd}{}{m^\std}
    \RenewDocumentCommand{\Henryrat}{}{k}
    \RenewDocumentCommand{\Henrymol}{}{k''}

    % Fix partial molar properties
    \cs_set:Npn \__thermodynamics_pm_case_one #1
    {
      \l__thermodynamics_pm_symbol_tl\c_math_subscript_token{\mathrm{m}#1}
    }
    \cs_set:Npn \__thermodynamics_pm_case_two [#1]#2
    {
      \l__thermodynamics_pm_symbol_tl
        \c_math_superscript_token{#1}\c_math_subscript_token{\mathrm{m}#2}
    }
    \cs_set:Npn \__thermodynamics_pm_case_three_part_two #1
    {
      \l__thermodynamics_pm_symbol_tl
        \c_math_superscript_token{\l__thermodynamics_pm_arg_tl}
        \c_math_subscript_token{\mathrm{m}#1}
    }
    \cs_set:Npn \__thermodynamics_pm_case_four #1
    {
      \l__thermodynamics_pm_symbol_tl\c_math_superscript_token{#1}
        \c_math_subscript_token{\mathrm{m}\l__thermodynamics_pm_arg_tl}
    }
    \cs_set:Npn \__thermodynamics_pm_case_five
    {
      \l__thermodynamics_pm_symbol_tl
        \c_math_subscript_token{\mathrm{m}\l__thermodynamics_pm_arg_tl}
    }

    % fix heat capacities
    \RenewSubscriptedSymbol{\cP}{\heatcapacitysymbol}
        {\g__thermodynamics_pressure_symbol\mathrm{m}}
    \RenewSubscriptedSymbol{\cV}{\heatcapacitysymbol}
        {\g__thermodynamics_volume_symbol\mathrm{m}}
    \RenewDocumentCommand{\cPpm}{}{\partialmolar{\cPt}}
    \RenewDocumentCommand{\cVpm}{}{\partialmolar{\cVt}}

    \cs_set:Npn \cP_two:n #1
    { \heatcapacitysymbol
      \c_math_subscript_token{\g__thermodynamics_pressure_symbol\mathrm{m}
        \l__thermodynamics_sub_separator_tl #1}
      \peek_catcode:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \cs_set:Npn \cV_two:n #1
    { \heatcapacitysymbol
      \c_math_subscript_token{\g__thermodynamics_volume_symbol\mathrm{m}
        \l__thermodynamics_sub_separator_tl #1}
      \peek_catcode:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
  }
  \AtBeginDocument{
    \@ifpackageloaded{emf}{\RenewDocumentCommand{\Epot}{}{\emf}}
    {%
      \PackageWarningNoLine{thermodynamics}
        {Package~emf~not~loaded;~load~to~make~Epot~match~Klotz~
         and~Rosenberg's~notation}%
    }
  }
}
\DeclareOption{Koretsky}{
  \ExecuteOptions{EUAGHAn,brackets,intensive-lowercase,delta,shortpm}
  \AtEndOfPackage{
    \tl_gset:Nn \g__thermodynamics_area_symbol {A}
    \RenewExpandableDocumentCommand{\std}{}{o}
    \RenewExpandableDocumentCommand{\ncomponents}{}{m}
    \RenewDocumentCommand{\partialmolar}{m}
    {
      \tl_set:Nn \l__thermodynamics_pm_symbol_tl {#1}
      \__thermodynamics_generic_pm:
    }
    \RenewDocumentCommand{\expansivitysymbol}{}{\beta}
    \RenewDocumentCommand{\IS}{}{{\text{ideal}}}
    \RenewDocumentCommand{\residual}{}{{\text{dep}}}
    \RenewDocumentCommand{\IG}{}{{\text{ideal~gas}}}
    \RenewDocumentCommand{\IGM}{}{{\text{ideal}}}
    \RenewDocumentCommand{\Henryrat}{}{{\mathcal{H}}}
    \RenewDocumentCommand{\gammarat}{}
        {\gamma\c_math_superscript_token\text{Henry's}}
    \RenewDocumentCommand{\gammamol}{}{\gamma\c_math_superscript_token{m}}
    \RenewDocumentCommand{\phipure}{}{\varphi}
    \RenewDocumentCommand{\phimix}{}{\hat\varphi}
    \RenewDocumentCommand{\phisat}{}{\varphi\c_math_superscript_token\sat}
    \cs_new:Npn \Delta_fus_sym {} {}
    \NewSubscriptedSymbol{\Delta_fus}{\Delta_fus_sym}{\fusion}
    \RenewDocumentCommand{\Deltafus}{m}{
      \cs_set:Npn \Delta_fus_sym {} { \Delta #1 }
      \Delta_fus
    }
    \cs_new:Npn \Delta_vap_sym {} {}
    \NewSubscriptedSymbol{\Delta_vap}{\Delta_vap_sym}{\vaporization}
    \RenewDocumentCommand{\Deltavap}{m}{
      \cs_set:Npn \Delta_vap_sym {} { \Delta #1 }
      \Delta_vap
    }
    \cs_new:Npn \Delta_sub_sym {} {}
    \NewSubscriptedSymbol{\Delta_sub}{\Delta_sub_sym}{\sublimation}
    \RenewDocumentCommand{\Deltasub}{m}{
      \cs_set:Npn \Delta_sub_sym {} { \Delta #1 }
      \Delta_sub
    }
    \tl_new:N \l__thermodynamics_Deltaf_superscript_tl
    \tl_new:N \l__thermodynamics_Deltaf_subscript_tl
    \bool_new:N \l__thermodynamics_Deltaf_parentheses_bool
    \tl_new:N \l__thermodynamics_Deltaf_entity_tl
    \cs_set:Nn \__thermodynamics_Deltaf_one:n
    {
      \tl_set:Nn \l__thermodynamics_Deltaf_superscript_tl {#1}
      \peek_catcode_remove:NTF \c_math_subscript_token
      {
        \bool_set_true:N \l__thermodynamics_Deltaf_parentheses_bool
        \__thermodynamics_Deltaf_two:n
      }
      {
        \bool_if:NTF \l__thermodynamics_Deltaf_parentheses_bool
        {
          (\Delta\l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token\formation
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
            { \c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl }
          )
          \tl_if_empty:NF \l__thermodynamics_Deltaf_subscript_tl
          { \c_math_subscript_token\l__thermodynamics_Deltaf_subscript_tl }
        }
        {
          \Delta\l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token\formation
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
            { \c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl }
        }
      }
    }
    \cs_set:Nn \__thermodynamics_Deltaf_two:n
    {
      \tl_set:Nn \l__thermodynamics_Deltaf_subscript_tl {#1}
      % check for case 4
      \peek_catcode_remove:NTF \c_math_superscript_token
      { \__thermodynamics_Deltaf_one:n }
      {
        \bool_if:NTF \l__thermodynamics_Deltaf_parentheses_bool
        {
          (\Delta\l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token\formation
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
              {\c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl}
          )
          \tl_if_empty:NF \l__thermodynamics_Deltaf_subscript_tl
            \c_math_subscript_token\l__thermodynamics_Deltaf_subscript_tl
        }
        {
          \Delta\l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token\formation
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
              {\c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl}
        }
      }
    }
    \RenewDocumentCommand{\Deltaf}{m}
    {
      \tl_clear:N \l__thermodynamics_Deltaf_superscript_tl
      \tl_clear:N \l__thermodynamics_Deltaf_subscript_tl
      \tl_set:Nn \l__thermodynamics_Deltaf_entity_tl {#1}
      \bool_set_false:N \l__thermodynamics_Deltaf_parentheses_bool
      \peek_catcode_remove:NTF \c_math_superscript_token
      {
        \__thermodynamics_Deltaf_one:n
      }
      {
        \peek_catcode_remove:NTF \c_math_subscript_token
        {
          \bool_set_true:N \l__thermodynamics_Deltaf_parentheses_bool
          \__thermodynamics_Deltaf_two:n
        }
        {
          \Delta #1\c_math_subscript_token \formation
        }
      }
    }
    \RenewDocumentCommand{\kappaT}{}{\compressibilitysymbol}
    \RenewDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewSubscriptedSymbol{\cV}{\__thermodynamics_intensive:n \heatcapacitysymbol}
        {\__thermodynamics_intensive:n \g__thermodynamics_volume_symbol}
    \RenewSubscriptedSymbol{\cVs}{\__thermodynamics_specific:n \heatcapacitysymbol}
        {\__thermodynamics_intensive:n \g__thermodynamics_volume_symbol}
    \RenewDocumentCommand{\Lm}{}{\omega}
    \RenewDocumentCommand{\Ls}{}{\hat\omega}
  }
}
\DeclareOption{MSBB}{
  \ExecuteOptions{EUFGHAn,intensive-lowercase,delta,shortpm}
  \AtEndOfPackage{
    \RenewDocumentCommand{\IGM}{}{\ast} % FIXME: is this * or \circ?
    \RenewDocumentCommand{\IG}{}{\ast}
    \RenewDocumentCommand{\expansivitysymbol}{}{\beta}
    \RenewDocumentCommand{\muJT}{}{\mu\c_math_subscript_token J}
    \RenewDocumentCommand{\allcomponents}{O{} m}{#2}
    \RenewDocumentCommand{\allbut}{O{j} m m}
    {
      \tl_if_eq:nnTF {#1} {#2}
      { {#3}\c_math_subscript_token k }
      { {#3}\c_math_subscript_token{#1} }
    }
    \tl_gset_eq:NN \g__thermodynamics_Helmholtz_symbol \psi
    \RenewDocumentCommand{\Ft}{}{\Psi}
    \RenewDocumentCommand{\Fpm}{}{\partialmolar{\Psi}}
    \cs_set:Nn \__thermodynamics_intensive:n {\__thermodynamics_overline:n{\text_lowercase:n{#1}}}
    \cs_set:Nn \__thermodynamics_specific:n {\text_lowercase:n{#1}}
    \RenewDocumentCommand{\fmix}{}{\bar f}
    \RenewDocumentCommand{\phimix}{}{\bar\phi}
    \RenewDocumentCommand{\phimix}{}{\bar\phi}
    \tl_gset:Nn \g__thermodynamics_pressure_symbol p
    \tl_gset:Nn \g__thermodynamics_volume_symbol v
    \RenewDocumentCommand{\partialmolar}{m}
    {
      \tl_set:Nn \l__thermodynamics_pm_symbol_tl {\text_uppercase:n #1}
      \__thermodynamics_generic_pm:
    }
    \RenewDocumentCommand{\kappaT}{}{\compressibilitysymbol}
    \RenewDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewDocumentCommand{\mustd}{}{\Gm^\std}
    \RenewExpandableDocumentCommand{\formation}{}{{\mathrm{f}}}
    \RenewDocumentCommand{\Pstd}{}
      {\g__thermodynamics_pressure_symbol\c_math_subscript_token\text{ref}}
    \RenewExpandableDocumentCommand{\xrxn}{}{\varepsilon}
    \RenewExpandableDocumentCommand{\Lm}{}{\__thermodynamics_intensive:n \omega}
    \RenewExpandableDocumentCommand{\Ls}{}{\__thermodynamics_specific:n \omega}
    \RenewExpandableDocumentCommand{\heatcapacitysymbol}{}{C}
    \tl_new:N \l__thermodynamics_Deltaf_superscript_tl
    \tl_new:N \l__thermodynamics_Deltaf_subscript_tl
    \bool_new:N \l__thermodynamics_Deltaf_parentheses_bool
    \tl_new:N \l__thermodynamics_Deltaf_entity_tl
    \cs_set:Nn \__thermodynamics_Deltaf_one:n
    {
      \tl_set:Nn \l__thermodynamics_Deltaf_superscript_tl {#1}
      \peek_catcode_remove:NTF \c_math_subscript_token
      {
        \bool_set_true:N \l__thermodynamics_Deltaf_parentheses_bool
        \__thermodynamics_Deltaf_two:n
      }
      {
        \bool_if:NTF \l__thermodynamics_Deltaf_parentheses_bool
        {
          (\l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token\formation
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
            { \c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl }
          )
          \tl_if_empty:NF \l__thermodynamics_Deltaf_subscript_tl
          { \c_math_subscript_token\l__thermodynamics_Deltaf_subscript_tl }
        }
        {
          \l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token{\formation}
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
            { \c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl }
        }
      }
    }
    \cs_set:Nn \__thermodynamics_Deltaf_two:n
    {
      \tl_set:Nn \l__thermodynamics_Deltaf_subscript_tl {#1}
      % check for case 4
      \peek_catcode_remove:NTF \c_math_superscript_token
      { \__thermodynamics_Deltaf_one:n }
      {
        \bool_if:NTF \l__thermodynamics_Deltaf_parentheses_bool
        {
          (\l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token\formation
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
            { \c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl }
          )
          \tl_if_empty:NF \l__thermodynamics_Deltaf_subscript_tl
          { \c_math_subscript_token\l__thermodynamics_Deltaf_subscript_tl }
        }
        {
          \l__thermodynamics_Deltaf_entity_tl\c_math_subscript_token\formation
            \tl_if_empty:NF \l__thermodynamics_Deltaf_superscript_tl
            { \c_math_superscript_token\l__thermodynamics_Deltaf_superscript_tl }
        }
      }
    }
    \RenewDocumentCommand{\Deltaf}{m}
    {
      \tl_clear:N \l__thermodynamics_Deltaf_superscript_tl
      \tl_clear:N \l__thermodynamics_Deltaf_subscript_tl
      \tl_set:Nn \l__thermodynamics_Deltaf_entity_tl {#1}
      \bool_set_false:N \l__thermodynamics_Deltaf_parentheses_bool
      \peek_catcode_remove:NTF \c_math_superscript_token
      {
        \__thermodynamics_Deltaf_one:n
      }
      {
        \peek_catcode_remove:NTF \c_math_subscript_token
        {
          \bool_set_true:N \l__thermodynamics_Deltaf_parentheses_bool
          \__thermodynamics_Deltaf_two:n
        }
        {
          \Delta #1\c_math_subscript_token \formation
        }
      }
    }
  }
}
\DeclareOption{Prausnitz}{
  \ExecuteOptions{intensive-lowercase,shortpm}
  \AtEndOfPackage{
    \RenewExpandableDocumentCommand{\ncomponents}{}{m}
    \RenewDocumentCommand{\fmix}{}{f}
    \RenewDocumentCommand{\fsat}{}{\fpure\c_math_superscript_token\sat}
    % TODO: this should pick up H_2 and make it into H_{2,1} (assuming
    % the solvent is always 1...?)
    \RenewDocumentCommand{\Henryrat}{}{H}
    %^^A\RenewDocumentCommand{\residual}{}{{{\mathcal{R}}}}
    \RenewDocumentCommand{\allcomponents}{O{i} m}
      { {#2}\c_math_subscript_token{#1} }
    \RenewDocumentCommand{\allbut}{O{i} m m}
    { \tl_if_eq:nnTF {#1} {#2}
        { {#3}\c_math_subscript_token k }
        { {#3}\c_math_subscript_token{#1} }
    }
    \tl_set:Nn \l__thermodynamics_sub_separator_tl {\,}
    \tl_gset:Nn \g__thermodynamics_pressure_symbol {p}
    \tl_gset:Nn \g__thermodynamics_volume_symbol {v}
    \RenewSubscriptedSymbol{\fpure}{f}{{\text{pure}}}
    \RenewDocumentCommand{\phimix}{}{\varphi}
    \RenewDocumentCommand{\phisat}{}{\varphi^\sat}
    \RenewDocumentCommand{\sat}{}{s}
    \RenewDocumentCommand{\mixing}{}{\text{mixing}}
    \RenewDocumentCommand{\Lm}{}{\omega}
    \RenewDocumentCommand{\Ls}{}{\__thermodynamics_specific:n \omega}
    \RenewSubscriptedSymbol{\phipure}{\varphi}{{\text{pure}}}
    \RenewDocumentCommand{\IG}{}{{\text{id}}}
    \RenewDocumentCommand{\IGM}{}{{\text{id}}}
    \RenewDocumentCommand{\IS}{}{{\text{(ideal)}}}
    \RenewExpandableDocumentCommand{\compressibilitysymbol}{}{\beta}
    \RenewDocumentCommand{\kappaT}{}{\compressibilitysymbol}
    \RenewDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewExpandableDocumentCommand{\std}{}{0}
    \@ifpackageloaded{emf}
      {\RenewDocumentCommand{\Epot}{}{\emf}}
      {\RenewDocumentCommand{\Epot}{}{\mathcal{E}}}
    \DeclareMathAlphabet{\mathdutchcal}{U}{dutchcal}{m}{n}
    \RenewExpandableDocumentCommand{\actrel}{}{\mathdutchcal{a}}
  }
}
\DeclareOption{Sandler}{
  \ExecuteOptions{EUAGHaN,extensive-plain,shortpm}
  \AtEndOfPackage{
    \RenewDocumentCommand{\Pvap}{}
        {{P\c_math_superscript_token{\text{vap}}}}
    \RenewDocumentCommand{\excess}{}{{\text{ex}}}
    \RenewDocumentCommand{\residual}{}{{\text{r}}}
    \RenewExpandableDocumentCommand{\ncomponents}{}{\mathcal{C}}
    \RenewDocumentCommand{\fmix}{}{\bar f}
    \RenewDocumentCommand{\fstd}{}{\bar f\c_math_superscript_token\std}
    \RenewDocumentCommand{\phimix}{}{\bar\phi}
    \RenewDocumentCommand{\allcomponents}{O{} m}{\__thermodynamics_underline:n{#2}}
    \RenewDocumentCommand{\IG}{}{{\text{IG}}}
    \RenewDocumentCommand{\IGM}{}{{\text{IGM}}}
    \RenewDocumentCommand{\IS}{}{{\text{IM}}}
    \RenewDocumentCommand{\Deltamix}{m}
        {\Delta\c_math_subscript_token\mixing #1}
    \RenewDocumentCommand{\Deltarxn}{m}
        {\Delta\c_math_subscript_token\reaction #1}
    \RenewDocumentCommand{\Deltasub}{m}
        {\Delta\c_math_subscript_token\sublimation #1}
    \RenewDocumentCommand{\Deltafus}{m}
        {\Delta\c_math_subscript_token\fusion #1}
    \RenewDocumentCommand{\Deltavap}{m}
        {\Delta\c_math_subscript_token\vaporization #1}
    \RenewDocumentCommand{\Pstd}{}{\text{1~bar}
      \peek_catcode_remove:NT \c_math_subscript_token {\use_none:n}
    }
    \RenewDocumentCommand{\Cstd}{}{\text{1~molal}
      \peek_catcode_remove:NT \c_math_subscript_token {\use_none:n}
    }
    \RenewDocumentCommand{\Henryrat}{}{H}
    \RenewSubscriptedSymbol{\cV}
        {\heatcapacitysymbol}{\g__thermodynamics_volume_symbol}
    \RenewSubscriptedSymbol{\cP}
        {\heatcapacitysymbol}{\g__thermodynamics_pressure_symbol}
    \RenewSubscriptedSymbol{\cVt}
        {\Nt\heatcapacitysymbol}{\g__thermodynamics_volume_symbol}
    \RenewSubscriptedSymbol{\cPt}
        {\Nt\heatcapacitysymbol}{\g__thermodynamics_pressure_symbol}
    \RenewDocumentCommand{\formation}{}{\mathrm{f}}
    \RenewDocumentCommand{\Deltaf}{}
        {\Delta\c_math_subscript_token\formation}
    \RenewDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewDocumentCommand{\muJT}{}{\mu}
    \RenewDocumentCommand{\xrxn}{}{X}
  }
}
\DeclareOption{SVNAS}{
  \ExecuteOptions{extensive-superscript,shortpm}
  \AtEndOfPackage{
    \RenewDocumentCommand{\allcomponents}{O{} m}{#2}
    \RenewDocumentCommand{\allbut}{O{j} m m}
    {
      \tl_if_eq:nnTF {#1} {#2}
      { {#3}\c_math_subscript_token k }
      { {#3}\c_math_subscript_token{#1} }
    }
    \RenewDocumentCommand{\IG}{}{{ig}}
    \RenewDocumentCommand{\IGM}{}{{ig}}
    \RenewDocumentCommand{\IS}{}{{id}}
    \RenewDocumentCommand{\IS}{}{{id}}
    \RenewDocumentCommand{\fusion}{}{{sl}}
    \RenewDocumentCommand{\vaporization}{}{{vl}}
    \RenewDocumentCommand{\sublimation}{}{{vs}}
    \RenewDocumentCommand{\expansivitysymbol}{}{\beta}
    \RenewDocumentCommand{\xrxn}{}{\varepsilon}
    \RenewDocumentCommand{\Deltarxn}{m}{\Delta #1}
    \RenewDocumentCommand{\Deltamix}{m}{\Delta #1}
    \RenewSubscriptedSymbol{\cVt}
        {\Nt\heatcapacitysymbol}{\g__thermodynamics_volume_symbol}
    \RenewSubscriptedSymbol{\cPt}
        {\Nt\heatcapacitysymbol}{\g__thermodynamics_pressure_symbol}
    % FIXME
    \RenewDocumentCommand{\cP}{}
        {{\heatcapacitysymbol\c_math_subscript_token\g__thermodynamics_pressure_symbol}}
    \RenewDocumentCommand{\cV}{}
        {{\heatcapacitysymbol\c_math_subscript_token\g__thermodynamics_volume_symbol}}
    \RenewDocumentCommand{\kappaT}{}{\compressibilitysymbol}
    \RenewDocumentCommand{\alphaP}{}{\expansivitysymbol}
    \RenewDocumentCommand{\muJT}{}{\mu}
    \RenewDocumentCommand{\Cstd}{}{m\c_math_superscript_token\std
      \peek_catcode_remove:NT \c_math_subscript_token {\use_none:n}
    }
    \RenewDocumentCommand{\mustd}{}{\Gm\c_math_superscript_token\std}
    \RenewDocumentCommand{\Henryrat}{}{\mathcal{H}}
    \RenewDocumentCommand{\formation}{}
    {
      \tl_set:Nn \l__thermodynamics_sub_separator_tl {}
      f298
    }
    \cs_set:Nn \__thermodynamics_specific:n {#1}
  }
}
\DeclareOption{ModellReid}{\ExecuteOptions{TesterModell}}
\DeclareOption{TesterModell}{
  \ExecuteOptions{EUAGHaN,delta,shortpm}
  \AtEndOfPackage{
    \cs_set:Nn \__thermodynamics_specific:n {\text_lowercase:n{#1}}
    \RenewExpandableDocumentCommand{\ncomponents}{}{n}
    \RenewDocumentCommand{\allcomponents}{O{i} m}
    {
      {#2}\c_math_subscript_token{#1}
    }
    \RenewDocumentCommand{\allbut}{O{i} m m}
    { \tl_if_eq:nnTF {#1} {#2}
      { {#3}\c_math_subscript_token{k}[#2] }
      { {#3}\c_math_subscript_token{#1}[#2] }
    }
    \RenewDocumentCommand{\allbutlastand}{O{j} m m}
    { \tl_if_eq:xxTF {#2} {\ncomponents}
      { {#3}\c_math_subscript_token{#1}\relax[#2] }
      { \tl_if_eq:nnTF {#1} {#2}
        { {#3}\c_math_subscript_token{k}[#2,\ncomponents] }
        { {#3}\c_math_subscript_token{#1}[#2,\ncomponents] }
      }
    }
    \RenewDocumentCommand{\IG}{}{{o}}
    \RenewDocumentCommand{\IGM}{}{{o}}
    \RenewDocumentCommand{\IS}{}{{ID}}
    \RenewDocumentCommand{\excess}{}{{EX}}
    \RenewDocumentCommand{\reaction}{}{{rx}}
    \RenewDocumentCommand{\Henryrat}{}
        {f\c_math_superscript_token{\ast\ast}}
    \RenewDocumentCommand{\Henrymol}{}{f\c_math_superscript_token\ast}
    \cs_if_exist:NTF \gammaup
    { \RenewDocumentCommand{\gamma}{}{\gammaup} }
    { \cs_if_exist:NT \upgamma
        { \RenewDocumentCommand{\gamma}{}{\upgamma} }
    }
    \RenewDocumentCommand{\gammarat}{}
        {\gamma\c_math_superscript_token{\ast\ast}}
    \RenewDocumentCommand{\gammamol}{}
        {\gamma\c_math_superscript_token\ast}
    \RenewExpandableDocumentCommand{\JTsymbol}{}{\alpha}
    \RenewSubscriptedSymbol{\muJT}{\JTsymbol}{H}
    \cs_if_exist:NTF \xiup
    { \RenewDocumentCommand{\xrxn}{}{\xiup} }
    { \cs_if_exist:NT \upxi
        { \RenewDocumentCommand{\xrxn}{}{\upxi} }
    }
    \cs_if_exist:NTF \phiup
    {
      \RenewDocumentCommand{\phipure}{}{\phiup}
      \RenewDocumentCommand{\phimix}{}{\hat\phiup}
      \RenewDocumentCommand{\phisat}{}{\phiup\c_math_superscript_token\sat}
    }
    { \cs_if_exist:NT \upphi
      {
        \RenewDocumentCommand{\phipure}{}{\upphi}
        \RenewDocumentCommand{\phimix}{}{\hat\upphi}
        \RenewDocumentCommand{\phisat}{}{\upphi\c_math_superscript_token\sat}
      }
    }
    \RenewDocumentCommand{\Cstd}{}{m\c_math_superscript_token+
      \peek_catcode_remove:NT \c_math_subscript_token {\use_none:n}
    }
    \cs_if_exist:NTF \muup
    { \RenewDocumentCommand{\mu}{}{\muup} }
    { \cs_if_exist:NT \upmu
      { \RenewDocumentCommand{\mu}{}{\upmu} }
    }
    \RenewDocumentCommand{\std}{}{o}
    \RenewDocumentCommand{\Pstd}{}{P^\ast}
    \tl_gset:Nn \g__thermodynamics_area_symbol {\text{\large\(\mathit{a}\)}}
    \RenewDocumentCommand{\Epot}{}{\exists}
    \tl_set:Nn \l__thermodynamics_sub_separator_tl {}
    \tl_gset:Nn \g__thermodynamics_pressure_symbol {p}
    \RenewSubscriptedSymbol{\cVt}{\__thermodynamics_extensive:n {\heatcapacitysymbol}}{v}
    \RenewSubscriptedSymbol{\cV}{\__thermodynamics_intensive:n {\heatcapacitysymbol}}{v}
    \RenewSubscriptedSymbol{\cVs}{\__thermodynamics_specific:n {\heatcapacitysymbol}}{v}
  }
}
\DeclareOption{Thompson}{
  \ExecuteOptions{EUAGHAn,delta,shortpm}
  \AtEndOfPackage
  {
    \RenewDocumentCommand{\excess}{}{{EX}}
    \RenewDocumentCommand{\residual}{}{{R}}
    \RenewDocumentCommand{\actrel}{}{\widehat{a}}
    \RenewSubscriptedSymbol{\Henryrat}{k}{H}
    \RenewSubscriptedSymbol{\Henrymol}{k}{H}
    \RenewDocumentCommand{\allcomponents}{O{j} m}
    {
      {#2}\c_math_subscript_token{#1}
    }
    \RenewDocumentCommand{\allNs}{O{j}}{\allcomponents[#1]{\Nt}}
    \RenewDocumentCommand{\allXs}{O{j}}{\allcomponents[#1]{x}}
    \RenewDocumentCommand{\allYs}{O{j}}{\allcomponents[#1]{y}}
    \RenewDocumentCommand{\allmus}{O{j}}{\allcomponents[#1]{\mu}}
    \RenewDocumentCommand{\allMs}{O{j}}{\allcomponents[#1]{m}}
    \RenewDocumentCommand{\allWs}{O{j}}{\allcomponents[#1]{w}}
    \RenewExpandableDocumentCommand{\ncomponents}{}{c}
    \RenewDocumentCommand{\IS}{}{{IS}}
    \RenewDocumentCommand{\IG}{}{{IG}}
    \RenewDocumentCommand{\IGM}{}{{IG}}
    \cs_new:Nn \__thermodynamics_fpure_one:n
    {
      f\c_math_subscript_token{#1}
      \peek_catcode_remove:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \RenewDocumentCommand{\fpure}{}
    {
      \peek_catcode_remove:NTF \c_math_subscript_token
      { \__thermodynamics_fpure_one:n }
      { f }
    }
    \cs_new:Nn \__thermodynamics_intensive_two:n
    {
      \c_math_subscript_token{#1}
      \peek_catcode:NF \c_math_superscript_token
      {
        \c_math_superscript_token\bullet
      }
    }
    \cs_set:Nn \__thermodynamics_intensive:n
    {
      #1
      \peek_catcode_remove:NT \c_math_subscript_token
      { \__thermodynamics_intensive_two:n }
    }
    \cs_new:Nn \__thermodynamics_phipure_one:n
    {
      \phi\c_math_subscript_token{#1}
      \peek_catcode:NF \c_math_superscript_token
      { \c_math_superscript_token\bullet }
    }
    \RenewDocumentCommand{\phipure}{}
    {
      \peek_catcode_remove:NTF \c_math_subscript_token
      {
        \__thermodynamics_phipure_one:n
      }
      {\phi}
    }
    \RenewDocumentCommand{\phimix}{}{\widehat\phi}
    \RenewDocumentCommand{\fmix}{}{\widehat f}
    \RenewDocumentCommand{\mixing}{}{{MIX}}
    \RenewDocumentCommand{\muJT}{}{\alpha\c_math_subscript_token H}
    \RenewDocumentCommand{\Deltamix}{m}
        {\Delta\c_math_subscript_token\mixing #1}
    \RenewDocumentCommand{\reaction}{}{R}
    \RenewDocumentCommand{\fusion}{}{{SL}}
    \RenewDocumentCommand{\vaporization}{}{{LV}}
    \RenewDocumentCommand{\sublimation}{}{{SV}}
    \RenewDocumentCommand{\allbut}{O{j} m m}
    { \tl_if_eq:nnTF {#1} {#2}
      {
        {#3}\c_math_subscript_token k\neq{#3}\c_math_subscript_token{#2}
      }
      {
        {#3}\c_math_subscript_token{#1}\neq{#3}\c_math_subscript_token{#2}
      }
    }
    \RenewDocumentCommand{\Cstd}{}{m^\std}
    \RenewDocumentCommand{\mustd}{}{\Gamma}
    \RenewDocumentCommand{\formation}{}{F}
  }
}
\ExecuteOptions{EUAGHan,subscripts,parentheses,intensive-plain,
    moles-index,longpm}
\ProcessOptions
\tl_const:Nn \c__thermodynamics_sort_order_tl
    {\Et\Em\Es\Ut\Um\Us\Ht\Hm\Hs\Ft\Fm\Fs\Gt\Gm\Gs\Lt\Lm\Ls T\St\Sm\Ss
        P\Vt\Vm\Vs\mu\Nt mwxyz\At\Am\As\sigma
        ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklnopqrstuvwxyz}
\clist_new:N \l__thermodynamics_in_list_clist
\clist_new:N \l__thermodynamics_sorted_list_clist
\clist_new:N \l__thermodynamics_remaining_list_clist
\cs_new:Nn \__thermodynamics_sort_clist:n
{% Sort the list in the order of \c__thermodynamics_sort_order_tl

  % Wipe out any remnants from the last sort
  \clist_clear:N \l__thermodynamics_in_list_clist
  \clist_clear:N \l__thermodynamics_sorted_list_clist

  % Make a copy of the list
  \clist_set:Nn \l__thermodynamics_remaining_list_clist {#1}

  % Make a list of everything that's in the known sort order list
  % and put everything else in the "not in sort order list" list.
  \tl_map_inline:Nn \c__thermodynamics_sort_order_tl
  {
    \clist_if_in:NnT \l__thermodynamics_remaining_list_clist {##1}
    { \clist_put_right:Nn \l__thermodynamics_in_list_clist {##1} }

    \clist_remove_all:Nn \l__thermodynamics_remaining_list_clist {##1}
  }

  % Then merge the lists back together again.
  \clist_if_empty:NF \l__thermodynamics_in_list_clist
  {
    \clist_put_right:Nn \l__thermodynamics_sorted_list_clist \l__thermodynamics_in_list_clist
  }
  \clist_if_empty:NF \l__thermodynamics_remaining_list_clist
  {
    \clist_put_right:Nn \l__thermodynamics_sorted_list_clist \l__thermodynamics_remaining_list_clist
  }
  \clist_use:Nn \l__thermodynamics_sorted_list_clist ,
}
\dim_new:N \l__thermodynamics_Partial_const_dim
\dim_new:N \l__thermodynamics_operator_width_dim
\dim_new:N \l__thermodynamics_adjust_width_dim
\settowidth{\l__thermodynamics_operator_width_dim}{=}
\dim_set:Nn \l__thermodynamics_adjust_width_dim {0.1\l__thermodynamics_operator_width_dim}
\dim_add:Nn \l__thermodynamics_operator_width_dim \l__thermodynamics_adjust_width_dim
\tl_new:N \l__thermodynamics_Partial_start_tl
\tl_new:N \l__thermodynamics_Partial_end_tl
\tl_new:N \l__thermodynamics_Partial_empty_end_tl
\tl_new:N \l__thermodynamics_Partial_middle_tl
\tl_set:Nn \l__thermodynamics_Partial_start_tl {\left\l__thermodynamics_PartialOpen_tl}
\tl_set:Nn \l__thermodynamics_Partial_end_tl {\right\l__thermodynamics_PartialClose_tl}
\tl_set:Nn \l__thermodynamics_Partial_empty_end_tl {\right\l__thermodynamics_PartialEmptyClose_tl}
\tl_set:Nn \l__thermodynamics_Partial_middle_tl {\middle}
\cs_set_eq:NN \__thermodynamics_frac:nn \frac
\NewDocumentCommand{\Partial}{s m m m}
{ \bool_if:nTF {#1}
  {% Starred form (recursive)
    \settowidth{\l__thermodynamics_Partial_const_dim}{\ensuremath{#4}}%
    \dim_add:Nn \l__thermodynamics_Partial_const_dim {-0.20\l__thermodynamics_Partial_const_dim}%
    \Partial{#2}{#3}{#4}%
    \bool_if:NT \l__thermodynamics_subscripted_bool
    { \dim_compare:nNnTF \l__thermodynamics_operator_width_dim
                       < \l__thermodynamics_Partial_const_dim
      { \kern -\l__thermodynamics_operator_width_dim }
      { \kern -\l__thermodynamics_Partial_const_dim }
    }
  }
  {% Unstarred form
    \bool_if:NTF \l__thermodynamics_subscripted_bool
    {% Handle case of empty variables held constant
      \tl_if_eq:nnTF {#4} {}
      { \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial #2}{\partial #3}\l__thermodynamics_Partial_empty_end_tl
      }
      { \l__thermodynamics_Partial_start_tl\__thermodynamics_frac:nn{\partial #2}
                                         {\partial #3}\l__thermodynamics_Partial_end_tl
        \c_math_subscript_token{#4}%
      }
    }
    {% Check whether #4 contains \allNsbut{i} and #3 is \Nt_i
      \tl_if_in:nnTF {#3} {\Nt}
      { \RenewDocumentCommand{\allbut}{O{j} m m}{\allcomponents{##3}}
        \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial #2(\__thermodynamics_sort_clist:n{#4})}
                   {\partial #3}\l__thermodynamics_Partial_end_tl
      }
      { \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial #2(\__thermodynamics_sort_clist:n{#3,#4})}
                   {\partial #3}\l__thermodynamics_Partial_end_tl
      }
    }
  }
}
\NewDocumentCommand{\PartialBigg}{}
  { \tl_set:Nn \l__thermodynamics_Partial_start_tl {\Biggl\l__thermodynamics_PartialOpen_tl}
    \tl_set:Nn \l__thermodynamics_Partial_end_tl {\Biggr\l__thermodynamics_PartialClose_tl}
    \tl_set:Nn \l__thermodynamics_Partial_Empty_end_tl
        {\Biggr\l__thermodynamics_PartialEmptyClose_tl}
    \Partial
  }
\NewDocumentCommand{\Partialbigg}{}
  { \tl_set:Nn \l__thermodynamics_Partial_start_tl {\biggl\l__thermodynamics_PartialOpen_tl}
    \tl_set:Nn \l__thermodynamics_Partial_end_tl {\biggr\l__thermodynamics_PartialClose_tl}
    \tl_set:Nn \l__thermodynamics_Partial_empty_end_tl
        {\biggr\l__thermodynamics_PartialEmptyClose_tl}
    \Partial
  }
\NewDocumentCommand{\PartialSecond}{s m m m}
{
  \bool_if:nTF {#1}
  {% Starred form
    \settowidth{\l__thermodynamics_Partial_const_dim}{\ensuremath{#4}}%
    \dim_add:Nn \l__thermodynamics_Partial_const_dim {-0.20\l__thermodynamics_Partial_const_dim}
    \PartialSecond{#2}{#3}{#4}%
    \bool_if:nT \l__thermodynamics_subscripted_bool
    {  \dim_compare:nNnTF {\l__thermodynamics_operator_width_dim}
                        < {\l__thermodynamics_Partial_const_dim}
      { \kern -\l__thermodynamics_operator_width_dim }
      { \kern -\l__thermodynamics_Partial_const_dim }
    }
  }
  {% Unstarred form
    \bool_if:NTF \l__thermodynamics_subscripted_bool
    {% Handles case of empty variables held constant
      \tl_if_eq:nnTF {#4} {}
      { \l__thermodynamics_Partial_start_tl
            \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2 #2}
        {\partial #3\c_math_superscript_token 2}\l__thermodynamics_Partial_empty_end_tl
      }
      { \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2 #2}
            {\partial #3\c_math_superscript_token 2}\l__thermodynamics_Partial_end_tl
            \c_math_subscript_token{#4}%
      }
    }
    {% Check whether #4 contains \allNsbut{i} and #3 is \Nt_i
      \tl_if_in:nnTF {#2} {\Nt}
      { \RenewDocumentCommand{\allbut}{O{j} m m}{\allcomponents{##3}}
        \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2 #2(#4)}
            {\partial\c_math_superscript_token 2 #3}\l__thermodynamics_Partial_end_tl
      }
      { \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2
                      #2(\__thermodynamics_sort_clist:n{#3,#4})}
            {\partial #3\c_math_superscript_token 2}\l__thermodynamics_Partial_end_tl
      }
    }
  }
}
\NewDocumentCommand{\PartialSecondBigg}{}
{ \tl_set:Nn \l__thermodynamics_Partial_start_tl {\biggl\l__thermodynamics_PartialOpen_tl}
  \tl_set:Nn \l__thermodynamics_Partial_end_tl {\biggl\l__thermodynamics_PartialClose_tl}
  \tl_set:Nn \l__thermodynamics_Partial_empty_end_tl {\biggl\l__thermodynamics_PartialClose_tl}
  \PartialSecond
}
\NewDocumentCommand{\PartialSecondbigg}{}
{ \tl_set:Nn \l__thermodynamics_Partial_start_tl {\biggl\l__thermodynamics_PartialOpen_tl}
  \tl_set:Nn \l__thermodynamics_Partial_end_tl {\biggl\l__thermodynamics_PartialClose_tl}
  \tl_set:Nn \l__thermodynamics_Partial_empty_end_tl {\biggl\l__thermodynamics_PartialClose_tl}
  \PartialSecond
}
\bool_new:N \l__thermodynamics_has_x_or_y_bool
\NewDocumentCommand{\PartialMixSecond}{s m m m m}
{
  \bool_if:nTF {#1}
  {% Starred version
    \settowidth{\l__thermodynamics_Partial_const_dim}{\ensuremath{#4}}%
    \dim_add:Nn \l__thermodynamics_Partial_const_dim {-0.20\l__thermodynamics_Partial_const_dim}
    \PartialMixSecond{#2}{#3}{#4}{#5}
    \bool_if:nT \l__thermodynamics_subscripted_bool
    { \dim_compare:nNnTF {\l__thermodynamics_operator_width_dim}
                       < {\l__thermodynamics_Partial_const_dim}
      { \kern -\l__thermodynamics_operator_width_dim }
      { \kern -\l__thermodynamics_Partial_const_dim }
    }
  }
  {% Unstarred version
    \bool_if:nTF \l__thermodynamics_subscripted_bool
    {% subscripted version
      \tl_if_eq:nnTF {#5} {}
      {% Handle case of empty variables held constant
        \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2 #2}
            {\partial #3\partial #4}\l__thermodynamics_Partial_empty_end_tl
      }
      { \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2 #2}
            {\partial #3\partial #4}\l__thermodynamics_Partial_end_tl
            \c_math_subscript_token{#5}
      }
    }
    {% not subscripted
      \tl_if_eq:nnTF {#5} {}
      {% empty argument
        \l__thermodynamics_Partial_start_tl
        \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2
                        #2(\__thermodynamics_sort_clist:n{#3,#4,#5})}
                   {\partial #3\partial #4}\l__thermodynamics_Partial_empty_end_tl
      }
      {% Check whether #3 OR #4 are \Nt_i/etc.
        \tl_if_in:nnTF {#3} {\Nt}
        { \RenewDocumentCommand{\allbut}{O{j} m m}{\allcomponents{##3}}%
          \l__thermodynamics_Partial_start_tl
          \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2
                        #2(\__thermodynamics_sort_clist:n{#4,#5})}
                     {\partial #3\partial #4}\l__thermodynamics_Partial_end_tl
        }
        { \tl_if_in:nnTF {#4} {\Nt}
          { \RenewDocumentCommand{\allbut}{O{j} m m}{\allcomponents{##3}}%
            \l__thermodynamics_Partial_start_tl
            \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2
                            #2(\__thermodynamics_sort_clist:n{#3,#5})}
                       {\partial #3\partial #4}\l__thermodynamics_Partial_end_tl
          }
          {% Check for x, y, or w
            \bool_set_false:N \l__thermodynamics_has_x_or_y_bool
            \tl_if_in:nnT {#3} {x}
            { \l__thermodynamics_has_x_or_y_bool }
            \tl_if_in:nnT {#3} {y}
            { \l__thermodynamics_has_x_or_y_bool }
            \tl_if_in:nnT {#3} {w}
            { \l__thermodynamics_has_x_or_y_bool }
            \bool_if:NTF \l__thermodynamics_has_x_or_y_bool
            { \RenewDocumentCommand{\allbutlastand}{O{j} m m}
                {\allcomponents{##3}}
              \l__thermodynamics_Partial_start_tl
              \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2
                            #2(\__thermodynamics_sort_clist:n{#4,#5})}
                         {\partial #3\partial #4}\l__thermodynamics_Partial_end_tl
            }
            {
              \l__thermodynamics_Partial_start_tl
              \__thermodynamics_frac:nn{\partial\c_math_superscript_token 2
                            #2(\__thermodynamics_sort_clist:n{#3,#4,#5})}
                         {\partial #3\partial #4}\l__thermodynamics_Partial_end_tl
            }
          }
        }
      }
    }
  }
}
\NewDocumentCommand{\PartialMixSecondBigg}{}
{ \tl_set:Nn \l__thermodynamics_Partial_start_tl {\Biggl\l__thermodynamics_PartialOpen_tl}
  \tl_set:Nn \l__thermodynamics_Partial_end_tl {\Biggl\l__thermodynamics_PartialClose_tl}
  \tl_set:Nn \l__thermodynamics_Partial_empty_end_tl {\Biggl\l__thermodynamics_PartialClose_tl}
  \PartialMixSecond
}
\NewDocumentCommand{\PartialMixSecondbigg}{}
{ \tl_set:Nn \l__thermodynamics_Partial_start_tl {\biggl\l__thermodynamics_PartialOpen_tl}
  \tl_set:Nn \l__thermodynamics_Partial_end_tl {\biggl\l__thermodynamics_PartialClose_tl}
  \tl_set:Nn \l__thermodynamics_Partial_empty_end_tl {\biggl\l__thermodynamics_PartialClose_tl}
  \PartialMixSecond
}
\AtBeginDocument{%
  \@ifpackageloaded{amsmath}{}{%
      \PackageWarningNoLine{thermodynamics}
        {Package~amsmath~not~loaded;~load~to~make~PartialBigg~and~friends~
            work~correctly}%
      \cs_set_eq:NN \PartialBigg \Partial
      \cs_set_eq:NN \Partialbigg \Partial
      \cs_set_eq:NN \PartialSecondBigg \PartialSecond
      \cs_set_eq:NN \PartialSecondbigg \PartialSecond
      \cs_set_eq:NN \PartialMixSecondBigg \PartialMixSecond
      \cs_set_eq:NN \PartialMixSecondbigg \PartialMixSecond
      \ProvideDocumentCommand{\rvert}{}{|}
      \ProvideDocumentCommand{\lvert}{}{|}
  }%
}
\NewDocumentCommand{\Partialinline}{}
{
  \cs_set:Nn \__thermodynamics_frac:nn { ##1 \l__thermodynamics_Partial_middle_tl / ##2 }
  \Partial
}
\NewDocumentCommand{\PartialSecondinline}{}
{
  \cs_set:Nn \__thermodynamics_frac:nn { ##1 \l__thermodynamics_Partial_middle_tl / ##2 }
  \PartialSecond
}
\NewDocumentCommand{\PartialMixSecondinline}{}
{
  \cs_set:Nn \__thermodynamics_frac:nn { ##1 \l__thermodynamics_Partial_middle_tl / ##2 }
  \PartialMixSecond
}
\NewDocumentCommand{\Partialinlinetext}{}
{ \cs_set_eq:NN \l__thermodynamics_Partial_start_tl \l__thermodynamics_PartialOpen_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_end_tl \l__thermodynamics_PartialClose_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_empty_end_tl \l__thermodynamics_PartialEmptyClose_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_middle_tl \relax
  \Partialinline
}
\NewDocumentCommand{\PartialSecondinlinetext}{}
{ \cs_set_eq:NN \l__thermodynamics_Partial_start_tl \l__thermodynamics_PartialOpen_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_end_tl \l__thermodynamics_PartialClose_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_empty_end_tl \l__thermodynamics_PartialEmptyClose_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_middle_tl \relax
  \PartialSecondinline
}
\NewDocumentCommand{\PartialMixSecondinlinetext}{}
{ \cs_set_eq:NN \l__thermodynamics_Partial_start_tl \l__thermodynamics_PartialOpen_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_end_tl \l__thermodynamics_PartialClose_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_empty_end_tl \l__thermodynamics_PartialEmptyClose_tl
  \cs_set_eq:NN \l__thermodynamics_Partial_middle_tl \relax
  \PartialMixSecondinline
}
\NewDocumentEnvironment{thermoparentheses}{}
{ \cs_set:Nn \l__thermodynamics_PartialOpen_tl {(}
  \cs_set:Nn \l__thermodynamics_PartialClose_tl {)}
  \cs_set:Nn \l__thermodynamics_PartialEmptyClose_tl {)}
}{}
\NewDocumentEnvironment{thermobrackets}{}
{ \tl_set:Nn \l__thermodynamics_PartialOpen_tl {[}
  \tl_set:Nn \l__thermodynamics_PartialClose_tl {]}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {]}
}{}
\NewDocumentEnvironment{thermobraces}{}
{ \tl_set:Nn \l__thermodynamics_PartialOpen_tl {\{}
  \tl_set:Nn \l__thermodynamics_PartialClose_tl {\}}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {\}}
}{}
\NewDocumentEnvironment{thermobar}{}
{ \tl_set:Nn \l__thermodynamics_PartialOpen_tl {.}
  \tl_set:Nn \l__thermodynamics_PartialClose_tl {\rvert}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {.}
}{}
\NewDocumentEnvironment{thermoplain}{}
{ \tl_set:Nn \l__thermodynamics_PartialOpen_tl {.}
  \tl_set:Nn \l__thermodynamics_PartialClose_tl {.}
  \tl_set:Nn \l__thermodynamics_PartialEmptyClose_tl {.}
  \bool_set_false:N \l__thermodynamics_subscripted_bool
}{}
\NewDocumentEnvironment{thermoNOsubscripts}{}
    {\bool_set_false:N \l__thermodynamics_subscripted_bool}
    {}
\NewDocumentEnvironment{thermosubscripts}{}
    {\bool_set_true:N \l__thermodynamics_subscripted_bool}
    {}
\NewDocumentEnvironment{thermomolesrange}{}
    { \__thermodynamics_set_moles_range }
    {}
\NewDocumentEnvironment{thermointensiveplain}{}
    { \__thermodynamics_set_intensive_plain }
    {}
\NewDocumentEnvironment{thermoextensiveplain}{}
    { \__thermodynamics_set_extensive_plain }
    {}
\NewDocumentEnvironment{thermointensivelowercase}{}
    {% {

      \__thermodynamics_set_intensive_lowercase
      \__thermodynamics_set_lowercase_pms
    }
    {}
\NewDocumentEnvironment{thermoextensivesuperscript}{}
    {
      \__thermodynamics_set_extensive_superscripts
    }
    {}
\str_new:N \l__thermodynamics_tmp_str
\cs_new:Npn \__thermodynamics_check_definable:nN #1#2
{
  \tl_trim_spaces_apply:nN {#1} \tl_if_single_token:nTF
  {
    \str_set:Nx \l__thermodynamics_tmp_str {\tl_to_str:n {#1}}
    \int_compare:nNnT {\str_count:N \l__thermodynamics_tmp_str} = 1
    { \PackageError{thermodynamics}
        {First~argument~of~'\tl_trim_spaces:o {\tl_to_str:n {#2}}'~
         must~be~a~command}
        {The~first~argument~of~'\tl_trim_spaces:o {\tl_to_str:n {#2}}'~
         should~be~the~macro~that~will~be~used~to~refer~to~the~symbol.~
         The~provided~argument~'\tl_trim_spaces:o {\tl_to_str:n {#1}}'~
         is~a~single~character.
         \MessageBreak Perhaps~a~backslash~is~missing?}
    }
  }
  { \PackageError{thermodynamics}
      {First~argument~of~'\tl_trim_spaces:o {\tl_to_str:n {#2}}'~
       must~be~a~command}
      {The~first~argument~of~'\tl_trim_spaces:o {\tl_to_str:n {#2}}'~
       should~be~the~macro~that~will~be~used~to~refer~to~the~symbol.~
       The~provided~argument~'\tl_trim_spaces:o {\tl_to_str:n {#1}}'~
       contains~more~than~one~token.
       \MessageBreak Perhaps~a~backslash~is~missing?}
  }
}
\tl_new:N \l__thermodynamics_super_separator_tl
\tl_new:N \l__thermodynamics_sub_separator_tl
\tl_set:Nn \l__thermodynamics_super_separator_tl {,}
\tl_set:Nn \l__thermodynamics_sub_separator_tl {,}
\NewDocumentCommand{\NewSubscriptedSymbol}{m m m}
{
  \__thermodynamics_check_definable:nN {#1} \NewSubscriptedSymbol
  \cs_if_exist:NT #1
  { \PackageError{thermodynamics}
      {Command~'\tl_trim_spaces:o {\tl_to_str:n {#1}}'~already~defined}
      {You~have~used~
       '\tl_trim_spaces:o {\tl_to_str:n {\NewSubscriptedSymbol}}'~
       with~a~command~that~already~has~a~definition}
  }
  \cs_new:cpn {\cs_to_str:N #1_one:n} ##1
  {
    {#2}\c_math_superscript_token{##1}
    \peek_catcode_remove:NTF \c_math_subscript_token
    { \use:c {\cs_to_str:N #1_three:n} }
    { \c_math_subscript_token{#3} }
  }

  \cs_new:cpn {\cs_to_str:N #1_two:n} ##1
  { {#2}\c_math_subscript_token{#3\l__thermodynamics_sub_separator_tl ##1} }

  \cs_new:cpn {\cs_to_str:N #1_three:n} ##1
  { \c_math_subscript_token{#3\l__thermodynamics_sub_separator_tl ##1} }

  \NewDocumentCommand{#1}{}
  {% @branch
    \peek_catcode_remove:NTF \c_math_superscript_token
    { \use:c {\cs_to_str:N #1_one:n} }
    { \peek_catcode_remove:NTF \c_math_subscript_token
      { \use:c {\cs_to_str:N #1_two:n} }
      { {#2}\c_math_subscript_token{#3} }
    }
  }
}
\NewDocumentCommand{\RenewSubscriptedSymbol}{m m m}
{
  \__thermodynamics_check_definable:nN {#1} \RenewSubscriptedSymbol
  \cs_if_exist:NF #1
  { \PackageError{thermodynamics}
      {Command~'\tl_trim_spaces:o {\tl_to_str:n {#1}}'~not~defined}
      {You~have~used~
       '\tl_trim_spaces:o {\tl_to_str:n {\RenewSubscriptedSymbol}}'~
       with~a~command~that~does~not~have~a~definition}
  }
  \cs_set:cpn {\cs_to_str:N #1_one:n} ##1
  {
    {#2}\c_math_superscript_token{##1}
    \peek_catcode_remove:NTF \c_math_subscript_token
    { \use:c {\cs_to_str:N #1_three:n} }
    { \c_math_subscript_token{#3} }
  }

  \cs_set:cpn {\cs_to_str:N #1_two:n} ##1
  { {#2}\c_math_subscript_token{#3\l__thermodynamics_sub_separator_tl ##1} }

  \cs_set:cpn {\cs_to_str:N #1_three:n} ##1
  { \c_math_subscript_token{#3\l__thermodynamics_sub_separator_tl ##1} }

  \RenewDocumentCommand{#1}{}
  {% @branch
    \peek_catcode_remove:NTF \c_math_superscript_token
    { \use:c {\cs_to_str:N #1_one:n} }
    { \peek_catcode_remove:NTF \c_math_subscript_token
      { \use:c {\cs_to_str:N #1_two:n} }
      { {#2}\c_math_subscript_token{#3} }
    }
  }
}
\NewDocumentCommand{\NewSuperscriptedSymbol}{m m m}
{
  \__thermodynamics_check_definable:nN {#1} \NewSuperscriptedSymbol
  \cs_if_exist:NT #1
  { \PackageError{thermodynamics}
      {Command~'\tl_trim_spaces:o {\tl_to_str:n {#1}}'~already~defined}
      {You~have~used~
       '\tl_trim_spaces:o {\tl_to_str:n {\NewSuperscriptedSymbol}}'~
       with~a~command~that~already~has~a~definition}
  }
  \cs_new:cpn {\cs_to_str:N #1_one:n} ##1
  {
    {#2}\c_math_subscript_token{##1}
    \peek_catcode_remove:NTF \c_math_superscript_token
    { \use:c {\cs_to_str:N #1_three:n} }
    { \c_math_superscript_token{#3} }
  }

  \cs_new:cpn {\cs_to_str:N #1_two:n} ##1
  { {#2}\c_math_superscript_token{#3\l__thermodynamics_super_separator_tl ##1} }

  \cs_new:cpn {\cs_to_str:N #1_three:n} ##1
  { {#2}\c_math_superscript_token{#3\l__thermodynamics_super_separator_tl ##1} }

  \NewDocumentCommand{#1}{}
  {
    \peek_catcode_remove:NTF \c_math_subscript_token
    { \use:c {\cs_to_str:N #1_one:n} }
    { \peek_catcode_remove:NTF \c_math_superscript_token
      { \use:c {\cs_to_str:N #1_two:n} }
      { {#2}\c_math_superscript_token{#3} }
    }
  }
}
\NewDocumentCommand{\RenewSuperscriptedSymbol}{m m m}
{
  \__thermodynamics_check_definable:nN {#1} \RenewSuperscriptedSymbol
  \cs_if_exist:NF #1
  { \PackageError{thermodynamics}
      {Command~'\tl_trim_spaces:o {\tl_to_str:n {#1}}'~not~defined}
      {You~have~used~
       '\tl_trim_spaces:o {\tl_to_str:n {\RenewSuperscriptedSymbol}}'~
       with~a~command~that~does~not~have~a~definition}
  }
  \cs_set:cpn {\cs_to_str:N #1_one:n} ##1
  {
    {#2}\c_math_subscript_token{##1}
    \peek_catcode_remove:NTF \c_math_superscript_token
    { \use:c {\cs_to_str:N #1_three:n} }
    { \c_math_superscript_token{#3} }
  }

  \cs_set:cpn {\cs_to_str:N #1_two:n} ##1
  { {#2}\c_math_superscript_token{#3\l__thermodynamics_super_separator_tl ##1} }

  \cs_set:cpn {\cs_to_str:N #1_three:n} ##1
  { \c_math_superscript_token{#3\l__thermodynamics_super_separator_tl ##1} }

  \RenewDocumentCommand{#1}{}
  {% @branch
    \peek_catcode_remove:NTF \c_math_subscript_token
    { \use:c {\cs_to_str:N #1_one:n} }
    { \peek_catcode_remove:NTF \c_math_superscript_token
      { \use:c {\cs_to_str:N #1_two:n} }
      { {#2}\c_math_superscript_token{#3} }
    }
  }
}
\cs_new:Nn \__thermodynamics_subscripted_and_superscripted_core:nnnn
{
  \cs_set:cpn {\cs_to_str:N #1_one:n} ##1
  {
    {#2}\c_math_superscript_token{##1}
    \peek_catcode_remove:NTF \c_math_subscript_token
    { \use:c {\cs_to_str:N #1_three:n} }
    { \c_math_subscript_token{#3} }
  }
  \cs_set:cpn {\cs_to_str:N #1_two:n} ##1
  {
    {#2}\c_math_subscript_token{#3 ##1}
    \peek_catcode_remove:NTF \c_math_superscript_token
    { \use:c {\cs_to_str:N #1_four:n} }
    { \c_math_superscript_token{#4 \bullet} }
  }
  \cs_set:cpn {\cs_to_str:N #1_three:n} ##1
  { \c_math_subscript_token{#3 ##1} }
  \cs_set:cpn {\cs_to_str:N #1_four:n} ##1
  { \c_math_superscript_token{#4 ##1} }
}
\NewDocumentCommand{\NewSubscriptedandSuperscriptedSymbol}{m m m m}
{
  \__thermodynamics_check_definable:nN {#1} \NewSubscriptedandSuperscriptedSymbol
  \cs_if_exist:NT #1
  { \PackageError{thermodynamics}
      {Command~'\tl_trim_spaces:o {\tl_to_str:n {#1}}'~already~defined}
      {You~have~used~
       '\tl_trim_spaces:o
          {\tl_to_str:n {\NewSubscriptedandSuperScriptedSymbol}}'~
           with~a~command~that~already~has~a~definition}
  }
  \__thermodynamics_subscripted_and_superscripted_core:nnnn {#1} {#2} {#3} {#4}
  \NewDocumentCommand{#1}{}
  {
    \peek_catcode_remove:NTF \c_math_superscript_token
    { \use:c {\cs_to_str:N #1_one:n} }
    { \peek_catcode_remove:NTF \c_math_subscript_token
      { \use:c {\cs_to_str:N #1_two:n} }
      { {#2}\c_math_subscript_token{#3}\c_math_superscript_token{#4} }
    }
  }
}
\NewDocumentCommand{\RenewSubscriptedandSuperscriptedSymbol}{m m m m}
{
  \__thermodynamics_check_definable:nN {#1} \RenewSubscriptedandSuperscriptedSymbol
}
\NewExpandableDocumentCommand{\heatcapacitysymbol}{}{C}
\NewExpandableDocumentCommand{\compressibilitysymbol}{}{\kappa}
\NewExpandableDocumentCommand{\expansivitysymbol}{}{\alpha}
\NewExpandableDocumentCommand{\JTsymbol}{}{\mu}
\NewSubscriptedSymbol{\cV}{\__thermodynamics_intensive:n \heatcapacitysymbol}
    {\g__thermodynamics_volume_symbol}
\NewSubscriptedSymbol{\cP}{\__thermodynamics_intensive:n \heatcapacitysymbol}
    {\g__thermodynamics_pressure_symbol}
\NewSubscriptedSymbol{\cVt}{\__thermodynamics_extensive:n \heatcapacitysymbol}
    {\g__thermodynamics_volume_symbol}
\NewSubscriptedSymbol{\cPt}{\__thermodynamics_extensive:n \heatcapacitysymbol}
    {\g__thermodynamics_pressure_symbol}
\NewSubscriptedSymbol{\cVs}{\__thermodynamics_specific:n \heatcapacitysymbol}
    {\g__thermodynamics_volume_symbol}
\NewSubscriptedSymbol{\cPs}{\__thermodynamics_specific:n \heatcapacitysymbol}
    {\g__thermodynamics_pressure_symbol}
\NewSubscriptedSymbol{\kappaT}{\compressibilitysymbol}
    {\g__thermodynamics_temperature_symbol}
\NewSubscriptedSymbol{\kappaS}{\compressibilitysymbol}
    {\g__thermodynamics_entropy_symbol}
\NewSubscriptedSymbol{\alphaP}{\expansivitysymbol}{\g__thermodynamics_pressure_symbol}
\NewSubscriptedSymbol{\alphaS}{\expansivitysymbol}{\g__thermodynamics_entropy_symbol}
\NewSubscriptedSymbol{\muJT}{\JTsymbol}{\text{JT}}
\NewDocumentCommand{\sat}{}{{\text{sat}}}
\NewDocumentCommand{\Psat}{}{P\c_math_superscript_token\sat}
\NewDocumentCommand{\Pvap}{}{\Psat}
\NewDocumentCommand{\phisat}{}{\phi\c_math_superscript_token\sat}
\NewDocumentCommand{\fsat}{}{\fpure\c_math_superscript_token\sat}
\NewDocumentCommand{\std}{}{\circ}
\NewDocumentCommand{\Pstd}{}{P\c_math_superscript_token \std}
\NewDocumentCommand{\Cstd}{}{C\c_math_superscript_token \std}
\NewDocumentCommand{\fstd}{}{f\c_math_superscript_token \std}
\NewDocumentCommand{\mustd}{}{\mu\c_math_superscript_token \std}
\NewDocumentCommand{\xrxn}{}{\xi}
\NewDocumentCommand{\fmix}{}{\hat{f}}
\NewDocumentCommand{\phimix}{}{\hat\phi}
\NewDocumentCommand{\fpure}{}{f}
\NewDocumentCommand{\phipure}{}{\phi}
\NewExpandableDocumentCommand{\actabs}{}{\lambda}
\NewExpandableDocumentCommand{\actrel}{}{a}
\NewDocumentCommand{\mixing}{}{{\text{mix}}}
\NewDocumentCommand{\Deltamix}{m}
    {\Delta{#1}\c_math_subscript_token\mixing}
\NewDocumentCommand{\formation}{}{f}
\NewDocumentCommand{\fusion}{}{{\text{fus}}}
\NewDocumentCommand{\reaction}{}{{\text{rxn}}}
\NewDocumentCommand{\sublimation}{}{{\text{sub}}}
\NewDocumentCommand{\vaporization}{}{{\text{vap}}}
\NewDocumentCommand{\Deltafus}{m}
    {\Delta #1\c_math_superscript_token\fusion}
\NewDocumentCommand{\Deltasub}{m}
    {\Delta #1\c_math_superscript_token\sublimation}
\NewDocumentCommand{\Deltavap}{m}
    {\Delta #1\c_math_superscript_token\vaporization}
\NewDocumentCommand{\Deltarxn}{m}
{
  \cs_set:Npn \__thermodynamics_Deltarxn_one ##1
  {
      \Delta #1\c_math_subscript_token{\reaction,##1}
  }
  \peek_catcode_remove:NTF \c_math_subscript_token
  {
    \__thermodynamics_Deltarxn_one
  }
  {
    \Delta #1\c_math_subscript_token{\reaction}
  }
}
\tl_new:N \l__thermodynamics_Deltaf_sym_tl
\NewSubscriptedSymbol{\__thermodynamics_Deltaf}{\l__thermodynamics_Deltaf_sym_tl}{\formation}
\NewDocumentCommand{\Deltaf}{m}
{ \tl_set:Nn \l__thermodynamics_Deltaf_sym_tl {\Delta #1}
  \__thermodynamics_Deltaf
}
\tl_new:N \l__thermodynamics_pm_symbol_tl
\tl_new:N \l__thermodynamics_pm_arg_tl
\NewDocumentCommand{\partialmolar}{m}
{
  \tl_set:Nn \l__thermodynamics_pm_symbol_tl {#1}
  \__thermodynamics_generic_pm:
}
%% cases to consider:
%% (1) \Mpm{i}
%% (2) \Mpm[S]{i}
%% (3) \Mpm^S_i
%% (4) \Mpm_i^S
%% (5) \Mpm_i
%% note that \Mpm^S with no subscript makes no sense and is thus forbidden
\cs_new:Nn \__thermodynamics_generic_pm:
{
  \peek_catcode_remove:NTF \c_math_subscript_token
  {% case 4 or case 5
    \__thermodynamics_pm_case_four_or_five
  }
  {% look for superscript token
    \peek_catcode_remove:NTF \c_math_superscript_token
    {% case 3: \Mpm^{#1}_{#2} or \Mpm^{#1}{#2}
      \__thermodynamics_pm_case_three
    }
    {% Look for optional argument [...]
      \peek_charcode:NTF [
      {% case 2: \Mpm[S]{i}
        \__thermodynamics_pm_case_two
      }
      {% case 1: \Mpm{i}
        \__thermodynamics_pm_case_one
      }
    }
  }
}
\cs_new:Npn \__thermodynamics_pm_case_one #1
{
  \bool_if:NTF \l__thermodynamics_longpm_bool
  { \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl\c_math_subscript_token{#1}} }
  {
    \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl}\c_math_subscript_token{#1}
  }
}
\cs_new:Npn \__thermodynamics_pm_case_two [#1]#2
{
  \bool_if:NTF \l__thermodynamics_longpm_bool
  {  \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl
       \c_math_superscript_token{#1}\c_math_subscript_token{#2}}
  }
  {  \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl}
       \c_math_superscript_token{#1}\c_math_subscript_token{#2}
  }
}
\cs_new:Npn \__thermodynamics_pm_case_three #1
{
  \tl_set:Nn \l__thermodynamics_pm_arg_tl {#1}
  \peek_catcode_remove:NTF \c_math_subscript_token
  { \__thermodynamics_pm_case_three_part_two }
  { \__thermodynamics_pm_case_three_part_two }
}
\cs_new:Npn \__thermodynamics_pm_case_three_part_two #1
{
  \bool_if:NTF \l__thermodynamics_longpm_bool
  { \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl
      \c_math_superscript_token{\l__thermodynamics_pm_arg_tl}
      \c_math_subscript_token{#1}}
  }
  { \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl}
      \c_math_superscript_token{\l__thermodynamics_pm_arg_tl}
      \c_math_subscript_token{#1}
  }
}
\cs_new:Npn \__thermodynamics_pm_case_four_or_five #1
{
  \tl_set:Nn \l__thermodynamics_pm_arg_tl {#1}
  \peek_catcode_remove:NTF \c_math_superscript_token
  { \__thermodynamics_pm_case_four }
  { \__thermodynamics_pm_case_five }
}
\cs_new:Npn \__thermodynamics_pm_case_four #1
{
  \bool_if:NTF \l__thermodynamics_longpm_bool
  { \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl\c_math_superscript_token{#1}
      \c_math_subscript_token{\l__thermodynamics_pm_arg_tl}}
  }
  { \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl}\c_math_superscript_token{#1}
      \c_math_subscript_token{\l__thermodynamics_pm_arg_tl}
  }
}
\cs_new:Npn \__thermodynamics_pm_case_five
{
  \bool_if:NTF \l__thermodynamics_longpm_bool
  { \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl
      \c_math_subscript_token{\l__thermodynamics_pm_arg_tl}}
  }
  { \__thermodynamics_overline:n {\l__thermodynamics_pm_symbol_tl}
      \c_math_subscript_token{\l__thermodynamics_pm_arg_tl}
  }
}
\NewDocumentCommand{\NewThermodynamicProperty}{m m}
{
  \NewExtensiveProperty{#1}{#2}
  \NewPartialMolarProperty{#1}{#2}
  \NewResidualProperty{#1}{#2}
  \NewExcessProperty{#1}{#2}
}
\ProvideDocumentCommand{\NewExtensiveProperty}{m m}
{
  % Extensive property
  \exp_after:wN \NewDocumentCommand \exp_after:wN
    {\cs:w #1t\cs_end:}{}{\__thermodynamics_extensive:n {#2}}
  % Molar property
  \exp_after:wN \NewDocumentCommand \exp_after:wN
    {\cs:w #1m\cs_end:}{}{\__thermodynamics_intensive:n {#2}}
  % Specific property
  \exp_after:wN \NewDocumentCommand \exp_after:wN
    {\cs:w #1s\cs_end:}{}{\__thermodynamics_specific:n {#2}}
}
\NewDocumentCommand{\NewPartialMolarProperty}{m m}
{
  % Partial molar property
  \exp_after:wN \NewDocumentCommand \exp_after:wN
    {\cs:w #1pm\cs_end:}{}{\partialmolar{#2}}
}
\ProvideDocumentCommand{\NewExcessProperty}{m m}
{
  \exp_after:wN \NewSuperscriptedSymbol \exp_after:wN
    {\cs:w #1 Et\cs_end:}{\__thermodynamics_extensive:n{#2}}{\excess}
  \exp_after:wN \NewSuperscriptedSymbol \exp_after:wN
    {\cs:w #1 E\cs_end:}{\__thermodynamics_intensive:n{#2}}{\excess}
  \exp_after:wN \NewSuperscriptedSymbol \exp_after:wN
    {\cs:w #1 Es\cs_end:}{\__thermodynamics_specific:n{#2}}{\excess}

  % Excess partial molar property
  \exp_after:wN \NewDocumentCommand \exp_after:wN
    {\cs:w #1Epm\cs_end:}{}{\partialmolar{#2}
       \c_math_superscript_token\excess}
}
\ProvideDocumentCommand{\NewResidualProperty}{m m}
{
  \exp_after:wN \NewSuperscriptedSymbol \exp_after:wN
    {\cs:w #1 Rt\cs_end:}{\__thermodynamics_extensive:n{#2}}{\residual}
  \exp_after:wN \NewSuperscriptedSymbol \exp_after:wN
    {\cs:w #1 R\cs_end:}{\__thermodynamics_intensive:n{#2}}{\residual}
  \exp_after:wN \NewSuperscriptedSymbol \exp_after:wN
    {\cs:w #1 Rs\cs_end:}{\__thermodynamics_specific:n{#2}}{\residual}

  % Residual partial molar property
  \exp_after:wN \NewDocumentCommand \exp_after:wN
    {\cs:w #1Rpm\cs_end:}{}{\partialmolar{#2}
        \c_math_superscript_token\residual}
}
\NewDocumentCommand{\Nt}{}{\g__thermodynamics_mole_symbol}
\NewThermodynamicProperty{E}{\g__thermodynamics_total_energy_symbol}
\NewThermodynamicProperty{U}{\g__thermodynamics_internal_energy_symbol}
\NewThermodynamicProperty{F}{\g__thermodynamics_Helmholtz_symbol}
\NewThermodynamicProperty{G}{\g__thermodynamics_Gibbs_symbol}
\NewThermodynamicProperty{H}{\g__thermodynamics_enthalpy_symbol}
\NewThermodynamicProperty{L}{\g__thermodynamics_Landau_symbol}
\NewThermodynamicProperty{V}{\g__thermodynamics_volume_symbol}
\NewThermodynamicProperty{S}{\g__thermodynamics_entropy_symbol}
\NewExtensiveProperty{A}{\g__thermodynamics_area_symbol}
\NewPartialMolarProperty{A}{\g__thermodynamics_area_symbol}
\NewExtensiveProperty{Q}{\g__thermodynamics_heat_symbol}
\NewExtensiveProperty{W}{\g__thermodynamics_work_symbol}
\NewPartialMolarProperty{cP}{\cP}
\NewPartialMolarProperty{cV}{\cV}
\NewSubscriptedSymbol{\cPpmshort}{\__thermodynamics_overline_copy:n{\heatcapacitysymbol}}
    {\g__thermodynamics_pressure_symbol}
\NewSubscriptedSymbol{\cVpmshort}{\__thermodynamics_overline_copy:n{\heatcapacitysymbol}}
    {\g__thermodynamics_volume_symbol}
\NewExpandableDocumentCommand{\Epot}{}{E}
\NewDocumentCommand{\residual}{}{R}
\NewDocumentCommand{\excess}{}{E}
\NewDocumentCommand{\sumall}{m m}
  { \sum\c_math_subscript_token{#2=1}
      \c_math_superscript_token{\ncomponents} }
\NewDocumentCommand{\sumallbutlast}{m m}
  { \sum\c_math_subscript_token{#2=1}
      \c_math_superscript_token{\ncomponents-1} }
\NewDocumentCommand{\prodall}{m m}
  { \prod\c_math_subscript_token{#2=1}
       \c_math_superscript_token{\ncomponents} }
\NewDocumentCommand{\IG}{}{{\text{IG}}}
\NewDocumentCommand{\IGM}{}{{\text{IGM}}}
\NewDocumentCommand{\IS}{}{{\text{IS}}}
\NewDocumentCommand{\Henryrat}{}{h}
\NewDocumentCommand{\Henrymol}{}{\mathcal{H}}
\cs_gset_eq:NN \gammait \gamma
\cs_gset_eq:NN \muit \mu
\AtBeginDocument{%
  \ProvideDocumentCommand{\square}{}{%
    \text{\leavevmode
      \hbox to.65em{%
      \hfil\vrule
      \vbox to.53em{\hrule width.45em\vfil\hrule}%
      \vrule\hfil}%
    }%
  }%
}
\NewDocumentCommand{\gammarat}{}{\gamma\c_math_superscript_token\ast}
\NewDocumentCommand{\gammamol}{}{\gamma\c_math_superscript_token\square}
\NewDocumentEnvironment{thermovmatrix}{}
{ \cs_if_exist:NTF \vmatrix
  { \begin{vmatrix} }
  { \left|\begin{array}{c c c c c c c c c c} }
}
{ \cs_if_exist:NTF \endvmatrix
  {  \end{vmatrix} }
  {  \end{array}\right| }
}
\NewDocumentCommand{\Jacobian}{m m}
    {\__thermodynamics_frac:nn{\partial(#1)}{\partial{(#2)}}}
\NewDocumentCommand{\Jacobiandet}{O{} O{} m m}
{
  \__thermodynamics_Jacobian_set_ncomponents:nn {#3} {#4}
  \begin{thermovmatrix}
    \__thermodynamics_Jacobianmatrix:nnnn {#1} {#2} {#3} {#4}
  \end{thermovmatrix}
}
\seq_new:N \l__thermodynamics_row_seq
\seq_new:N \l__thermodynamics_matrix_seq
\clist_new:N \l__thermodynamics_other_vars_clist
\clist_new:N \l__thermodynamics_other_vars_copy_clist
\tl_new:N \l__thermodynamics_Jacobian_x_tl
\tl_new:N \l__thermodynamics_Jacobian_n_tl
\tl_new:N \l__thermodynamics_Jacobian_temp_tl
\bool_new:N \l__thermodynamics_found_dots_bool
\cs_new:Nn \__thermodynamics_Jacobian_set_ncomponents:nn
{
  % If any entry is \dots, we assume the Jacobian is of the form
  % d(f_1,\dots,f_n)/d(x_1,\dots,x_n) where f is some function
  % (any symbol) and x is some variable (any symbol).
  \tl_if_in:nnTF {#1} {\dots}
  {% Has dots
    \bool_set_true:N \l__thermodynamics_found_dots_bool
    % look for what "x" is
    \tl_set:Nn \l__thermodynamics_Jacobian_x_tl {\tl_head:n {#2}}
    % look for what "n" is and set \ncomponents to it
    \tl_set:Nx \l__thermodynamics_Jacobian_n_tl {\tl_item:nn {#2} {-1}}
    \RenewExpandableDocumentCommand{\ncomponents}{}{\l__thermodynamics_Jacobian_n_tl}
  }
  {% Does not have dots; proceed accordingly
    \bool_set_false:N \l__thermodynamics_found_dots_bool
  }
}
\cs_new_protected:Nn \__thermodynamics_Jacobianmatrix:nnnn
{
  \seq_clear:N \l__thermodynamics_matrix_seq
  \clist_set:Nn \l__thermodynamics_other_vars_clist {#4}
  \clist_set_eq:NN \l__thermodynamics_other_vars_copy_clist \l__thermodynamics_other_vars_clist

  \clist_map_inline:nn {#3}
  {
    \seq_clear:N \l__thermodynamics_row_seq
    \tl_if_in:nnTF {##1} {\dots}
    {% The current row has "dots" => row is \vdots && \vdots
      \seq_put_right:Nn \l__thermodynamics_matrix_seq
        { \vdots \c_alignment_token \c_alignment_token \vdots }
    }
    {% Ordinary row
      \clist_map_inline:nn {#4}
      {
        \tl_if_in:nnTF {####1} {\dots}
        {% this column has "dots" in it
          \seq_put_right:Nn \l__thermodynamics_row_seq \dots
        }
        {% Normal column
          \clist_set_eq:NN \l__thermodynamics_other_vars_clist
                           \l__thermodynamics_other_vars_copy_clist
          \clist_remove_all:Nn \l__thermodynamics_other_vars_clist {####1}
          \bool_if:NTF \l__thermodynamics_found_dots_bool
          { \tl_set:Nn \l__thermodynamics_Jacobian_temp_tl {\tl_item:nn {####1} {-1}}
            \seq_put_right:Nx \l__thermodynamics_row_seq
            {
              #1\Partial{##1}{####1}
                  {\allbut{\l__thermodynamics_Jacobian_temp_tl}{\l__thermodynamics_Jacobian_x_tl}}
            }
          }
          { \seq_put_right:Nx \l__thermodynamics_row_seq
            {
              #1\Partial{##1}{####1}
                        {\clist_use:Nn \l__thermodynamics_other_vars_clist ,}
            }
          }
        }
      }
      \seq_put_right:Nx \l__thermodynamics_matrix_seq
      {
        \seq_use:Nn \l__thermodynamics_row_seq { \c_alignment_token }
      }
    }
  }
  \tl_if_empty:nTF {#2}
  {
    \tl_if_eq:nnTF {#1} {\displaystyle}
    { \seq_use:Nn \l__thermodynamics_matrix_seq { \\[2.75ex] } }
    { \seq_use:Nn \l__thermodynamics_matrix_seq { \\[1.25ex] } }
  }
  {
    \seq_use:Nn \l__thermodynamics_matrix_seq { \\[#2] }
  }
}
\endinput
%%
%% End of file `thermodynamics.sty'.
