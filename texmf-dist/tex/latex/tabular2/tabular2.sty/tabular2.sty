%%
%% This is file `tabular2.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% tabular2.dtx  (with options: `package')
%% 
\NeedsTeXFormat{LaTeX2e}[2023-11-01]
\ProvidesExplPackage{tabular2}{2025-09-03}{0.3}
  {A new table implementation base on expl3}
\RequirePackage{l3draw}[2024-02-20]
\cs_generate_variant:Nn \msg_error:nnn     {nnV}
\cs_generate_variant:Nn \str_const:Nn      {Ne}
\cs_generate_variant:Nn \seq_set_split:Nnn {NVn, NVV}
\cs_generate_variant:Nn \seq_set_item:Nnn  {NnV, Nne}
\cs_generate_variant:Nn \seq_gset_item:Nnn {NnV, Nne}
\cs_generate_variant:Nn \prop_gput:Nnn     {Nne, Nen, Nee, NeV, NVe, NVV}
\cs_generate_variant:Nn \prop_gpop:NnN     {NeN}
\cs_generate_variant:Nn \color_stroke:n    {e}
\cs_generate_variant:Nn \regex_extract_all:NnN {NVN}
\cs_if_free:NT \draw_set_linewidth:n
  { \cs_gset_eq:NN \draw_set_linewidth:n \draw_linewidth:n }
\cs_if_free:NT \draw_set_dash_pattern:nn
  { \cs_gset_eq:NN \draw_set_dash_pattern:nn \draw_dash_pattern:nn }
\cs_generate_variant:Nn \draw_set_linewidth:n     {V, e}
\cs_generate_variant:Nn \draw_set_dash_pattern:nn {Vn,en}
\msg_new:nnn {xtable} {unknown_row_name} {未知的行名称：<#1>}
\msg_new:nnn {xtable} {unknown_col_name} {未知的列名称：<#1>}
\msg_new:nnn {xtable} {unknown_input}    {未知的输入 <#1>}
\msg_new:nnn {xtable} {unknown_format}   {未知的格式 <#1>}
\msg_new:nnn {xtable} {unknown_cell}     {未知的单元格数据 @<#1>}
\msg_new:nnn {xtable} {outside_table}    {<#1> 应当在 xtable 的输入环境中使用}
\msg_new:nnn {xtable} {outside_render}   {<#1> 应当在 xtable 的输出环境中使用}
\msg_new:nnn {xtable} {unsaved_table}    {未保存的表：<#1>}
\str_const:Ne \c__xtable_space_str  { \char_generate:nn {32}  {10} } % <space>
\str_const:Ne \c__xtable_escape_str { \char_generate:nn {92}  {12} } % \
\str_const:Ne \c__xtable_lbrace_str { \char_generate:nn {123} {12} } % {
\str_const:Ne \c__xtable_rbrace_str { \char_generate:nn {125} {12} } % }
\dim_const:Nn \c__xtable_std_ht_dim {1.91ex} % 约等于汉字的高度，字母高度{1.67ex}
\dim_const:Nn \c__xtable_std_dp_dim {0.48ex} % 约等于字母的深度
\scan_new:N \s__xtable_mark
\int_new:N \l__xtable_row_loc_int
\int_new:N \l__xtable_col_loc_int
\dim_new:N \l__xtable_x_dim
\dim_new:N \l__xtable_y_dim
\dim_new:N \l__xtable_wd_dim
\dim_new:N \l__xtable_ht_dim
\dim_new:N \l__xtable_dp_dim
\dim_new:N \l__xtable_ufill_dim
\dim_new:N \l__xtable_dfill_dim
\dim_new:N \l__xtable_line_dim
\tl_new:N \l__xtable_style_tl
\tl_new:N \l__xtable_data_tl
\tl_new:N \l__xtable_row_align_tl
\tl_new:N \l__xtable_col_align_tl
\tl_new:N \l__xtable_pattern_tl
\tl_new:N \l__xtable_color_tl
\seq_new:N \l__xtable_shared_seq
\box_new:N \l__xtable_cell_box
\int_new:N \l__xtable_cachea_int
\int_new:N \l__xtable_cacheb_int
\dim_new:N \l__xtable_cachea_dim
\dim_new:N \l__xtable_cacheb_dim
\tl_new:N \l__xtable_cachea_tl
\tl_new:N \l__xtable_cacheb_tl
\seq_new:N \l__xtable_cachea_seq
\seq_new:N \l__xtable_cacheb_seq
\int_new:N \l__xtable_tmpa_int
\int_new:N \l__xtable_tmpb_int
\dim_new:N \l__xtable_tmpa_dim
\dim_new:N \l__xtable_tmpb_dim
\tl_new:N  \l__xtable_tmpa_tl
\tl_new:N  \l__xtable_tmpb_tl
\str_new:N \l__xtable_tmpa_str
\str_new:N \l__xtable_tmpb_str
\seq_new:N  \l__xtable_tmpa_seq
\seq_new:N  \l__xtable_tmpb_seq
\prop_new:N \l__xtable_tmpa_prop
\prop_new:N \l__xtable_tmpb_prop
\box_new:N \l__xtable_tmpa_box
\box_new:N \l__xtable_tmpb_box
\dim_new:N \g__xtable_row_sep_dim        % 行与行的最小间距（通常无边框线）
\dim_new:N \g__xtable_col_sep_dim
\dim_new:N \g__xtable_row_margin_dim     % 行的最小边距（通常有边框线）
\dim_new:N \g__xtable_col_margin_dim
\dim_new:N \g__xtable_above_space_dim    % 表格上下边距
\dim_new:N \g__xtable_below_space_dim
\dim_new:N \g__xtable_cell_wd_min_dim    % 单元格的最小宽度
\dim_new:N \g__xtable_cell_lineskip_dim  % 多行单元格的行距
\keys_define:nn { xtable / package }
  {
    rowsep  .dim_gset:N = \g__xtable_row_sep_dim,
    rowsep  .initial:n  = {0.6ex},
    colsep  .dim_gset:N = \g__xtable_col_sep_dim,
    colsep  .initial:n  = {0.5em},
    margin  .code:n     =
      {
        \dim_gset:Nn \g__xtable_row_margin_dim { \clist_item:nn {#1} {2} }
        \dim_gset:Nn \g__xtable_col_margin_dim { \clist_item:nn {#1} {1} }
      },
    margin  .initial:n  = {0.4em, 0.6ex},
    vspace  .code:n     =
      {
        \dim_gset:Nn \g__xtable_above_space_dim { \clist_item:nn {#1} {1} }
        \dim_gset:Nn \g__xtable_below_space_dim { \clist_item:nn {#1} {2} }
      },
    vspace   .initial:n  = {0.5ex, -1ex},
    minwidth .dim_gset:N = \g__xtable_cell_wd_min_dim,
    minwidth .initial:n  = {1.5em},
    lineskip .dim_gset:N = \g__xtable_cell_lineskip_dim,
    lineskip .initial:n  = {3ex}
  }
\ProcessKeyOptions [ xtable / package ]
\prop_new:N \g__xtable_line_pattern_prop
\prop_new:N \g__xtable_line_wd_prop
\prop_new:N \g__xtable_line_style_prop
\NewDocumentCommand {\linepatternset} { m m }
  { \prop_gput:Nnn \g__xtable_line_pattern_prop {#1} {#2} }
\NewDocumentCommand {\linewdset} { m m }
  { \prop_gput:Nnn \g__xtable_line_wd_prop      {#1} {#2} }
\NewDocumentCommand {\linestyleset} { m m m m }
  {
    \prop_get:NnNF \g__xtable_line_pattern_prop {#2} \l__xtable_tmpa_tl
      { \tl_set:Nn \l__xtable_tmpa_tl {#2} }
    \prop_get:NnNF \g__xtable_line_wd_prop      {#3} \l__xtable_tmpb_tl
      { \tl_set:Nn \l__xtable_tmpb_tl {#3} }
    \prop_gput:Nne \g__xtable_line_style_prop   {#1}
      {\l__xtable_tmpa_tl \s__xtable_mark \l__xtable_tmpb_tl \s__xtable_mark #4}
  }
\linepatternset {soild} {}
\linepatternset {dotted}{0.6em, 0.15em}
\linepatternset {dash}  {0.6em, 0.15em, 0.05em, 0.15em}
\linewdset {normal}     {1pt}
\linewdset {thick}      {1.5pt}
\linewdset {thin}       {0.75pt}
\linewdset {toprule}    {0.08em}
\linewdset {midrule}    {0.05em}
\linewdset {cmidrule}   {0.03em}
\linewdset {bottomrule} {0.08em}
\linestyleset {normal}  {soild}  {normal} {black}
\linestyleset {dotted}  {dotted} {normal} {black}
\linestyleset {dash}    {dash}   {normal} {black}
\linestyleset {bold}    {soild}  {thick}  {black}
\cs_new:Nn \__xtable_init_seq:Nnn
  {
    \seq_clear:N #1
    \prg_replicate:nn {#2} { \seq_put_right:Nn  #1 {#3} }
  }
\cs_new:Nn \__xtable_ginit_seq:Nnn
  {
    \seq_gclear:N #1
    \prg_replicate:nn {#2} { \seq_gput_right:Nn #1 {#3} }
  }
\cs_generate_variant:Nn \__xtable_init_seq:Nnn {Nne}
\cs_new:Nn \__xtable_int_set_max:Nn
  { \int_set:Nn  #1 { \int_max:nn {#1} {#2} } }
\cs_new:Nn \__xtable_int_gset_max:Nn
  { \int_gset:Nn #1 { \int_max:nn {#1} {#2} } }
\cs_new:Nn \__xtable_dim_set_max:NN
  { \dim_set:Nn  #1 { \dim_max:nn {#1} {#2} } }
\cs_new:Nn \__xtable_dim_set_max:Nn
  { \dim_set:Nn  #1 { \dim_max:nn {#1} {#2} } }
\cs_new:Nn \__xtable_set_line_pattern:n
  {
    \prop_get:NnNTF \g__xtable_line_pattern_prop {#1} \l__xtable_tmpa_tl
      { \draw_set_dash_pattern:Vn \l__xtable_tmpa_tl {0pt} }
      { \draw_set_dash_pattern:nn {#1} {0pt} }
  }
\cs_new:Nn \__xtable_set_line_wd:n
  {
    \prop_get:NnNTF \g__xtable_line_wd_prop {#1} \l__xtable_tmpa_tl
      { \draw_set_linewidth:V \l__xtable_tmpa_tl }
      { \draw_set_linewidth:n {#1} }
  }
\cs_new:Nn \__xtable_set_line_style:n
  {
    \prop_get:NnNTF \g__xtable_line_style_prop {#1} \l__xtable_tmpa_tl
      {
        \seq_set_split:NnV \l__xtable_tmpa_seq {\s__xtable_mark} \l__xtable_tmpa_tl
        \draw_set_dash_pattern:en { \seq_item:Nn \l__xtable_tmpa_seq {1} } {0pt}
        \draw_set_linewidth:e { \seq_item:Nn \l__xtable_tmpa_seq {2} }
        \color_stroke:e { \seq_item:Nn \l__xtable_tmpa_seq {3} }
      }
      {
        \__xtable_set_line_pattern:n {soild}
        \__xtable_set_line_wd:n {#1}
        \color_stroke:e {black}
      }
  }
\cs_generate_variant:Nn \__xtable_set_line_style:n {V}
\cs_new:Nn \__xtable_parse_line_style:n
  {
    \prop_get:NnNTF \g__xtable_line_style_prop {#1} \l__xtable_tmpa_tl
      {
        \seq_set_split:NnV \l__xtable_tmpa_seq {,} \l__xtable_tmpa_tl
        \tl_set:Ne  \l__xtable_pattern_tl  { \seq_item:Nn \l__xtable_tmpa_seq {1} }
        \dim_set:Nn \l__xtable_line_dim { \seq_item:Nn \l__xtable_tmpa_seq {2} }
        \tl_set:Ne  \l__xtable_color_tl { \seq_item:Nn \l__xtable_tmpa_seq {3} }
      }
      {
        \prop_get:NnNTF \g__xtable_line_wd_prop {#1} \l__xtable_tmpa_tl
          { \dim_set:Nn \l__xtable_line_dim { \l__xtable_tmpa_tl } }
          { \dim_set:Nn \l__xtable_line_dim {#1} }
        \tl_if_empty:NT \l__xtable_pattern_tl
          { \tl_set:Nn  \l__xtable_pattern_tl  { soild } }
        \tl_if_empty:NT \l__xtable_color_tl
          { \tl_set:Nn  \l__xtable_color_tl { black } }
      }
  }
\cs_generate_variant:Nn \__xtable_parse_line_style:n {V}
\prop_new:N \g__xtable_row_name_prop
\prop_new:N \g__xtable_col_name_prop
\tl_const:Nn \c__xtable_cell_content_tl {content}
\tl_const:Nn \c__xtable_cell_formula_tl {formula}
\tl_const:Nn \c__xtable_cell_merged_tl  {merged}
\tl_const:Nn \c__xtable_cell_empty_tl   {empty}
\bool_new:N \g__xtable_has_header_bool
\int_new:N  \g__xtable_row_count_int  % 不统计 header
\int_new:N  \g__xtable_col_count_int
\prop_new:N \g__xtable_cell_data_prop % 不记录 header
\prop_new:N \g__xtable_row_summary_prop
\prop_new:N \g__xtable_col_formula_prop
\seq_new:N \g__xtable_row_ht_style_seq
\seq_new:N \g__xtable_col_wd_style_seq
\seq_new:N \g__xtable_row_align_seq
\seq_new:N \g__xtable_col_align_seq
\int_new:N  \g__xtable_merge_count_int
\prop_new:N \g__xtable_merge_info_prop
\prop_new:N \g__xtable_merge_ref_prop
\seq_new:N \g__xtable_col_header_seq
\seq_new:N \g__xtable_row_sep_seq
\seq_new:N \g__xtable_col_sep_seq
\seq_new:N \g__xtable_row_ht_seq
\seq_new:N \g__xtable_row_dp_seq
\seq_new:N \g__xtable_col_wd_seq
\prop_new:N \g__xtable_cell_ht_prop
\prop_new:N \g__xtable_cell_ufill_prop
\prop_new:N \g__xtable_cell_dfill_prop
\seq_new:N \g__xtable_row_loc_seq
\seq_new:N \g__xtable_col_loc_seq
\seq_new:N \g__xtable_row_border_seq
\seq_new:N \g__xtable_col_border_seq
\cs_new:Nn \__xtable_set_excel_col_names:n
  {
    \int_step_inline:nn {#1}
      {
        \prop_gput:Nen \g__xtable_col_name_prop
          { \int_to_Alph:n {##1} } {##1}
      }
  }
\cs_new:Nn \__xtable_set_row_name:nN
  {
    \prop_gput:Nne \g__xtable_row_name_prop {#1} {\int_use:N #2}
    \__xtable_int_gset_max:Nn \g__xtable_row_count_int {#2}
  }
\cs_new:Nn \__xtable_set_col_name:nN
  {
    \prop_gput:Nne \g__xtable_col_name_prop {#1} {\int_use:N #2}
    \__xtable_int_gset_max:Nn \g__xtable_col_count_int {#2}
  }
\cs_generate_variant:Nn \__xtable_set_row_name:nN {VN}
\cs_generate_variant:Nn \__xtable_set_col_name:nN {VN}
\cs_new:Nn \__xtable_get_loc:NnNn
  {
    \regex_match:nnTF {^-?[0-9]+$} {#2}
      { \int_set:Nn #3 {#2} }
      {
        \prop_get:NnNTF #1 {#2} \l__xtable_tmpa_tl
          { \int_set:Nn #3 {\l__xtable_tmpa_tl} }
          { #4 }
      }
  }
\cs_new:Nn \__xtable_parse_row_loc:n
  {
    \__xtable_get_loc:NnNn \g__xtable_row_name_prop {#1} \l__xtable_row_loc_int
      { \msg_error:nnn {xtable} {unknown_row_name} {#1} }
  }
\cs_new:Nn \__xtable_parse_col_loc:n
  {
    \__xtable_get_loc:NnNn \g__xtable_col_name_prop {#1} \l__xtable_col_loc_int
      { \msg_error:nnn {xtable} {unknown_col_name} {#1} }
  }
\cs_generate_variant:Nn \__xtable_parse_row_loc:n {e, V}
\cs_generate_variant:Nn \__xtable_parse_col_loc:n {e, V}
\cs_new:Nn \__xtable_parse_new_row_loc:n
  {
    \__xtable_get_loc:NnNn \g__xtable_row_name_prop {#1} \l__xtable_row_loc_int
      {
        \int_if_zero:nT { \l__xtable_row_loc_int }
          { \int_set:Nn \l__xtable_row_loc_int {\g__xtable_row_count_int + 1} }
        \__xtable_set_row_name:nN {#1} \l__xtable_row_loc_int
      }
  }
\cs_new:Nn \__xtable_parse_new_col_loc:n
  {
    \__xtable_get_loc:NnNn \g__xtable_col_name_prop {#1} \l__xtable_col_loc_int
      {
        \int_if_zero:nT { \l__xtable_col_loc_int }
          { \int_set:Nn \l__xtable_col_loc_int {\g__xtable_col_count_int + 1} }
        \__xtable_set_col_name:nN {#1} \l__xtable_col_loc_int
      }
  }
\cs_generate_variant:Nn \__xtable_parse_new_row_loc:n {e, V}
\cs_generate_variant:Nn \__xtable_parse_new_col_loc:n {e, V}
\cs_new:Nn \__xtable_parse_coord:n
  {
    \__xtable_parse_row_loc:e { \clist_item:nn {#1} {1} }
    \__xtable_parse_col_loc:e { \clist_item:nn {#1} {2} }
  }
\cs_new:Nn \__xtable_parse_new_coord:n
  {
    \__xtable_parse_new_row_loc:e { \clist_item:nn {#1} {1} }
    \__xtable_parse_new_col_loc:e { \clist_item:nn {#1} {2} }
  }
\cs_new:Nn \__xtable_table_init:
  {
    \int_gzero:N   \g__xtable_row_count_int
    \int_gzero:N   \g__xtable_col_count_int
    \int_gzero:N   \g__xtable_merge_count_int
    \prop_gclear:N \g__xtable_row_name_prop
    \prop_gclear:N \g__xtable_col_name_prop
    \prop_gclear:N \g__xtable_cell_data_prop
    \prop_gclear:N \g__xtable_row_summary_prop
    \prop_gclear:N \g__xtable_col_formula_prop
    \seq_gclear:N  \g__xtable_row_ht_style_seq
    \seq_gclear:N  \g__xtable_col_wd_style_seq
    \seq_gclear:N  \g__xtable_row_align_seq
    \seq_gclear:N  \g__xtable_col_align_seq
    \prop_gclear:N \g__xtable_merge_info_prop
    \prop_gclear:N \g__xtable_merge_ref_prop
    \prop_gput:Nnn \g__xtable_row_name_prop {header} {0}
    \prop_gput:Nnn \g__xtable_row_name_prop {title} {0}
    \bool_gset_true:N \g__xtable_has_header_bool
  }
\cs_new:Nn \__xtable_table_save:n
  {
    \cs_if_exist:cF { g__xtable_row_count_#1_int }
      {
        \bool_new:c { g__xtable_has_header_#1_bool  }
        \int_new:c  { g__xtable_row_count_#1_int    }
        \int_new:c  { g__xtable_col_count_#1_int    }
        \int_new:c  { g__xtable_merge_count_#1_int  }
        \prop_new:c { g__xtable_row_name_#1_prop    }
        \prop_new:c { g__xtable_col_name_#1_prop    }
        \prop_new:c { g__xtable_cell_data_#1_prop   }
        \prop_new:c { g__xtable_row_summary_#1_prop }
        \prop_new:c { g__xtable_col_formula_#1_prop }
        \seq_new:c  { g__xtable_row_ht_style_#1_seq }
        \seq_new:c  { g__xtable_col_wd_style_#1_seq }
        \seq_new:c  { g__xtable_row_align_#1_seq    }
        \seq_new:c  { g__xtable_col_align_#1_seq    }
        \prop_new:c { g__xtable_merge_info_#1_prop  }
        \prop_new:c { g__xtable_merge_ref_#1_prop   }
      }
    \bool_gset_eq:cN { g__xtable_has_header_#1_bool  } \g__xtable_has_header_bool
    \int_gset_eq:cN  { g__xtable_row_count_#1_int    } \g__xtable_row_count_int
    \int_gset_eq:cN  { g__xtable_col_count_#1_int    } \g__xtable_col_count_int
    \int_gset_eq:cN  { g__xtable_merge_count_#1_int  } \g__xtable_merge_count_int
    \prop_gset_eq:cN { g__xtable_row_name_#1_prop    } \g__xtable_row_name_prop
    \prop_gset_eq:cN { g__xtable_col_name_#1_prop    } \g__xtable_col_name_prop
    \prop_gset_eq:cN { g__xtable_cell_data_#1_prop   } \g__xtable_cell_data_prop
    \prop_gset_eq:cN { g__xtable_row_summary_#1_prop } \g__xtable_row_summary_prop
    \prop_gset_eq:cN { g__xtable_col_formula_#1_prop } \g__xtable_col_formula_prop
    \seq_gset_eq:cN  { g__xtable_row_ht_style_#1_seq } \g__xtable_row_ht_style_seq
    \seq_gset_eq:cN  { g__xtable_col_wd_style_#1_seq } \g__xtable_col_wd_style_seq
    \seq_gset_eq:cN  { g__xtable_row_align_#1_seq    } \g__xtable_row_align_seq
    \seq_gset_eq:cN  { g__xtable_col_align_#1_seq    } \g__xtable_col_align_seq
    \prop_gset_eq:cN { g__xtable_merge_info_#1_prop  } \g__xtable_merge_info_prop
    \prop_gset_eq:cN { g__xtable_merge_ref_#1_prop   } \g__xtable_merge_ref_prop
  }
\cs_new:Nn \__xtable_table_restore:n
  {
    \cs_if_exist:cF { g__xtable_row_count_#1_int }
      { \msg_error:nnn {xtable} {unsaved_table} {#1} }
    \bool_gset_eq:Nc \g__xtable_has_header_bool  { g__xtable_has_header_#1_bool  }
    \int_gset_eq:Nc  \g__xtable_row_count_int    { g__xtable_row_count_#1_int    }
    \int_gset_eq:Nc  \g__xtable_col_count_int    { g__xtable_col_count_#1_int    }
    \int_gset_eq:Nc  \g__xtable_merge_count_int  { g__xtable_merge_count_#1_int  }
    \prop_gset_eq:Nc \g__xtable_row_name_prop    { g__xtable_row_name_#1_prop    }
    \prop_gset_eq:Nc \g__xtable_col_name_prop    { g__xtable_col_name_#1_prop    }
    \prop_gset_eq:Nc \g__xtable_cell_data_prop   { g__xtable_cell_data_#1_prop   }
    \prop_gset_eq:Nc \g__xtable_row_summary_prop { g__xtable_row_summary_#1_prop }
    \prop_gset_eq:Nc \g__xtable_col_formula_prop { g__xtable_col_formula_#1_prop }
    \seq_gset_eq:Nc  \g__xtable_row_ht_style_seq { g__xtable_row_ht_style_#1_seq }
    \seq_gset_eq:Nc  \g__xtable_col_wd_style_seq { g__xtable_col_wd_style_#1_seq }
    \seq_gset_eq:Nc  \g__xtable_row_align_seq    { g__xtable_row_align_#1_seq    }
    \seq_gset_eq:Nc  \g__xtable_col_align_seq    { g__xtable_col_align_#1_seq    }
    \prop_gset_eq:Nc \g__xtable_merge_info_prop  { g__xtable_merge_info_#1_prop  }
    \prop_gset_eq:Nc \g__xtable_merge_ref_prop   { g__xtable_merge_ref_#1_prop   }
  }
\cs_new:Nn \__xtable_set_cell:nnnnn
  {
    \prop_gput:Nnn \g__xtable_cell_data_prop
      {#1, #2} {#3 \s__xtable_mark #4 \s__xtable_mark #5}
    \__xtable_int_gset_max:Nn \g__xtable_row_count_int {#1}
    \__xtable_int_gset_max:Nn \g__xtable_col_count_int {#2}
  }
\cs_generate_variant:Nn \__xtable_set_cell:nnnnn {eeVnn}
\cs_new:Nn \__xtable_set_cell:NNn
  {
    \tl_if_empty:nTF {#3}
      {
        \prop_gpop:NeN \g__xtable_cell_data_prop
          { \int_use:N #1 , \int_use:N #2 }
          \l__xtable_tmpa_tl
      }
      {
        \__xtable_set_cell:eeVnn
          { \int_use:N #1 } { \int_use:N #2 }
          \c__xtable_cell_content_tl {#3} {}
      }
  }
\cs_new:Nn \__xtable_set_cell:n
  {
    \__xtable_set_cell:NNn
      \l__xtable_row_loc_int \l__xtable_col_loc_int {#1}
  }
\cs_generate_variant:Nn \__xtable_set_cell:NNn {NNV}
\cs_new:Nn \__xtable_parse_cell:nn
  {
    \prop_get:NnNTF \g__xtable_cell_data_prop {#1, #2} \l__xtable_tmpa_tl
      {
        \seq_set_split:NnV \l__xtable_tmpa_seq {\s__xtable_mark} \l__xtable_tmpa_tl
        \str_case_e:nnF { \seq_item:Nn \l__xtable_tmpa_seq {1} }
          {
            { \c__xtable_cell_content_tl } % 内容
            { \tl_set:Ne \l__xtable_data_tl { \seq_item:Nn \l__xtable_tmpa_seq {2} } }
            { \c__xtable_cell_formula_tl } % 公式
            { \tl_set:Ne \l__xtable_data_tl { \seq_item:Nn \l__xtable_tmpa_seq {2} } }
            { \c__xtable_cell_merged_tl }  % 合并
            { \tl_set:Nn \l__xtable_data_tl {} }
            { \c__xtable_cell_empty_tl }   % 空
            { \tl_set:Nn \l__xtable_data_tl {} }
          }
          { \msg_error:nnV {xtable} {unknown_cell} {#1,#2}}
      }
      {
        \str_if_eq:nnTF {#1} {0}
          { \tl_set:Ne \l__xtable_data_tl {\seq_item:Nn \g__xtable_col_header_seq {#2}} }
          { \tl_set:Nn \l__xtable_data_tl {} } % 空单元格
      }
  }
\cs_generate_variant:Nn {\__xtable_get_cell:nnN}  {eeN}
\cs_generate_variant:Nn {\__xtable_parse_cell:nn} {ee}
\cs_new:Nn \__xtable_set_row_style:NNn
 {
    \bool_if:NTF \g__xtable_has_header_bool
      {
        \int_set:Nn \l__xtable_tmpa_int    {1}
        \int_set:Nn \l__xtable_row_loc_int {0}
      } {
        \int_set:Nn \l__xtable_tmpa_int    {0}
        \int_set:Nn \l__xtable_row_loc_int {1}
      }
    \__xtable_int_gset_max:Nn \g__xtable_row_count_int
      { \seq_count:N #1 - \l__xtable_tmpa_int }
    \__xtable_ginit_seq:Nnn #1 {\g__xtable_row_count_int + 1} {#3}
    \seq_map_inline:Nn #2
      {
        \str_if_in:nnTF {##1} {=}
          {
            \seq_set_split:Nnn \l__xtable_tmpa_seq {=} {##1}
            \seq_get_left:NN \l__xtable_tmpa_seq \l__xtable_tmpa_tl
            \seq_get_right:NN \l__xtable_tmpa_seq \l__xtable_tmpb_tl
            \__xtable_parse_row_loc:V \l__xtable_tmpa_tl
          }
          { \tl_set:Nn \l__xtable_tmpb_tl {##1} }
        \seq_gset_item:NnV #1
          {\l__xtable_row_loc_int + 1} \l__xtable_tmpb_tl
        \int_incr:N \l__xtable_row_loc_int
      }
  }
\cs_new:Nn \__xtable_set_col_style:NNn
  {
    \int_set:Nn \l__xtable_col_loc_int {1}
    \__xtable_int_gset_max:Nn \g__xtable_col_count_int {\seq_count:N #1}
    \__xtable_ginit_seq:Nnn #1 {\g__xtable_col_count_int} {#3}
    \seq_map_inline:Nn #2
      {
        \str_if_in:nnTF {##1} {=}
          {
            \seq_set_split:Nnn \l__xtable_tmpa_seq {=} {##1}
            \seq_get_left:NN \l__xtable_tmpa_seq \l__xtable_tmpa_tl
            \seq_get_right:NN \l__xtable_tmpa_seq \l__xtable_tmpb_tl
            \__xtable_parse_col_loc:V \l__xtable_tmpa_tl
          }
          { \tl_set:Nn \l__xtable_tmpb_tl {##1} }
        \seq_gset_item:NnV #1 {\l__xtable_col_loc_int} \l__xtable_tmpb_tl
        \int_incr:N \l__xtable_col_loc_int
      }
  }
\cs_new:Nn \__xtable_set_row_ht_style:Nn
  {
    \__xtable_set_row_style:NNn \g__xtable_row_ht_style_seq #1 {#2}
    \int_step_inline:nn
      { \seq_count:N \g__xtable_row_ht_style_seq }
      {
        \tl_set:Ne \l__xtable_tmpa_tl
          { \seq_item:Nn \g__xtable_row_ht_style_seq {##1} }
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {auto} {a}
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {same} {s}
        \seq_gset_item:NnV \g__xtable_row_ht_style_seq {##1} \l__xtable_tmpa_tl
      }
  }
\cs_new:Nn \__xtable_set_col_wd_style:Nnn
  {
    \__xtable_set_col_style:NNn \g__xtable_col_wd_style_seq #1 {#2}
    \int_step_inline:nn
      { \seq_count:N \g__xtable_col_wd_style_seq }
      {
        \tl_set:Ne \l__xtable_tmpa_tl
          { \seq_item:Nn \g__xtable_col_wd_style_seq {##1} }
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {auto} {a}
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {same} {s}
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {fill} {f}
        \seq_gset_item:NnV \g__xtable_col_wd_style_seq {##1} \l__xtable_tmpa_tl
      }
    \seq_gput_right:Nn \g__xtable_col_wd_style_seq {#3}
  }
\cs_new:Nn \__xtable_set_row_align:Nn
  { \__xtable_set_row_style:NNn \g__xtable_row_align_seq #1 {#2} }
\cs_new:Nn \__xtable_set_col_align:Nn
  { \__xtable_set_col_style:NNn \g__xtable_col_align_seq #1 {#2} }
\cs_new:Nn \__xtable_insure_style:
  {
    \seq_clear:N \l__xtable_shared_seq
    \seq_if_empty:NT \g__xtable_row_ht_style_seq
      { \__xtable_set_row_ht_style:Nn \l__xtable_shared_seq {a} }
    \seq_if_empty:NT \g__xtable_col_wd_style_seq
      { \__xtable_set_col_wd_style:Nnn \l__xtable_shared_seq {a} {\textwidth} }
    \seq_if_empty:NT \g__xtable_row_align_seq
      { \__xtable_set_row_align:Nn \l__xtable_shared_seq {b} }
    \seq_if_empty:NT \g__xtable_col_align_seq
      { \__xtable_set_col_align:Nn \l__xtable_shared_seq {c} }
  }
\cs_new:Nn \__xtable_parse_row_ht_style:n
  {
    \tl_set:Ne \l__xtable_style_tl
      { \seq_item:Nn \g__xtable_row_ht_style_seq {#1 + 1} }
  }
\cs_new:Nn \__xtable_parse_col_wd_style:n
  {
    \tl_set:Ne \l__xtable_style_tl
      { \seq_item:Nn \g__xtable_col_wd_style_seq {#1} }
  }
\cs_new:Nn \__xtable_parse_row_align:n
  {
    \tl_set:Ne \l__xtable_row_align_tl
      { \seq_item:Nn \g__xtable_row_align_seq {#1 + 1} }
  }
\cs_new:Nn \__xtable_parse_col_align:n
  {
    \tl_set:Ne \l__xtable_col_align_tl
      { \seq_item:Nn \g__xtable_col_align_seq {#1} }
  }
\NewDocumentCommand \showtable {}
  {
    \prop_if_empty:NTF \g__xtable_cell_data_prop
      {当前表格内容为空。}
      {当前表格内容如下：\\No.}
    \seq_map_inline:Nn \g__xtable_col_header_seq
      { ,~\tl_to_str:n {##1} }
    \int_step_inline:nn {\g__xtable_row_count_int}
      {
        ;\\##1
        \int_step_inline:nn {\g__xtable_col_count_int}
          {
            \__xtable_parse_cell:nn {##1} {####1}
            ,~\l__xtable_data_tl
          }
      }。
  }
\NewDocumentCommand \logtable {}
  {
    \int_log:N  \g__xtable_row_count_int
    \int_log:N  \g__xtable_col_count_int
    \int_log:N  \g__xtable_merge_count_int
    \prop_log:N \g__xtable_row_name_prop
    \prop_log:N \g__xtable_col_name_prop
    \prop_log:N \g__xtable_cell_data_prop
    \prop_log:N \g__xtable_row_summary_prop
    \prop_log:N \g__xtable_col_formula_prop
    \seq_log:N  \g__xtable_row_ht_style_seq
    \seq_log:N  \g__xtable_col_wd_style_seq
    \seq_log:N  \g__xtable_row_align_seq
    \seq_log:N  \g__xtable_col_align_seq
    \prop_log:N \g__xtable_merge_info_prop
    \prop_log:N \g__xtable_merge_ref_prop
    \bool_log:N \g__xtable_has_header_bool
  }
\cs_new:Nn \__xtable_process_header:
  {
    \prop_clear:N \l__xtable_tmpa_prop
    \seq_gclear:N \g__xtable_col_header_seq
    \prop_map_inline:Nn \g__xtable_col_name_prop
      { \prop_put:Nnn \l__xtable_tmpa_prop {##2} {##1} }
    \int_step_inline:nn {\g__xtable_col_count_int}
      {
        \prop_get:NnNTF \l__xtable_tmpa_prop {##1} \l__xtable_tmpa_tl
          { \seq_gput_right:NV \g__xtable_col_header_seq \l__xtable_tmpa_tl }
          { \seq_gput_right:Nn \g__xtable_col_header_seq {<##1>} }
      }
  }
\cs_new:Nn \__xtable_set_row_sep:nn
  {
    \seq_gclear:N \g__xtable_row_sep_seq
    \prg_replicate:nn {\g__xtable_row_count_int}
      { \seq_gput_right:Nn \g__xtable_row_sep_seq {#2} }
    \seq_gput_left:Nn  \g__xtable_row_sep_seq {#1}
    \seq_gput_right:Nn \g__xtable_row_sep_seq {#1}
  }
\cs_new:Nn \__xtable_set_col_sep:nn
  {
    \seq_gclear:N \g__xtable_col_sep_seq
    \prg_replicate:nn {\g__xtable_col_count_int - 1}
      { \seq_gput_right:Nn \g__xtable_col_sep_seq {#2} }
    \seq_gput_left:Nn  \g__xtable_col_sep_seq {#1}
    \seq_gput_right:Nn \g__xtable_col_sep_seq {#1}
  }
\cs_generate_variant:Nn \__xtable_set_row_sep:nn { ne, en, ee }
\cs_generate_variant:Nn \__xtable_set_col_sep:nn { ne, en, ee }
\cs_new:Nn \__xtable_measure_cell_wd:n
  {
    \dim_zero:N    \l__xtable_ufill_dim
    \dim_set_eq:NN \l__xtable_wd_dim \g__xtable_cell_wd_min_dim
    \tl_if_empty:nF {#1}
      {
        \bool_set_true:N   \l__xtable_tmpa_bool
        \seq_set_split:Nnn \l__xtable_tmpa_seq {\\} {#1}
        \seq_map_inline:Nn \l__xtable_tmpa_seq
          {
            \hbox_set:Nn \l__xtable_tmpa_box {##1}
            \__xtable_dim_set_max:Nn \l__xtable_wd_dim
              { \box_wd:N \l__xtable_tmpa_box }
            \bool_if:NT \l__xtable_tmpa_bool
              {
                \__xtable_dim_set_max:Nn \l__xtable_ufill_dim
                  { \c__xtable_std_ht_dim - \box_ht:N \l__xtable_tmpa_box }
                \bool_set_false:N  \l__xtable_tmpa_bool
              }
            \dim_zero:N \l__xtable_dfill_dim % 每次都清除上次信息
            \__xtable_dim_set_max:Nn \l__xtable_dfill_dim
              { \c__xtable_std_dp_dim - \box_dp:N \l__xtable_tmpa_box }
          }
      }
  }
\cs_generate_variant:Nn \__xtable_measure_cell_wd:n { V, e }
\cs_new:Nn \__xtable_measure_col_wd:n
  {
    \dim_zero:N \l__xtable_tmpa_dim
    \bool_if:NTF \g__xtable_has_header_bool
      { \int_set:Nn \l__xtable_tmpa_int {0} }
      { \int_set:Nn \l__xtable_tmpa_int {1} }
    \int_step_inline:nnn {\l__xtable_tmpa_int} {\g__xtable_row_count_int}
      {
        \__xtable_parse_cell:nn {##1} {#1}
        \__xtable_measure_cell_wd:V \l__xtable_data_tl
        \__xtable_dim_set_max:NN \l__xtable_tmpa_dim \l__xtable_wd_dim
        \prop_gput:Nne \g__xtable_cell_ufill_prop
          {##1,#1} {\dim_use:N \l__xtable_ufill_dim}
        \prop_gput:Nne \g__xtable_cell_dfill_prop
          {##1,#1} {\dim_use:N \l__xtable_dfill_dim}
      }
    \dim_set_eq:NN \l__xtable_wd_dim \l__xtable_tmpa_dim
  }
\cs_new:Nn \__xtable_calc_col_wd:
  {
    \dim_zero:N    \l__xtable_cachea_dim
    \dim_zero:N    \l__xtable_cacheb_dim
    \seq_clear:N   \l__xtable_cachea_seq
    \seq_clear:N   \l__xtable_cacheb_seq
    \seq_gclear:N  \g__xtable_col_wd_seq
    \prop_gclear:N \g__xtable_cell_ufill_prop
    \prop_gclear:N \g__xtable_cell_dfill_prop
    \int_step_inline:nn {\g__xtable_col_count_int} % 自然宽度循环
      {
        \__xtable_measure_col_wd:n {##1}
        \__xtable_parse_col_wd_style:n {##1}
        \clist_if_in:nVTF {a,s,f,sf} \l__xtable_style_tl
          {
            \seq_gput_right:Ne \g__xtable_col_wd_seq
              { \dim_use:N \l__xtable_wd_dim }
            \tl_if_eq:VnT \l__xtable_style_tl {s}
              {
                \seq_put_right:Nn \l__xtable_cachea_seq {##1}
                \__xtable_dim_set_max:NN \l__xtable_cachea_dim \l__xtable_wd_dim
              }
            \tl_if_eq:VnT \l__xtable_style_tl {sf}
              {
                \seq_put_right:Nn \l__xtable_cacheb_seq {##1}
                \__xtable_dim_set_max:NN \l__xtable_cacheb_dim \l__xtable_wd_dim
              }
          }
          { \seq_gput_right:NV \g__xtable_col_wd_seq \l__xtable_style_tl }
      }
    \seq_map_inline:Nn \l__xtable_cachea_seq % 相同宽度循环
      {
        \seq_gset_item:Nne \g__xtable_col_wd_seq
          {##1} { \dim_use:N \l__xtable_cachea_dim }
      }
    \seq_map_inline:Nn \l__xtable_cacheb_seq
      {
        \seq_gset_item:Nne \g__xtable_col_wd_seq
          {##1} { \dim_use:N \l__xtable_cacheb_dim }
      }
    \int_zero:N  \l__xtable_cachea_int % 填充循环
    \seq_clear:N \l__xtable_cachea_seq
    \dim_set:Nn  \l__xtable_wd_dim
      { \seq_item:Nn \g__xtable_col_wd_style_seq {-1} }
    \seq_map_inline:Nn \g__xtable_col_sep_seq
      { \dim_sub:Nn \l__xtable_wd_dim {##1} }
    \int_step_inline:nn {\g__xtable_col_count_int}
      {
        \dim_sub:Nn \l__xtable_wd_dim
          { \seq_item:Nn \g__xtable_col_wd_seq {##1} }
        \__xtable_parse_col_wd_style:n {##1}
        \tl_if_in:NnT \l__xtable_style_tl {f}
          {
            \int_incr:N \l__xtable_cachea_int
            \seq_put_right:Nn \l__xtable_cachea_seq {##1}
          }
      }
    \int_if_zero:nF { \l__xtable_cachea_int }
      {
        \dim_set:Nn \l__xtable_cachea_dim
          { \l__xtable_wd_dim / \l__xtable_cachea_int }
      }
    \seq_map_inline:Nn \l__xtable_cachea_seq
      {
        \dim_set:Nn \l__xtable_wd_dim
          { \seq_item:Nn \g__xtable_col_wd_seq {##1} }
        \dim_add:Nn \l__xtable_wd_dim { \l__xtable_cachea_dim }
        \seq_gset_item:Nne \g__xtable_col_wd_seq
          {##1} { \dim_use:N \l__xtable_wd_dim }
      }
  }
\cs_new:Nn \__xtable_measure_cell_ht:nnn
  {
    \dim_set_eq:NN \l__xtable_ht_dim \c__xtable_std_ht_dim
    \dim_set_eq:NN \l__xtable_dp_dim \c__xtable_std_dp_dim
    \tl_if_empty:nF {#3}
      {
        \str_if_eq:nnTF {#1} {t}
          { \vbox_set_top:Nn } { \vbox_set:Nn }
          \l__xtable_tmpa_box
          {
            \baselineskip=\g__xtable_cell_lineskip_dim
            \hsize=#2 \parindent=0pt \noindent #3
          }
        \__xtable_dim_set_max:Nn \l__xtable_ht_dim
          { \box_ht:N \l__xtable_tmpa_box + \l__xtable_ufill_dim }
        \__xtable_dim_set_max:Nn \l__xtable_dp_dim
          { \box_dp:N \l__xtable_tmpa_box + \l__xtable_dfill_dim  }
      }
  }
\cs_generate_variant:Nn \__xtable_measure_cell_ht:nnn { VeV }
\cs_new:Nn \__xtable_measure_row_ht:n
  {
    \dim_zero:N \l__xtable_tmpa_dim
    \dim_zero:N \l__xtable_tmpb_dim
    \__xtable_parse_row_align:n {#1}
    \int_step_inline:nn {\g__xtable_col_count_int}
      {
        \__xtable_parse_cell:nn      {#1} {##1}
        \__xtable_parse_cell_fill:nn {#1} {##1}
        \__xtable_measure_cell_ht:VeV \l__xtable_row_align_tl
          { \seq_item:Nn \g__xtable_col_wd_seq {##1} }
          \l__xtable_data_tl
        \prop_gput:Nne \g__xtable_cell_ht_prop {#1,##1}
          { \dim_use:N \l__xtable_ht_dim }
        \__xtable_dim_set_max:NN \l__xtable_tmpa_dim \l__xtable_ht_dim
        \__xtable_dim_set_max:NN \l__xtable_tmpb_dim \l__xtable_dp_dim
      }
    \dim_set_eq:NN \l__xtable_ht_dim \l__xtable_tmpa_dim
    \dim_set_eq:NN \l__xtable_dp_dim \l__xtable_tmpb_dim
  }

\cs_new:Nn \__xtable_calc_row_ht:
  {
    \dim_zero:N    \l__xtable_cachea_dim
    \dim_zero:N    \l__xtable_cacheb_dim
    \seq_clear:N   \l__xtable_cachea_seq
    \seq_gclear:N  \g__xtable_row_ht_seq
    \seq_gclear:N  \g__xtable_row_dp_seq
    \prop_gclear:N \g__xtable_cell_ht_prop
    \int_step_inline:nnn {0} {\g__xtable_row_count_int} % 自然高度循环
      {
        \__xtable_parse_row_ht_style:n {##1}
        \__xtable_measure_row_ht:n {##1}
        \clist_if_in:nVTF {a,s} \l__xtable_style_tl
          {
            \seq_gput_right:Ne \g__xtable_row_ht_seq
              { \dim_use:N \l__xtable_ht_dim }
            \seq_gput_right:Ne \g__xtable_row_dp_seq
              { \dim_use:N \l__xtable_dp_dim }
            \tl_if_eq:VnT \l__xtable_style_tl {s}
              {
                \seq_put_right:Nn \l__xtable_cachea_seq {##1}
                \__xtable_dim_set_max:NN \l__xtable_cachea_dim \l__xtable_ht_dim
                \__xtable_dim_set_max:NN \l__xtable_cacheb_dim \l__xtable_dp_dim
              }
          }
          {
            \seq_gput_right:Ne \g__xtable_row_ht_seq
              { \dim_eval:n { \l__xtable_style_tl - \l__xtable_dp_dim } }
            \seq_gput_right:Ne \g__xtable_row_dp_seq
              { \dim_use:N \l__xtable_dp_dim }
          }
      }
    \seq_map_inline:Nn \l__xtable_cachea_seq % 相同高度循环
      {
        \__xtable_parse_row_align:n {##1}
        \str_if_eq:VnTF \l__xtable_row_align_tl {t}
          {
            \dim_set:Nn \l__xtable_ht_dim
              { \seq_item:Nn \g__xtable_row_ht_seq {##1+1} }
            \dim_set:Nn \l__xtable_dp_dim
              { \l__xtable_cachea_dim + \l__xtable_cacheb_dim - \l__xtable_ht_dim }
            \seq_gset_item:Nne \g__xtable_row_dp_seq
              {##1+1} { \dim_use:N \l__xtable_dp_dim  }
          }
          {
            \dim_set:Nn \l__xtable_dp_dim
              { \seq_item:Nn \g__xtable_row_dp_seq {##1+1} }
            \dim_set:Nn \l__xtable_ht_dim
              { \l__xtable_cachea_dim + \l__xtable_cacheb_dim - \l__xtable_dp_dim }
            \seq_gset_item:Nne \g__xtable_row_ht_seq
              {##1+1} { \dim_use:N \l__xtable_ht_dim  }
          }
      }
  }
\cs_new:Nn \__xtable_parse_cell_size:nn
  {
    \dim_set:Nn \l__xtable_wd_dim
      { \seq_item:Nn \g__xtable_col_wd_seq {#2} }
    \dim_set:Nn \l__xtable_ht_dim
      { \seq_item:Nn \g__xtable_row_ht_seq {#1+1} }
    \dim_set:Nn \l__xtable_dp_dim
      { \seq_item:Nn \g__xtable_row_dp_seq {#1+1} }
  }
\cs_new:Nn \__xtable_parse_cell_fill:nn
  {
    \prop_get:NnNF \g__xtable_cell_ufill_prop {#1,#2} \l__xtable_tmpa_tl
      { \tl_set:Nn \l__xtable_tmpa_tl {0pt} }
    \prop_get:NnNF \g__xtable_cell_dfill_prop {#1,#2} \l__xtable_tmpb_tl
      { \tl_set:Nn \l__xtable_tmpb_tl {0pt} }
    \dim_set:Nn \l__xtable_ufill_dim {\l__xtable_tmpa_tl}
    \dim_set:Nn \l__xtable_dfill_dim {\l__xtable_tmpb_tl}
  }
\cs_new:Nn \__xtable_parse_cell_ht:nn
  {
    \prop_get:NnN \g__xtable_cell_ht_prop {#1,#2} \l__xtable_tmpa_tl
    \dim_set:Nn \l__xtable_ht_dim {\l__xtable_tmpa_tl}
  }
\cs_new:Nn \__xtable_calc_coord:
  {
    \dim_zero:N   \l__xtable_wd_dim
    \seq_gclear:N \g__xtable_col_loc_seq
    \seq_gput_right:NV \g__xtable_col_loc_seq \l__xtable_wd_dim
    \dim_add:Nn \l__xtable_wd_dim
      { (\seq_item:Nn \g__xtable_col_sep_seq {1})/2 }
    \int_step_inline:nn {\g__xtable_col_count_int}
      {
        \dim_add:Nn \l__xtable_wd_dim
          { (\seq_item:Nn \g__xtable_col_sep_seq {##1})/2 }
        \dim_add:Nn \l__xtable_wd_dim
          { \seq_item:Nn \g__xtable_col_wd_seq {##1} }
        \dim_add:Nn \l__xtable_wd_dim
          { (\seq_item:Nn \g__xtable_col_sep_seq {##1+1})/2 }
        \seq_gput_right:NV \g__xtable_col_loc_seq \l__xtable_wd_dim
      }
    \dim_add:Nn \l__xtable_wd_dim
      { (\seq_item:Nn \g__xtable_col_sep_seq {-1})/2 }
    \seq_gset_item:NnV \g__xtable_col_loc_seq {-1} \l__xtable_wd_dim
    \dim_zero:N   \l__xtable_ht_dim
    \seq_gclear:N \g__xtable_row_loc_seq
    \seq_gput_right:NV \g__xtable_row_loc_seq \l__xtable_ht_dim
    \bool_if:NTF \g__xtable_has_header_bool
      { \int_set:Nn \l__xtable_tmpa_int {0} }
      { \int_set:Nn \l__xtable_tmpa_int {1} }
    \dim_sub:Nn \l__xtable_ht_dim
      { \seq_item:Nn \g__xtable_row_sep_seq {1} }
    \int_step_inline:nnn {\l__xtable_tmpa_int} {\g__xtable_row_count_int}
      {
        \int_compare:nNnF {##1} = {\l__xtable_tmpa_int}
          {
            \dim_sub:Nn \l__xtable_ht_dim
              { (\seq_item:Nn \g__xtable_row_sep_seq {##1+1})/2 }
          }
        \dim_sub:Nn \l__xtable_ht_dim
          { \seq_item:Nn \g__xtable_row_ht_seq {##1+1} }
        \dim_sub:Nn \l__xtable_ht_dim
          { \seq_item:Nn \g__xtable_row_dp_seq {##1+1} }
        \dim_sub:Nn \l__xtable_ht_dim
          { (\seq_item:Nn \g__xtable_row_sep_seq {##1+2})/2 }
        \seq_gput_right:NV \g__xtable_row_loc_seq \l__xtable_ht_dim
      }
    \dim_sub:Nn \l__xtable_ht_dim
      { (\seq_item:Nn \g__xtable_row_sep_seq {-1})/2 }
    \seq_gset_item:NnV \g__xtable_row_loc_seq {-1} \l__xtable_ht_dim
  }
\regex_const:Nn \c__xtable_csv_row_regex
  { (?:(?:[^"\c{\\}]+|"(?:""|[^"])+")+?)(?:\c{\\}) }
\regex_const:Nn \c__xtable_csv_cell_regex
  { (?:([^"\c{\\},]*)|"((?:""|[^"])+)")(?:,|\c{\\}) }
\regex_const:Nn \c__xtable_json_cell_regex
  {
    "((?:[^"\\]|\\.)+)"
    \s*:\s*
    (?:
      ([\+\-]?(?:\d*\.)?\d+|true|false) |
      "((?:[^"\\]|\\.)+)"
    )
    \s*[,]?
  }
\regex_const:Nn \c__xtable_row_ht_regex
  {
    \A(?:.*=)?(?:
    (auto|same|a|s)|
    ([0-9.]+(?:pt|ex|em|mm|cm|in|cc|dd|pc))
    )\Z
  }
\regex_const:Nn \c__xtable_col_wd_regex
  {
    \A(?:.*=)?(?:
    (auto|same|fill|samefill|a|s|f|sf)|
    ([0-9.]+(?:pt|ex|em|mm|cm|in|cc|dd|pc))
    )\Z
  }
\bool_new:N \l__xtable_input_bool
\bool_set_false:N \l__xtable_input_bool
\cs_new:Nn \__xtable_check_input_env:n
  {
    \bool_if:NF \l__xtable_input_bool
      { \msg_error:nnn {xtable} {outside_table} {#1} }
  }
\int_new:N  \l__xtable_parse_status_int
\bool_new:N \l__xtable_esc_status_bool
\bool_new:N \l__xtable_quote_status_bool
\seq_new:N \l__xtable_row_input_seq
\seq_new:N \l__xtable_cell_input_seq
\tl_new:N   \l__xtable_input_format_tl
\tl_new:N   \l__xtable_input_sep_tl
\bool_new:N \l__xtable_input_has_header_bool
\keys_define:nn { xtable / input }
  {
    format .choices:nn =
      { inner, csv, json }
      { \tl_set_eq:NN \l__xtable_input_format_tl \l_keys_choice_tl },
    format .initial:n = {inner},
    title  .bool_set:N = \l__xtable_input_has_header_bool,
    header .bool_set:N = \l__xtable_input_has_header_bool,
    header .initial:n = {true},
    sep .tl_set:N = \l__xtable_input_sep_tl,
    sep .initial:n = {,},
    loc .code:n = {\__xtable_parse_coord:n {#1}},
    loc .initial:n = {1,1}
  }
\cs_new:Nn \__xtable_parse_input:n
  {
    \seq_set_split:Nnn \l__xtable_row_input_seq {\\} {#1}
    \int_set_eq:NN \l__xtable_tmpa_int \l__xtable_row_loc_int
    \seq_map_inline:Nn \l__xtable_row_input_seq
      {
        \tl_set:Nn \l__xtable_tmpa_tl {##1}
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {\newline} {\\}
        \int_set_eq:NN \l__xtable_tmpb_int \l__xtable_col_loc_int
        \seq_set_split:NVV \l__xtable_cell_input_seq
          \l__xtable_input_sep_tl \l__xtable_tmpa_tl
        \bool_if:NTF \l__xtable_input_has_header_bool
          { % 填充标题
            \seq_map_inline:Nn \l__xtable_cell_input_seq
              {
                \__xtable_set_col_name:nN {####1} \l__xtable_tmpb_int
                \int_incr:N \l__xtable_tmpb_int
              }
            \bool_set_false:N \l__xtable_input_has_header_bool
          }
          { % 填充数据
            \seq_map_inline:Nn \l__xtable_cell_input_seq
              {
                \__xtable_set_cell:NNn \l__xtable_tmpa_int \l__xtable_tmpb_int {####1}
                \int_incr:N \l__xtable_tmpb_int
              }
            \int_incr:N \l__xtable_tmpa_int
          }
      }
  }
\cs_new:Nn \__xtable_parse_csv:n
  {
    \seq_clear:N \l__xtable_row_input_seq
    \regex_extract_all:NnN
      \c__xtable_csv_row_regex {#1\\} \l__xtable_row_input_seq
    \int_set_eq:NN \l__xtable_tmpa_int \l__xtable_row_loc_int
    \seq_map_inline:Nn \l__xtable_row_input_seq
      {
        \int_set_eq:NN \l__xtable_tmpb_int \l__xtable_col_loc_int
        \seq_clear:N \l__xtable_tmpa_seq
        \seq_clear:N \l__xtable_cell_input_seq
        \regex_extract_all:NnN
          \c__xtable_csv_cell_regex {##1} \l__xtable_tmpa_seq
        \int_step_inline:nnnn {2} {3} {\seq_count:N \l__xtable_tmpa_seq}
          {
            \tl_set:Ne \l__xtable_tmpa_tl
              { \seq_item:Nn \l__xtable_tmpa_seq {####1} }
            \tl_set:Ne \l__xtable_tmpb_tl
              { \seq_item:Nn \l__xtable_tmpa_seq {####1+1} }
            \tl_put_right:NV \l__xtable_tmpa_tl \l__xtable_tmpb_tl
            \seq_put_right:NV \l__xtable_cell_input_seq \l__xtable_tmpa_tl
          }
        \bool_if:NTF \l__xtable_input_has_header_bool
          { % 填充表头（设置列名）
            \seq_map_inline:Nn \l__xtable_cell_input_seq
              {
                \__xtable_set_col_name:nN {####1} \l__xtable_tmpb_int
                \int_incr:N \l__xtable_tmpb_int
              }
            \bool_set_false:N \l__xtable_input_has_header_bool
          }
          { % 填充数据
            \seq_map_inline:Nn \l__xtable_cell_input_seq
              {
                \__xtable_set_cell:NNn \l__xtable_tmpa_int \l__xtable_tmpb_int {####1}
                \int_incr:N \l__xtable_tmpb_int
              }
            \int_incr:N \l__xtable_tmpa_int
          }
      }
  }
\cs_new:Nn \__xtable_parse_json_auxa:n
  {
    \str_case_e:nnF {#1}
      {
        {\c__xtable_space_str} {}  % 空白，跳过
        {[}                   % 数组开始
        { \int_set:Nn \l__xtable_parse_status_int {1} }
        {\c__xtable_lbrace_str}    % 行开始
        {
          \int_set:Nn \l__xtable_parse_status_int {2}
          \str_clear:N \l__xtable_tmpa_str
        }
      }
      { \msg_error:nnn {xtable} {unknown_input} {#1} }
  }
\cs_new:Nn \__xtable_parse_json_auxb:n
  {
    \str_case_e:nnF {#1}
      {
        {\c__xtable_space_str} {}  % 空白，跳过
        {,} {}                % 行分隔，跳过
        {]}                   % 数组结束
        { \int_set:Nn \l__xtable_parse_status_int {0} }
        {\c__xtable_lbrace_str}    % 行开始
        {
          \int_set:Nn \l__xtable_parse_status_int {2}
          \str_clear:N \l__xtable_tmpa_str
        }
      }
      { \msg_error:nnn {xtable} {unknown_input} {#1} }
  }
\cs_new:Nn \__xtable_parse_json_auxc:n
  {
    \bool_if:NTF \l__xtable_esc_status_bool % 转义状态
      { \bool_set_false:N \l__xtable_esc_status_bool }
      {
        \str_if_eq:VnTF \c__xtable_escape_str {#1} % 即将转义
          { \bool_set_true:N \l__xtable_esc_status_bool }
          {
            \bool_if:NTF \l__xtable_quote_status_bool % 引用状态
              {
                \str_if_eq:nnT {"} {#1} % 结束引用
                  { \bool_set_false:N \l__xtable_quote_status_bool }
              }
              {
                \str_if_eq:nnTF {"} {#1} % 即将引用
                  { \bool_set_true:N \l__xtable_quote_status_bool }
                  {
                    \str_if_eq:VnT \c__xtable_rbrace_str {#1} % 行结束
                      {
                        \int_set:Nn \l__xtable_parse_status_int {1}
                        \seq_put_right:NV \l__xtable_row_input_seq \l__xtable_tmpa_str
                      }
                  }
              }
          }
      }
    \str_put_right:Nn \l__xtable_tmpa_str {#1}
  }
\cs_new:Nn \__xtable_parse_json_row:n
  {
    \regex_extract_all:NnN
      \c__xtable_json_cell_regex {#1} \l__xtable_cell_input_seq
    \bool_until_do:nn
      { \seq_if_empty_p:N \l__xtable_cell_input_seq }
      {
        \seq_pop_left:NN \l__xtable_cell_input_seq \l__xtable_tmpa_tl % 丢弃
        \seq_pop_left:NN \l__xtable_cell_input_seq \l__xtable_cachea_tl
        \seq_pop_left:NN \l__xtable_cell_input_seq \l__xtable_tmpa_tl
        \seq_pop_left:NN \l__xtable_cell_input_seq \l__xtable_tmpb_tl
        \tl_if_empty:NTF \l__xtable_tmpa_tl
          { \tl_set_eq:NN \l__xtable_cacheb_tl \l__xtable_tmpb_tl }
          { \tl_set_eq:NN \l__xtable_cacheb_tl \l__xtable_tmpa_tl }
        \int_set_eq:NN \l__xtable_cachea_int \l__xtable_col_loc_int
        \__xtable_parse_new_col_loc:V \l__xtable_cachea_tl
        \int_set_eq:NN \l__xtable_tmpa_int \l__xtable_col_loc_int
        \int_compare:nNnTF {\l__xtable_cachea_int} = {\l__xtable_col_loc_int}
          { \int_incr:N \l__xtable_col_loc_int }
          { \int_set_eq:NN \l__xtable_col_loc_int \l__xtable_cachea_int }
        \__xtable_set_cell:NNV
          \l__xtable_row_loc_int \l__xtable_tmpa_int \l__xtable_cacheb_tl
      }
    \int_incr:N \l__xtable_row_loc_int
  }
\cs_new:Nn \__xtable_parse_json:n
  {
    \int_zero:N \l__xtable_parse_status_int
    \bool_set_false:N \l__xtable_esc_status_bool
    \bool_set_false:N \l__xtable_quote_status_bool
    \str_clear:N \l__xtable_tmpa_str
    \seq_clear:N \l__xtable_row_input_seq
    \str_map_inline:nn {#1} % 解析 JSON 中的行
      {
        \int_case:nn
          { \l__xtable_parse_status_int }
          {
            {0} { \__xtable_parse_json_auxa:n {##1} } % 开始
            {1} { \__xtable_parse_json_auxb:n {##1} } % 行间状态
            {2} { \__xtable_parse_json_auxc:n {##1} } % 行内状态
          }
      }
    \seq_map_function:NN \l__xtable_row_input_seq \__xtable_parse_json_row:n
  }
\cs_generate_variant:Nn \__xtable_parse_json:nnn {een}
\NewDocumentCommand {\loadtable} { m }
  {
    \__xtable_check_input_env:n {\loadtable}
    \__xtable_table_restore:n {#1}
  }
\NewDocumentCommand {\savetable} { m }
  {
    \__xtable_check_input_env:n {\savetable}
    \__xtable_table_save:n {#1}
  }
\NewDocumentCommand {\excelcolname} { O{26} }
  {
    \__xtable_check_input_env:n {\excelcolname}
    \__xtable_set_excel_col_names:n {#1}
  }
\NewDocumentCommand {\rowname} { D(){} O{,} m }
  {
    \__xtable_check_input_env:n {\rowname}
    \str_if_empty:nTF {#1}
      { \int_set:Nn \l__xtable_row_loc_int {1} }
      { \int_set:Nn \l__xtable_row_loc_int {#1} }
    \seq_set_split:Nnn \l__xtable_cell_input_seq {#2} {#3}
    \seq_map_inline:Nn \l__xtable_cell_input_seq
      {
        \__xtable_set_row_name:nN {##1} \l__xtable_row_loc_int
        \int_incr:N \l__xtable_row_loc_int
      }
  }
\NewDocumentCommand {\colname} { D(){} O{,} m }
  {
    \__xtable_check_input_env:n {\colname}
    \str_if_empty:nTF {#1}
      { \int_set:Nn \l__xtable_col_loc_int {1} }
      { \int_set:Nn \l__xtable_col_loc_int {#1} }
    \seq_set_split:Nnn \l__xtable_cell_input_seq {#2} {#3}
    \seq_map_inline:Nn \l__xtable_cell_input_seq
      {
        \__xtable_set_col_name:nN {##1} \l__xtable_col_loc_int
        \int_incr:N \l__xtable_col_loc_int
      }
  }
\NewDocumentCommand {\__xtable_row:nnn} { D(){} O{,} m }
  {
    \str_if_empty:nTF {#1}
      {
        \int_set:Nn \l__xtable_row_loc_int { \g__xtable_row_count_int + 1}
        \int_set:Nn \l__xtable_col_loc_int {1}
      }
      {
        \str_if_in:nnTF {#1} {,}
          {
            \int_zero:N \l__xtable_row_loc_int
            \int_zero:N \l__xtable_col_loc_int
            \__xtable_parse_new_coord:n {#1}
          }
          {
            \int_zero:N \l__xtable_row_loc_int
            \int_set:Nn \l__xtable_col_loc_int {1}
            \__xtable_parse_new_row_loc:n {#1}
          }
      }
    \seq_set_split:Nnn \l__xtable_cell_input_seq {#2} {#3}
    \seq_map_inline:Nn \l__xtable_cell_input_seq
      {
        \__xtable_set_cell:n {##1}
        \int_incr:N \l__xtable_col_loc_int
      }
  }
\NewDocumentCommand {\__xtable_col:nnn} { D(){} O{,} m }
  {
    \str_if_empty:nTF {#1}
      {
        \int_set:Nn \l__xtable_row_loc_int {1}
        \int_set:Nn \l__xtable_col_loc_int { \g__xtable_col_count_int + 1}
      }
      {
        \str_if_in:nnTF {#1} {,}
          {
            \int_zero:N \l__xtable_row_loc_int
            \int_zero:N \l__xtable_col_loc_int
            \__xtable_parse_new_coord:n {#1}
          }
          {
            \int_set:Nn \l__xtable_row_loc_int {1}
            \int_zero:N \l__xtable_col_loc_int
            \__xtable_parse_new_col_loc:n {#1}
          }
      }
    \seq_set_split:Nnn \l__xtable_cell_input_seq {#2} {#3}
    \seq_map_inline:Nn \l__xtable_cell_input_seq
      {
        \__xtable_set_cell:n {##1}
        \int_incr:N \l__xtable_row_loc_int
      }
  }
\NewDocumentCommand {\__xtable_cell:nn} { r() m}
  {
    \int_zero:N \l__xtable_row_loc_int
    \int_zero:N \l__xtable_col_loc_int
    \__xtable_parse_new_coord:n {#1}
    \__xtable_set_cell:n {#2}
  }
\NewDocumentEnvironment{__xtable_data:}{O{} +b}
  {
    \keys_set:nn { xtable/input } {#1}
    \str_case:VnF \l__xtable_input_format_tl
      {
        {inner} { \__xtable_parse_input:n {#2} }
        {csv}   { \__xtable_parse_csv:n   {#2} }
        {json}  { \__xtable_parse_json:n  {#2} }
      }
      { \msg_error:nnV {xtable} {unknown_format} \l__xtable_input_format_tl }
  }
  {}
\NewDocumentEnvironment{xtable}{ O{} }
  {
    \__xtable_table_init:
    \keys_set:nn { xtable/input } {#1}
    \bool_gset_eq:NN
      \g__xtable_has_header_bool \l__xtable_input_has_header_bool
    \cs_set_eq:NN \data \__xtable_data:
    \cs_set_eq:NN \enddata \end__xtable_data:
    \cs_set_eq:NN \row  \__xtable_row:nnn
    \cs_set_eq:NN \col  \__xtable_col:nnn
    \cs_set_eq:NN \cell \__xtable_cell:nn
    \bool_set_true:N \l__xtable_input_bool
  }
  {
    \bool_set_false:N \l__xtable_input_bool
    \__xtable_insure_style:
    \__xtable_process_header:
  }
\NewDocumentCommand {\rowheight} { O{auto} m }
  {
    \__xtable_check_input_env:n {\rowheight}
    \tl_if_empty:nTF {#2}
      { \seq_clear:N \l__xtable_shared_seq }
      { \seq_set_split:Nnn \l__xtable_shared_seq {,} {#2} }
    \regex_extract_all:NnNF
      \c__xtable_row_ht_regex {#1} \l__xtable_tmpa_seq
      { \msg_error:nnn {xtable} {unknown_format} {#1} }
    \seq_map_inline:Nn \l__xtable_shared_seq
      {
        \regex_extract_all:NnNF
          \c__xtable_row_ht_regex {##1} \l__xtable_tmpa_seq
          { \msg_error:nnn {xtable} {unknown_format} {##1} }
      }
    \__xtable_set_row_ht_style:Nn \l__xtable_shared_seq {#1}
   }
\NewDocumentCommand {\colwidth} { O{auto} O{\textwidth} m }
  {
    \__xtable_check_input_env:n {\colwidth}
    \tl_if_empty:nTF {#3}
      { \seq_clear:N \l__xtable_shared_seq }
      { \seq_set_split:Nnn \l__xtable_shared_seq {,} {#3} }
    \regex_extract_all:NnNF
      \c__xtable_col_wd_regex {#1} \l__xtable_tmpa_seq
      { \msg_error:nnn {xtable} {unknown_format} {#1} }
    \seq_map_inline:Nn \l__xtable_shared_seq
      {
        \regex_extract_all:NnNF
          \c__xtable_col_wd_regex {##1} \l__xtable_tmpa_seq
          { \msg_error:nnn {xtable} {unknown_format} {##1} }
      }
    \__xtable_set_col_wd_style:Nnn \l__xtable_shared_seq {#1} {#2}
  }
\NewDocumentCommand {\rowalign} { O{b} m }
  {
    \__xtable_check_input_env:n {\rowalign}
    \regex_extract_all:nnNF
      {^(?:(?:.*=)?[tmb],?)*$} {#1#2} \l__xtable_tmpa_seq
      { \msg_error:nnn {xtable} {unknown_format} {[#1],{#2}} }
    \str_if_in:nnTF {#2} {=}
      { \seq_set_split:Nnn \l__xtable_shared_seq {,} {#2} }
      {
        \tl_set:Nn \l__xtable_tmpa_tl {#2}
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {,} {}
        \seq_set_split:NnV \l__xtable_shared_seq {} \l__xtable_tmpa_tl
      }
    \__xtable_set_row_align:Nn \l__xtable_shared_seq {#1}
  }
\NewDocumentCommand {\colalign} { O{c} m }
  {
    \__xtable_check_input_env:n {\colalign}
    \regex_extract_all:nnNF
      {^(?:(?:.*=)?[lcr],?)*$} {#1#2} \l__xtable_tmpa_seq
      { \msg_error:nnn {xtable} {unknown_format} {[#1],{#2}} }
    \str_if_in:nnTF {#2} {=}
      { \seq_set_split:Nnn \l__xtable_shared_seq {,} {#2} }
      {
        \tl_set:Nn \l__xtable_tmpa_tl {#2}
        \tl_replace_all:Nnn \l__xtable_tmpa_tl {,} {}
        \seq_set_split:NnV \l__xtable_shared_seq {} \l__xtable_tmpa_tl
      }
    \__xtable_set_col_align:Nn \l__xtable_shared_seq {#1}
  }
\dim_new:N \l__xtable_expand_start_dim
\dim_new:N \l__xtable_expand_end_dim
\dim_new:N \l__xtable_offset_x_dim
\dim_new:N \l__xtable_offset_y_dim
\cs_new:Nn \__xtable_draw_hline:n
  {
    \draw_path_moveto:n
      {
        \seq_item:Nn \g__xtable_col_loc_seq {1} - \l__xtable_expand_start_dim,
        \seq_item:Nn \g__xtable_row_loc_seq {#1}
      }
    \draw_path_lineto:n
      {
        \seq_item:Nn \g__xtable_col_loc_seq {-1} + \l__xtable_expand_end_dim,
        \seq_item:Nn \g__xtable_row_loc_seq {#1}
      }
  }
\cs_new:Nn \__xtable_draw_vline:n
  {
    \draw_path_moveto:n
      {
        \seq_item:Nn \g__xtable_col_loc_seq {#1},
        \seq_item:Nn \g__xtable_row_loc_seq {1} + \l__xtable_expand_start_dim
      }
    \draw_path_lineto:n
      {
        \seq_item:Nn \g__xtable_col_loc_seq {#1},
        \seq_item:Nn \g__xtable_row_loc_seq {-1} - \l__xtable_expand_end_dim
      }
  }
\cs_new:Nn \__xtable_print_data:nnn
  {
    \str_if_in:nnTF {tmb} {#1}
      { \tl_set:Nn \l__xtable_tmpb_tl {#1} }
      { \tl_set:Nn \l__xtable_tmpb_tl {b} }
    \str_case:nnF {#2}
      {
        {l} { \tl_set:Nn \l__xtable_tmpa_tl {\raggedright} }
        {c} { \tl_set:Nn \l__xtable_tmpa_tl {\centering} }
        {r} { \tl_set:Nn \l__xtable_tmpa_tl {\raggedleft} }
      }
      { \tl_set:Nn \l__xtable_tmpa_tl {} }
    \tl_if_empty:nT {#3}
      { \tl_put_right:Nn \l__xtable_tmpa_tl {\rule{1pt}{0pt}} }
    \str_case:Vn \l__xtable_tmpb_tl
      {
        {t}
        {
          \vbox_set_top:Nn \l__xtable_tmpa_box
            {
              \baselineskip=\g__xtable_cell_lineskip_dim
              \hsize=\l__xtable_wd_dim \parindent=0pt
              \l__xtable_tmpa_tl #3 \vfill \par
            }
        }
        {m}
        {
          \dim_set:Nn \l__xtable_tmpa_dim
            { (\l__xtable_ht_dim - \l__xtable_cachea_dim)/2 + \l__xtable_ufill_dim }
          \vbox_set_to_ht:Nnn \l__xtable_tmpa_box {\l__xtable_ht_dim}
            {
              \baselineskip=\g__xtable_cell_lineskip_dim
              \hsize=\l__xtable_wd_dim \parindent=0pt
              \vskip \l__xtable_tmpa_dim
              \l__xtable_tmpa_tl #3 \vfill \par
            }
        }
        {b}
        {
          \dim_set:Nn \l__xtable_tmpa_dim
            { \l__xtable_ht_dim - \l__xtable_cachea_dim + \l__xtable_ufill_dim }
          \vbox_set:Nn \l__xtable_tmpa_box
            {
              \baselineskip=\g__xtable_cell_lineskip_dim
              \hsize=\l__xtable_wd_dim \parindent=0pt
              \vskip \l__xtable_tmpa_dim
              \l__xtable_tmpa_tl #3 \par
            }
        }
      }
    \dim_compare:nNnT {\box_dp:N \l__xtable_tmpa_box} < {\l__xtable_dp_dim}
      { \box_set_dp:Nn \l__xtable_tmpa_box {\l__xtable_dp_dim} }
    \box_use:N \l__xtable_tmpa_box
  }
\cs_generate_variant:Nn \__xtable_print_data:nnn {VVV}
\NewDocumentCommand \printtable { s O{0em} }
  {
    \__xtable_set_col_sep:ne {0pt} { \dim_use:N \g__xtable_col_sep_dim }
    \__xtable_calc_col_wd: \__xtable_calc_row_ht:
    \bool_if:NTF \g__xtable_has_header_bool
      { \int_set:Nn \l__xtable_cachea_int {1} }
      { \int_set:Nn \l__xtable_cachea_int {0} }
    \int_step_inline:nnn {1-\l__xtable_cachea_int} {\g__xtable_row_count_int}
      {
        \hbox:n
          {
            \dim_zero:N \l__xtable_tmpa_dim
            \int_step_inline:nn {\g__xtable_col_count_int}
              {
                \int_compare:nNnTF {####1} = {1}
                  { \hspace{#2} }
                  { \hspace{\g__xtable_col_sep_dim} }
                \__xtable_parse_cell:nn      {##1} {####1}
                \__xtable_parse_cell_fill:nn {##1} {####1}
                \__xtable_parse_cell_ht:nn   {##1} {####1}
                \dim_set_eq:NN \l__xtable_cachea_dim \l__xtable_ht_dim
                \__xtable_parse_cell_size:nn {##1} {####1}
                \__xtable_parse_row_align:n  {##1}
                \__xtable_parse_col_align:n  {####1}
                \__xtable_print_data:VVV
                  \l__xtable_row_align_tl \l__xtable_col_align_tl \l__xtable_data_tl
              }
          }
        \IfBooleanF {#1}
          { \int_compare:nNnT {##1} < {\g__xtable_row_count_int} {\\} }
      }
  }
\cs_new:Nn \__xtable_render_data:nnn
  {
    \str_case:nnF{#2}
      {
        {l} { \tl_set:Nn \l__xtable_tmpa_tl {\raggedright} }
        {c} { \tl_set:Nn \l__xtable_tmpa_tl {\centering} }
        {r} { \tl_set:Nn \l__xtable_tmpa_tl {\raggedleft} }
      }
      { \tl_set:Nn \l__xtable_tmpa_tl {} }
    \tl_if_empty:nTF {#3}
      { \tl_set:Nn \l__xtable_tmpb_tl {\rule{1pt}{0pt}} }
      { \tl_set:Nn \l__xtable_tmpb_tl {#3} }
    \str_if_eq:nnTF {#1} {t}
      { \vbox_set_top:Nn } { \vbox_set:Nn }
      \l__xtable_cell_box
      {
        \baselineskip=3ex \hsize=\l__xtable_wd_dim \parindent=0pt
        \l__xtable_tmpa_tl \l__xtable_tmpb_tl \par
      }
  }
\cs_generate_variant:Nn \__xtable_render_data:nnn {VVV}
\cs_new:Nn \__xtable_draw_cell:nn
  {
    \__xtable_parse_cell:nn      {#1} {#2}
    \__xtable_parse_cell_fill:nn {#1} {#2}
    \__xtable_parse_cell_size:nn {#1} {#2}
    \__xtable_parse_row_align:n  {#1}
    \__xtable_parse_col_align:n  {#2}
    \__xtable_render_data:VVV
      \l__xtable_row_align_tl \l__xtable_col_align_tl \l__xtable_data_tl
    \tl_if_eq:NnTF \l__xtable_row_align_tl {m}
      {
        \dim_set:Nn \l__xtable_tmpb_dim
          { \box_ht:N \l__xtable_cell_box + \l__xtable_ufill_dim }
        \dim_set:Nn \l__xtable_tmpa_dim
          { \l__xtable_y_dim - \l__xtable_tmpb_dim }
        \dim_sub:Nn \l__xtable_tmpa_dim
          { (\l__xtable_ht_dim - \l__xtable_tmpb_dim) / 2 }
      }
      {
        \dim_set:Nn \l__xtable_tmpa_dim
          { \l__xtable_y_dim - \l__xtable_ht_dim }
      }
    \draw_box_use:Nn \l__xtable_cell_box {\l__xtable_x_dim, \l__xtable_tmpa_dim }
  }
\cs_new:Nn \__xtable_draw_cells:
  {
    \dim_set:Nn \l__xtable_y_dim {-\c__xtable_std_dp_dim / 3} % 补偿
    \bool_if:NTF \g__xtable_has_header_bool
      { \int_set:Nn \l__xtable_tmpa_int {0} }
      {
        \int_set:Nn \l__xtable_tmpa_int {1}
        \dim_sub:Nn \l__xtable_y_dim { \seq_item:Nn \g__xtable_row_sep_seq {1} }
        \dim_add:Nn \l__xtable_y_dim { \seq_item:Nn \g__xtable_row_sep_seq {2} }
      }
    \int_step_inline:nnn {\l__xtable_tmpa_int} {\g__xtable_row_count_int}
      {
        \dim_sub:Nn \l__xtable_y_dim { \seq_item:Nn \g__xtable_row_sep_seq {##1+1} }
        \dim_zero:N \l__xtable_x_dim
        \int_step_inline:nn {\g__xtable_col_count_int}
          {
            \dim_add:Nn \l__xtable_x_dim { \seq_item:Nn \g__xtable_col_sep_seq {####1} }
            \__xtable_draw_cell:nn {##1} {####1}
            \dim_add:Nn \l__xtable_x_dim { \l__xtable_wd_dim  }
          }
        \dim_sub:Nn \l__xtable_y_dim
          { \l__xtable_ht_dim + \l__xtable_dp_dim }
      }
  }
\cs_new:Nn \__xtable_draw_booktabs:n
  {
    \dim_zero:N \l__xtable_expand_start_dim
    \dim_zero:N \l__xtable_expand_end_dim
    \__xtable_set_line_style:n {toprule}
    \__xtable_draw_hline:n {1}
    \draw_path_use_clear:n { stroke }
    \bool_if:NTF \g__xtable_has_header_bool
      {
        \__xtable_set_line_style:n {midrule}
        \__xtable_draw_hline:n {2}
        \draw_path_use_clear:n { stroke }
        \int_set:Nn \l__xtable_cachea_int {2}
      }
      { \int_set:Nn \l__xtable_cachea_int {1} }
    \__xtable_set_line_style:n {bottomrule}
    \__xtable_draw_hline:n {-1}
    \draw_path_use_clear:n { stroke }
    \__xtable_set_line_style:n {cmidrule}
    \clist_map_inline:nn {#1}
      { \__xtable_draw_hline:n {##1+\l__xtable_cachea_int}  }
    \draw_path_use_clear:n { stroke }
    \__xtable_rendertable_post:
  }
\NewDocumentCommand {\__xtable_row_line:nn} { O{} m }
  {
    \tl_set:Nn \l__xtable_style_tl {#1}
    \tl_if_empty:nTF {#2}
      { \seq_clear:N \l__xtable_shared_seq }
      {
        \seq_set_split:Nnn \l__xtable_shared_seq {,} {#2}
        \seq_get_left:NN \l__xtable_shared_seq \l__xtable_tmpa_tl
        \str_if_in:NnF \l__xtable_tmpa_tl {=}
          { \seq_pop_left:NN \l__xtable_shared_seq \l__xtable_style_tl }
      }
    \__xtable_set_row_style:NNn \g__xtable_row_border_seq
      \l__xtable_shared_seq {#1}
    \bool_if:NF \g__xtable_has_header_bool
      { \seq_gpop_left:NN \g__xtable_row_border_seq \l__xtable_tmpa_tl }
    \seq_gput_left:NV \g__xtable_row_border_seq \l__xtable_style_tl
  }
\NewDocumentCommand {\__xtable_col_line:nn} { O{} m }
  {
    \tl_set:Nn \l__xtable_style_tl {#1}
    \tl_if_empty:nTF {#2}
      { \seq_clear:N \l__xtable_shared_seq }
      {
        \seq_set_split:Nnn \l__xtable_shared_seq {,} {#2}
        \seq_get_left:NN \l__xtable_shared_seq \l__xtable_tmpa_tl
        \str_if_in:NnF \l__xtable_tmpa_tl {=}
          { \seq_pop_left:NN \l__xtable_shared_seq \l__xtable_style_tl }
      }
    \__xtable_set_col_style:NNn \g__xtable_col_border_seq
      \l__xtable_shared_seq {#1}
    \seq_gput_left:NV \g__xtable_col_border_seq  \l__xtable_style_tl
  }
\cs_new:Nn \__xtable_calc_grid_expand:N
  {
    \seq_if_empty:NTF #1
      { \seq_set_split:Nnn \l__xtable_tmpa_seq {,} {0pt} }
      { \seq_set_eq:NN \l__xtable_tmpa_seq #1 }
    \seq_get_left:NN \l__xtable_tmpa_seq \l__xtable_style_tl
    \tl_if_empty:NTF \l__xtable_style_tl
      { \dim_zero:N \l__xtable_expand_start_dim }
      {
        \__xtable_parse_line_style:V \l__xtable_style_tl
        \dim_set:Nn \l__xtable_expand_start_dim
          { \l__xtable_line_dim/2 }
      }
    \seq_get_right:NN \l__xtable_tmpa_seq \l__xtable_style_tl
    \tl_if_empty:NTF \l__xtable_style_tl
      { \dim_zero:N \l__xtable_expand_end_dim }
      {
        \__xtable_parse_line_style:V \l__xtable_style_tl
        \dim_set:Nn \l__xtable_expand_end_dim
          { \l__xtable_line_dim/2 }
      }
  }
\cs_new:Nn \__xtable_draw_grid:nn
  {
    \group_begin:
      \cs_set_eq:NN \rowborder \__xtable_row_line:nn
      \cs_set_eq:NN \colborder \__xtable_col_line:nn
      #2
    \group_end:
    \__xtable_calc_grid_expand:N \g__xtable_row_border_seq
    \int_step_inline:nn  {\seq_count:N \g__xtable_col_loc_seq}
      {
        \tl_set:Ne \l__xtable_style_tl
          { \seq_item:Nn \g__xtable_col_border_seq {##1} }
        \tl_if_empty:NF \l__xtable_style_tl
          {
            \__xtable_set_line_style:V \l__xtable_style_tl
            \__xtable_draw_vline:n {##1}
            \draw_path_use_clear:n { stroke }
          }
      }
    \__xtable_calc_grid_expand:N \g__xtable_col_border_seq
    \int_step_inline:nn  {\seq_count:N \g__xtable_row_loc_seq}
      {
        \tl_set:Ne \l__xtable_style_tl
          { \seq_item:Nn \g__xtable_row_border_seq {##1} }
        \tl_if_empty:NF \l__xtable_style_tl
          {
            \__xtable_set_line_style:V \l__xtable_style_tl
            \__xtable_draw_hline:n {##1}
            \draw_path_use_clear:n { stroke }
          }
      }
    \__xtable_rendertable_post:
  }
\cs_new:Nn \__xtable_draw_cell_border:nn
  {
    \__xtable_parse_cell_size:nn {#1} {#2}
    \dim_set:Nn \l__xtable_tmpa_dim
      {\l__xtable_wd_dim + \g__xtable_col_margin_dim * 2}
    \dim_set:Nn \l__xtable_tmpb_dim
      {\l__xtable_ht_dim + \l__xtable_dp_dim + \g__xtable_row_margin_dim * 2}
    \draw_path_rectangle:nn
      {\l__xtable_x_dim, \l__xtable_y_dim - \l__xtable_tmpb_dim }
      {\l__xtable_tmpa_dim, \l__xtable_tmpb_dim }
    \draw_path_use_clear:n { draw }
  }
\cs_new:Nn \__xtable_draw_cell_borders:
  {
    \dim_zero:N \l__xtable_y_dim
    \int_step_inline:nnn
      { \bool_if:NTF \g__xtable_has_header_bool {0} {1} }
      {\g__xtable_row_count_int}
      {
        \dim_zero:N \l__xtable_x_dim
        \int_step_inline:nn {\g__xtable_col_count_int}
          {
            \__xtable_draw_cell_border:nn {##1} {####1}
            \dim_set:Nn \l__xtable_x_dim
              { \l__xtable_x_dim + \l__xtable_wd_dim + \g__xtable_col_margin_dim * 2 }
          }
        \dim_set:Nn \l__xtable_y_dim
          { \l__xtable_y_dim - \l__xtable_ht_dim - \l__xtable_dp_dim - \g__xtable_row_margin_dim * 2 }
      }
    \__xtable_rendertable_post:
  }
\cs_new:Nn \__xtable_set_table_sep:n
  {
    \__xtable_set_row_sep:ee
      { \dim_use:N \g__xtable_row_margin_dim }
      { \dim_eval:n { \g__xtable_row_margin_dim * 2 } }
    \__xtable_set_col_sep:ee
      {
        \bool_if:nTF {#1}
          { \dim_use:N \g__xtable_col_margin_dim }
          { 0pt }
      }
      { \dim_eval:n { \g__xtable_col_margin_dim * 2 } }
  }
\cs_new:Nn \__xtable_rendertable_pre:
  {
    \__xtable_set_table_sep:n {\c_true_bool}
    \__xtable_calc_col_wd:
    \__xtable_calc_row_ht:
    \__xtable_calc_coord:
    \draw_begin:
    \vbox_set_to_ht:Nnn \l__xtable_tmpa_box
      {\g__xtable_above_space_dim} {}
    \draw_box_use:N \l__xtable_tmpa_box
  }
\cs_new:Nn \__xtable_rendertable_post:
  {
    \__xtable_draw_cells:
    \draw_end:
  }
\NewDocumentCommand \rendertable { O{} O{} }
  {
    \__xtable_rendertable_pre:
    \str_case:nnF {#1}
      {
        {booktabs} { \__xtable_draw_booktabs:n {#2} }
        {grid}     { \__xtable_draw_grid:nn    {#2} }
      }
      { \__xtable_draw_cell_borders: }
  }
%% 
%%
%% End of file `tabular2.sty'.
