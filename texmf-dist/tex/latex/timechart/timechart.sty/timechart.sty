%%
%% This is file `timechart.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% timechart.dtx  (with options: `package')
%% 
%% This is a generated file.
%% 
%% Copyright (C) 2025 Alan J. Cain
%% 
%% This file may be distributed and/or modified under the
%% conditions of the LaTeX Project Public Licence, either
%% version 1.3c of this licence or (at your option) any later
%% version. The latest version of this licence is in:
%% 
%% http://www.latex-project.org/lppl.txt
%% 
%% and version 1.3c or later is part of all distributions of
%% LaTeX version 2008-05-04 or later.
%% 
\NeedsTeXFormat{LaTeX2e}[2020-02-02]
\ProvidesExplPackage{timechart}{2025-10-17}{0.56.1}
  {Typesetting chronological charts}
\cs_new:Npn \__timechart_debug_real:n #1
  {
    \typeout{timechart:~#1}
  }
\cs_set_eq:NN\__timechart_debug:n\use_none:n
\RequirePackage{tikz}
\bool_new:N\l__timechart_tmpa_bool
\bool_new:N\l__timechart_tmpb_bool
\bool_new:N\l__timechart_tmpc_bool
\bool_new:N\l__timechart_tmpd_bool
\cs_set_eq:NN\l__timechart_tmpa_dim\l_tmpa_dim
\cs_set_eq:NN\l__timechart_tmpb_dim\l_tmpb_dim
\dim_new:N\l__timechart_tmpc_dim
\dim_new:N\l__timechart_tmpd_dim
\cs_new:Npn\__timechart_make_ref:NN #1#2
  {
    \str_if_empty:NTF #1
      { #2 }
      { \hyperref[#1]{#2} }
  }
\cs_new:Npn\__timechart_pgfmathsetbool:nn #1#2
  {
    \pgfmathsetmacro{#1}{ifthenelse(#2,"\c_true_bool","\c_false_bool")}
  }
\cs_new:Npn\__timechart_if_equal:nnF #1#2#3
  {
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}{#1==#2}
    \bool_if:NF\l__timechart_tmpa_bool{#3}
  }
\cs_new:Npn\__timechart_pgfextractxy:nnn #1#2#3
  {
    \pgf@process{#3}
    #1=\pgf@x\relax
    #2=\pgf@y\relax
  }
\cs_new:Npn\__timechart_hsmash_pgfnode:nnnnn #1#2#3#4#5
  {
    \pgfinterruptboundingbox
    \pgfnode{#1}{#2}{#3}{#4}{#5}
    \pgfcoordinate
      {__timechart_tmpa_coord}
      {\pgfpointanchor{current~bounding~box}{south}}
    \pgfcoordinate
      {__timechart_tmpb_coord}
      {\pgfpointanchor{current~bounding~box}{north}}
    \endpgfinterruptboundingbox
    \pgfextractx
      {\l__timechart_tmpa_dim}
      {\pgfpointanchor{__timechart_tmpa_coord}{center}}
    \pgfextractx
      {\l__timechart_tmpb_dim}
      {\pgfpointanchor{__timechart_tmpb_coord}{center}}
    \pgfpathmoveto{\pgfpoint{\l__timechart_tmpa_dim}{0}}
    \pgfpathmoveto{\pgfpoint{\l__timechart_tmpb_dim}{0}}
    \pgfusepath{discard}
  }
\cs_new:Npn\__timechart_make_rectangle_node:nnnn #1#2#3#4
  {
    \group_begin:
    \__timechart_pgfextractxy:nnn
      {\l__timechart_tmpa_dim}{\l__timechart_tmpb_dim}{#1}
    \__timechart_pgfextractxy:nnn
      {\l__timechart_tmpc_dim}{\l__timechart_tmpd_dim}{#2}
    \pgftransformshift{#1}
    \pgfset{
      minimum~width=\l__timechart_tmpc_dim-\l__timechart_tmpa_dim,
      minimum~height=\l__timechart_tmpd_dim-\l__timechart_tmpb_dim,
      inner~sep=0,
      outer~sep=0,
    }
    \bool_if:NTF #4
      { \pgfnode{rectangle}{south~west}{}{#3}{\pgfusepath{draw}} }
      { \pgfnode{rectangle}{south~west}{}{#3}{\pgfusepath{discard}} }
    \group_end:
  }
\cs_new:Npn\__timechart_set_style_line_width:nn #1#2
  {
    \begingroup
    \tikzset{#2}
    \pgfmathsetlengthmacro{#1}{\pgflinewidth}
    \pgfmathsmuggle #1
    \endgroup
  }
\pgfkeys{
  /timechart/.cd,
  debug/.code = {
    \cs_set_eq:NN\__timechart_debug:n\__timechart_debug_real:n
  },
  no~debug/.code = {
    \cs_set_eq:NN\__timechart_debug:n\use_none:n
  },
  width/.initial=\textwidth,
  ystep/.initial=-10pt,
  minor~tick~interval/.initial=10,
  major~tick~interval/.initial=50,
  tolerance~start/.initial=5pt,
  tolerance~finish/.initial=5pt,
  beyond~length~start/.initial=5pt,
  beyond~length~finish/.initial=5pt,
  beyond~x~radius~start/.initial=4pt,
  beyond~x~radius~finish/.initial=4pt,
  tolerance/.code = {
    \pgfkeyssetvalue{/timechart/tolerance~start}{#1}
    \pgfkeyssetvalue{/timechart/tolerance~finish}{#1}
  },
  beyond~length/.code = {
    \pgfkeyssetvalue{/timechart/beyond~length~start}{#1}
    \pgfkeyssetvalue{/timechart/beyond~length~finish}{#1}
  },
  beyond~x~radius/.code = {
    \pgfkeyssetvalue{/timechart/beyond~x~radius~start}{#1}
    \pgfkeyssetvalue{/timechart/beyond~x~radius~finish}{#1}
  },
  no~grid/.code = { \bool_set_false:N\l__timechart_grid_bool },
  grid~top~ysep/.initial={3pt},
  grid~bottom~ysep/.initial={3pt},
  grid/.style={},
  axis~line/.style={
    line~cap=rect,
  },
  axis~ysep/.initial=3pt,
  axis/.is~choice,
  axis/none/.code
    = { \int_set:Nn\l__timechart_axis_int{0} },
  axis/above/.code
    = { \int_set:Nn\l__timechart_axis_int{1} },
  axis/below/.code
    = { \int_set:Nn\l__timechart_axis_int{2} },
  no~axis/.code = { \int_set:Nn\l__timechart_axis_int{0} },
  minor~tick/.style={},
  minor~tick~length/.initial=1.5mm,
  major~tick/.style={},
  major~tick~length/.initial=3mm,
  major~tick~label/.style={
    inner~sep=0,
    outer~sep=0,
    anchor=mid~west,
    rotate=90,
  },
  major~tick~eras/.is~choice,
  major~tick~eras/none/.code
    = { \int_set:Nn\l__timechart_major_tick_eras_int{0} },
  major~tick~eras/all/.code
    = { \int_set:Nn\l__timechart_major_tick_eras_int{1} },
  major~tick~eras/outer/.code
    = { \int_set:Nn\l__timechart_major_tick_eras_int{2} },
  no~autostep/.code = { \bool_set_false:Nz\l__timechart_autostep_bool },
  ref/.initial={},
  mark/.initial={},
  marks/.forward~to=/timechart/mark,
  circa~uncertainty/.initial=3,
  interval~minimum~width/.initial=1pt,
  interval~bar~color/.initial=black,
  interval~bar~thickness/.initial=8pt,
  interval~bar~node~name/.initial = {bar~node},
  interval~mark~color/.initial=gray,
  interval~label/.style={},
  interval~label~centered/.style={/timechart/interval~label,text=white},
  interval~label~centered~background/.style={/timechart/interval~label},
  interval~label~baseline/.initial=-3pt,
  interval~label~pos/.is~choice,
  interval~label~pos/left/.code
    = { \int_set:Nn\l__timechart_label_pos_int{0} },
  interval~label~pos/center/.code
    = { \int_set:Nn\l__timechart_label_pos_int{1} },
  interval~label~pos/right/.code
    = { \int_set:Nn\l__timechart_label_pos_int{2} },
  interval~label~node~name/.initial = {label~node},
  start~range/.is~choice,
  start~range/fade/.code
    = { \int_set:Nn\l__timechart_start_range_type_int{0} },
  start~range/slant/.code
    = { \int_set:Nn\l__timechart_start_range_type_int{1} },
  finish~range/.is~choice,
  finish~range/fade/.code
    = { \int_set:Nn\l__timechart_finish_range_type_int{0} },
  finish~range/slant/.code
    = { \int_set:Nn\l__timechart_finish_range_type_int{1} },
  text~node~name/.initial = {text~node},
  text/.style={},
  text~baseline/.initial=-3pt,
  text~pos/.is~choice,
  text~pos/left/.code = { \int_set:Nn\l__timechart_text_pos_int{0} },
  text~pos/center/.code = { \int_set:Nn\l__timechart_text_pos_int{1} },
  text~pos/right/.code = { \int_set:Nn\l__timechart_text_pos_int{2} },
  legend~item~width/.initial=9mm,
  legend~item~range~width/.initial=3mm,
  left/.code = {
    \int_set:Nn\l__timechart_label_pos_int{0}
    \int_set:Nn\l__timechart_text_pos_int{0}
  },
  center/.code = {
    \int_set:Nn\l__timechart_label_pos_int{1}
    \int_set:Nn\l__timechart_text_pos_int{1}
  },
  right/.code = {
    \int_set:Nn\l__timechart_label_pos_int{2}
    \int_set:Nn\l__timechart_text_pos_int{2}
  },
}
\bool_new:N\l__timechart_grid_bool
\bool_set_true:N\l__timechart_grid_bool
\int_new:N\l__timechart_axis_int
\int_set:Nn\l__timechart_axis_int{1}
\int_new:N\l__timechart_major_tick_eras_int
\int_set:Nn\l__timechart_major_tick_eras_int{2}
\bool_new:N\l__timechart_autostep_bool
\bool_set_true:N\l__timechart_autostep_bool
\int_new:N \l__timechart_label_pos_int
\int_new:N \l__timechart_text_pos_int
\int_new:N \l__timechart_start_range_type_int
\int_new:N \l__timechart_finish_range_type_int
\NewDocumentEnvironment{timechart}{ O{} m m }
  { \__timechart_main_begin:nnn{#1}{#2}{#3} }
  { \__timechart_main_end: }
\cs_new:Npn \__timechart_main_begin:nnn #1#2#3
  {
    \pgfkeys{
      /timechart/.cd,
      #1,
      width/.get=\l__timechart_width_pgf,
      ystep/.get=\l__timechart_ystep_pgf,
      grid~top~ysep/.get=\l__timechart_grid_top_ysep_pgf,
      grid~bottom~ysep/.get=\l__timechart_grid_bottom_ysep_pgf,
      minor~tick~interval/.get=\l__timechart_minor_tick_interval_year,
      major~tick~interval/.get=\l__timechart_major_tick_interval_year,
    }
    \tikzpicture
    \pgfdeclarelayer{grid}
    \pgfdeclarelayer{labelbg}
    \pgfsetlayers{grid,labelbg,main}
    \bool_if:NTF\l__timechart_grid_bool
      {
        \__timechart_set_style_line_width:nn
          {\l__timechart_grid_line_width}
          {/timechart/grid}
      }
      { \pgfmathsetlengthmacro{\l__timechart_grid_line_width}{0} }
    \int_if_zero:nTF{ \l__timechart_axis_int }
      {
        \pgfmathsetlengthmacro{\l__timechart_axis_line_width}{0}
        \pgfmathsetlengthmacro{\l__timechart_major_tick_line_width}{0}
        \pgfmathsetlengthmacro{\l__timechart_minor_tick_line_width}{0}
      }
      {
        \__timechart_set_style_line_width:nn
          {\l__timechart_axis_line_width}
          {/timechart/axis~line}
        \__timechart_set_style_line_width:nn
          {\l__timechart_major_tick_line_width}
          {/timechart/major~tick}
        \__timechart_set_style_line_width:nn
          {\l__timechart_minor_tick_line_width}
          {/timechart/minor~tick}
      }
    \__timechart_parse_date:NNn\l_tmpa_bool\l__timechart_start_year{#2}
    \__timechart_parse_date:NNn\l_tmpa_bool\l__timechart_finish_year{#3}
    \pgfmathsetmacro{\l__timechart_start_year}
      {floor(\l__timechart_start_year)}
    \pgfmathsetmacro{\l__timechart_finish_year}
      {floor(\l__timechart_finish_year)}
    \pgfmathsetmacro{\l__timechart_x}
      {
        (
          \l__timechart_width_pgf
          - max(
            \l__timechart_grid_line_width,
            \l__timechart_axis_line_width,
            \l__timechart_major_tick_line_width,
            \l__timechart_minor_tick_line_width
          )
        )/(\l__timechart_finish_year-\l__timechart_start_year)
      }
    \pgfkeys{
      /pgf/declare~function={
        yeartox(\n)=\l__timechart_x*(\n-\l__timechart_start_year);
      },
    }
    \pgfmathsetmacro{\l__timechart_start_x}
      {yeartox(\l__timechart_start_year)}
    \pgfmathsetmacro{\l__timechart_finish_x}
      {yeartox(\l__timechart_finish_year)}
    \pgfmathsetmacro{\l__timechart_current_y}{0}
    \pgfmathsetmacro{\l__timechart_saved_y}{0}
    \pgfmathsetmacro{\l__timechart_auto_reset_minimum_y}{-16000pt}
    \pgfmathsetmacro{\l__timechart_auto_reset_maximum_y}{16000pt}
    \pgfmathsetmacro{\l__timechart_start_plus_year}{
      \l__timechart_start_year+\l__timechart_minor_tick_interval_year
    }
    \pgfmathsetmacro{\l__timechart_start_plusplus_year}{
      \l__timechart_start_year+(2*\l__timechart_minor_tick_interval_year)
    }
    \pgfmathsetmacro{\l__timechart_end_minus_year}{
      \l__timechart_finish_year-\l__timechart_minor_tick_interval_year
    }
    \group_begin:
    \cs_set_eq:NN\timechartinterval\__timechart_interval_user:Ommm
    \cs_set_eq:NN\timecharttext\__timechart_text_user:Omm
    \cs_set_eq:NN\timechartspace\__timechart_space_user:O
    \cs_set_eq:NN\timechartsety\__timechart_set_y_user:m
    \cs_set_eq:NN\timechartsavey\__timechart_save_y_user:
    \cs_set_eq:NN\timechartresety\__timechart_reset_y_user:
    \cs_set_eq:NN\timechartsetyminimumautoreset
      \__timechart_set_y_minimum_auto_reset_user:m
    \cs_set_eq:NN\timechartsetymaximumautoreset
      \__timechart_set_y_maximum_auto_reset_user:m
    \cs_set_eq:NN\timechartstepy\__timechart_step_y_user:O
    \cs_set_eq:NN\timechartfinish\__timechart_main_end_user:
  }
\cs_new:Npn\__timechart_main_end:
  {
    \cs_if_eq:NNT\timechartfinish\__timechart_main_end_user:
      { \__timechart_main_end_user: }
    \endtikzpicture
  }
\cs_new:Npn\__timechart_main_end_user:
  {
    \pgfextracty{\l__timechart_tmpa_dim}
      { \pgfpointanchor{current~bounding~box}{south} }
    \pgfextracty{\l__timechart_tmpb_dim}
      { \pgfpointanchor{current~bounding~box}{north} }
    \pgfresetboundingbox
    \dim_compare:nNnTF{\l__timechart_tmpa_dim}>{\l__timechart_tmpb_dim}
      {
        \pgfmathsetmacro{\l__timechart_content_bottom_y}{0pt}
        \pgfmathsetmacro{\l__timechart_content_top_y}{0pt}
      }
      {
        \pgfmathsetmacro{\l__timechart_content_bottom_y}
          {\l__timechart_tmpa_dim}
        \pgfmathsetmacro{\l__timechart_content_top_y}
          {\l__timechart_tmpb_dim}
      }
    \bool_if:NTF{\l__timechart_grid_bool}
      { \__timechart_grid_draw: }
      { \__timechart_nogrid_bounding_box_set: }
    \__timechart_axis_draw:
    \group_end:
  }
\cs_new:Npn\__timechart_grid_draw:
  {
    \pgfmathsetmacro{\l__timechart_content_bottom_y}{
      \l__timechart_content_bottom_y-\l__timechart_grid_bottom_ysep_pgf
    }
    \pgfmathsetmacro{\l__timechart_content_top_y}{
      \l__timechart_content_top_y+\l__timechart_grid_top_ysep_pgf
    }
    \pgfonlayer{ grid }
    \scope[/timechart/grid]
    \foreach \year in {
      \l__timechart_start_plus_year,
      \l__timechart_start_plusplus_year,
      ...,
      \l__timechart_end_minus_year
    } {
      \group_begin:
      \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
        { Mod(\year,\l__timechart_major_tick_interval_year)==0 }
      \bool_if:NT\l__timechart_tmpa_bool
        {
          \pgftransformshift{ \pgfpoint{yeartox(\year)}{0} }
          \pgfpathmoveto{ \pgfpoint{0}{\l__timechart_content_top_y} }
          \pgfpathlineto{ \pgfpoint{0}{\l__timechart_content_bottom_y} }
          \pgfusepath{ draw }
        }
      \group_end:
    }
    \__timechart_make_rectangle_node:nnnn
      { \pgfpoint{\l__timechart_start_x}{\l__timechart_content_bottom_y} }
      { \pgfpoint{\l__timechart_finish_x}{\l__timechart_content_top_y} }
      { grid }
      { \c_true_bool }
    \endscope
    \endpgfonlayer
  }
\cs_new:Npn\__timechart_axis_draw:
  {
    \group_begin:
    \int_case:nn{ \l__timechart_axis_int }
    {
      {0}
      { \prg_do_nothing: }
      {1}
      {
        \pgftransformshift{
          \pgfpoint{0}{
            \l__timechart_content_top_y
            +\pgfkeysvalueof{/timechart/axis~ysep}
          }
        }
        \pgfmathsetmacro{\l__timechart_tick_orientation_pgf}{1}
        \cs_set:Npn\l__timechart_tick_label_anchor_text
          { mid~west }
        \cs_set:Npn\l__timechart_zero_tick_before_label_anchor_text
          { base~west }
        \cs_set:Npn\l__timechart_zero_tick_after_label_anchor_text
          { north~west }
        \__timechart_axis_draw_aux:
      }
      {2}
      {
        \pgftransformshift{
          \pgfpoint{0}{
            \l__timechart_content_bottom_y
            -\pgfkeysvalueof{/timechart/axis~ysep}
          }
        }
        \pgfmathsetmacro{\l__timechart_tick_orientation_pgf}{-1}
        \cs_set:Npn\l__timechart_tick_label_anchor_text
          { mid~east }
        \cs_set:Npn\l__timechart_zero_tick_before_label_anchor_text
          { base~east }
        \cs_set:Npn\l__timechart_zero_tick_after_label_anchor_text
          { north~east }
        \__timechart_axis_draw_aux:
      }
    }
    \group_end:
  }
\cs_new:Npn\__timechart_axis_draw_aux:
  {
    \pgfkeys{
      /timechart/minor~tick~length/.get=\__timechart_minor_tick_length_pgf,
      /timechart/major~tick~length/.get=\__timechart_major_tick_length_pgf,
    }
    \pgfmathsetmacro{\l__timechart_start_major_tick_year}
      {
        \l__timechart_start_year
        -Mod(
          \l__timechart_start_year,
          \l__timechart_major_tick_interval_year
        )
      }
    \pgfmathsetmacro{\l__timechart_start_major_tick_year}
      {
        ifthenelse(
          \l__timechart_start_major_tick_year<\l__timechart_start_year,
          \l__timechart_start_major_tick_year
            +\l__timechart_major_tick_interval_year,
          \l__timechart_start_major_tick_year
        )
      }
    \pgfmathsetmacro{\l__timechart_start_plus_major_tick_year}
      {
        \l__timechart_start_major_tick_year
        +\l__timechart_major_tick_interval_year
      }
    \pgfmathsetmacro{\l__timechart_finish_major_tick_year}
      {
        \l__timechart_finish_year
        -Mod(
          \l__timechart_finish_year,
          \l__timechart_major_tick_interval_year
        )
      }
    \foreach \year in {
      \l__timechart_start_year,
      \l__timechart_start_plus_year,
      ...,
      \l__timechart_finish_year
    } {
      \pgfmathsetmacro{\x}{yeartox(\year)}
      \__timechart_pgfmathsetbool:nn
        {\l__timechart_tmpa_bool}
        {
          Mod(
            \year-\l__timechart_start_major_tick_year,
            \l__timechart_major_tick_interval_year
          )==0
        }
      \bool_if:NF\l__timechart_tmpa_bool
        { \__timechart_axis_draw_minor_tick:N\x }
    }
    \foreach \year in {
      \l__timechart_start_major_tick_year,
      \l__timechart_start_plus_major_tick_year,
      ...,
      \l__timechart_finish_major_tick_year
    } {
      \pgfmathsetmacro{\x}{yeartox(\year)}
      \__timechart_axis_draw_labelled_major_tick:NN\x\year
    }
    \__timechart_draw_axis_line
    \int_case:nn{\l__timechart_axis_int}
    {
      {1}
      {
        \pgfextracty{\l__timechart_tmpa_dim}
          { \pgfpointanchor{current~bounding~box}{north} }
        \pgfmathsetmacro{\l__timechart_axis_top_y}{\l__timechart_tmpa_dim}
        \pgfmathsetmacro{\l__timechart_axis_bottom_y}{0}
      }
      {2}
      {
        \pgfextracty{\l__timechart_tmpa_dim}
          { \pgfpointanchor{current~bounding~box}{south} }
        \pgfmathsetmacro{\l__timechart_axis_top_y}{0}
        \pgfmathsetmacro{\l__timechart_axis_bottom_y}{\l__timechart_tmpa_dim}
      }
    }
    \__timechart_make_rectangle_node:nnnn
      { \pgfpoint{\l__timechart_start_x}{\l__timechart_axis_bottom_y} }
      { \pgfpoint{\l__timechart_finish_x}{\l__timechart_axis_top_y} }
      { axis }
      { \c_false_bool }
  }
\cs_new:Npn\__timechart_axis_draw_minor_tick:N #1
  {
    \scope[/timechart/minor~tick]
    \pgfpathmoveto{ \pgfpoint{#1}{0} }
    \pgfpathlineto{
      \pgfpoint{#1}{
        \l__timechart_tick_orientation_pgf
        *\__timechart_minor_tick_length_pgf
      }
    }
    \pgfusepath{draw}
    \endscope
  }
\cs_new:Npn\__timechart_axis_draw_labelled_major_tick:NN #1#2
  {
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}{#2==0}
    \bool_if:NTF \l__timechart_tmpa_bool
      { \__timechart_axis_draw_zero_tick:N #1 }
      {
        \int_case:nn { \l__timechart_major_tick_eras_int }
        {
          {0}{ \bool_set_false:N\l__timechart_tmpd_bool }
          {1}{ \bool_set_true:N\l__timechart_tmpd_bool }
          {2}
          {
            \__timechart_pgfmathsetbool:nn{\l__timechart_tmpb_bool}
              { #2==\l__timechart_start_major_tick_year }
            \__timechart_pgfmathsetbool:nn{\l__timechart_tmpc_bool}
              { #2==\l__timechart_finish_major_tick_year }
            \bool_set:Nn\l__timechart_tmpd_bool
              { \l__timechart_tmpb_bool || \l__timechart_tmpc_bool }
          }
        }
        \__timechart_axis_draw_major_tick:N #1
        \__timechart_axis_draw_year_label:nnnnnn
          { #1 }
          { #2 }
          { \l__timechart_tmpd_bool }
          { \l__timechart_tick_label_anchor_text }
          { 0 }
          {
            \l__timechart_tick_orientation_pgf
            *(\__timechart_major_tick_length_pgf+1mm)
          }
      }
  }
\cs_new:Npn\__timechart_axis_draw_major_tick:N #1
  {
    \scope[/timechart/major~tick]
    \pgfpathmoveto{ \pgfpoint{#1}{0} }
    \pgfpathlineto{
      \pgfpoint{#1}{
        \l__timechart_tick_orientation_pgf
        *\__timechart_major_tick_length_pgf
      }
    }
    \pgfusepath{draw}
    \endscope
  }
\cs_new:Npn\__timechart_axis_draw_zero_tick:N #1
  {
    \group_begin:
    \pgftransformshift{ \pgfpoint{#1}{0} }
    \pgfmathsetmacro{\a}{5}
    \pgfmathsetlengthmacro{\r}{1mm}
    \pgfmathsetlengthmacro{\t}{\r*(cos(\a)-cos(90-\a))/(1-cos(90-\a))}
    \scope[/timechart/major~tick,line~join=miter]
    \group_begin:
    \pgftransformyscale{\l__timechart_tick_orientation_pgf}
    \pgfpathmoveto{\pgfpointorigin}
    \pgfpathlineto{\pgfpoint{0}{\__timechart_major_tick_length_pgf}}
    \pgfpatharc{0}{90-\a}{\t~and~\r}
    \pgfpatharc{270+\a}{360-\a}{\r}
    \pgfpatharc{180+\a}{270-\a}{\r}
    \pgfpatharc{90+\a}{180-\a}{\t~and~\r}
    \pgfpathlineto{\pgfpoint{0}{\__timechart_major_tick_length_pgf-1pt}}
    \pgfusepath{draw}
    \group_end:
    \endscope
    \__timechart_axis_draw_year_label:nnnnnn
      { 0 }
      { -1 }
      { \c_true_bool }
      { \l__timechart_zero_tick_before_label_anchor_text }
      { -.5mm }
      { \l__timechart_tick_orientation_pgf*5.5mm }
    \__timechart_axis_draw_year_label:nnnnnn
      { 0 }
      { 1 }
      { \c_true_bool }
      { \l__timechart_zero_tick_after_label_anchor_text }
      { .5mm }
      { \l__timechart_tick_orientation_pgf*5.5mm }
    \group_end:
  }
\cs_new:Npn\__timechart_draw_axis_line
  {
    \scope[/timechart/axis~line]
    \pgfpathmoveto{ \pgfpoint{\l__timechart_start_x}{0} }
    \pgfpathlineto{ \pgfpoint{\l__timechart_finish_x}{0} }
    \pgfusepath{draw}
    \endscope
  }
\cs_new:Npn\__timechart_axis_draw_year_label:nnnnnn #1#2#3#4#5#6
  {
    \group_begin:
    \pgftransformshift{ \pgfpoint{#1+#5}{#6} }
    \pgfmathtruncatemacro{\absyear}{ abs(#2) }
    \scope[/timechart/major~tick~label]
    \bool_if:NTF #3
      {
        \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}{#2<0}
        \bool_if:NTF\l__timechart_tmpa_bool
          { \cs_set_eq:NN\__timechart_make_year:n\timechartmakebeforeyear }
          { \cs_set_eq:NN\__timechart_make_year:n\timechartmakeafteryear  }
      }
      { \cs_set_eq:NN\__timechart_make_year:n\use:n }
    \__timechart_hsmash_pgfnode:nnnnn
      {rectangle}
      {#4}
      {\__timechart_make_year:n{\absyear}}
      {}
      {}
    \endscope
    \group_end:
  }
\cs_new:Npn\timechartmakebeforeyear #1
  {
    #1\nobreakspace\textsc{bce}
  }
\cs_new:Npn\timechartmakeafteryear #1
  {
    #1\nobreakspace\textsc{ce}
  }
\cs_new:Npn\__timechart_nogrid_bounding_box_set:
  {
    \pgfpathmoveto
      { \pgfpoint{\l__timechart_start_x}{\l__timechart_content_bottom_y} }
    \pgfpathmoveto
      { \pgfpoint{\l__timechart_finish_x}{\l__timechart_content_top_y} }
    \pgfusepath{discard}
  }
\cs_new:Npn\__timechart_set_y_user:m #1
  {
    \pgfmathsetmacro{\l__timechart_current_y}{#1}
  }
\cs_new:Npn\__timechart_save_y_user:
  {
    \pgfmathsetmacro{\l__timechart_saved_y}{\l__timechart_current_y}
  }
\cs_new:Npn\__timechart_reset_y_user:
  {
    \pgfmathsetmacro{\l__timechart_current_y}{\l__timechart_saved_y}
  }
\cs_new:Npn\__timechart_set_y_minimum_auto_reset_user:m #1
  {
    \pgfmathsetmacro{\l__timechart_auto_reset_minimum_y}{#1}
  }
\cs_new:Npn\__timechart_set_y_maximum_auto_reset_user:m #1
  {
    \pgfmathsetmacro{\l__timechart_auto_reset_maximum_y}{#1}
  }
\NewDocumentCommand{\__timechart_step_y_user:O}{ O{1} }
  {
    \pgfmathsetmacro{\l__timechart_current_y}
      {\l__timechart_current_y+#1*\l__timechart_ystep_pgf}
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      {
        or(
          \l__timechart_current_y<\l__timechart_auto_reset_minimum_y,
          \l__timechart_current_y>\l__timechart_auto_reset_maximum_y
        )
      }
    \bool_if:nT{\l__timechart_tmpa_bool}
      { \pgfmathsetmacro{\l__timechart_current_y}{\l__timechart_saved_y)} }
  }
\cs_new:Npn\__timechart_if_x_in_bounds:nT #1#2
  {
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}{
      and(
        #1>=\l__timechart_start_x,
        #1<=\l__timechart_finish_x
      )
    }
    \bool_if:NT\l__timechart_tmpa_bool
      {#2}
  }

\cs_new:Npn\__timechart_if_x_range_intersect_bounds:nnT #1#2#3
  {
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}{
      or(
        or(
          and(
            #2>=\l__timechart_start_x,
            #2<=\l__timechart_finish_x
          ),
          and(
            #1>=\l__timechart_start_x,
            #1<=\l__timechart_finish_x
          )
        ),
        and(
          #1<\l__timechart_start_x,
          #2>\l__timechart_finish_x
        )
      )
    }
    \bool_if:NT\l__timechart_tmpa_bool
      {#3}
  }
\cs_new:Npn\__timechart_parse_date_or_daterange:NNNNNn #1#2#3#4#5#6
{
  \bool_set:Nn #1 {\__timechart_is_nondaterange_p:w #6/\q_stop}
  \bool_set_inverse:N #1
  \bool_if:nTF #1
    { \__timechart_parse_range:w #2#3#4#5\q_mark #6\q_stop }
    {
      \__timechart_parse_date:NNn #2#3{#6}
      \bool_set_eq:NN #4#2
      \pgfmathsetmacro{#5}{#3}
    }
}
\cs_new:Npn\__timechart_is_nondaterange_p:w #1/#2\q_stop
{
  \tl_if_empty_p:n{#2}
}
\cs_new:Npn\__timechart_parse_range:w #1#2#3#4\q_mark #5/#6\q_stop
{
  \__timechart_parse_date:NNn #1#2{#5}
  \__timechart_parse_date:NNn #3#4{#6}
}
\cs_new:Npn\__timechart_parse_date:NNn #1#2#3
{
  \bool_set:Nn #1 { \__timechart_is_circa_p:w #3c\q_stop }
  \bool_if:NTF #1
    { \__timechart_parse_circa_date:w #2\q_mark #3\q_stop }
    { \__timechart_parse_noncirca_date:Nn #2{#3} }
}
\cs_new:Npn\__timechart_is_circa_p:w #1c#2\q_stop
{
  \tl_if_empty_p:n{#1}
}
\cs_new:Npn\__timechart_parse_circa_date:w #1\q_mark c#2\q_stop
{
  \__timechart_parse_noncirca_date:Nn #1{#2}
}
\cs_new:Npn\__timechart_parse_noncirca_date:Nn #1#2
{
  \bool_if:nTF { \__timechart_is_before_p:w #2-\q_stop }
    { \__timechart_parse_before_date:w #1\q_mark #2\q_stop }
    { \__timechart_parse_signed_date:w #1\q_mark #2-0-0\q_stop }
}
\cs_new:Npn\__timechart_is_before_p:w #1-#2\q_stop
{
  \tl_if_empty_p:n{#1}
}
\cs_new:Npn\__timechart_parse_before_date:w #1\q_mark-#2\q_stop
{
  \__timechart_parse_signed_date:w #1-\q_mark #2-0-0\q_stop
}
\cs_new:cpn{c__timechart_year_days_pgf}{365}
\cs_new:cpn{c__timechart_month_days_1_pgf}{31}
\cs_new:cpn{c__timechart_month_days_2_pgf}{28}
\cs_new:cpn{c__timechart_month_days_3_pgf}{31}
\cs_new:cpn{c__timechart_month_days_4_pgf}{30}
\cs_new:cpn{c__timechart_month_days_5_pgf}{31}
\cs_new:cpn{c__timechart_month_days_6_pgf}{30}
\cs_new:cpn{c__timechart_month_days_7_pgf}{31}
\cs_new:cpn{c__timechart_month_days_8_pgf}{31}
\cs_new:cpn{c__timechart_month_days_9_pgf}{30}
\cs_new:cpn{c__timechart_month_days_10_pgf}{31}
\cs_new:cpn{c__timechart_month_days_11_pgf}{30}
\cs_new:cpn{c__timechart_month_days_12_pgf}{31}
\cs_new:cpn{c__timechart_cumulative_days_1_pgf}{0}
\cs_new:cpn{c__timechart_cumulative_days_2_pgf}{31}
\cs_new:cpn{c__timechart_cumulative_days_3_pgf}{59}
\cs_new:cpn{c__timechart_cumulative_days_4_pgf}{90}
\cs_new:cpn{c__timechart_cumulative_days_5_pgf}{120}
\cs_new:cpn{c__timechart_cumulative_days_6_pgf}{151}
\cs_new:cpn{c__timechart_cumulative_days_7_pgf}{181}
\cs_new:cpn{c__timechart_cumulative_days_8_pgf}{212}
\cs_new:cpn{c__timechart_cumulative_days_9_pgf}{243}
\cs_new:cpn{c__timechart_cumulative_days_10_pgf}{273}
\cs_new:cpn{c__timechart_cumulative_days_11_pgf}{304}
\cs_new:cpn{c__timechart_cumulative_days_12_pgf}{334}
\cs_new:Npn\__timechart_parse_signed_date:w #1#2\q_mark #3-#4-#5\q_stop
{
  \pgfmathtruncatemacro{\__timechart_parsed_year_pgf}{#2#3}
  \pgfmathtruncatemacro{\__timechart_parsed_month_pgf}{#4}
  \pgfmathtruncatemacro{\__timechart_parsed_day_pgf}{#5}
  \__timechart_pgfmathsetbool:nn{\l_tmpa_bool}{
    or(
      \__timechart_parsed_month_pgf < 1,
      \__timechart_parsed_month_pgf > 12,
    )
  }
  \bool_if:NTF\l_tmpa_bool
  {
    \pgfmathsetmacro{#1}{#2#3}
  }
  {
    \cs_set_eq:NN\l__timechart_year_days_pgf\c__timechart_year_days_pgf
    \cs_set_eq:Nc\l__timechart_month_days_pgf
      { c__timechart_month_days_\__timechart_parsed_month_pgf _pgf }
    \cs_set_eq:Nc\l__timechart_cumulative_days_pgf
      { c__timechart_cumulative_days_\__timechart_parsed_month_pgf _pgf }
    \__timechart_pgfmathsetbool:nn{\l_tmpa_bool}{
      or(
        Mod(\__timechart_parsed_year_pgf,400) == 0,
        and(
          Mod(\__timechart_parsed_year_pgf,4) == 0,
          Mod(\__timechart_parsed_year_pgf,100) != 0
        )
      )
    }
    \bool_if:NT\l_tmpa_bool
      {
        \pgfmathsetmacro{\l__timechart_year_days_pgf}
          { \l__timechart_year_days_pgf+1 }
        \__timechart_pgfmathsetbool:nn{\l_tmpb_bool}
          { \__timechart_parsed_month == 1 }
        \bool_if:NF\l_tmpb_bool
          {
            \__timechart_pgfmathsetbool:nn{\l_tmpb_bool}
              { \__timechart_parsed_month == 2 }
            \bool_if:NF\l_tmpb_bool
              {
                \pgfmathsetmacro{\l__timechart_month_days_pgf}
                  { \l__timechart_month_days_pgf + 1 }
              }
              {
                \pgfmathsetmacro{\l__timechart_cumulative_days_pgf}
                  { \l__timechart_cumulative_days_pgf + 1 }
              }
          }
      }
    \__timechart_pgfmathsetbool:nn{\l_tmpa_bool}{
      or(
        \__timechart_parsed_day_pgf < 1,
        \__timechart_parsed_day_pgf > \l__timechart_month_days_pgf,
      )
    }
    \bool_if:NTF\l_tmpa_bool
      {
       \pgfmathsetmacro{#1}
         {
           #2#3
           + \l__timechart_cumulative_days_pgf/\l__timechart_year_days_pgf
         }
      }
      {
       \pgfmathsetmacro{#1}
         {
           #2#3
           + (
               \l__timechart_cumulative_days_pgf
               + \__timechart_parsed_day_pgf
             )/\l__timechart_year_days_pgf
         }
      }
  }
}
\bool_new:N\l__timechart_start_is_range_bool
\bool_new:N\l__timechart_interval_start_min_circa_bool
\bool_new:N\l__timechart_interval_start_max_circa_bool
\bool_new:N\l__timechart_finish_is_range_bool
\bool_new:N\l__timechart_interval_finish_min_circa_bool
\bool_new:N\l__timechart_interval_finish_max_circa_bool
\msg_new:nnn{timechart}{interval_dates_invalid}
  { Invalid~interval~dates:~#1~to~#2 }
\NewDocumentCommand{\__timechart_interval_user:Ommm}{ O{} m m m }
  {
    \__timechart_interval:nnnn{#1}{#2}{#3}{#4}
  }
\cs_new:Npn \__timechart_interval:nnnn #1#2#3#4
  {
    \__timechart_debug:n{
      ************************************************************
    }
    \__timechart_debug:n{Interval~#2~to~#3~"#4"}
    \group_begin:
    \__timechart_parse_date_or_daterange:NNNNNn
      \l__timechart_start_is_range_bool
      \l__timechart_interval_start_min_circa_bool
      \l__timechart_interval_start_min_year
      \l__timechart_interval_start_max_circa_bool
      \l__timechart_interval_start_max_year
      {#2}
    \__timechart_parse_date_or_daterange:NNNNNn
      \l__timechart_finish_is_range_bool
      \l__timechart_interval_finish_min_circa_bool
      \l__timechart_interval_finish_min_year
      \l__timechart_interval_finish_max_circa_bool
      \l__timechart_interval_finish_max_year
      {#3}
    \__timechart_pgfmathsetbool:nn{\l_tmpa_bool}{
      and(
        \l__timechart_interval_start_min_year
          <= \l__timechart_interval_start_max_year,
        and(
          \l__timechart_interval_start_max_year
            <= \l__timechart_interval_finish_min_year,
          \l__timechart_interval_finish_min_year
            <= \l__timechart_interval_finish_max_year
        )
      )
    }
    \bool_if:NTF\l_tmpa_bool
      {
        \__timechart_interval_checked:nn{#1}{#4}
        \group_end:
        \bool_if:NT\l__timechart_autostep_bool
          { \__timechart_step_y_user:O }
      }
      {
        \msg_error:nnnn{timechart}{interval_dates_invalid}{#2}{#3}
        \group_end:
      }
  }
\cs_new:Npn \__timechart_interval_checked:nn #1#2
  {
    \pgfqkeys{/timechart}{
      #1,
      circa~uncertainty/.get=\l__timechart_circa_uncertainty_year
    }
    \bool_if:NTF\l__timechart_interval_start_min_circa_bool
      {
        \pgfmathsetmacro{\l__timechart_interval_start_min_x}
          { yeartox(\l__timechart_interval_start_min_year
            - \l__timechart_circa_uncertainty_year) }
      }
      {
        \pgfmathsetmacro{\l__timechart_interval_start_min_x}
          { yeartox(\l__timechart_interval_start_min_year) }
      }
    \bool_if:NTF\l__timechart_interval_finish_max_circa_bool
      {
        \pgfmathsetmacro{\l__timechart_interval_finish_max_x}
          { yeartox(\l__timechart_interval_finish_max_year
            + \l__timechart_circa_uncertainty_year) }
      }
      {
        \pgfmathsetmacro{\l__timechart_interval_finish_max_x}
          { yeartox(\l__timechart_interval_finish_max_year) }
      }
    \__timechart_if_x_range_intersect_bounds:nnT
      {\l__timechart_interval_start_min_x}
      {\l__timechart_interval_finish_max_x}
      { \__timechart_draw_visible_interval:nn{#1}{#2} }
  }
\bool_new:N\l__timechart_interval_start_beyond_bool
\bool_new:N\l__timechart_interval_finish_beyond_bool
\cs_new:Npn\__timechart_draw_visible_interval:nn #1#2
  {
    \pgfqkeys{/timechart}{
      tolerance~start/.get=\l__timechart_start_tolerance_pgf,
      tolerance~finish/.get=\l__timechart_finish_tolerance_pgf,
      beyond~length~start/.get=\l__timechart_start_beyond_length_pgf,
      beyond~length~finish/.get=\l__timechart_finish_beyond_length_pgf,
      beyond~x~radius~start/.get=\l__timechart_start_beyond_x_radius_pgf,
      beyond~x~radius~finish/.get=\l__timechart_finish_beyond_x_radius_pgf,
      ref/.get=\l__timechart_ref_text,
      mark/.get=\l__timechart_mark_text,
      interval~minimum~width/.get=\l__timechart_minimum_width_pgf,
      interval~bar~color/.get=\l__timechart_bar_color,
      interval~bar~thickness/.get=\l__timechart_bar_thickness_pgf,
      interval~mark~color/.get=\l__timechart_mark_color,
      interval~label~baseline/.get=\l__timechart_text_baseline_pgf,
      interval~label~node~name/.get=\l__timechart_interval_label_node_name,
    }
    \pgfmathsetmacro{\l__timechart_start_tolerance_x}{
      \l__timechart_start_x-(\l__timechart_start_tolerance_pgf)
    }
    \pgfmathsetmacro{\l__timechart_finish_tolerance_x}{
      \l__timechart_finish_x+(\l__timechart_finish_tolerance_pgf)
    }
    \pgfmathsetmacro{\l__timechart_start_beyond_x}{
      \l__timechart_start_x-(\l__timechart_start_beyond_length_pgf)
    }
    \pgfmathsetmacro{\l__timechart_finish_beyond_x}{
      \l__timechart_finish_x+(\l__timechart_finish_beyond_length_pgf)
    }
    \pgfmathsetlengthmacro{\l__timechart_bar_half_thickness_pgf}
      {.5*\l__timechart_bar_thickness_pgf}
    \cs_set:Npn\l__timechart_label_text{#2}
    \bool_if:NTF\l__timechart_interval_start_max_circa_bool
      {
        \pgfmathsetmacro{\l__timechart_interval_start_max_x}
          { yeartox(\l__timechart_interval_start_max_year
            + \l__timechart_circa_uncertainty_year) }
      }
      {
        \pgfmathsetmacro{\l__timechart_interval_start_max_x}
          { yeartox(\l__timechart_interval_start_max_year) }
      }
    \bool_if:NTF\l__timechart_interval_finish_min_circa_bool
      {
        \pgfmathsetmacro{\l__timechart_interval_finish_min_x}
          { yeartox(\l__timechart_interval_finish_min_year
            - \l__timechart_circa_uncertainty_year) }
      }
      {
        \pgfmathsetmacro{\l__timechart_interval_finish_min_x}
          { yeartox(\l__timechart_interval_finish_min_year) }
      }
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      {
        \l__timechart_interval_start_max_x
          > \l__timechart_interval_finish_min_x
      }
    \bool_if:NT\l__timechart_tmpa_bool
      {
        \pgfmathsetmacro{\l__timechart_interval_start_max_x}
          {
            .5*(
              \l__timechart_interval_start_max_x
              + \l__timechart_interval_finish_min_x
            )
          }
        \pgfmathsetmacro{\l__timechart_interval_finish_min_x}
          { \l__timechart_interval_start_max_x }
      }
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      {
        (\l__timechart_interval_finish_max_x
          -\l__timechart_interval_start_min_x)
        > \l__timechart_minimum_width_pgf
      }
    \bool_if:NF \l__timechart_tmpa_bool
    {
      \pgfmathsetmacro{\l__timechart_width_adjust}
        { .5*\l__timechart_minimum_width_pgf }
      \pgfmathsetmacro{\l__timechart_interval_start_max_x}
        { \l__timechart_interval_start_max_x-\l__timechart_width_adjust }
      \pgfmathsetmacro{\l__timechart_interval_finish_min_x}
        { \l__timechart_interval_finish_min_x+\l__timechart_width_adjust }
      \pgfmathsetmacro{\l__timechart_interval_start_min_x}
        {
          min(
            \l__timechart_interval_start_min_x,
            \l__timechart_interval_start_max_x
          )
        }
      \pgfmathsetmacro{\l__timechart_interval_finish_max_x}
        {
          max(
            \l__timechart_interval_finish_max_x,
            \l__timechart_interval_finish_min_x
          )
        }
    }
    \__timechart_debug:n{Calculated+adjusted~x~coords:}
    \__timechart_debug:n{~
      \l__timechart_interval_start_min_x/\l__timechart_interval_start_max_x~
      to~
      \l__timechart_interval_finish_min_x/\l__timechart_interval_finish_max_x
    }
    \__timechart_pgfmathsetbool:nn{\l__timechart_interval_start_beyond_bool}
      {\l__timechart_interval_start_min_x<=\l__timechart_start_tolerance_x}
    \bool_if:NT\l__timechart_interval_start_beyond_bool
      {
        \cs_set_eq:NN
          \__timechart_interval_start_clip_path:
          \__timechart_interval_start_clip_path_beyond:
      }
    \__timechart_pgfmathsetbool:nn{\l__timechart_interval_finish_beyond_bool}
      {\l__timechart_interval_finish_max_x>=\l__timechart_finish_tolerance_x}
    \bool_if:NT\l__timechart_interval_finish_beyond_bool
      {
        \cs_set_eq:NN
          \__timechart_interval_finish_clip_path:
          \__timechart_interval_finish_clip_path_beyond:
      }
    \__timechart_interval_definite_compute:
    \__timechart_interval_startrange_compute:
    \__timechart_interval_finishrange_compute:
    \pgftransformshift{ \pgfpoint{0}{\l__timechart_current_y} }
    \pgfscope
    \__timechart_interval_clip:
    \__timechart_interval_startrange_draw:
    \__timechart_interval_finishrange_draw:
    \__timechart_interval_solid_draw:
    \__timechart_interval_mark:
    \__timechart_interval_define_bar_node:
    \endpgfscope
    \__timechart_interval_label:
  }
\cs_new:Npn\__timechart_interval_definite_compute:
  {
    \__timechart_debug:n{Computing:~definite~part}
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      { \l__timechart_interval_finish_min_x < \l__timechart_start_x }
    \bool_if:nTF{
      \l__timechart_tmpa_bool && \l__timechart_interval_start_beyond_bool
    }
      {
        \cs_set_eq:NN
          \__timechart_interval_solid_draw:\prg_do_nothing:
        \cs_set_eq:NN
          \__timechart_interval_startrange_compute:\prg_do_nothing:
        \cs_set_eq:NN
          \__timechart_interval_startrange_draw:\prg_do_nothing:
      }
      {
        \__timechart_interval_definite_compute_ii:
      }
  }
\cs_new:Npn\__timechart_interval_definite_compute_ii:
  {
    \__timechart_debug:n{~(Stage~II)}
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      { \l__timechart_interval_start_max_x > \l__timechart_finish_x }
    \bool_if:nTF{
      \l__timechart_tmpa_bool && \l__timechart_interval_finish_beyond_bool
    }
      {
        \cs_set_eq:NN
          \__timechart_interval_solid_draw:\prg_do_nothing:
        \cs_set_eq:NN
          \__timechart_interval_finishrange_compute:\prg_do_nothing:
        \cs_set_eq:NN
          \__timechart_interval_finishrange_draw:\prg_do_nothing:
      }
      {
        \__timechart_interval_definite_compute_iii:
      }
  }
\cs_new:Npn\__timechart_interval_definite_compute_iii:
  {
    \__timechart_debug:n{~(Stage~III)}
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      { \l__timechart_interval_start_max_x <= \l__timechart_start_x }
    \bool_if:nTF{
      \l__timechart_tmpa_bool && \l__timechart_interval_start_beyond_bool
    }
      {
        \cs_set_eq:NN
          \l__timechart_interval_solid_start_x\l__timechart_start_beyond_x
        \cs_set_eq:NN
          \__timechart_interval_startrange_compute:\prg_do_nothing:
        \cs_set_eq:NN
          \__timechart_interval_startrange_draw:\prg_do_nothing:
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_solid_start_x
          \l__timechart_interval_start_max_x
      }
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpb_bool}
      { \l__timechart_interval_finish_min_x >= \l__timechart_finish_x }
    \bool_if:nTF{
      \l__timechart_tmpb_bool && \l__timechart_interval_finish_beyond_bool
    }
      {
        \cs_set_eq:NN
          \l__timechart_interval_solid_finish_x\l__timechart_finish_beyond_x
        \cs_set_eq:NN
          \__timechart_interval_finishrange_compute:\prg_do_nothing:
        \cs_set_eq:NN
          \__timechart_interval_finishrange_draw:\prg_do_nothing:
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_solid_finish_x
          \l__timechart_interval_finish_min_x
      }
  }
\cs_new:Npn\__timechart_interval_startrange_compute:
  {
    \__timechart_debug:n{Computing:~startrange}
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      {
        \l__timechart_interval_start_min_x
          == \l__timechart_interval_start_max_x
      }
    \bool_if:NTF\l__timechart_tmpa_bool
      {
        \cs_set_eq:NN\__timechart_interval_startrange_draw:\prg_do_nothing:
      }
      {
        \__timechart_interval_startrange_compute_ii:
      }
  }
\bool_new:N\l__timechart_interval_startrange_finish_beyond_bool
\cs_new:Npn\__timechart_interval_startrange_compute_ii:
  {
    \__timechart_debug:n{~(Stage~II)}
    \bool_if:NTF\l__timechart_interval_start_beyond_bool
      {
        \cs_set_eq:NN
          \l__timechart_interval_startrange_start_x\l__timechart_start_x
        \pgfmathsetmacro{\l__timechart_interval_startrange_start_level_pgf}
          {
            (\l__timechart_interval_startrange_start_x
              -\l__timechart_interval_start_min_x)
            /
            (\l__timechart_interval_start_max_x
              -\l__timechart_interval_start_min_x)
          }
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_startrange_start_x
          \l__timechart_interval_start_min_x
        \pgfmathsetmacro
          {\l__timechart_interval_startrange_start_level_pgf}{0}
      }
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      { \l__timechart_interval_start_max_x > \l__timechart_finish_x }
    \bool_set:Nn\l__timechart_interval_startrange_finish_beyond_bool
      {
        \l__timechart_tmpa_bool
        && \l__timechart_interval_finish_beyond_bool
      }
    \bool_if:NTF\l__timechart_interval_startrange_finish_beyond_bool
      {
        \cs_set_eq:NN
          \l__timechart_interval_startrange_finish_x
          \l__timechart_finish_x
        \pgfmathsetmacro{\l__timechart_interval_startrange_finish_level_pgf}
          {
            (\l__timechart_interval_startrange_finish_x
              -\l__timechart_interval_start_min_x)
            /
            (\l__timechart_interval_start_max_x
              -\l__timechart_interval_start_min_x)
          }
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_startrange_finish_x
          \l__timechart_interval_start_max_x
        \pgfmathsetmacro
          {\l__timechart_interval_startrange_finish_level_pgf}{1}
      }
    \int_case:nn {\l__timechart_start_range_type_int}
      {
        {0}{
          \cs_set_eq:NN
            \__timechart_interval_startrange_draw:
            \__timechart_interval_startrange_draw_pseudofade:
        }
        {1}{
          \__timechart_interval_startrange_slant_compute:
        }
      }
  }
\cs_new:Npn \__timechart_interval_startrange_slant_compute:
  {
    \__timechart_debug:n{~(Startrange~slant)}
    \bool_if:NTF\l__timechart_interval_start_beyond_bool
      {
        \bool_if:NTF\l__timechart_interval_startrange_finish_beyond_bool
          {
            \cs_set_eq:NN
              \__timechart_interval_both_clip_path:
              \__timechart_interval_startrange_clip_path_beyond_both:
          }
          {
            \cs_set_eq:NN
              \__timechart_interval_start_clip_path:
              \__timechart_interval_startrange_clip_path_beyond_start:
          }
      }
      {
        \bool_if:NTF\l__timechart_interval_startrange_finish_beyond_bool
          {
            \cs_set_eq:NN
              \__timechart_interval_both_clip_path:
              \__timechart_interval_startrange_clip_path_beyond_finish:
          }
          {
            \cs_set_eq:NN
              \__timechart_interval_start_clip_path:
              \__timechart_interval_startrange_clip_path_start:
          }
        }
    \cs_if_eq:NNTF\__timechart_interval_solid_draw:\prg_do_nothing:
      {
        \cs_set_eq:NN
          \__timechart_interval_startrange_draw:
          \__timechart_interval_startfinishrange_draw_slant:
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_solid_start_x
          \l__timechart_start_beyond_x
        \cs_set_eq:NN
          \__timechart_interval_startrange_draw:
          \prg_do_nothing:
      }
  }
\cs_new:Npn\__timechart_interval_finishrange_compute:
  {
    \__timechart_debug:n{Computing:~finishrange}
    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      {
        \l__timechart_interval_finish_max_x
          == \l__timechart_interval_finish_min_x
      }
    \bool_if:NTF\l__timechart_tmpa_bool
      {
        \cs_set_eq:NN\__timechart_interval_finishrange_draw:\prg_do_nothing:
      }
      {
        \__timechart_interval_finishrange_compute_ii:
      }
  }
\bool_new:N\l__timechart_interval_finishrange_start_beyond_bool
\cs_new:Npn\__timechart_interval_finishrange_compute_ii:
  {
    \__timechart_debug:n{~(Stage~II)}
    \bool_if:NTF\l__timechart_interval_finish_beyond_bool
      {
        \cs_set_eq:NN
          \l__timechart_interval_finishrange_finish_x
          \l__timechart_finish_x
        \pgfmathsetmacro{\l__timechart_interval_finishrange_finish_level_pgf}
          {
            (\l__timechart_interval_finishrange_finish_x
              -\l__timechart_interval_finish_max_x)
            /
            (\l__timechart_interval_finish_min_x
              -\l__timechart_interval_finish_max_x)
          }
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_finishrange_finish_x
          \l__timechart_interval_finish_max_x
        \pgfmathsetmacro
          {\l__timechart_interval_finishrange_finish_level_pgf}{0}
      }

    \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
      { \l__timechart_interval_finish_min_x < \l__timechart_start_x }
    \bool_set:Nn\l__timechart_interval_finishrange_start_beyond_bool
      {
        \l__timechart_tmpa_bool
        && \l__timechart_interval_start_beyond_bool
      }
    \bool_if:NTF\l__timechart_interval_finishrange_start_beyond_bool
      {
        \cs_set_eq:NN
          \l__timechart_interval_finishrange_start_x
          \l__timechart_start_x
        \pgfmathsetmacro{\l__timechart_interval_finishrange_start_level_pgf}
          {
            (\l__timechart_interval_finishrange_start_x
              -\l__timechart_interval_finish_max_x)
            /
            (\l__timechart_interval_finish_min_x
              -\l__timechart_interval_finish_max_x)
          }
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_finishrange_start_x
          \l__timechart_interval_finish_min_x
        \pgfmathsetmacro
          {\l__timechart_interval_finishrange_start_level_pgf}{1}
      }
    \int_case:nn {\l__timechart_finish_range_type_int}
      {
        {0}{
          \cs_set_eq:NN
            \__timechart_interval_finishrange_draw:
            \__timechart_interval_finishrange_draw_pseudofade:
        }
        {1}{
          \__timechart_interval_finishrange_slant_compute:
        }
      }
  }
\cs_new:Npn \__timechart_interval_finishrange_slant_compute:
  {
    \__timechart_debug:n{~(Finishrange~slant)}
    \bool_if:NTF\l__timechart_interval_finish_beyond_bool
      {
        \bool_if:NTF\l__timechart_interval_finishrange_start_beyond_bool
          {
            \cs_set_eq:NN
              \__timechart_interval_both_clip_path:
              \__timechart_interval_finishrange_clip_path_beyond_both:
          }
          {
            \cs_set_eq:NN
              \__timechart_interval_finish_clip_path:
              \__timechart_interval_finishrange_clip_path_beyond_finish:
          }
      }
      {
        \bool_if:NTF\l__timechart_interval_finishrange_start_beyond_bool
          {
            \cs_set_eq:NN
              \__timechart_interval_both_clip_path:
              \__timechart_interval_finishrange_clip_path_beyond_start:
          }
          {
            \cs_set_eq:NN
              \__timechart_interval_finish_clip_path:
              \__timechart_interval_finishrange_clip_path_finish:
          }
        }
    \cs_if_eq:NNTF\__timechart_interval_solid_draw:\prg_do_nothing:
      {
        \cs_set_eq:NN
          \__timechart_interval_finishrange_draw:
          \__timechart_interval_startfinishrange_draw_slant:
      }
      {
        \cs_set_eq:NN
          \l__timechart_interval_solid_finish_x
          \l__timechart_finish_beyond_x
        \cs_set_eq:NN
          \__timechart_interval_finishrange_draw:
          \prg_do_nothing:
      }
  }
\cs_new:Npn\__timechart_interval_solid_draw:
  {
    \__timechart_debug:n{
      Drawing:~solid~\l__timechart_interval_solid_start_x~
      to~\l__timechart_interval_solid_finish_x
    }
    \pgfpathrectanglecorners{
      \pgfpoint
       {\l__timechart_interval_solid_start_x}
       {-\l__timechart_bar_half_thickness_pgf}
    }{
      \pgfpoint
        {\l__timechart_interval_solid_finish_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfsetfillcolor{\l__timechart_bar_color}
    \pgfusepath{fill}
  }
\cs_new:Npn\__timechart_interval_startrange_draw_pseudofade:
  {
    \__timechart_debug:n{Drawing:~startrange,~pseudofade}
    \__timechart_debug:n{~
      \l__timechart_interval_startrange_start_x~
      (\l__timechart_interval_startrange_start_level_pgf)~
      to~\l__timechart_interval_startrange_finish_x~
      (\l__timechart_interval_startrange_finish_level_pgf)
    }
    \__timechart_interval_draw_pseudofade:nnnnn
      {\l__timechart_interval_startrange_start_x}
      {\l__timechart_interval_startrange_finish_x}
      {\l__timechart_bar_color}
      {\l__timechart_interval_startrange_start_level_pgf}
      {\l__timechart_interval_startrange_finish_level_pgf}
    \bool_if:NT\l__timechart_interval_start_beyond_bool
      { \__timechart_interval_startrange_start_beyond_draw_fade: }
    \bool_if:NT\l__timechart_interval_startrange_finish_beyond_bool
      { \__timechart_interval_startrange_finish_beyond_draw_fade: }
  }
\cs_new:Npn\__timechart_interval_startrange_start_beyond_draw_fade:
  {
    \__timechart_debug:n{Drawing:~startrange,~pseudofade~beyond~start}
    \__timechart_debug:n{~
      \l__timechart_start_beyond_x~to~\l__timechart_start_x
    }
    \pgfscope
    \pgfpathrectanglecorners{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }{
      \pgfpoint
        {\l__timechart_start_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfsetfillcolor{\l__timechart_bar_color}
    \pgfsetfillopacity
      {\l__timechart_interval_startrange_start_level_pgf}
    \pgfusepath{fill}
    \endpgfscope
  }
\cs_new:Npn\__timechart_interval_startrange_finish_beyond_draw_fade:
  {
    \__timechart_debug:n{Drawing:~startrange,~pseudofade~beyond~finish}
    \__timechart_debug:n{~
      \l__timechart_finish_beyond_x~to~\l__timechart_finish_x
    }
    \pgfscope
    \pgfpathrectanglecorners{
      \pgfpoint
        {\l__timechart_finish_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfsetfillcolor{\l__timechart_bar_color}
    \pgfsetfillopacity
      {\l__timechart_interval_startrange_finish_level_pgf}
    \pgfusepath{fill}
    \endpgfscope
  }
\cs_new:Npn\__timechart_interval_finishrange_draw_pseudofade:
  {
    \__timechart_debug:n{Drawing:~finishrange,~pseudofade}
    \__timechart_debug:n{~
      \l__timechart_interval_finishrange_start_x~
      (\l__timechart_interval_finishrange_start_level_pgf)~
      to~\l__timechart_interval_finishrange_finish_x~
      (\l__timechart_interval_finishrange_finish_level_pgf)
    }
    \__timechart_interval_draw_pseudofade:nnnnn
      {\l__timechart_interval_finishrange_start_x}
      {\l__timechart_interval_finishrange_finish_x}
      {\l__timechart_bar_color}
      {\l__timechart_interval_finishrange_start_level_pgf}
      {\l__timechart_interval_finishrange_finish_level_pgf}
    \bool_if:NT\l__timechart_interval_finish_beyond_bool
      { \__timechart_interval_finishrange_finish_beyond_draw_fade: }
    \bool_if:NT\l__timechart_interval_finishrange_start_beyond_bool
      { \__timechart_interval_finishrange_start_beyond_draw_fade: }
  }

\cs_new:Npn\__timechart_interval_finishrange_finish_beyond_draw_fade:
  {
    \__timechart_debug:n{Drawing:~finishrange,~pseudofade~beyond~finish}
    \__timechart_debug:n{~
      \l__timechart_finish_beyond_x~to~\l__timechart_finish_x
    }
    \pgfscope
    \pgfpathrectanglecorners{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }{
      \pgfpoint
        {\l__timechart_finish_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfsetfillcolor{\l__timechart_bar_color}
    \pgfsetfillopacity
      {\l__timechart_interval_finishrange_finish_level_pgf}
    \pgfusepath{fill}
    \endpgfscope
  }
\cs_new:Npn\__timechart_interval_finishrange_start_beyond_draw_fade:
  {
    \__timechart_debug:n{Drawing:~finishrange,~pseudofade~beyond~start}
    \__timechart_debug:n{~
      \l__timechart_start_beyond_x~to~\l__timechart_start_x
    }
    \pgfscope
    \pgfpathrectanglecorners{
      \pgfpoint
        {\l__timechart_start_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfsetfillcolor{\l__timechart_bar_color}
    \pgfsetfillopacity
      {\l__timechart_interval_finishrange_start_level_pgf}
    \pgfusepath{fill}
    \endpgfscope
  }
\pgfmathsetmacro{\l__timechart_fadestep_pgf}{1}
\cs_new:Npn\__timechart_interval_draw_pseudofade:nnnnn #1#2#3#4#5
  {
    \__timechart_debug:n{Pseudofade:~#1~to~#2,~color~#3,~opacity~#4~to~#5}
    \group_begin:
    \pgfmathsetmacro{\start}{#1}
    \pgfmathsetmacro{\stop}{#2}
    \pgfmathsetmacro{\fadestep}
      {(\stop-\start)/(floor((\stop-\start)/\l__timechart_fadestep_pgf)+1)}
    \pgfmathsetmacro{\startnext}{\start+\fadestep}
    \pgfmathsetmacro{\stopprev}{\stop-\fadestep}
    \pgfmathsetmacro{\denominator}{abs(\stop-\start)+\fadestep}
    \foreach \xa in {\start,\startnext,...,\stopprev} {
      \pgfmathsetlengthmacro{\o}
        {((\stop-\xa)*#4+(\xa-\start+\fadestep)*#5)/\denominator}
      \pgfscope
      \pgfpathrectanglecorners{
        \pgfpoint{\xa}{-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{\xa+\fadestep}{\l__timechart_bar_half_thickness_pgf}
      }
      \pgfsetfillcolor{#3}
      \pgfsetfillopacity{\o}
      \pgfusepath{fill}
      \endpgfscope
    }
    \group_end:
  }
\cs_new:Npn\__timechart_interval_startfinishrange_draw_slant:
  {
    \pgfpathrectanglecorners{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfsetfillcolor{\l__timechart_bar_color}
    \pgfusepath{fill}
  }
\pgfmathsetmacro{\c__timechart_left_far_x}{-16000pt}
\pgfmathsetmacro{\c__timechart_right_far_x}{16000pt}
\cs_new:Npn\__timechart_interval_start_clip_path_none:
  {
    \__timechart_debug:n{~Start~clip~path:~none}
    \pgfpathlineto{
      \pgfpoint
      {\c__timechart_left_far_x}
      {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
      {\c__timechart_left_far_x}
      {\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn\__timechart_interval_finish_clip_path_none:
  {
    \__timechart_debug:n{~Finish~clip~path:~none}
    \pgfpathmoveto{
      \pgfpoint
      {\c__timechart_right_far_x}
      {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
      {\c__timechart_right_far_x}
      {-\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn\__timechart_interval_start_clip_path_beyond:
  {
    \__timechart_debug:n{~Start~clip~path:~beyond}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpatharc
      {-90}
      {90}
      {\l__timechart_start_beyond_x_radius_pgf
        ~and~\l__timechart_bar_half_thickness_pgf}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn\__timechart_interval_finish_clip_path_beyond:
  {
    \__timechart_debug:n{~Finish~clip~path:~beyond}
    \pgfpathmoveto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpatharc
      {90}
      {270}
      {\l__timechart_finish_beyond_x_radius_pgf
        ~and~\l__timechart_bar_half_thickness_pgf}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {-\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn\__timechart_interval_startrange_clip_path_start:
  {
    \__timechart_debug:n{~Start~clip~path:~startrange}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_startrange_start_x}
        {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_startrange_start_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_startrange_finish_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_startrange_finish_x}
        {\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn\__timechart_interval_finishrange_clip_path_finish:
  {
    \__timechart_debug:n{~Finish~clip~path:~finishrange}
    \pgfpathmoveto{
      \pgfpoint
        {\l__timechart_interval_finishrange_finish_x}
        {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_finishrange_finish_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_finishrange_start_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_finishrange_start_x}
        {-\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn \__timechart_interval_startrange_clip_path_beyond_start:
  {
    \__timechart_debug:n{~Start~clip~path:~startrange,~beyond~start}
    \pgfmathsetmacro{\l__timechart_tmpa_pgf}{
      \l__timechart_bar_thickness_pgf
        *\l__timechart_interval_startrange_start_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpb_pgf}{
      .5*\l__timechart_tmpa_pgf
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpatharc
      {-90}
      {90}
      {\l__timechart_start_beyond_x_radius_pgf
        ~and~\l__timechart_tmpb_pgf}
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_start_x}
          {-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{\l__timechart_tmpa_pgf}
      }
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_start_max_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_start_max_x}
        {\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn\__timechart_interval_finishrange_clip_path_beyond_finish:
  {
    \__timechart_debug:n{~Finish~clip~path:~finishrange,~beyond~finish}
    \pgfmathsetmacro{\l__timechart_tmpa_pgf}{
      \l__timechart_bar_thickness_pgf
        *\l__timechart_interval_finishrange_finish_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpb_pgf}{
      .5*\l__timechart_tmpa_pgf
    }
    \pgfpathmoveto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpatharc
      {90}
      {270}
      {\l__timechart_finish_beyond_x_radius_pgf
        ~and~\l__timechart_tmpb_pgf}
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_finish_x}
          {\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{-\l__timechart_tmpa_pgf}
      }
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_finish_min_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_finish_min_x}
        {-\l__timechart_bar_thickness_pgf}
    }
  }
\cs_new:Npn\__timechart_interval_startrange_clip_path_beyond_finish:
  {
    \__timechart_debug:n{~Two-sided~clip~path:~startrange,~beyond~finish}
    \pgfmathsetmacro{\l__timechart_tmpc_pgf}{
      \l__timechart_bar_thickness_pgf
        *\l__timechart_interval_startrange_finish_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpd_pgf}{
      .5*\l__timechart_tmpc_pgf
    }
    \pgfpathmoveto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_finish_beyond_x}
          {-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{\l__timechart_tmpc_pgf}
      }
    }
    \pgfpatharc
      {90}
      {270}
      {\l__timechart_start_beyond_x_radius_pgf
        ~and~\l__timechart_tmpd_pgf}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_start_min_x}
        {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_start_min_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_finish_x}
          {-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{\l__timechart_tmpc_pgf}
      }
    }
  }
\cs_new:Npn\__timechart_interval_finishrange_clip_path_beyond_start:
  {
    \__timechart_debug:n{~Two-sided~clip~path:~finishrange,~beyond~start}
    \pgfmathsetmacro{\l__timechart_tmpc_pgf}{
      \l__timechart_bar_thickness_pgf
        *\l__timechart_interval_finishrange_start_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpd_pgf}{
      .5*\l__timechart_tmpc_pgf
    }
    \pgfpathmoveto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_start_beyond_x}
          {\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{-\l__timechart_tmpc_pgf}
      }
    }
    \pgfpatharc
      {-90}
      {90}
      {\l__timechart_start_beyond_x_radius_pgf
        ~and~\l__timechart_tmpd_pgf}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_finish_max_x}
        {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_interval_finish_max_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_start_x}
          {\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{-\l__timechart_tmpc_pgf}
      }
    }
  }
\cs_new:Npn\__timechart_interval_startrange_clip_path_beyond_both:
  {
    \__timechart_debug:n{~Two-sided~clip~path:~startrange,~beyond~both}
    \pgfmathsetmacro{\l__timechart_tmpa_pgf}{
      \l__timechart_bar_thickness_pgf
      *\l__timechart_interval_startrange_start_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpb_pgf}{
      .5*\l__timechart_tmpa_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpc_pgf}{
      \l__timechart_bar_thickness_pgf
      *\l__timechart_interval_startrange_finish_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpd_pgf}{
      .5*\l__timechart_tmpc_pgf
    }
    \pgfpathmoveto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_finish_beyond_x}
          {-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{\l__timechart_tmpc_pgf}
      }
    }
    \pgfpatharc
      {90}
      {270}
      {\l__timechart_finish_beyond_x_radius_pgf
        ~and~\l__timechart_tmpd_pgf}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpatharc
      {-90}
      {90}
      {\l__timechart_start_beyond_x_radius_pgf
        ~and~\l__timechart_tmpb_pgf}
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_start_x}
          {-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{\l__timechart_tmpa_pgf}
      }
    }
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_finish_x}
          {-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{\l__timechart_tmpc_pgf}
      }
    }
  }
\cs_new:Npn\__timechart_interval_finishrange_clip_path_beyond_both:
  {
    \__timechart_debug:n{~Two-sided~clip~path:~finishrange,~beyond~both}
    \pgfmathsetmacro{\l__timechart_tmpa_pgf}{
      \l__timechart_bar_thickness_pgf
        *\l__timechart_interval_finishrange_finish_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpb_pgf}{
      .5*\l__timechart_tmpa_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpc_pgf}{
      \l__timechart_bar_thickness_pgf
        *\l__timechart_interval_finishrange_start_level_pgf
    }
    \pgfmathsetmacro{\l__timechart_tmpd_pgf}{
      .5*\l__timechart_tmpc_pgf
    }
    \pgfpathmoveto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_start_beyond_x}
          {\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{-\l__timechart_tmpc_pgf}
      }
    }
    \pgfpatharc
      {-90}
      {90}
      {\l__timechart_start_beyond_x_radius_pgf
        ~and~\l__timechart_tmpd_pgf}
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_start_beyond_x}
        {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_thickness_pgf}
    }
    \pgfpathlineto{
      \pgfpoint
        {\l__timechart_finish_beyond_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpatharc
      {90}
      {270}
      {\l__timechart_finish_beyond_x_radius_pgf
        ~and~\l__timechart_tmpb_pgf}
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_finish_x}
          {\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{-\l__timechart_tmpa_pgf}
      }
    }
    \pgfpathlineto{
      \pgfpointadd{
        \pgfpoint
          {\l__timechart_start_x}
          {\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint{0}{-\l__timechart_tmpc_pgf}
      }
    }
  }
\cs_new:Npn\__timechart_interval_clip:
  {
    \__timechart_debug:n{Clipping:}
    \pgfinterruptboundingbox
    \__timechart_interval_both_clip_path:
    \pgfpathclose
    \pgfusepath{clip}
    \endpgfinterruptboundingbox
  }
\cs_new:Npn\__timechart_interval_both_clip_path:
  {
    \cs_if_exist_use:NF\__timechart_interval_finish_clip_path:
      { \__timechart_interval_finish_clip_path_none: }
    \cs_if_exist_use:NF\__timechart_interval_start_clip_path:
      { \__timechart_interval_start_clip_path_none: }
  }
\msg_new:nnn{timechart}{interval_mark_outside}
  { Ignoring~mark~outside~interval~definite~part~at~date~#1 }
\cs_new:Npn\__timechart_interval_mark:
  {
    \pgfscope
    \bool_if:NTF\l__timechart_interval_start_beyond_bool
      {
        \pgfmathsetmacro{\l__timechart_interval_mark_min_x}
          { max(\l__timechart_interval_start_max_x,\l__timechart_start_x) }
      }
      {
        \cs_set_eq:NN\l__timechart_interval_mark_min_x\l__timechart_interval_start_max_x
      }
    \bool_if:NTF\l__timechart_interval_finish_beyond_bool
      {
        \pgfmathsetmacro{\l__timechart_interval_mark_max_x}
          { min(\l__timechart_interval_finish_min_x,\l__timechart_finish_x) }
      }
      {
        \cs_set_eq:NN\l__timechart_interval_mark_max_x\l__timechart_interval_finish_min_x
      }
    \pgfsetstrokecolor{\l__timechart_mark_color}
    \foreach \year in \l__timechart_mark_text
      {
        \pgfmathsetmacro{\l__timechart_mark_x}{yeartox(\year)}
        \__timechart_pgfmathsetbool:nn{\l__timechart_tmpa_bool}
          {
            and (
              \l__timechart_mark_x >= \l__timechart_interval_mark_min_x,
              \l__timechart_mark_x <= \l__timechart_interval_mark_max_x
            )
          }
        \bool_if:NTF\l__timechart_tmpa_bool
          {
            \pgfpathmoveto{
              \pgfpoint
                {\l__timechart_mark_x}
                {-\l__timechart_bar_half_thickness_pgf}
            }
            \pgfpathlineto{
              \pgfpoint
                {\l__timechart_mark_x}
                {\l__timechart_bar_half_thickness_pgf}
            }
            \pgfusepath{draw}
          }
          { \msg_warning:nne{timechart}{interval_mark_outside}{\year} }
      }
    \endpgfscope
  }
\cs_new:Npn\__timechart_interval_define_bar_node:
  {
    \__timechart_make_rectangle_node:nnnn
      {
        \pgfpoint
          {\l__timechart_interval_start_min_x}
          {-\l__timechart_bar_half_thickness_pgf}
      }{
        \pgfpoint
          {\l__timechart_interval_finish_max_x}
          {\l__timechart_bar_half_thickness_pgf}
      }
      {\pgfkeysvalueof{/timechart/interval~bar~node~name}}
      {\c_false_bool}
  }
\cs_new:Npn\__timechart_interval_label:
  {
    \str_if_empty:NF \l__timechart_label_text
      {
        \pgfinterruptboundingbox
        \int_case:nn {\l__timechart_label_pos_int}
        {
          {0}{ \__timechart_interval_label_left: }
          {1}{ \__timechart_interval_label_center: }
          {2}{ \__timechart_interval_label_right: }
        }
        \endpgfinterruptboundingbox
      }
  }
\cs_new:Npn\__timechart_interval_label_left:
  {
    \__timechart_if_x_in_bounds:nT{\l__timechart_interval_start_min_x}
      {
        \group_begin:
        \pgftransformshift{
          \pgfpoint
            {\l__timechart_interval_start_min_x}
            {\l__timechart_text_baseline_pgf}
        }
        \node[/timechart/interval~label,anchor=base~east]
          (\l__timechart_interval_label_node_name)
          at (0,0)
          {
            \__timechart_make_ref:NN
              \l__timechart_ref_text
              \l__timechart_label_text
          };
        \group_end:
      }
  }
\cs_new:Npn\__timechart_interval_label_right:
  {
    \__timechart_if_x_in_bounds:nT{\l__timechart_interval_finish_max_x}
      {
        \group_begin:
        \pgftransformshift{
          \pgfpoint
            {\l__timechart_interval_finish_max_x}
            {\l__timechart_text_baseline_pgf}
        }
        \node[/timechart/interval~label,anchor=base~west]
          (\l__timechart_interval_label_node_name)
          at (0,0)
          {
            \__timechart_make_ref:NN
              \l__timechart_ref_text
              \l__timechart_label_text
          };
        \group_end:
      }
  }
\cs_new:Npn\__timechart_interval_label_center:
  {
    \pgfmathsetlengthmacro{\l__timechart_label_anchor_x}
      {
        .5*max(\l__timechart_interval_start_max_x,\l__timechart_start_x)
        + .5*min(\l__timechart_interval_finish_min_x,\l__timechart_finish_x)
      }
    \group_begin:
    \pgftransformshift{
      \pgfpoint
        {\l__timechart_label_anchor_x}
        {\l__timechart_text_baseline_pgf}
    }
    \pgfonlayer{labelbg}
    \node[
      /timechart/interval~label~centered~background,
      anchor=base
    ]
      at (0,0)
      { \l__timechart_label_text };
    \endpgfonlayer
    \group_end:
    \pgfscope
    \pgfpathrectanglecorners{
      \pgfpoint
        {\l__timechart_interval_start_min_x}
        {-\l__timechart_bar_half_thickness_pgf}
    }{
      \pgfpoint
        {\l__timechart_interval_finish_max_x}
        {\l__timechart_bar_half_thickness_pgf}
    }
    \pgfusepath{clip}
    \group_begin:
    \pgftransformshift{
      \pgfpoint
        {\l__timechart_label_anchor_x}
        {\l__timechart_text_baseline_pgf}
    }
    \node[
    /timechart/interval~label~centered,
    anchor=base
    ]
      (\l__timechart_interval_label_node_name)
      at (0,0)
      {
        \__timechart_make_ref:NN
        \l__timechart_ref_text
        \l__timechart_label_text
      };
    \group_end:
    \endpgfscope
  }
\NewDocumentCommand{\__timechart_text_user:Omm}{ O{} m m }
  {
    \str_if_empty:nF{#3}{
      \group_begin:
      \pgfmathsetmacro{\l__timechart_text_x}{yeartox(#2)}
      \pgfqkeys{/timechart}{
        #1,
        tolerance~start/.get=\l__timechart_start_tolerance_pgf,
        tolerance~finish/.get=\l__timechart_finish_tolerance_pgf,
      }
      \__timechart_if_x_in_bounds:nT{\l__timechart_text_x}
        {
          \pgfqkeys{/timechart}{
            ref/.get=\l__timechart_ref_text,
            text~node~name/.get=\l__timechart_node_name_text,
            text~baseline/.get=\l__timechart_text_baseline_pgf,
          }
          \pgftransformshift{
            \pgfpoint{0}{\l__timechart_current_y}
          }
          \pgfinterruptboundingbox
          \group_begin:
          \pgftransformshift{
            \pgfpoint{\l__timechart_text_x}{\l__timechart_text_baseline_pgf}
          }
          \cs_set:Npn\l__timechart_text{#3}
          \int_case:nn {\l__timechart_text_pos_int}
          {
            {0}{ \cs_set:Npn\l__timechart_node_anchor_text{base~east} }
            {1}{ \cs_set:Npn\l__timechart_node_anchor_text{base} }
            {2}{ \cs_set:Npn\l__timechart_node_anchor_text{base~west} }
          }
          \node[/timechart/text,anchor=\l__timechart_node_anchor_text]
            (\l__timechart_node_name_text)
            at (0,0)
            {
              \__timechart_make_ref:NN
              \l__timechart_ref_text
              \l__timechart_text
            };
          \group_end:
          \endpgfinterruptboundingbox
        }
      \group_end:
    }
    \__timechart_space_user:O[#1]
  }
\NewDocumentCommand{\__timechart_space_user:O}{ O{} }
  {
    \group_begin:

    \pgfqkeys{/timechart}{
      #1,
      interval~bar~thickness/.get=\l__timechart_bar_thickness_pgf,
    }
    \pgfmathsetlengthmacro{\l__timechart_bar_half_thickness_pgf}
      { .5*\l__timechart_bar_thickness_pgf }
    \pgftransformshift{
      \pgfpoint{0}{\l__timechart_current_y}
    }
    \pgfpathmoveto{
      \pgfpoint{0}{-\l__timechart_bar_half_thickness_pgf}
    }
    \pgfpathmoveto{
      \pgfpoint{0}{\l__timechart_bar_half_thickness_pgf}
    }
    \pgfusepath{discard}
    \group_end:
    \bool_if:NT\l__timechart_autostep_bool{
      \__timechart_step_y_user:O
    }
  }
\NewDocumentCommand{\timechartlegenditem}{ O{} }
  {
    \__timechart_legend_aux:nn{#1}{
      \pgfmathsetlengthmacro{\l__timechart_interval_solid_start_x}{0}
      \pgfmathsetlengthmacro{\l__timechart_interval_solid_finish_x}
        {\l__timechart_legenditem_width_pgf}
      \__timechart_interval_solid_draw:
    }
  }
\NewDocumentCommand{\timechartlegendstartrange}{ O{} }
  {
    \__timechart_legend_aux:nn{#1}{
      \pgfmathsetlengthmacro
        {\l__timechart_interval_startrange_start_x}{0}
      \pgfmathsetlengthmacro{\l__timechart_interval_startrange_finish_x}
        {\l__timechart_legenditem_range_width_pgf}
      \pgfmathsetlengthmacro
        {\l__timechart_interval_startrange_start_level_pgf}{0}
      \pgfmathsetlengthmacro
        {\l__timechart_interval_startrange_finish_level_pgf}{1}
      \pgfmathsetlengthmacro{\l__timechart_interval_solid_finish_x}
        {\l__timechart_legenditem_width_pgf}
      \int_case:nn {\l__timechart_start_range_type_int}
        {
          {0}{
            \pgfmathsetlengthmacro{\l__timechart_interval_solid_start_x}
              {\l__timechart_legenditem_range_width_pgf}
            \__timechart_interval_startrange_draw_pseudofade:
          }
          {1}{
            \pgfmathsetlengthmacro{\l__timechart_interval_solid_start_x}
              {\l__timechart_interval_startrange_start_x}
            \pgfinterruptboundingbox
            \__timechart_interval_finish_clip_path_none:
            \__timechart_interval_startrange_clip_path_start:
            \pgfpathclose
            \pgfusepath{clip}
            \endpgfinterruptboundingbox
          }
        }
      \__timechart_interval_solid_draw:
    }
  }
\NewDocumentCommand{\timechartlegendfinishrange}{ O{} }
  {
    \__timechart_legend_aux:nn{#1}{
      \pgfmathsetlengthmacro{\l__timechart_interval_finishrange_start_x}
        {
          \l__timechart_legenditem_width_pgf
          -\l__timechart_legenditem_range_width_pgf
        }
      \pgfmathsetlengthmacro{\l__timechart_interval_finishrange_finish_x}
        {\l__timechart_legenditem_width_pgf}
      \pgfmathsetlengthmacro
        {\l__timechart_interval_finishrange_start_level_pgf}{1}
      \pgfmathsetlengthmacro
        {\l__timechart_interval_finishrange_finish_level_pgf}{0}
      \pgfmathsetlengthmacro
        {\l__timechart_interval_solid_start_x}{0}
      \pgfmathsetlengthmacro{\l__timechart_interval_finish_max_x}
        {\l__timechart_legenditem_width_pgf}
      \int_case:nn {\l__timechart_finish_range_type_int}
        {
          {0}{
            \pgfmathsetlengthmacro{\l__timechart_interval_solid_finish_x}
              {
                \l__timechart_legenditem_width_pgf
                -\l__timechart_legenditem_range_width_pgf
              }
            \__timechart_interval_finishrange_draw_pseudofade:
          }
          {1}{
            \pgfmathsetlengthmacro{\l__timechart_interval_solid_finish_x}
              {\l__timechart_interval_finishrange_finish_x}
            \pgfinterruptboundingbox
            \__timechart_interval_finishrange_clip_path_finish:
            \__timechart_interval_start_clip_path_none:
            \pgfpathclose
            \pgfusepath{clip}
            \endpgfinterruptboundingbox
          }
        }
      \__timechart_interval_solid_draw:
    }
  }
\cs_new:Npn\__timechart_legend_aux:nn #1#2
  {
    \__timechart_debug:n{Legend~auxiliary}
    \tikzpicture
    \pgfkeys{
      /timechart/.cd,
      #1,
      interval~bar~thickness/.get=\l__timechart_bar_thickness_pgf,
      interval~bar~color/.get=\l__timechart_bar_color,
      interval~minimum~width/.get=\l__timechart_minimum_width_pgf,
      beyond~length~start/.get=\l__timechart_start_beyond_length_pgf,
      beyond~length~finish/.get=\l__timechart_finish_beyond_length_pgf,
      legend~item~width/.get=\l__timechart_legenditem_width_pgf,
      legend~item~range~width/.get=\l__timechart_legenditem_range_width_pgf,
    }
    \pgfmathsetlengthmacro{\l__timechart_bar_half_thickness_pgf}
      {.5*\l__timechart_bar_thickness_pgf}
    \pgfmathsetmacro{\l__timechart_start_x}{0}
    \pgfmathsetmacro{\l__timechart_finish_x}
      {\l__timechart_legenditem_width_pgf}
    \pgfmathsetlengthmacro{\l__timechart_start_beyond_x}
      {\l__timechart_start_x-\l__timechart_start_beyond_length_pgf}
    \pgfmathsetlengthmacro{\l__timechart_finish_beyond_x}
      {\l__timechart_finish_x+\l__timechart_finish_beyond_length_pgf}
    \pgfmathsetmacro{\l__timechart_current_y}{0}
    \pgfmathsetmacro{\l__timechart_start_tolerance_x}
      {\l__timechart_start_x-10mm}
    \pgfmathsetmacro{\l__timechart_finish_tolerance_x}
      {\l__timechart_finish_x+10mm}
    \pgfscope
    #2
    \endpgfscope
    \endtikzpicture%
  }
