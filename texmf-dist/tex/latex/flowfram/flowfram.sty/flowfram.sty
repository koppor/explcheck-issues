%%
%% This is file `flowfram.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% flowfram.dtx  (with options: `flowfram.sty,package')
%% 
%%  flowfram.dtx
%%  Copyright 2025 Nicola Talbot
%% 
%%  This work may be distributed and/or modified under the
%%  conditions of the LaTeX Project Public License, either version 1.3
%%  of this license or (at your option) any later version.
%%  The latest version of this license is in
%%    http://www.latex-project.org/lppl.txt
%%  and version 1.3 or later is part of all distributions of LaTeX
%%  version 2005/12/01 or later.
%% 
%%  This work has the LPPL maintenance status `maintained'.
%% 
%%  The Current Maintainer of this work is Nicola Talbot.
%% 
%%  This work consists of the files flowfram.dtx and flowfram.ins and the derived files flowfram.sty, flowframtkutils.sty, flowfram-2014-09-30.sty, flowfram-2025-08-23.sty, flowfram.l2h.
%% 
%% \CharacterTable
%%  {Upper-case    \A\B\C\D\E\F\G\H\I\J\K\L\M\N\O\P\Q\R\S\T\U\V\W\X\Y\Z
%%   Lower-case    \a\b\c\d\e\f\g\h\i\j\k\l\m\n\o\p\q\r\s\t\u\v\w\x\y\z
%%   Digits        \0\1\2\3\4\5\6\7\8\9
%%   Exclamation   \!     Double quote  \"     Hash (number) \#
%%   Dollar        \$     Percent       \%     Ampersand     \&
%%   Acute accent  \'     Left paren    \(     Right paren   \)
%%   Asterisk      \*     Plus          \+     Comma         \,
%%   Minus         \-     Point         \.     Solidus       \/
%%   Colon         \:     Semicolon     \;     Less than     \<
%%   Equals        \=     Greater than  \>     Question mark \?
%%   Commercial at \@     Left bracket  \[     Backslash     \\
%%   Right bracket \]     Circumflex    \^     Underscore    \_
%%   Grave accent  \`     Left brace    \{     Vertical bar  \|
%%   Right brace   \}     Tilde         \~}
\NeedsTeXFormat{LaTeX2e}
\DeclareRelease{v1.17}{2014-09-30}{flowfram-2014-09-30.sty}
\DeclareRelease{v1.18}{2025-08-23}{flowfram-2025-08-23.sty}
\DeclareCurrentRelease{v2.0}{2025-11-24}
\ProvidesPackage{flowfram}[2025/11/24 v2.0 (NLCT)]
\RequirePackage{rerunfilecheck}
\RequirePackage{graphics}
\RequirePackage{afterpage}
\RequirePackage{etoolbox}
\ExplSyntaxOn
\newcommand{\setffdraftcolor}{\color[gray]{0.8}}
\newcommand{\setffdrafttypeblockcolor}{\color[gray]{0.9}}
\newlength\fflabelsep
\setlength\fflabelsep{1pt}
\newcommand*{\fflabelfont}{\small\sffamily}
\newif\ifshowtypeblock
\newif\ifshowmargins
\newif\ifshowframebbox
\cs_new:Nn \__flowfram_set_draft:
 {
  \showtypeblocktrue
  \showmarginstrue
  \showframebboxtrue
 }
\cs_new:Nn \__flowfram_set_final:
 {
  \showtypeblockfalse
  \showmarginsfalse
  \showframebboxfalse
 }
\__flowfram_set_final:
\cs_new_protected:Nn \flowfram_frame:n
 {
   \leavevmode
   \hbox
    {
     \hskip -\@wholewidth
     \vbox
      {
        \vskip -\@wholewidth
        \hrule \@height \@wholewidth
        \hbox
         {
           \vrule \@width \@wholewidth
           #1
           \vrule \@width \@wholewidth
         }
        \hrule \@height \@wholewidth
        \vskip -\@wholewidth
      }
     \hskip -\@wholewidth
    }
 }
\cs_new:Nn \__flowfram_message:n
 {
  \flf@doifverbose
   {
     \msg_note:nn { flowfram } { #1 }
   }
 }
\cs_new:Nn \__flowfram_message:nn
 {
  \flf@doifverbose
   {
     \msg_note:nnn { flowfram } { #1 } { #2 }
   }
 }
\cs_new:Nn \__flowfram_message:nnn
 {
  \flf@doifverbose
   {
     \msg_note:nnnn { flowfram } { #1 } { #2 } { #3 }
   }
 }
\cs_generate_variant:Nn \__flowfram_message:nnn { nen , nee }
\cs_new:Nn \__flowfram_message:nnnn
 {
  \flf@doifverbose
   {
     \msg_note:nnnnn { flowfram } { #1 } { #2 } { #3 } { #4 }
   }
 }
\cs_generate_variant:Nn \__flowfram_message:nnnn { neee }
\cs_new:Nn \__flowfram_message:nnnnn
 {
  \flf@doifverbose
   {
     \msg_note:nnnnnn { flowfram } { #1 } { #2 } { #3 } { #4 } { #5 }
   }
 }
\cs_generate_variant:Nn \__flowfram_message:nnnnn
  { nnnen , nnneV , nnnev }
\cs_new:Nn \__flowfram_error:nnn
 {
   \msg_error:nnnn { flowfram } { #1 } { #2 } { #3 }
 }
\cs_generate_variant:Nn \__flowfram_error:nnn
 { eee }
\cs_new:Nn \__flowfram_error:nnnn
 {
   \msg_error:nnnnn { flowfram } { #1 } { #2 } { #3 } { #4 }
 }
\cs_generate_variant:Nn \__flowfram_error:nnnn
 { eeee }
\cs_new:Nn \__flowfram_error:nnnnn
 {
   \msg_error:nnnnnn { flowfram } { #1 } { #2 } { #3 } { #4 } { #5 }
 }
\cs_generate_variant:Nn \__flowfram_error:nnnnn
 { eeeee }
\newcommand{\flf@doifverbose}[1]{}
\char_set_catcode_space:n { `\ }

\msg_new:nnnn {flowfram} {label-defined}
 {Label `#1' already defined for frame type `#2'}
 {You can't assign this label, as it is already defined
  for #2 frame IDN #3}

\msg_new:nnnn {flowfram} {label-undefined}
 {Label `#1' is not defined for any #2 frame}
 {Check that you have spelt the label correctly and that
  the label corresponds to a #2 frame}

\msg_new:nnnn {flowfram} {idn-undefined}
 {No #1 frame with IDN #2}
 {Identification numbers start from 1 to the number of defined #1 frames}

\msg_new:nnnn {flowfram} {invalid-id}
 {Invalid IDN #1}
 {Identification numbers start from 1}

\msg_new:nnnn {flowfram} {attribute-type-change}
 {Frame attribute #1 of type '#2' now being defined as '#3'}
 {Frame attribute #1 has already been defined as type '#2' but
 now this attribute is being defined as type '#3'}

\msg_new:nnnn {flowfram} {invalid-frame-type}
 {Unknown frame type `#1'}
 {Frame types can be one of: flow, static or dynamic}

\msg_new:nnnn {flowfram} {invalid-frame-typeid}
 {Unknown frame type ID `#1'}
 {Frame type IDs can be one of: 1 (flow), 2 (static) or 3 (dynamic)}

\msg_new:nnn {flowfram} {frame-unsupported-options}
 {Frame type `#1' does not support option(s): #2}

\msg_new:nnnn {flowfram} {frame-unknown-tag}
 {Frame type `#1' does not have #4 attribute #2 defined (IDN #3)}
 {Check that you have correctly spelt the attribute `#2' and have
correctly identified the type of frame and its numeric identifier.
The other possibility is that there is a bug in the code that's
incorrectly identified the underlying data type (#4).}

\msg_new:nnn {flowfram} {non-void-box}
 {Box #1 is not void.  Dumping. This page: #2.
  Page list: "#3".  Exclusion list: "#4".
  (Maybe the page list was changed after this frame was
  selected or maybe you should use package option pages=absolute)}

\msg_new:nnn {flowfram} {invalid-bool}
 {Invalid boolean setting `#1' for attribute `#2' applied to #3 frame IDN #4}

\msg_new:nnnn {flowfram} {invalid-pagelist}
 {Invalid page list `#1'}
 {A page list may be one of the keywords `all', `none', `even' or
 `odd', or may be an ordered comma-separated list of individual
  numbers (e.g. `2'), a closed range (e.g. `12-18'), or an
  open-ended range (e.g. `<3' or `>5'). Overlapping ranges are not
  permitted and items must be listed in increasing numerical order
  (e.g. `<4,9-12,15,>20')}

\msg_new:nnnn {flowfram} {cant-set-column}
 {Can't set current column to frame `#1' (so such frame)}
 {There is no frame defined with the IDN `#1'}

\msg_new:nnn {flowfram} {unequal-cols}
 {Moving to flow frame of unequal width, use of
  \token_to_str:N \framebreak \c_space_tl advised,
  or text might not appear correctly (difference = #1,
  tolerance = #2)}

\msg_new:nnn {flowfram} {no-page1-col}
 {Can't find a flow frame on page 1.
  Attempting to find the first page with a flow frame}

\msg_new:nnn {flowfram} {no-cols}
 {No flow frames, adding #1}

\msg_new:nnn {flowfram} {no-more-cols-on-page}
 {Run out of flows frames on page #1, adding new one}

\msg_new:nnn {flowfram} {misplaced-col-cmd}
 {Found #1 in document environment with
 column-changes=switch option set but no frame
 has been identified to use with #1}

\msg_new:nnnn {flowfram} {doc-env-only}
 {Command #1 only permitted in document environment}
 {You can't use #1 in the preamble}

\msg_new:nnn {flowfram} {background-not-first}
 {Background frame is not first static frame to be
  defined. All previously defined static frames may be
  obscured.}

\msg_new:nnn {flowfram} {ignoring-multiple-makethumbtabs}
 {Ignoring repeated instance of \makethumbtabs}

\msg_new:nnn {flowfram} {no-thumbtabs-missing-makethumbtabs}
 {No thumb tabs defined: missing \makethumbtabs}

\msg_new:nnn {flowfram} {no-thumbtabs-rerun}
 {No thumb tabs defined. Rerun may be required}

\msg_new:nnn {flowfram} {cant-find-thumbtab}
 {Can't find thumbtab number `#1', ttb file may not be
 up-to-date}

\msg_new:nnnn {flowfram} {cant-find-thumbtab-index}
 {Can't find thumbtab index number `#1'}
 {Something's gone wrong. The thumbtab `#1' exists but
  thumbtab index `#1' doesn't}

\msg_new:nnnn {flowfram} {invalid-thumbtab-index}
 {Invalid thumbtab index `#1'}
 {Thumbtab indexing starts at 1}

\msg_new:nnn {flowfram} {section-unit-not-defined}
 {Sectioning type `#1' not defined}

\msg_new:nnn {flowfram} {unknown-heading-cmd}
 {Unknown heading command `#1'}

\msg_new:nnn {flowfram} {unknown-shape}
 {Unknown shape #1}

\msg_new:nnn {flowfram} {forbidden-cmd-in-shape}
 {You can't use #1 within a paragraph shaped with #2}

\msg_new:nnnn {flowfram} {cant-continue}
 {Can't continue to new frame: either not in static or dynamic frame or attempting to append content}
 {\token_to_str:N \continueonframe \c_space_tl may only
  be used inside `staticcontents' or `dynamiccontents'
  environments (or their starred versions) or in the commands
  \token_to_str:N \setstaticcontents \c_space_tl or
  \token_to_str:N \setdynamiccontents}

\msg_new:nnnn {flowfram} {invalid-num-frames}
 {You have requested #2 #1 frames!}
 {The number of frames must be greater than 0}

\msg_new:nnnn {flowfram} {no-chapters}
 {Chapters aren't defined}
 {The document class you are using does not support chapters}

\msg_new:nnnn {flowfram} {option-too-late}
 {Option #1 occurring too late (has no effect after #2)}
 {If you want to set this option, you need to do so earlier}

\msg_new:nnn {flowfram} {relloc-label-already-defined}
 {Relative location label `#1' multiply defined}

\msg_new:nnn {flowfram} {relloc-label-not-defined}
 {Relative location label `#1' undefined}

\msg_new:nnn {flowfram} {data-changed-rerun}
 {Label or frame data has changed. Rerun required}

\msg_new:nnn {flowfram} {info-set-excludelist}
 {Setting exclusion list for #1 frame IDN #2 to `#3'}

\msg_new:nnn {flowfram} {info-switching-col}
 {Switching to flow frame #1 on page #2}

\msg_new:nnn {flowfram} {info-setting-col}
 {Setting contents of box for flow frame #1}

\msg_new:nnn {flowfram} {info-doing-col}
 {Doing flow frame #1 (page #2)}

\msg_new:nnn {flowfram} {info-col-not-required}
 {Flow frame #1 is not required on page #2}

\msg_new:nnn {flowfram} {info-col-list}
 {List of defined flow frames: #1}

\msg_new:nnn {flowfram} {info-static-frame-hidden}
 {Static frame IDN #1 is hidden (#2=true)}

\msg_new:nnn {flowfram} {info-dynamic-frame-hidden}
 {Dynamic frame IDN #1 is hidden (#2=true)}

\msg_new:nnn {flowfram} {info-no-file}
  {No file #1.}

\msg_new:nnn {flowfram} {info-no-rotation}
  {Frame rotation has been disable.
   Attempt to rotate frame has been ignored.}

\msg_new:nnn {flowfram} {info-found-thumbtab}
 {Found thumbtab data { #1 } { #2 } { #3 } { #4 }}

\msg_new:nnn {flowfram} {info-thumbtab}
 {Thumbtab #1 dynamic frame #2 (IDN #3)}

\msg_new:nnn {flowfram} {info-thumbtab-index}
 {Thumbtab index #1 dynamic frame #2 (IDN #3)}

\msg_new:nnn {flowfram} {info-setting-frame-attribute}
 {Setting #1 attribute for #2 frame #3 to #4}

\msg_new:nnn {flowfram} {show-frame-attributes}
 {Frame type #1 IDN #2 has the following attributes:\\#3}

\msg_new:nnn {flowfram} {show-all-frames-none}
 {There are no frames of type #1}

\msg_new:nnn {flowfram} {show-all-frames}
 {Showing all #1 frames.
  Each frame will be shown separately.
  Total number of #1 frames: \\#2}

\char_set_catcode_ignore:n { `\ }
\bool_new:N \l__flowfram_allow_frame_rotation_bool
\bool_set_true:N \l__flowfram_allow_frame_rotation_bool
\cs_new:Nn \__flowfram_thumbtab_fmt:nn
 {
   \__flowfram_thumbtab_fmt_sideways:nn { #1 } { #2 }
 }
\cs_new:Nn \__flowfram_thumbtab_fmt_sideways_oneside_right:nn
 {
    \rotatebox { -90 }
     {
       \parbox [ c ] [ \thumbtabwidth ] { #2 }
        {
          \centering #1
        }
     }
 }
\cs_new:Nn \__flowfram_thumbtab_fmt_sideways_oneside_left:nn
 {
    \rotatebox { 90 }
     {
       \parbox [ c ] [ \thumbtabwidth ] { #2 }
        {
          \centering #1
        }
     }
 }
\cs_new:Nn \__flowfram_thumbtab_fmt_sideways:nn
 {
   \if@twoside
     \int_if_odd:nTF { \c@page }
      {
        \__flowfram_thumbtab_fmt_sideways_oneside_right:nn
          { #1 } { #2 }
      }
      {
        \__flowfram_thumbtab_fmt_sideways_oneside_left:nn
          { #1 } { #2 }
      }
   \else
     \__flowfram_thumbtab_fmt_sideways_oneside_right:nn
   \fi
 }
\cs_new:Nn \__flowfram_thumbtab_fmt_stack:nn
 {
   \parbox [ c ] [ #2 ] { \thumbtabwidth }
    {
      \centering
      \flowfram_thumbtab_stack:n { #1 }
    }
 }
\bool_new:N \l__flowfram_ttb_show_number_bool
\bool_set_false:N \l__flowfram_ttb_show_number_bool
\bool_new:N \l__flowfram_ttb_show_title_bool
\bool_set_true:N \l__flowfram_ttb_show_title_bool
\tl_new:N \g__flowfram_pagecounter_tl
\tl_gset:Nn \g__flowfram_pagecounter_tl { \c@page }
\newcommand \theFramePageCounter
 {
   \int_eval:n { \g__flowfram_pagecounter_tl }
 }
\newcounter{absolutepage}
\newcommand \flowfram@thepagenumber { \int_use:N \c@page }
\tl_const:Nn \c_flowfram_all_tl { all }
\tl_const:Nn \c_flowfram_odd_tl { odd }
\tl_const:Nn \c_flowfram_even_tl { even }
\tl_const:Nn \c_flowfram_none_tl { none }
\tl_const:Nn \c_flowfram_color_none_tl {  { none } }
\tl_const:Nn \c_flowfram_color_black_tl {  { black } }
\tl_const:Nn \c_flowfram_inner_tl { inner }
\tl_const:Nn \c_flowfram_outer_tl { outer }
\tl_const:Nn \c_flowfram_left_tl { left }
\tl_const:Nn \c_flowfram_right_tl { right }
\tl_const:Nn \c_flowfram_compute_tl { compute}
\int_const:Nn \c_flowfram_max_page_int { 100000 }
\int_const:Nn \c_flowfram_shape_type_parshape_int { 1 }
\int_const:Nn \c_flowfram_shape_type_shapepar_int { 2 }
\int_const:Nn \c_flowfram_shape_type_none_int { 0 }
\int_const:Nn \c_flowfram_frame_type_flow_int { 1 }
\int_const:Nn \c_flowfram_frame_type_static_int { 2 }
\int_const:Nn \c_flowfram_frame_type_dynamic_int { 3 }
\newcommand \flowframecol { }
\newcommand \flowframetextcol { }
\cs_new:Nn \__flowfram_do_if_draft:nnn
 {
  \tl_set_eq:NN
     \l__flowfram_backcolor_tl
     \c_flowfram_color_none_tl
  #1
  \flowfram_frame:n { #2 }
  \tl_if_empty:nF { #3 }
   {
     \makebox [ 0pt ] [ l ]
      {
        \hskip \fflabelsep
        \fflabelfont { #3 }
      }
   }
}
\cs_new:Nn \__flowfram_do_if_draft:nn
 {
   \__flowfram_do_if_draft:nnn
    { \setffdraftcolor } { #1 } { #2 }
 }
\cs_new:Nn \flowfram_draft_annote:nnn
 {
   [ #1 : #2 ; #3 ]
 }
\cs_new:Nn \flowfram_draft_annote:nn
 {
   [ #1 : #2 ]
 }
\cs_new:Nn \__flowfram_set_border_color: { }
\tl_new:N \l__flowfram_bordercolor_tl
\cs_new:Nn \__flowfram_set_text_color: { }
\tl_new:N \l__flowfram_textcolor_tl
\cs_new:Nn \__flowfram_background_box:n { #1 }
\tl_new:N \l__flowfram_backcolor_tl
\cs_new:Nn \__flowfram_enable_color:
 {
  \tl_set_eq:NN \flowframecol \c_flowfram_color_black_tl
  \tl_set_eq:NN \flowframetextcol \c_flowfram_color_black_tl
  \cs_set:Nn \__flowfram_set_border_color:
   {
     \exp_args:Ne \__flowfram_color:n
       { \l__flowfram_bordercolor_tl }
   }
  \cs_set:Nn \__flowfram_set_text_color:
   {
     \exp_args:Ne \__flowfram_color:n
       { \l__flowfram_textcolor_tl }
   }
  \cs_set:Nn \__flowfram_background_box:n
   {
     \exp_args:Ne
     \__flowfram_background_box:nn
       { \l__flowfram_backcolor_tl } { ##1 }
   }
 }
\prg_new_conditional:Nnn \__flowfram_if_no_color:n
   { T, F, TF }
 {
   \tl_if_empty:nTF { #1 }
     { \prg_return_true: }
    {
      \tl_if_eq:NnTF \c_flowfram_color_none_tl { #1 }
        { \prg_return_true: }
        { \prg_return_false: }
    }
 }
\cs_new:Nn \__flowfram_color:n
 {
   \__flowfram_if_no_color:nF
    { #1 }
    { \color #1 }
 }
\cs_new:Nn \__flowfram_background_box:nn
 {
   \__flowfram_if_no_color:nTF { #1 }
     { #2 }
     {
       \group_begin:
         \dim_zero:N \fboxsep
         \colorbox #1 { #2 }
       \group_end:
     }
 }
\cs_new:Nn \__flowfram_disable_color:
 {
  \tl_clear:N \flowframetextcol
  \tl_clear:N \flowframecol
  \cs_set:Nn \__flowfram_set_border_color: { }
  \cs_set:Nn \__flowfram_set_text_color: { }
  \cs_set_eq:NN \__flowfram_background_box:n \use:n
 }
\newif\iflefttorightcolumns
\lefttorightcolumnstrue
\bool_new:N \g__flowfram_ignore_column_changes_bool
\bool_gset_true:N \g__flowfram_ignore_column_changes_bool
\bool_new:N \g__flowfram_clearpage_column_changes_bool
\bool_gset_false:N \g__flowfram_clearpage_column_changes_bool
\bool_new:N \g__flowfram_save_nonum_thumbtabs_bool
\newif\ifaligntoc
\aligntocfalse
\bool_new:N \l__flowfram_thumbtabs_in_toc_bool
\bool_set_false:N \l__flowfram_thumbtabs_in_toc_bool
\bool_new:N \l__flowfram_thumbtabs_span_toc_bool
\bool_set_false:N \l__flowfram_thumbtabs_span_toc_bool
\bool_new:N \l__flowfram_section_header_opt_bool
\IfClassLoadedTF { memoir }
 {
   \bool_set_true:N \l__flowfram_section_header_opt_bool
 }
 {
   \bool_set_false:N \l__flowfram_section_header_opt_bool
 }
\bool_new:N \l__flowfram_section_header_opt_thumbtab_bool
\bool_set_true:N \l__flowfram_section_header_opt_thumbtab_bool
\bool_new:N \l__flowfram_section_keyval_opt_bool
\bool_set_false:N \l__flowfram_section_keyval_opt_bool
\tl_new:N \l__flowfram_section_opti_tl
\tl_new:N \l__flowfram_section_optii_tl
\tl_new:N \l__flowfram_section_toc_tl
\tl_new:N \l__flowfram_section_head_tl
\keys_define:nn { flowfram / section }
 {
    head .tl_set:N = \l__flowfram_section_head_tl ,
    tocentry .tl_set:N = \l__flowfram_section_toc_tl ,
    toc .tl_set:N = \l__flowfram_section_toc_tl ,
 }
\NewDocumentCommand \thumbtabhyperlinkformat { m m m }
 {
    \thumbtabformat { #2 } { #3 }
 }
\AddToHook
  { package / hyperref / after }
  {
    \RenewDocumentCommand \thumbtabhyperlinkformat { m m m }
     {
        \hyperlink { #1 } { \thumbtabformat { #2 } { #3 } }
     }
  }
\newcommand \thumbtabindexformat [ 3 ]
 {
   \thumbtabhyperlinkformat { #1 } { #2 } { #3 }
 }
\newcommand \thumbtabregularformat [ 3 ]
 {
   \thumbtabformat { #2 } { #3 }
 }
\bool_new:N \g__flowfram_frontmatter_bool
\bool_gset_false:N \g__flowfram_frontmatter_bool
\bool_new:N \g__flowfram_backmatter_bool
\bool_gset_false:N \g__flowfram_backmatter_bool
\cs_if_exist:cTF { if@mainmatter }
 {
   \prg_new_conditional:Nnn \flowfram_if_mainmatter:
      { T, F, TF }
    {
      \legacy_if:nTF { @mainmatter }
        { \prg_return_true: }
        { \prg_return_false: }
    }
   \cs_if_exist:NT \frontmatter
    {
      \appto \frontmatter
       {
         \bool_gset_true:N \g__flowfram_frontmatter_bool
         \bool_gset_false:N \g__flowfram_backmatter_bool
       }
    }
   \cs_if_exist:NT \backmatter
    {
      \appto \backmatter
       {
         \bool_gset_false:N \g__flowfram_frontmatter_bool
         \bool_gset_true:N \g__flowfram_backmatter_bool
         \__flowfram_write_backmatter_ttb:
         \__flowfram_backmatter_setsecnumdepth:
       }
    }
   \cs_if_exist:NT \mainmatter
    {
      \appto \mainmatter
       {
         \bool_gset_false:N \g__flowfram_frontmatter_bool
         \bool_gset_false:N \g__flowfram_backmatter_bool
       }
    }
 }
 {
   \prg_new_conditional:Nnn \flowfram_if_mainmatter:
      { T, F, TF }
    {
       \prg_return_true:
    }
 }
\cs_new:Nn \__flowfram_ttb_notmainmatter_num:n
 {
   \bool_if:NF \g__flowfram_frontmatter_bool
     {
       \__flowfram_ttb_num:n { #1 }
     }
 }
\cs_new:Nn \__flowfram_backmatter_setsecnumdepth:
 {
   \setcounter { secnumdepth } { -1 }
 }
\cs_new:Nn \flowfram_header_case:n { #1 }
\cs_new:Nn \flowfram_subheader_case:n { #1 }
\cs_new:Nn \flowfram_header_font:n { \emph { #1 } }
\cs_new:Nn \flowfram_subheader_font:n { \flowfram_header_font:n { #1 } }
\cs_new:Nn \__flowfram_adjust_page_styles:n
 {
   #1
 }
\ExplSyntaxOff
\ifdef\chapter
 {
  \newcommand{\flowframheaderchapprefix}{\@chapapp \ }
  \newcommand{\flowframheadersep}{.\ }
 }
 {
  \newcommand{\flowframheaderchapprefix}{}
  \newcommand{\flowframheadersep}{\quad}
 }
\ExplSyntaxOn
\renewcommand \tableofcontents
 {
   \__flowfram_tableofcontents:
 }
\cs_if_exist:NTF \chapter
 {
  \cs_new:Nn \__flowfram_adjusted_toc:
   {
     \chapter * { \contentsname }
     \chaptermark { \contentsname }
     \@starttoc { toc }
   }
 }
 {
  \cs_new:Nn \__flowfram_adjusted_toc:
   {
     \section * { \contentsname }
     \sectionmark { \contentsname }
     \@starttoc { toc }
   }
 }
\cs_new:Nn \flowfram_toc:
 {
   \__flowfram_adjusted_toc:
 }
\tl_new:N \l__flowfram_ffempty_style_tl
\tl_set:Nn \l__flowfram_ffempty_style_tl { \__flowfram_ps_empty: }
\bool_new:N \l__flowfram_ps_ffempty_hides_bool
\bool_set_true:N \l__flowfram_ps_ffempty_hides_bool
\cs_new:Nn \__flowfram_only_pre_makedfheaderfooter:nn { #2 }
\cs_set_eq:NN \__flowfram_org_tableofcontents: \tableofcontents
\cs_new:Nn \__flowfram_do_addto_prechap:
{
  \__flowfram_addto_prechap:
}
\cs_new:Nn \__flowfram_addto_prechap:
{
  \cs_if_exist:NT \chapter
   {
    \newcommand*{\chapterfirstpagestyle}{plain}%
    \AddToHook { cmd / chapter / before }
     {
       \ffprechapterhook
       \thispagestyle { \chapterfirstpagestyle }
     }
    \newcommand*{\ffprechapterhook}{}
 }
}
\keys_define:nn { flowfram }
{
  adjust-toc .choice: ,
  adjust-toc / header  .code:n =
   {
     \cs_set:Nn \flowfram_toc:
      {
        \__flowfram_adjusted_toc:
      }
     \renewcommand \tableofcontents
      {
        \__flowfram_tableofcontents:
      }
   } ,
  adjust-toc / notheader  .code:n =
   {
     \cs_set:Nn \flowfram_toc:
      {
         \__flowfram_org_tableofcontents:
      }
     \renewcommand \tableofcontents
      {
        \__flowfram_tableofcontents:
      }
   } ,
  adjust-toc / off  .code:n =
   {
     \let \tableofcontents \__flowfram_org_tableofcontents:
   } ,
  dynamic-page-style .choice: ,
  dynamic-page-style .usage:n = { preamble } ,
  dynamic-page-style / adjust .code:n =
   {
     \__flowfram_only_pre_makedfheaderfooter:nn
       { dynamic-page-style = adjust }
      {
        \cs_set_eq:NN \__flowfram_adjust_page_styles:n \use:n
      }
   } ,
  dynamic-page-style / noadjust .code:n =
   {
     \__flowfram_only_pre_makedfheaderfooter:nn
       { dynamic-page-style = noadjust }
      {
        \cs_set_eq:NN \__flowfram_adjust_page_styles:n \use_none:n
      }
   } ,
  dynamic-header-case .choice: ,
  dynamic-header-case / uc .code:n =
   {
     \cs_set:Nn \flowfram_header_case:n
      {
        \MakeUppercase { ##1 }
      }
   } ,
  dynamic-header-case / no-change .code:n =
   {
     \cs_set:Nn \flowfram_header_case:n { ##1 }
   } ,
  dynamic-subheader-case .choice: ,
  dynamic-subheader-case / uc .code:n =
   {
     \cs_set:Nn \flowfram_subheader_case:n
      {
        \MakeUppercase { ##1 }
      }
   } ,
  dynamic-subheader-case / no-change .code:n =
   {
     \cs_set:Nn \flowfram_subheader_case:n { ##1 }
   } ,
  dynamic-page-style-header-font .code:n =
   {
     \tl_if_empty:nTF { #1 }
      {
        \cs_set:Nn \flowfram_header_font:n { ##1 }
      }
      {
        \cs_set:Nn \flowfram_header_font:n { #1 { ##1 } }
      }
   } ,
  dynamic-page-style-subheader-font .code:n =
   {
     \tl_if_empty:nTF { #1 }
      {
        \cs_set:Nn \flowfram_subheader_font:n { ##1 }
      }
      {
        \cs_set:Nn \flowfram_subheader_font:n { #1 { ##1 } }
      }
   } ,
  dynamic-empty-page-style .choice: ,
  dynamic-empty-page-style / empty .code:n =
    {
      \tl_set:Nn \l__flowfram_ffempty_style_tl { \__flowfram_ps_empty: }
      \bool_set_false:N \l__flowfram_ps_ffempty_hides_bool
    } ,
  dynamic-empty-page-style / plain .code:n =
    {
      \tl_set:Nn \l__flowfram_ffempty_style_tl { \__flowfram_ps_plain: }
      \bool_set_false:N \l__flowfram_ps_ffempty_hides_bool
    } ,
  dynamic-empty-page-style / headings .code:n =
    {
      \tl_set:Nn \l__flowfram_ffempty_style_tl { \__flowfram_ps_headings: }
      \bool_set_false:N \l__flowfram_ps_ffempty_hides_bool
    } ,
  dynamic-empty-page-style / myheadings .code:n =
    {
      \tl_set:Nn \l__flowfram_ffempty_style_tl { \__flowfram_ps_myheadings: }
      \bool_set_false:N \l__flowfram_ps_ffempty_hides_bool
    } ,
  dynamic-empty-page-style / ignore .code:n =
    {
      \tl_clear:N \l__flowfram_ffempty_style_tl
      \bool_set_false:N \l__flowfram_ps_ffempty_hides_bool
    } ,
  dynamic-empty-page-style / hide .code:n =
    {
      \bool_set_true:N \l__flowfram_ps_ffempty_hides_bool
    } ,
  dynamic-empty-page-style / show .code:n =
    {
      \bool_set_false:N \l__flowfram_ps_ffempty_hides_bool
    } ,
  backmatter-sections .choice: ,
  backmatter-sections / no-number .code:n =
   {
    \cs_set:Nn \__flowfram_backmatter_setsecnumdepth:
     {
       \setcounter { secnumdepth } { -1 }
     }
   } ,
  backmatter-sections / no-change .code:n =
   {
    \cs_set:Nn \__flowfram_backmatter_setsecnumdepth:
     {
     }
   } ,
   matter-thumbtabs .choice: ,
   matter-thumbtabs / main-only .code:n =
    {
      \cs_set:Nn \__flowfram_ttb_notmainmatter_num:n
       {
       }
    },
   matter-thumbtabs / all .code:n =
    {
      \cs_set:Nn \__flowfram_ttb_notmainmatter_num:n
       {
         \__flowfram_ttb_num:n { ##1 }
       }
    },
   matter-thumbtabs / not-front .code:n =
    {
      \cs_set:Nn \__flowfram_ttb_notmainmatter_num:n
       {
         \bool_if:NF \g__flowfram_frontmatter_bool
           {
             \__flowfram_ttb_num:n { ##1 }
           }
       }
    },
   matter-thumbtabs / not-back .code:n =
    {
      \cs_set:Nn \__flowfram_ttb_notmainmatter_num:n
       {
         \bool_if:NF \g__flowfram_backmatter_bool
           {
             \__flowfram_ttb_num:n { ##1 }
           }
       }
    },
   thumbtab-links .choice: ,
   thumbtab-links / toc-only .code:n =
    {
      \renewcommand \thumbtabindexformat [ 3 ]
       {
         \thumbtabhyperlinkformat { ##1 } { ##2 } { ##3 }
       }
      \renewcommand \thumbtabregularformat [ 3 ]
       {
         \thumbtabformat { ##2 } { ##3 }
       }
    } ,
   thumbtab-links / all .code:n =
    {
      \renewcommand \thumbtabindexformat [ 3 ]
       {
         \thumbtabhyperlinkformat { ##1 } { ##2 } { ##3 }
       }
      \renewcommand \thumbtabregularformat [ 3 ]
       {
         \thumbtabhyperlinkformat { ##1 } { ##2 } { ##3 }
       }
    } ,
   thumbtab-links / none .code:n =
    {
      \renewcommand \thumbtabindexformat [ 3 ]
       {
         \thumbtabformat { ##2 } { ##3 }
       }
      \renewcommand \thumbtabregularformat [ 3 ]
       {
         \thumbtabformat { ##2 } { ##3 }
       }
    } ,
   unstarred-thumbtabs .bool_gset:N =
    \g__flowfram_save_nonum_thumbtabs_bool ,
   toc-thumbtabs .choice: ,
   toc-thumbtabs / aligned .code:n =
    {
      \aligntoctrue
      \bool_set_true:N \l__flowfram_thumbtabs_in_toc_bool
      \bool_set_false:N \l__flowfram_thumbtabs_span_toc_bool
    } ,
   toc-thumbtabs / unaligned .code:n =
    {
      \aligntocfalse
      \bool_set_true:N \l__flowfram_thumbtabs_in_toc_bool
      \bool_set_false:N \l__flowfram_thumbtabs_span_toc_bool
    } ,
   toc-thumbtabs / false .code:n =
    {
      \bool_set_false:N \l__flowfram_thumbtabs_in_toc_bool
    } ,
   toc-thumbtabs / true .code:n =
    {
      \aligntocfalse
      \bool_set_true:N \l__flowfram_thumbtabs_in_toc_bool
      \bool_set_true:N \l__flowfram_thumbtabs_span_toc_bool
    } ,
   toc-thumbtabs .default:n = { true } ,
   sections-extra-option .choice: ,
   sections-extra-option / as-original .code:n =
    {
      \bool_set_true:N \l__flowfram_section_header_opt_bool
      \bool_set_false:N \l__flowfram_section_header_opt_thumbtab_bool
    } ,
   sections-extra-option / thumbtab-only .code:n =
    {
      \bool_set_false:N \l__flowfram_section_header_opt_bool
      \bool_set_true:N \l__flowfram_section_header_opt_thumbtab_bool
    } ,
   sections-extra-option / original-and-thumbtab .code:n =
    {
      \bool_set_true:N \l__flowfram_section_header_opt_bool
      \bool_set_true:N \l__flowfram_section_header_opt_thumbtab_bool
    } ,
   sections-option-keyval .bool_set:N = \l__flowfram_section_keyval_opt_bool ,
   column-changes .choice: ,
   column-changes / ignore .code:n =
    {
      \bool_gset_true:N \g__flowfram_ignore_column_changes_bool
      \bool_gset_false:N \g__flowfram_clearpage_column_changes_bool
    } ,
   column-changes / clearpage .code:n =
    {
      \bool_gset_true:N \g__flowfram_clearpage_column_changes_bool
      \bool_gset_true:N \g__flowfram_ignore_column_changes_bool
    } ,
   column-changes / switch .code:n =
    {
      \bool_gset_true:N \g__flowfram_clearpage_column_changes_bool
      \bool_gset_false:N \g__flowfram_ignore_column_changes_bool
    } ,
   draft .code:n = { \__flowfram_set_draft: } ,
   final .code:n = { \__flowfram_set_final: } ,
   verbose .choice: ,
   verbose / true .code:n =
    {
      \let \flf@doifverbose \@firstofone
    } ,
   verbose / false .code:n =
    {
      \let \flf@doifverbose \@gobble
    } ,
   verbose .default:n = { true } ,
   thumbtab-text .choice: ,
   thumbtab-text / normal .code:n =
    {
      \cs_set_eq:NN \__flowfram_thumbtab_fmt:nn \use_i:nn
    } ,
   thumbtab-text / stack .code:n =
    {
      \cs_set_eq:NN
         \__flowfram_thumbtab_fmt:nn
         \__flowfram_thumbtab_fmt_stack:nn
    } ,
   thumbtab-text / rotate-right .code:n =
    {
      \cs_set_eq:NN
         \__flowfram_thumbtab_fmt:nn
         \__flowfram_thumbtab_fmt_sideways_oneside_right:nn
    } ,
   thumbtab-text / rotate-left .code:n =
    {
      \cs_set_eq:NN
         \__flowfram_thumbtab_fmt:nn
         \__flowfram_thumbtab_fmt_sideways_oneside_left:nn
    } ,
   thumbtab-text / rotate .code:n =
    {
      \cs_set_eq:NN
         \__flowfram_thumbtab_fmt:nn
         \__flowfram_thumbtab_fmt_sideways:nn
    } ,
   prohibit-frame-rotation .bool_set_inverse:N =
       \l__flowfram_allow_frame_rotation_bool ,
   rotate .choice: ,
   rotate / true .code:n =
    {
      \bool_set_true:N \l__flowfram_allow_frame_rotation_bool
      \cs_set_eq:NN
         \__flowfram_thumbtab_fmt:nn
         \__flowfram_thumbtab_fmt_sideways_oneside_right:nn
    } ,
   rotate / false .code:n =
    {
      \bool_set_false:N \l__flowfram_allow_frame_rotation_bool
      \cs_set_eq:NN
         \__flowfram_thumbtab_fmt:nn
         \__flowfram_thumbtab_fmt_stack:nn
    } ,
   rotate .default:n = { true } ,
   norotate .code:n =
    {
      \bool_set_false:N \l__flowfram_allow_frame_rotation_bool
      \cs_set_eq:NN
         \__flowfram_thumbtab_fmt:nn
         \__flowfram_thumbtab_fmt_stack:nn
    } ,
   thumbtabs .choice: ,
   thumbtabs / title .code:n =
    {
       \bool_set_false:N \l__flowfram_ttb_show_number_bool
       \bool_set_true:N \l__flowfram_ttb_show_title_bool
    } ,
   thumbtabs / number .code:n =
    {
       \bool_set_true:N \l__flowfram_ttb_show_number_bool
       \bool_set_false:N \l__flowfram_ttb_show_title_bool
    } ,
   thumbtabs / both .code:n =
    {
       \bool_set_true:N \l__flowfram_ttb_show_number_bool
       \bool_set_true:N \l__flowfram_ttb_show_title_bool
    } ,
   thumbtabs / none .code:n =
    {
       \bool_set_false:N \l__flowfram_ttb_show_number_bool
       \bool_set_false:N \l__flowfram_ttb_show_title_bool
    } ,
   thumbtabs .default:n = { title } ,
   thumbtabs .usage:n = { preamble } ,
   ttbtitle .code:n =
     {
       \bool_set_true:N \l__flowfram_ttb_show_title_bool
     } ,
   ttbtitle .usage:n = { preamble } ,
   ttbnotitle .code:n =
     {
       \bool_set_false:N \l__flowfram_ttb_show_title_bool
     } ,
   ttbnotitle .usage:n = { preamble } ,
   ttbnum .code:n =
     {
       \bool_set_true:N \l__flowfram_ttb_show_number_bool
     } ,
   ttbnum .usage:n = { preamble } ,
   ttbnonum .code:n =
     {
       \bool_set_false:N \l__flowfram_ttb_show_number_bool
     } ,
   ttbnonum .usage:n = { preamble } ,
   pages .choice: ,
   pages / relative .code:n =
    {
      \tl_gset:Nn \g__flowfram_pagecounter_tl { \c@page }
    } ,
   pages / absolute .code:n =
    {
      \tl_gset:Nn \g__flowfram_pagecounter_tl { \c@absolutepage }
    } ,
   pages .usage:n = { preamble } ,
   color .choice: ,
   color / true .code:n =
    {
      \__flowfram_enable_color:
    } ,
   color / false .code:n =
    {
      \__flowfram_disable_color:
    } ,
   color .default:n = { true } ,
   color .usage:n = { preamble } ,
   nocolor .code:n =
    {
      \__flowfram_disable_color:
    } ,
   nocolor .usage:n = { preamble } ,
   LR .code:n = { \lefttorightcolumnstrue } ,
   LR .usage:n = { preamble } ,
   RL .code:n = { \lefttorightcolumnsfalse } ,
   RL .usage:n = { preamble } ,
   adjust-pre-chapter .choice: ,
   adjust-pre-chapter / true .code:n =
    {
      \cs_set:Nn \__flowfram_do_addto_prechap:
      {
        \__flowfram_addto_prechap:
      }
    } ,
   adjust-pre-chapter / false .code:n =
    {
      \cs_set:Nn \__flowfram_do_addto_prechap: { }
    } ,
   adjust-pre-chapter .default:n = { true },
   adjust-pre-chapter .usage:n = { load },
}
\NewDocumentCommand \flowframsetup { m }
 {
   \keys_set:nn { flowfram } { #1 }
 }
\flowframsetup{color}
\IfPackageLoadedT { flowframtkutils }
 {
   \clist_if_empty:NF  \g__flowframtk_options_clist
    {
      \keys_set:nV { flowfram } \g__flowframtk_options_clist
    }
 }
\ExplSyntaxOff
\RequirePackage{color}
\ProcessKeyOptions[flowfram]
\ExplSyntaxOn
\newlength \typeblockwidth
\newlength \typeblockheight
\newlength \typeblockoffsety
\cs_new:Nn \flowfram_update_typeblock:
 {
   \global \setlength \typeblockwidth \textwidth
   \global \setlength \typeblockheight \textheight
   \dim_gset:Nn \typeblockoffsety
    {
      \topmargin
       + \headheight
       + \headsep
       + \voffset
    }
 }
\flowfram_update_typeblock:
\AddToHook
  { package / geometry / after }
  {
    \flowfram_update_typeblock:
  }
\__flowfram_do_addto_prechap:
\newcounter{maxflow}
\newcounter{thisframe}
\AddToHook
  { package / hyperref / after }
  {
    \def \theHthisframe { \theabsolutepage . \arabic {thisframe} }
  }
\NewDocumentCommand \labelflowidn { m }
 {
   \group_begin:
    \def \@currentlabel { \thethisframe }
    \label { #1 }
   \group_end:
 }
\newcounter{displayedframe}
\AddToHook
  { package / hyperref / after }
  {
    \def \theHdisplayedframe { \thepage . \arabic{displayedframe} }
  }
\NewDocumentCommand \labelflow { m }
{
  \group_begin:
    \def \@currentlabel { \thedisplayedframe }
    \label { #1 }
  \group_end:
}
\newcounter{maxstatic}
\newcounter{maxdynamic}
\int_new:N \l__flowfram_current_frame_int
\int_new:N \l__flowfram_current_abspage_int
\int_new:N \l__flowfram_current_static_int
\int_new:N \l__flowfram_current_dynamic_int
\int_new:N \l__flowfram_col_int
\int_new:N \l__flowfram_tmpa_int
\int_new:N \l__flowfram_tmpb_int
\int_new:N \l__flowfram_id_int
\int_new:N \l__flowfram_id_ii_int
\int_new:N \l__flowfram_type_int
\int_new:N \l__flowfram_type_ii_int
\int_new:N \l__flowfram_range_start_int
\int_new:N \l__flowfram_range_end_int
\int_new:N \l__flowfram_shape_int
\dim_new:N \l__flowfram_tmpa_dim
\dim_new:N \l__flowfram_tmpb_dim
\clist_new:N \l__flowfram_tmp_clist
\dim_new:N \l__flowfram_sfdf_height_dim
\dim_new:N \l__flowfram_sfdf_width_dim
\tl_new:N \l__flowfram_tmpa_tl
\bool_new:N \l__flowfram_found_bool
\tl_new:N \g__flowfram_next_tl
\dim_new:N \l__flowfram_x_dim
\dim_new:N \l__flowfram_evenx_dim
\dim_new:N \l__flowfram_y_dim
\dim_new:N \l__flowfram_eveny_dim
\dim_new:N \l__flowfram_width_dim
\dim_new:N \l__flowfram_height_dim
\dim_new:N \l__flowfram_offset_dim
\tl_new:N \l__flowfram_remainder_tl
\tl_new:N \l__flowfram_pages_tl
\tl_new:N \l__flowfram_next_pages_tl
\tl_new:N \l__flowfram_exclude_pages_tl
\clist_new:N \l__flowfram_pages_clist
\clist_new:N \l__flowfram_even_pages_clist
\clist_new:N \l__flowfram_odd_pages_clist
\clist_new:N \l__flowfram_exclude_pages_clist
\tl_new:N \l__flowfram_label_tl
\tl_new:N \l__flowfram_frametype_tl
\tl_new:N \l__flowfram_style_tl
\tl_new:N \l__flowfram_parindent_tl
\tl_new:N \l__flowfram_shape_tl
\tl_new:N \l__flowfram_valign_tl
\tl_new:N \l__flowfram_minipage_tl
\tl_new:N \l__flowfram_contents_tl
\tl_new:N \l__flowfram_width_tl
\tl_new:N \l__flowfram_height_tl
\tl_new:N \l__flowfram_x_tl
\tl_new:N \l__flowfram_y_tl
\tl_new:N \l__flowfram_evenx_tl
\tl_new:N \l__flowfram_eveny_tl
\tl_new:N \l__flowfram_oddx_tl
\tl_new:N \l__flowfram_oddy_tl
\tl_new:N \l__flowfram_offset_tl
\tl_new:N \l__flowfram_angle_tl
\tl_new:N \l__flowfram_margin_tl
\tl_new:N \l__flowfram_frameflag_tl
\tl_new:N \l__flowfram_clearflag_tl
\tl_new:N \l__flowfram_hideflag_tl
\tl_new:N \l__flowfram_hidethisflag_tl
\newlength\sdfparindent
\cs_new:Nn \__flowfram_map_idns:nnn
 {
   \tl_if_eq:NnTF \c_flowfram_all_tl { #1 }
    {
      \int_step_inline:nn { \value { max #2 } }
       {
         \int_set:Nn \l__flowfram_id_int { ##1 }
        #3
       }
    }
    {
      \tl_if_eq:NnTF \c_flowfram_odd_tl { #1 }
       {
         \int_step_inline:nnn { \c_one_int } { 2 } { \value { max #2 } }
          {
            \int_set:Nn \l__flowfram_id_int { ##1 }
            #3
          }
       }
       {
         \tl_if_eq:NnTF \c_flowfram_even_tl { #1 }
          {
            \int_step_inline:nnn { 2 } { 2 } { \value { max #2 } }
             {
               \int_set:Nn \l__flowfram_id_int { ##1 }
               #3
             }
          }
          {
            \clist_map_inline:nn { #1 }
             {
               \__flowfram_get_range:n { ##1 }
               \int_compare:nNnT { \l__flowfram_range_start_int } < { \c_one_int }
                {
                  \int_set_eq:NN \l__flowfram_range_start_int \c_one_int
                }
               \int_compare:nNnT
                  { \l__flowfram_range_end_int } > { \value { max #2 } }
                {
                  \int_set_eq:Nc \l__flowfram_range_end_int { c@max #2}
                }
               \int_compare:nNnTF
                 { \l__flowfram_range_start_int } < {  \l__flowfram_range_end_int }
                 {
                   \int_step_inline:nNnTF
                      { \l__flowfram_range_start_int }
                      { \l__flowfram_range_end_int }
                    {
                      \int_set:Nn \l__flowfram_id_int { ##1 }
                      #3
                    }
                }
                {
                  \int_set_eq:NN
                    \l__flowfram_id_int
                    \l__flowfram_range_start_int
                  #3
                }
             }
          }
       }
    }
 }
\cs_generate_variant:Nn \__flowfram_map_idns:nnn { enn }
\cs_new:Nn \__flowfram_get_frame_type:Nn
 {
   \int_if_exist:cTF { c_flowfram_frame_type_ #2 _int }
     {
       \int_set_eq:Nc #1 { c_flowfram_frame_type_ #2 _int }
     }
     {
        \int_set:Nn #1 { - \c_one_int }
        \msg_error:nnn { flowfram } { invalid-frame-type } { #2 }
     }
 }
\cs_new:Nn \__flowfram_get_frame_type:n
 {
   \__flowfram_get_frame_type:Nn
    \l__flowfram_type_int
    { #1 }
 }
\seq_new:N \g__flowfram_flowlabels_seq
\seq_new:N \g__flowfram_staticlabels_seq
\seq_new:N \g__flowfram_dynamiclabels_seq
\keys_define:nn { flowfram / frame }
 {
   width .tl_set:N = \l__flowfram_width_tl ,
   width .groups:n = { flow , static , dynamic } ,
   height .tl_set:N = \l__flowfram_height_tl ,
   height .groups:n = { flow , static , dynamic } ,
   x .tl_set:N = \l__flowfram_x_tl ,
   x .groups:n = { flow , static , dynamic } ,
   y .tl_set:N = \l__flowfram_y_tl ,
   y .groups:n = { flow , static , dynamic } ,
   evenx .tl_set:N = \l__flowfram_evenx_tl ,
   evenx .groups:n = { flow , static , dynamic } ,
   eveny .tl_set:N = \l__flowfram_eveny_tl ,
   eveny .groups:n = { flow , static , dynamic } ,
   oddx .tl_set:N = \l__flowfram_oddx_tl ,
   oddx .groups:n = { flow , static , dynamic } ,
   oddy .tl_set:N = \l__flowfram_oddy_tl ,
   oddy .groups:n = { flow , static , dynamic } ,
   label .tl_set_e:N = \l__flowfram_label_tl ,
   label .groups:n = { flow , static , dynamic } ,
   border .choice: ,
   border .default:n = { plain } ,
   border / plain .code:n =
    {
      \tl_set:Nn \l__flowfram_frameflag_tl { true }
      \tl_set:Nn \l__flowfram_frametype_tl { fbox }
    } ,
   border / none .code:n =
    {
      \tl_set:Nn \l__flowfram_frameflag_tl { false }
    } ,
   border / unknown .code:n =
    {
      \tl_set:Nn \l__flowfram_frameflag_tl { true }
      \tl_set:Ne \l__flowfram_frametype_tl { #1 }
    } ,
   border .groups:n = { flow , static , dynamic } ,
   bordercolor .tl_set_e:N = \l__flowfram_bordercolor_tl ,
   bordercolour .tl_set_e:N = \l__flowfram_bordercolor_tl ,
   border-color .tl_set_e:N = \l__flowfram_bordercolor_tl ,
   border-colour .tl_set_e:N = \l__flowfram_bordercolor_tl ,
   bordercolor .groups:n = { flow , static , dynamic } ,
   bordercolour .groups:n = { flow , static , dynamic } ,
   border-color .groups:n = { flow , static , dynamic } ,
   border-colour .groups:n = { flow , static , dynamic } ,
   textcolor .tl_set_e:N = \l__flowfram_textcolor_tl ,
   textcolour .tl_set_e:N = \l__flowfram_textcolor_tl ,
   text-color .tl_set_e:N = \l__flowfram_textcolor_tl ,
   text-colour .tl_set_e:N = \l__flowfram_textcolor_tl ,
   textcolor .groups:n = { flow , static , dynamic } ,
   textcolour .groups:n = { flow , static , dynamic } ,
   text-color .groups:n = { flow , static , dynamic } ,
   text-colour .groups:n = { flow , static , dynamic } ,
   backcolor .tl_set_e:N = \l__flowfram_backcolor_tl ,
   backcolour .tl_set_e:N = \l__flowfram_backcolor_tl ,
   back-color .tl_set_e:N = \l__flowfram_backcolor_tl ,
   back-colour .tl_set_e:N = \l__flowfram_backcolor_tl ,
   backcolor .groups:n = { flow , static , dynamic } ,
   backcolour .groups:n = { flow , static , dynamic } ,
   back-color .groups:n = { flow , static , dynamic } ,
   back-colour .groups:n = { flow , static , dynamic } ,
   pages .tl_set_e:N = \l__flowfram_pages_tl ,
   pages .groups:n = { flow , static , dynamic } ,
   excludepages .tl_set_e:N = \l__flowfram_exclude_pages_tl ,
   excludepages .groups:n = { flow , static , dynamic } ,
%%Value may be "compute" or a length.
   offset .tl_set:N = \l__flowfram_offset_tl ,
   offset .groups:n = { flow , static , dynamic } ,
   angle .code:n =
     {
       \bool_if:NTF \l__flowfram_allow_frame_rotation_bool
        {
          \tl_set:Ne \l__flowfram_angle_tl { #1 }
        }
        {
          \tl_if_eq:enF { #1 } { 0 }
           {
             \msg_info:nn { flowfram } { info-no-rotation }
           }
        }
     } ,
   angle .groups:n = { flow , static , angle } ,
   margin .choice: ,
   margin / inner .code:n =
     { \tl_set:Nn \l__flowfram_margin_tl { inner } } ,
   margin / outer .code:n =
     { \tl_set:Nn \l__flowfram_margin_tl { outer } } ,
   margin / left .code:n =
     { \tl_set:Nn \l__flowfram_margin_tl { left } } ,
   margin / right .code:n =
     { \tl_set:Nn \l__flowfram_margin_tl { right } } ,
   margin .groups:n = { flow } ,
   clear .choice: ,
   clear / true .code:n =
     {
       \tl_set:Nn \l__flowfram_clearflag_tl { true }
     } ,
   clear / false .code:n =
     {
       \tl_set:Nn \l__flowfram_clearflag_tl { false }
     } ,
   clear .default:n = { true } ,
   clear .groups:n = { static, dynamic } ,
   style .choice: ,
   style / none .code:n =
     {
       \tl_set:Nn \l__flowfram_style_tl { @firstofone }
     } ,
   style / unknown .code:n =
     {
       \tl_set:Ne \l__flowfram_style_tl { #1 }
     } ,
   style .groups:n = { dynamic } ,
   shape .tl_set:N = \l__flowfram_shape_tl ,
   shape .groups:n = { static, dynamic } ,
   parindent .tl_set:N = \l__flowfram_parindent_tl ,
   parindent .groups:n = { static, dynamic } ,
   valign .choice: ,
   valign / c .code:n =
     { \tl_set:Nn \l__flowfram_valign_tl { c } } ,
   valign / t .code:n =
     { \tl_set:Nn \l__flowfram_valign_tl { t } } ,
   valign / b .code:n =
     { \tl_set:Nn \l__flowfram_valign_tl { b } } ,
   valign .groups:n = { static, dynamic } ,
   hide .choice: ,
   hide / true .code:n =
     { \tl_set:Nn \l__flowfram_hideflag_tl { true } } ,
   hide / false .code:n =
     { \tl_set:Nn \l__flowfram_hideflag_tl { false } } ,
   hide .default:n = { true } ,
   hide .groups:n = { static, dynamic } ,
   hidethis .choice: ,
   hidethis / true .code:n =
     { \tl_set:Ne \l__flowfram_hidethisflag_tl { true } } ,
   hidethis / false .code:n =
     { \tl_set:Ne \l__flowfram_hidethisflag_tl { false } } ,
   hidethis .default:n = { true } ,
   hidethis .groups:n = { static, dynamic } ,
   html .tl_set:N = \l__flowfram_html_tl ,
   html .groups:n = { static, dynamic } ,
 }
\cs_new:Nn \__flowfram_set_keys_for_type:nnn
 {
  \tl_clear:N \l__flowfram_frameflag_tl
  \tl_clear:N \l__flowfram_width_tl
  \tl_clear:N \l__flowfram_height_tl
  \tl_clear:N \l__flowfram_margin_tl
  \tl_clear:N \l__flowfram_x_tl
  \tl_clear:N \l__flowfram_y_tl
  \tl_clear:N \l__flowfram_frametype_tl
  \tl_clear:N \l__flowfram_bordercolor_tl
  \tl_clear:N \l__flowfram_valign_tl
  \tl_clear:N \l__flowfram_style_tl
  \tl_clear:N \l__flowfram_hideflag_tl
  \tl_clear:N \l__flowfram_hidethisflag_tl
  \tl_clear:N \l__flowfram_textcolor_tl
  \tl_clear:N \l__flowfram_clearflag_tl
  \tl_clear:N \l__flowfram_offset_tl
  \tl_clear:N \l__flowfram_pages_tl
  \tl_clear:N \l__flowfram_label_tl
  \tl_clear:N \l__flowfram_backcolor_tl
  \tl_clear:N \l__flowfram_evenx_tl
  \tl_clear:N \l__flowfram_eveny_tl
  \tl_clear:N \l__flowfram_oddx_tl
  \tl_clear:N \l__flowfram_oddy_tl
  \tl_clear:N \l__flowfram_angle_tl
  \tl_set_eq:NN \l__flowfram_exclude_pages_tl \c_novalue_tl
  \tl_set_eq:NN \l__flowfram_shape_tl \c_novalue_tl
  \tl_set_eq:NN \l__flowfram_parindent_tl \c_novalue_tl
  \tl_clear:N \l__flowfram_html_tl
  \keys_set_groups:nnnN { flowfram / frame } { #2 } { #1 }
    \l__flowfram_remainder_tl
  \tl_if_empty:NF \l__flowfram_remainder_tl
   {
     \__flowfram_error:eee
       { frame-unsupported-options }
      { #2 } { \l__flowfram_remainder_tl }
   }
  \tl_if_empty:NF \l__flowfram_frameflag_tl
   {
     \flowfram_frame_set_bool_from_option:nnnV
       { #2 } { hasframe } { #3 }
       \l__flowfram_frameflag_tl
   }
  \tl_if_empty:NF \l__flowfram_width_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { width } { #3 }
       { \l__flowfram_width_tl }
   }
  \tl_if_empty:NF \l__flowfram_height_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { height } { #3 }
       { \l__flowfram_height_tl }
   }
  \tl_if_empty:NF \l__flowfram_x_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { posx } { #3 }
       { \l__flowfram_x_tl }
     \flowfram_frame_set_dim:nnnn { #2 } { evenx } { #3 }
       { \l__flowfram_x_tl }
   }
  \tl_if_empty:NF \l__flowfram_y_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { posy } { #3 }
       { \l__flowfram_y_tl }
     \flowfram_frame_set_dim:nnnn { #2 } { eveny } { #3 }
       { \l__flowfram_y_tl }
   }
  \tl_if_empty:NF \l__flowfram_evenx_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { evenx } { #3 }
       { \l__flowfram_evenx_tl }
   }
  \tl_if_empty:NF \l__flowfram_eveny_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { eveny } { #3 }
       { \l__flowfram_eveny_tl }
   }
  \tl_if_empty:NF \l__flowfram_oddx_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { posx } { #3 }
       { \l__flowfram_oddx_tl }
   }
  \tl_if_empty:NF \l__flowfram_oddy_tl
   {
     \flowfram_frame_set_dim:nnnn { #2 } { posy } { #3 }
      { \l__flowfram_oddy_tl }
   }
  \tl_if_empty:NF \l__flowfram_label_tl
   {
     \__flowfram_set_frame_id:nnV { #2 } { #3 } \l__flowfram_label_tl
   }
  \tl_if_empty:NF \l__flowfram_frametype_tl
   {
     \flowfram_frame_set_tl:nnnV
        { #2 } { frametype } { #3 }
       \l__flowfram_frametype_tl
   }
  \tl_if_empty:NF \l__flowfram_bordercolor_tl
   {
    \exp_after:wN \__flowfram_set_frame_color:w
      \l__flowfram_bordercolor_tl
      \q_stop { #2 } { bordercolor } { #3 }
   }
  \tl_if_empty:NF \l__flowfram_textcolor_tl
   {
    \exp_after:wN \__flowfram_set_frame_color:w
      \l__flowfram_textcolor_tl
      \q_stop { #2 } { textcolor } { #3 }
   }
  \tl_if_empty:NF \l__flowfram_backcolor_tl
   {
    \exp_after:wN \__flowfram_set_frame_color:w
      \l__flowfram_backcolor_tl
      \q_stop { #2 } { backcolor } { #3 }
   }
  \tl_if_empty:NF \l__flowfram_pages_tl
   {
     \flowfram_set_frame_pagelist:nnV
       { #2 } { #3 } \l__flowfram_pages_tl
   }
  \exp_args:NV \tl_if_novalue:nF \l__flowfram_exclude_pages_tl
   {
     \flowfram_set_frame_excludelist:nnV
       { #2 } { #3 } \l__flowfram_exclude_pages_tl
   }
  \tl_if_empty:NF \l__flowfram_offset_tl
   {
     \flowfram_frame_set_tl:nnnV
       { #2 } { offset } { #3 }
       \l__flowfram_offset_tl
   }
  \tl_if_empty:NF \l__flowfram_angle_tl
   {
     \flowfram_frame_set_tl:nnnV
      { #2 } { angle } { #3 }
      \l__flowfram_angle_tl
   }
  \tl_if_empty:NF \l__flowfram_html_tl
   {
     \dim_zero:N \l__flowfram_sfdf_width_dim
     \dim_zero:N \l__flowfram_sfdf_height_dim
     \flowfram_set_dim_to_frame_dim:Nnnn
       \l__flowfram_sfdf_width_dim
        { #2 } { width } { #3 }
     \flowfram_set_dim_to_frame_dim:Nnnn
       \l__flowfram_sfdf_height_dim
        { #2 } { height } { #3 }
     \tl_put_left:Ne \l__flowfram_html_tl
      {
        width = \dim_eval:n { \l__flowfram_sfdf_width_dim } ,
        height = \dim_eval:n { \l__flowfram_sfdf_height_dim } ,
      }
     \exp_args:NV \__flowfram_write_html_opts:nnn
       \l__flowfram_html_tl { #2 } { \int_eval:n { #3 } }
   }
 }
\int_new:N \g__flowfram_html_opts_int
\cs_new:Nn \__flowfram_write_html_opts:nnn
 {
   \__flowfram_preamble_write_html_opts:nnn { #1 } { #2 } { #3 }
 }
\cs_new:Nn \__flowfram_preamble_write_html_opts:nnn
 {
   \int_gincr:N \g__flowfram_html_opts_int
   \protected@write \@auxout
     { \let \theabsolutepage \relax }
     {
       \string \flowfram@preamble@htmlopts
        { \int_use:N \g__flowfram_html_opts_int }
        { #2 } { #3 } { #1 }
        { \thepage }
        { \theabsolutepage }
     }
 }
\cs_new:Nn \__flowfram_doc_write_html_opts:nnn
 {
   \int_gincr:N \g__flowfram_html_opts_int
   \protected@write \@auxout
     { \let \theabsolutepage \relax }
     {
       \string \flowfram@doc@htmlopts
        { \int_use:N \g__flowfram_html_opts_int }
        { #2 } { #3 } { #1 }
        { \thepage }
        { \theabsolutepage }
     }
 }
\newcommand*\flowfram@preamble@htmlopts[6]{}
\newcommand*\flowfram@doc@htmlopts[6]{}
\cs_new:Npn \__flowfram_set_frame_color:w
 {
   \@ifnextchar [
     \__flowfram_set_frame_color:wnnnn
     \__flowfram_set_frame_color:wnnn
 }
\cs_new:Npn \__flowfram_set_frame_color:wnnnn
   [ #1 ] #2 \q_stop #3 #4 #5
 {
  \flowfram_frame_set_tl:nnne
    { #3 } { #4 } { #5 }
    { [ #1 ] { #2 } }
 }
\cs_new:Npn \__flowfram_set_frame_color:wnnn
 #1 \q_stop #2 #3 #4
 {
  \flowfram_frame_set_tl:nnne
    { #2 } { #3 } { #4 }
    { { #1 } }
 }
\cs_new_nopar:Nn \__flowfram_new_frame:nnnnnnn
 {
  \int_gincr:c { c@max #7 }
  \flowfram_frame_new_bool:nnnN
    { #7 } { hasframe } { \int_use:c { c@max #7 } } \c_false_bool
  \flowfram_frame_new_dim:nnnn
    { #7 } { width } { \int_use:c { c@max #7 } } { #2 }
  \flowfram_frame_new_dim:nnnn
    { #7 } { height } { \int_use:c { c@max #7 } } { #3 }
  \flowfram_frame_new_dim:nnnn
    { #7 } { posx } { \int_use:c { c@max #7 } } { #4 }
  \flowfram_frame_new_dim:nnnn
    { #7 } { posy } { \int_use:c { c@max #7 } } { #5 }
  \flowfram_frame_new_dim:nnnn
    { #7 } { evenx } { \int_use:c { c@max #7 } } { #4 }
  \flowfram_frame_new_dim:nnnn
    { #7 } { eveny } { \int_use:c { c@max #7 } } { #5 }
  \flowfram_frame_new_tl:nnnn
    { #7 } { frametype } { \int_use:c { c@max #7 } } { fbox }
  \flowfram_frame_new_tl:nnnn
    { #7 } { bordercolor } { \int_use:c { c@max #7 } } { \flowframecol }
  \flowfram_frame_new_tl:nnnn
    { #7 } { textcolor } { \int_use:c { c@max #7 } } { \flowframetextcol }
  \flowfram_frame_new_tl:nnnn
    { #7 } { backcolor } { \int_use:c { c@max #7 } } { { none } }
  \flowfram_frame_new_tl:nnnn
    { #7 } { angle } { \int_use:c { c@max #7 } } { 0 }
  \clist_set:Ne \l__flowfram_pages_clist { #1 }
  \exp_args:NV
  \flowfram_if_valid_pagelist:nTF \l__flowfram_pages_clist
   {
     \flowfram_frame_new_clist:nnnV
       { #7 } { pagelist } { \int_use:c { c@max #7 } }
       \l__flowfram_pages_clist
   }
   {
     \msg_error:nnn { flowfram } { invalid-pagelist } { #1 }
     \flowfram_frame_new_clist:nnnn
       { #7 } { pagelist } { \int_use:c { c@max #7 } } { all }
   }
  \flowfram_frame_new_clist:nnnn
    { #7 } { excludelist } { \int_use:c { c@max #7 } } { }
  \flowfram_frame_new_tl:nnnn
    { #7 } { offset } { \int_use:c { c@max #7 } } { compute }
  \__flowfram_set_frame_id:nnn { #7 } { \int_use:c { c@max #7 } } { #6 }
 }
\cs_new:Nn \__flowfram_set_frame_id:nnn
{
  \tl_set:Ne \l__flowfram_label_tl { #3 }
  \int_compare:nNnTF
    { #2 } > { \seq_count:c { g__flowfram_ #1 labels_seq } }
   {
     \exp_args:NnV
        \__flowfram_checkunique_frame_idl:nnF { #1 } \l__flowfram_label_tl
      {
        \tl_set:Ne \l__flowfram_label_tl { \int_eval:n { #2 } }
      }
     \seq_gput_right:cV { g__flowfram_ #1 labels_seq } \l__flowfram_label_tl
     \flowfram_frame_new_tl:nnnV
       { #1 } { label } { #2 }
       \l__flowfram_label_tl
   }
   {
     \seq_set_item:cnn { g__flowfram_ #1 labels_seq } { #2 } { }
     \exp_args:NnV
        \__flowfram_checkunique_frame_idl:nnF { #1 } \l__flowfram_label_tl
      {
        \tl_set:Ne \l__flowfram_label_tl { \int_eval:n { #2 } }
      }
     \exp_args:NcnV
       \seq_gset_item:Nnn
       { g__flowfram_ #1 labels_seq }
       { #2 }
       \l__flowfram_label_tl
     \flowfram_frame_set_tl:nnnV
       { #1 } { label } { #2 }
       \l__flowfram_label_tl
   }
}
\cs_generate_variant:Nn \__flowfram_set_frame_id:nnn { nne , nnV }
\prg_new_conditional:Nnn \__flowfram_checkunique_frame_idl:nn
 { T, F, TF }
{
 \seq_if_in:cnTF { g__flowfram_ #1 labels_seq } { #2 }
  {
    \exp_args:Nc
    \seq_map_indexed_inline:Nn
       { g__flowfram_ #1 labels_seq }
      {
        \tl_if_eq:nnT { ##2 } { #2 }
         {
           \msg_error:nnnnn { flowfram } { label-defined }
             { #2 } { #1 } { ##1 }
            \seq_map_break:
         }
      }
   \prg_return_false:
  }
  { \prg_return_true: }
}
\prg_new_conditional:Nnn \__flowfram_if_frame_label_exists:nnN
 { TF , T , F }
 {
  \int_zero:N #3
  \exp_args:Nc \seq_map_indexed_inline:Nn
     { g__flowfram_ #1 labels_seq }
    {
      \tl_if_eq:neT { ##2 } { #2 }
       {
         \int_set:Nn #3 { ##1 }
         \seq_map_break:
       }
    }
  \int_if_zero:nTF { #3 }
    { \prg_return_false: }
    { \prg_return_true: }
 }
\prg_new_conditional:Nnn \__flowfram_if_frame_idn_exists:nn
   { p , T , F, TF }
 {
   \tl_if_exist:cTF
     { g__flowfram_ #1 _ label _ \romannumeral #2 _ tl }
    { \prg_return_true: }
    { \prg_return_false: }
 }
\cs_new:Nn \__flowfram_get_frame_id:nn
{
  \__flowfram_if_frame_label_exists:nnNF
     { #1 } { #2 } \l__flowfram_id_int
   {
     \__flowfram_error:eee { label-undefined } { #2 } { #1 }
   }
}
\cs_generate_variant:Nn \__flowfram_get_frame_id:nn { ne, nV }
\prop_new:N \g__flowfram_flow_attributes_prop
\prop_new:N \g__flowfram_static_attributes_prop
\prop_new:N \g__flowfram_dynamic_attributes_prop
\cs_new:Nn \flowfram_show_flow_frame_by_idl:n
 {
   \__flowfram_if_flow_label_exists:nTF { #1 }
    {
      \__flowfram_show_flow_frame:
    }
    {
      \__flowfram_error:eee { label-undefined } { #1 } { flow }
    }
 }
\cs_new:Nn \flowfram_show_flow_frame_by_idn:n
 {
   \int_set:Nn \l__flowfram_id_int { #1 }
   \tl_if_exist:cTF
      { g__flowfram_flow_label_ \romannumeral \l__flowfram_id_int _ tl }
    {
      \__flowfram_show_flow_frame:
    }
    {
      \msg_error:nnee { flowfram } { idn-undefined }
       { flow } { \int_use:N \l__flowfram_id_int }
    }
 }
\cs_new:Nn \flowfram_show_all_flow_frames:
 {
   \int_if_zero:nTF  { \c@maxflow }
    {
      \msg_show:nnne { flowfram } { show-all-frames-none }
       { flow }
    }
    {
      \msg_show:nnne { flowfram } { show-all-frames }
       { flow }
       {
         \exp_args:NV \msg_show_item_unbraced:n
           \c@maxflow
       }
      \int_step_inline:nn { \c@maxflow }
       {
         \int_set:Nn \l__flowfram_id_int { ##1 }
         \__flowfram_show_flow_frame:
       }
    }
 }
\cs_new:Nn \__flowfram_show_flow_frame:
 {
   \msg_show:nneee { flowfram } { show-frame-attributes }
    { flow } { \int_use:N \l__flowfram_id_int }
    {
      \prop_map_function:NN
         \g__flowfram_flow_attributes_prop
         \__flowfram_show_flow_attribute:nn
   }
 }
\cs_new:Nn \__flowfram_show_flow_attribute:nn
  {
    \exp_args:Ne \msg_show_item_unbraced:n
     {
       \__flowfram_show_attribute:nnnn
        { flow } { #1 } { \l__flowfram_id_int } { #2 }
     }
  }
\cs_new:Nn \flowfram_show_static_frame_by_idl:n
 {
   \__flowfram_if_static_label_exists:nTF { #1 }
    {
      \__flowfram_show_static_frame:
    }
    {
      \__flowfram_error:eee { label-undefined } { #1 } { static }
    }
 }
\cs_new:Nn \flowfram_show_static_frame_by_idn:n
 {
   \int_set:Nn \l__flowfram_id_int { #1 }
   \tl_if_exist:cTF
      { g__flowfram_static_label_ \romannumeral \l__flowfram_id_int _ tl }
    {
      \__flowfram_show_static_frame:
    }
    {
      \msg_error:nnee { flowfram } { idn-undefined }
       { static } { \int_use:N \l__flowfram_id_int }
    }
 }
\cs_new:Nn \flowfram_show_all_static_frames:
 {
   \int_if_zero:nTF  { \c@maxstatic }
    {
      \msg_show:nnne { flowfram } { show-all-frames-none }
       { static }
    }
    {
      \msg_show:nnne { flowfram } { show-all-frames }
       { static }
       {
         \exp_args:NV \msg_show_item_unbraced:n
           \c@maxstatic
       }
      \int_step_inline:nn { \c@maxstatic }
       {
         \int_set:Nn \l__flowfram_id_int { ##1 }
         \__flowfram_show_static_frame:
       }
    }
 }
\cs_new:Nn \__flowfram_show_static_frame:
 {
   \msg_show:nneee { flowfram } { show-frame-attributes }
    { static } { \int_use:N \l__flowfram_id_int }
    {
      \prop_map_function:NN
         \g__flowfram_static_attributes_prop
         \__flowfram_show_static_attribute:nn
   }
 }
\cs_new:Nn \__flowfram_show_static_attribute:nn
  {
    \exp_args:Ne \msg_show_item_unbraced:n
     {
       \__flowfram_show_attribute:nnnn
        { static } { #1 } { \l__flowfram_id_int } { #2 }
     }
  }
\cs_new:Nn \flowfram_show_dynamic_frame_by_idl:n
 {
   \__flowfram_if_dynamic_label_exists:nTF { #1 }
    {
      \__flowfram_show_dynamic_frame:
    }
    {
      \__flowfram_error:eee { label-undefined } { #1 } { dynamic }
    }
 }
\cs_new:Nn \flowfram_show_dynamic_frame_by_idn:n
 {
   \int_set:Nn \l__flowfram_id_int { #1 }
   \tl_if_exist:cTF
      { g__flowfram_dynamic_label_ \romannumeral \l__flowfram_id_int _ tl }
    {
      \__flowfram_show_dynamic_frame:
    }
    {
      \msg_error:nnee { flowfram } { idn-undefined }
       { dynamic } { \int_use:N \l__flowfram_id_int }
    }
 }
\cs_new:Nn \flowfram_show_all_dynamic_frames:
 {
   \int_if_zero:nTF  { \c@maxdynamic }
    {
      \msg_show:nnne { flowfram } { show-all-frames-none }
       { dynamic }
    }
    {
      \msg_show:nnne { flowfram } { show-all-frames }
       { dynamic }
       {
         \exp_args:NV \msg_show_item_unbraced:n
           \c@maxdynamic
       }
      \int_step_inline:nn { \c@maxdynamic }
       {
         \int_set:Nn \l__flowfram_id_int { ##1 }
         \__flowfram_show_dynamic_frame:
       }
    }
 }
\cs_new:Nn \__flowfram_show_dynamic_frame:
 {
   \msg_show:nneee { flowfram } { show-frame-attributes }
    { dynamic } { \int_use:N \l__flowfram_id_int }
    {
      \prop_map_function:NN
         \g__flowfram_dynamic_attributes_prop
         \__flowfram_show_dynamic_attribute:nn
   }
 }
\cs_new:Nn \__flowfram_show_dynamic_attribute:nn
  {
    \exp_args:Ne \msg_show_item_unbraced:n
     {
       \__flowfram_show_attribute:nnnn
        { dynamic } { #1 } { \l__flowfram_id_int } { #2 }
     }
  }
\cs_new:Nn \__flowfram_show_bool_attribute:nnn
 {
   \bool_if:cTF
     { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
     { true }
     { false }
 }
\cs_new:Nn \__flowfram_show_box_attribute:nnn
 {
   \box_if_empty:cTF
     { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
     { empty }
     { not ~ empty }
 }
\cs_new:Nn \__flowfram_show_attribute:nnnn
 {
   #2 ~ ( #4 ) : ~
   \cs_if_exist:cTF { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ #4 }
    {
      \cs_if_exist:cTF { __flowfram_show_ #4 _attribute:nnn }
       {
         \use:c { __flowfram_show_ #4 _attribute:nnn }
           { #1 } { #2 } { #3 }
       }
       {
         \use:c { #4 _use:c }
           { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ #4 }
       }
    }
    { undefined }
 }
\cs_new:Nn \__flowfram_add_frame_attribute:Nnn
 {
   \prop_get:NnNTF #1 { #2 } \l__flowfram_tmpa_tl
    {
      \tl_if_eq:NnF \l__flowfram_tmpa_tl { #3 }
       {
          \msg_error:nneee { flowfram } {attribute-type-change}
           { #2 } { \l__flowfram_tmpa_tl } { #3 }
       }
    }
    {
      \prop_gput:Nnn #1 { #2 } { #3 }
    }
 }
\cs_generate_variant:Nn \__flowfram_add_frame_attribute:Nnn { cen }
\cs_new:Nn \flowfram_frame_new_dim:nnn
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \dim_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ dim }
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { dim }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\cs_new:Nn \flowfram_frame_new_dim:nnnn
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \dim_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ dim }
      \dim_gset:cn
       { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ dim }
       { #4 }
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { dim }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\cs_new:Nn \flowfram_frame_use_dim:nnn
 {
   \dim_use:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ dim }
 }
\cs_new:Nn \flowfram_frame_set_dim:nnnn
 {
   \dim_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ dim }
    {
      \dim_gset:cn
       { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ dim }
       { #4 }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { dim }
    }
 }
\cs_new:Nn \flowfram_set_dim_to_frame_dim:Nnnn
 {
   \dim_if_exist:cTF
      { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ dim }
    {
      \dim_set_eq:Nc
       #1
       { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ dim }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #2 } { #3 } { \int_eval:n { #4 } } { dim }
    }
 }
\cs_new:Nn \flowfram_gset_dim_to_frame_dim:Nnnn
 {
   \dim_if_exist:cTF
      { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ dim }
    {
      \dim_gset_eq:Nc
       #1
       { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ dim }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #2 } { #3 } { \int_eval:n { #4 } } { dim }
    }
 }
\cs_new:Nn \flowfram_set_dim_to_frame_tl:Nnnn
 {
   \dim_if_exist:cTF
      { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ tl }
    {
      \dim_set:Nn
       #1
       { \tl_use:c { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ tl } }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #2 } { #3 } { \int_eval:n { #4 } } { tl }
    }
 }
\cs_new:Nn \flowfram_frame_swap_dim:nnnn
 {
   \dim_set_eq:Nc \l__flowfram_tmpa_dim
     { g__flowfram_ #1 _ #2 _ \romannumeral #4 _ dim }
   \dim_gset_eq:cc
    { g__flowfram_ #1 _ #2 _ \romannumeral #4 _ dim }
    { g__flowfram_ #1 _ #3 _ \romannumeral #4 _ dim }
   \dim_gset_eq:cN
    { g__flowfram_ #1 _ #3 _ \romannumeral #4 _ dim }
    \l__flowfram_tmpa_dim
 }
\cs_new:Nn \flowfram_frame_new_box:nnn
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \box_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { box }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\cs_new:Nn \flowfram_frame_set_box_eq:nnnN
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    {
      \box_gset_eq:cN
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
        #4
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
        { #1 } { #2 } { \int_eval:n { #3 } } { box }
    }
 }
\cs_new:Nn \flowfram_frame_clear_box:nnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    {
      \box_gclear:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
        { #1 } { #2 } { \int_eval:n { #3 } } { box }
    }
 }
\cs_new:Nn \flowfram_frame_use_box:nnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    {
      \leavevmode
      \box_use:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
        { #1 } { #2 } { \int_eval:n { #3 } } { box }
    }
 }
\cs_new:Nn \flowfram_frame_use_drop_box:nnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    {
      \box_use_drop:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
        { #1 } { #2 } { \int_eval:n { #3 } } { box }
    }
 }
\prg_new_conditional:Nnn \flowfram_frame_if_box_empty:nnn
 { T, F, TF }
 {
   \exp_args:Nc \if_box_empty:N
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ box }
    \prg_return_true:
   \else:
    \prg_return_false:
   \fi:
 }
\cs_new:Nn \flowfram_frame_new_tl:nnn
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \tl_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { tl }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\cs_new:Nn \flowfram_frame_new_tl:nnnn
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \tl_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
      \tl_gset:cn
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
        { #4 }
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { tl }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\cs_generate_variant:Nn  \flowfram_frame_new_tl:nnnn
 { nnnn , nnnV , nnne }
\cs_new:Nn \flowfram_frame_use_tl:nnn
 {
   \tl_use:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
 }
\cs_new:Nn \flowfram_frame_set_tl:nnnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
    {
       \__flowfram_message:nnnen
        { info-setting-frame-attribute }
        { #2 } { #1 } { \int_eval:n { #3 } } { #4 }
       \tl_gset:cn
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
        { #4 }
    }
    {
     \__flowfram_error:eeeee{ frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { tl }
    }
 }
\cs_generate_variant:Nn \flowfram_frame_set_tl:nnnn { nnne , nnnV }
\cs_new:Nn \flowfram_frame_clear_tl:nnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
    {
       \__flowfram_message:nnnen
          { info-setting-frame-attribute }
          { #2 } { #1 } { \int_eval:n { #3 } } { }
       \tl_gclear:c
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { tl }
    }
 }
\cs_new:Nn \flowfram_frame_put_right_tl:nnnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
    {
       \tl_gput_right:cn
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
        { #4 }
      \__flowfram_message:nnnev
        { info-setting-frame-attribute }
        { #2 } { #1 } { \int_eval:n { #3 } }
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { tl }
    }
 }
\cs_generate_variant:Nn \flowfram_frame_put_right_tl:nnnn { nnne , nnnV }
\cs_new:Nn \flowfram_set_tl_to_frame_tl:Nnnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ tl }
    {
      \tl_set_eq:Nc
       #1
       { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ tl }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #2 } { #3 } { \int_eval:n { #4 } } { tl }
    }
 }
\cs_new:Nn \flowfram_set_frame_tl_to_tl:Nnnn
 {
   \tl_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
    {
       \__flowfram_message:nnneV
        { info-setting-frame-attribute }
        { #2 } { #1 } { \int_eval:n { #3 } } #4
      \tl_gset_eq:cN
       { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
       #4
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #2 } { #3 } { \int_eval:n { #4 } } { tl }
    }
 }
\prg_new_conditional:Nnn \flowfram_if_tl_eq_frame_tl:Nnnn
   { T, F, TF }
 {
   \tl_if_eq:NcTF
     #1
     { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ tl }
   { \prg_return_true: }
   { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_tl_eq_frame_tl:nnnn
   { T, F, TF }
 {
   \tl_if_eq:cnTF
     { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ tl }
     { #1 }
   { \prg_return_true: }
   { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_tl_exist:nnn
   { T, F, TF }
 {
   \tl_if_exist:cTF
     { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
   { \prg_return_true: }
   { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_tl_empty:nnn
   { T, F, TF }
 {
   \tl_if_empty:cTF
     { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ tl }
   { \prg_return_true: }
   { \prg_return_false: }
 }
\cs_new:Nn \flowfram_frame_new_clist:nnnn
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \clist_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
      \clist_gset:cn
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
        { #4 }
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { clist }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\cs_generate_variant:Nn \flowfram_frame_new_clist:nnnn
  { nnne , nnnV }
\cs_new:Nn \flowfram_frame_use_clist:nnn
 {
   \clist_use:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
 }
\cs_new:Nn \flowfram_frame_set_clist:nnnn
 {
   \clist_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
    {
      \__flowfram_message:nnnen
        { info-setting-frame-attribute }
        { #2 } { #1 } { \int_eval:n { #3 } } { #4 }
       \clist_gset:cn
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
        { #4 }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { clist }
    }
 }
\cs_generate_variant:Nn \flowfram_frame_set_clist:nnnn { nnne , nnnV }
\cs_new:Nn \flowfram_frame_put_right_clist:nnnn
 {
   \clist_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
    {
       \clist_gput_right:cn
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
        { #4 }
      \__flowfram_message:nnnev
        { info-setting-frame-attribute }
        { #2 } { #1 } { \int_eval:n { #3 } }
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { clist }
    }
 }
\cs_generate_variant:Nn \flowfram_frame_put_right_clist:nnnn { nnne , nnnV }
\cs_new:Nn \flowfram_frame_concat_clist:nnnN
 {
   \clist_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
    {
       \exp_args:Ncc
       \clist_gconcat:NNN
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
         #4
      \__flowfram_message:nnnev
        { info-setting-frame-attribute }
        { #2 } { #1 } { \int_eval:n { #3 } }
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { clist }
    }
 }
\cs_generate_variant:Nn \flowfram_frame_concat_clist:nnnN { nnnc }
\cs_new:Nn \flowfram_set_clist_to_frame_clist:Nnnn
 {
   \clist_if_exist:cTF
      { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ clist }
    {
      \clist_set_eq:Nc
       #1
       { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ clist }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #2 } { #3 } { \int_eval:n { #4 } } { clist }
    }
 }
\prg_new_conditional:Nnn \flowfram_if_tl_eq_frame_clist:Nnnn
   { T, F, TF }
 {
   \tl_if_eq:cNTF
     { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ clist }
     #1
   { \prg_return_true: }
   { \prg_return_false: }
 }
\cs_new:Nn \flowfram_frame_clist_map_inline:nnnn
 {
   \clist_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
    {
      \clist_map_inline:cn
       { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ clist }
        { #4 }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
        { #1 } { #2 } { \int_eval:n { #3 } } { clist }
    }
 }
\prg_new_conditional:Nnn \flowfram_if_in_frame_clist:nnnn
   { T, F, TF }
 {
   \clist_if_in:cnTF
     { g__flowfram_ #2 _ #3 _ \romannumeral #4 _ clist }
     { #1 }
   { \prg_return_true: }
   { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_excludedpage:nnn
 { T, F, TF}
 {
   \flowfram_if_in_frame_clist:nnnnTF
     { #1 } { #2 } { excludelist } { #3 }
   { \prg_return_true: }
   { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_in_frame_pagelist:nnn
 { T, F, TF}
 {
   \flowfram_if_frame_allpages:nnTF { #2 } { #3 }
    { \prg_return_true: }
    {
      \flowfram_if_frame_nopages:nnTF { #2 } { #3 }
       { \prg_return_false: }
       {
         \flowfram_if_frame_oddpages_only:nnTF { #2 } { #3 }
          {
            \int_if_odd:nTF { #1 }
             { \prg_return_true: }
             { \prg_return_false: }
          }
          {
            \flowfram_if_frame_evenpages_only:nnTF { #2 } { #3 }
             {
               \int_if_even:nTF { #1 }
                { \prg_return_true: }
                { \prg_return_false: }
             }
             {
               \flowfram_if_in_frame_clist:nnnnTF
                 { #1 } { #2 } { pagelist } { #3 }
                { \prg_return_true: }
                {
                  \bool_set_false:N \l__flowfram_found_bool
                  \flowfram_frame_clist_map_inline:nnnn
                   { #2 } { pagelist } { #3 }
                  {
                    \flowfram_if_in_pagerange:nnT { #1 } { ##1 }
                     {
                        \clist_map_break:n
                         {
                           \bool_set_true:N \l__flowfram_found_bool
                         }
                     }
                  }
                 \bool_if:NTF \l__flowfram_found_bool
                  { \prg_return_true: }
                  { \prg_return_false: }
                }
             }
          }
       }
    }
 }
\prg_new_conditional:Nnn \flowfram_if_in_pagerange:nn
   { T, F, TF }
 {
   \__flowfram_get_range:n { #2 }
   \bool_lazy_or:nnTF
    {
      \int_compare_p:nNn { #1 } < { \l__flowfram_range_start_int }
    }
    {
      \int_compare_p:nNn { #1 } > { \l__flowfram_range_end_int }
    }
   { \prg_return_false: }
   { \prg_return_true: }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_has_morepages:nnn
 { T, F, TF}
 {
   \flowfram_if_frame_allpages:nnTF { #2 } { #3 }
    { \prg_return_true: }
    {
      \flowfram_if_frame_nopages:nnTF { #2 } { #3 }
       { \prg_return_false: }
       {
         \flowfram_if_frame_oddpages_only:nnTF { #2 } { #3 }
           { \prg_return_true: }
          {
            \flowfram_if_frame_evenpages_only:nnTF { #2 } { #3 }
              { \prg_return_true: }
             {
               \exp_args:Ne
               \__flowfram_get_range:n
                {
                  \clist_item:cn
                   { g__flowfram_ #2 _ pagelist _ \romannumeral #3 _ clist }
                   {
                     \clist_count:c
                       { g__flowfram_ #2 _ pagelist _ \romannumeral #3 _ clist }
                   }
                }
              \int_compare:nNnTF
               { \l__flowfram_range_end_int } > { #1 }
               { \prg_return_true: }
               { \prg_return_false: }
             }
          }
       }
    }
 }
\cs_new:Nn \flowfram_frame_get_start_page:Nnn
 {
   \flowfram_if_frame_allpages:nnTF { #2 } { #3 }
    {
      \int_set_eq:NN #1 \c_one_int
    }
    {
      \flowfram_if_frame_nopages:nnTF { #2 } { #3 }
       {
         \int_set:Nn #1
          { \c_flowfram_max_page_int + \c_one_int }
       }
       {
         \flowfram_if_frame_oddpages_only:nnTF { #2 } { #3 }
          {
            \int_set_eq:NN #1 \c_one_int
          }
          {
            \flowfram_if_frame_evenpages_only:nnTF { #2 } { #3 }
             {
               \int_set:Nn #1 { 2 }
             }
             {
               \exp_args:Ne
               \__flowfram_get_range:n
                {
                  \clist_item:cn
                   { g__flowfram_ #2 _ pagelist _ \romannumeral #3 _ clist }
                   { \c_one_int }
                }
               \int_if_zero:nT { #1 }
                {
                  \int_set_eq:NN #1 \c_one_int
                }
             }
          }
       }
    }
 }
\cs_new:Nn \__flowfram_frame_get_start_page:nn
 {
   \flowfram_frame_get_start_page:Nnn
     \l__flowfram_range_start_int { #1 } { #2 }
 }
\cs_new:Nn \flowfram_set_frame_pagelist:nnn
 {
   \flowfram_if_valid_pagelist:nTF { #3 }
    {
      \flowfram_frame_set_clist:nnnn
       { #1 } { pagelist } { #2 } { #3 }
    }
    {
      \msg_error:nnn { flowfram } { invalid-pagelist } { #3 }
    }
 }
\cs_generate_variant:Nn \flowfram_set_frame_pagelist:nnn
  { nne , nnV }
\prg_new_conditional:Nnn \flowfram_if_valid_pagelist:n
   { T, F, TF }
 {
   \tl_if_blank:nTF { #1 }
    { \prg_return_false: }
    {
      \flowfram_if_all_or_odd:nTF { #1 }
       { \prg_return_true: }
       {
         \flowfram_if_none_or_even:nTF { #1 }
         { \prg_return_true: }
         {
           \bool_set_false:N \l__flowfram_found_bool
           \int_set_eq:NN \l__flowfram_tmpa_int \c_zero_int
           \clist_map_inline:nn { #1 }
            {
              \__flowfram_get_range:n { ##1 }
              \int_if_zero:nT { \l__flowfram_range_start_int }
               {
                 \int_set_eq:NN \l__flowfram_range_start_int \c_one_int
               }
              \bool_lazy_or:nnT
               {
                 \int_compare_p:nNn
                 { \l__flowfram_range_start_int } > { \l__flowfram_range_end_int }
               }
               {
                 \bool_not_p:n
                  {
                    \int_compare_p:nNn
                      { \l__flowfram_range_start_int } > { \l__flowfram_tmpa_int }
                  }
               }
               {
                 \clist_map_break:n
                  {
                    \bool_set_true:N \l__flowfram_found_bool
                  }
               }
            \int_set_eq:NN \l__flowfram_tmpa_int \l__flowfram_range_end_int
          }
         \bool_if:NTF \l__flowfram_found_bool
          { \prg_return_false: }
          { \prg_return_true: }
       }
     }
    }
 }
\cs_new:Nn \flowfram_set_frame_excludelist:nnn
{
   \flowfram_frame_set_clist:nnnn
    { #1 } { excludelist } { #2 } { #3 }
}
\cs_generate_variant:Nn \flowfram_set_frame_excludelist:nnn
  { nne , nnV }
\cs_new:Nn \flowfram_concat_frame_excludelist:nnN
{
   \flowfram_frame_concat_clist:nnnN
    { #1 } { excludelist } { #2 }  #3
}
\cs_generate_variant:Nn \flowfram_concat_frame_excludelist:nnN { nnc }
\cs_new:Nn \flowfram_concat_frame_excludelist:nnn
{
  \clist_set:Nn \l__flowfram_exclude_pages_clist { #3 }
  \flowfram_concat_frame_excludelist:nnN
   { #1 } { #2 } \l__flowfram_exclude_pages_clist
}
\cs_generate_variant:Nn \flowfram_concat_frame_excludelist:nnn { nne }
\prg_new_conditional:Nnn \flowfram_if_frame_oddpages_only:nn
  { p , T , F , TF }
 {
   \flowfram_if_tl_eq_frame_clist:NnnnTF
     \c_flowfram_odd_tl
     { #1 } { pagelist } { #2 }
    { \prg_return_true: }
    { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_evenpages_only:nn
  { p , T , F , TF }
 {
   \flowfram_if_tl_eq_frame_clist:NnnnTF
     \c_flowfram_even_tl
     { #1 } { pagelist } { #2 }
    { \prg_return_true: }
    { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_allpages:nn
  { p , T , F , TF }
 {
   \flowfram_if_tl_eq_frame_clist:NnnnTF
     \c_flowfram_all_tl
     { #1 } { pagelist } { #2 }
    { \prg_return_true: }
    { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_nopages:nn
  { p , T , F , TF }
 {
   \flowfram_if_tl_eq_frame_clist:NnnnTF
     \c_flowfram_none_tl
     { #1 } { pagelist } { #2 }
    { \prg_return_true: }
    { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_all_or_odd:N
  { p, T, F, TF }
 {
   \bool_lazy_or:nnTF
    {
      \tl_if_eq_p:NN #1 \c_flowfram_all_tl
    }
    {
      \tl_if_eq_p:NN #1 \c_flowfram_odd_tl
    }
  { \prg_return_true: }
  { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_all_or_odd:n
  { T, F, TF }
 {
   \tl_if_eq:NnTF \c_flowfram_all_tl { #1 }
    { \prg_return_true: }
    {
      \tl_if_eq:NnTF \c_flowfram_odd_tl { #1 }
      { \prg_return_true: }
      { \prg_return_false: }
    }
 }
\prg_new_conditional:Nnn \flowfram_if_none_or_even:N
  { p, T, F, TF }
 {
   \bool_lazy_or:nnTF
    {
      \tl_if_eq_p:NN #1 \c_flowfram_none_tl
    }
    {
      \tl_if_eq_p:NN #1 \c_flowfram_even_tl
    }
  { \prg_return_true: }
  { \prg_return_false: }
 }
\prg_new_conditional:Nnn \flowfram_if_none_or_even:n
  { T, F, TF }
 {
   \tl_if_eq:NnTF \c_flowfram_none_tl { #1 }
    { \prg_return_true: }
    {
      \tl_if_eq:NnTF \c_flowfram_even_tl { #1 }
      { \prg_return_true: }
      { \prg_return_false: }
    }
 }
\cs_new:Nn \__flowfram_get_range:n
 {
  \flowfram_if_all_or_odd:nTF { #1 }
   {
     \int_set_eq:NN \l__flowfram_range_start_int \c_one_int
     \int_set_eq:NN
        \l__flowfram_range_end_int
        \c_flowfram_max_page_int
   }
   {
     \tl_if_eq:nnTF { #1 } { even }
      {
        \int_set:Nn \l__flowfram_range_start_int { 2 }
        \int_set_eq:NN
           \l__flowfram_range_end_int
           \c_flowfram_max_page_int
      }
      {
        \tl_if_eq:nnTF { #1 } { none }
         {
           \int_zero:N \l__flowfram_range_start_int
           \int_zero:N \l__flowfram_range_end_int
         }
         {
           \__flowfram_get_range:w #1 - \q_nil \q_stop
         }
      }
   }
 }
\cs_generate_variant:Nn \__flowfram_get_range:n { e }
\cs_new:Npn \__flowfram_get_range:w #1 - #2 \q_stop
 {
  \quark_if_nil:nTF { #2 }
   {
     \tl_if_head_eq_meaning:nNTF { #1 } <
      {
        \int_zero:N \l__flowfram_range_start_int
        \int_set:Nn \l__flowfram_range_end_int
         {
           \tl_tail:n { #1 } - \c_one_int
         }
      }
      {
        \tl_if_head_eq_meaning:nNTF { #1 } >
         {
           \int_set:Nn \l__flowfram_range_start_int
            {
              \tl_tail:n { #1 } + \c_one_int
            }
           \int_set_eq:NN
            \l__flowfram_range_end_int
            \c_flowfram_max_page_int
         }
         {
           \int_set:Nn \l__flowfram_range_start_int { #1 }
           \int_set:Nn \l__flowfram_range_end_int { #1 }
         }
      }
   }
   {
     \int_set:Nn \l__flowfram_range_start_int { #1 }
     \__flowfram_get_end_range:w #2 - \q_stop
   }
}
\cs_new:Npn \__flowfram_get_end_range:w #1 - #2 \q_stop
 {
   \int_set:Nn \l__flowfram_range_end_int { #1 }
 }
\cs_new:Nn \flowfram_frame_new_bool:nnn
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \bool_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { bool }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\cs_new:Nn \flowfram_frame_new_bool:nnnN
 {
   \prop_if_exist:cTF
    { g__flowfram_ #1 _attributes_prop }
    {
      \bool_new:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
      \bool_gset_eq:cN
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
        #4
      \__flowfram_add_frame_attribute:cen
        { g__flowfram_ #1 _attributes_prop }
        { #2 } { bool }
    }
    {
      \msg_error:nne { flowfram } {invalid-frame-type} { #1 }
    }
 }
\prg_new_conditional:Nnn \flowfram_if_frame_bool:nnn
   { T, F, TF }
 {
   \bool_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
    {
      \bool_if:cTF
        { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
      { \prg_return_true: }
      { \prg_return_false: }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { bool }
      \prg_return_false:
    }
 }
\cs_new:Nn \flowfram_frame_set_bool_true:nnn
 {
   \bool_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
    {
      \bool_gset_true:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { bool }
    }
 }
\cs_new:Nn \flowfram_frame_set_bool_false:nnn
 {
   \bool_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
    {
      \bool_gset_false:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { bool }
    }
 }
\cs_new:Nn \flowfram_frame_set_bool_from_option:nnnn
 {
   \bool_if_exist:cTF
      { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
    {
      \tl_if_eq:nnTF { #4 } { true }
       {
         \bool_gset_true:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
       }
       {
         \tl_if_eq:nnTF { #4 } { false }
          {
            \bool_gset_false:c { g__flowfram_ #1 _ #2 _ \romannumeral #3 _ bool }
          }
          {
            \msg_error:nnnnnn { flowfram } { invalid-bool }
             { #4 } { #2 } { #1 } { #3 }
          }
       }
    }
    {
      \__flowfram_error:eeeee { frame-unknown-tag }
       { #1 } { #2 } { \int_eval:n { #3 } } { bool }
    }
 }
\cs_generate_variant:Nn \flowfram_frame_set_bool_from_option:nnnn
 { nnnV , nnne }
\cs_new:Nn \__flowfram_only_preamble:Nn { #2 }
\cs_new:Nn \__flowfram_forbidden:Nn
 {
   \msg_error:nnn { flowfram } { misplaced-col-cmd } { #1 }
 }
\cs_new:Nn \__flowfram_only_document_env:Nn
 {
   \msg_error:nnn { flowfram } { doc-env-only } { #1 }
 }
\newlength\flowframesep
\flowframesep=\fboxsep
\newlength\flowframerule
\flowframerule=\fboxrule
\NewDocumentCommand \flowframeshowlayout { }
 {
  \finishthispage
   \group_begin:
     \__flowfram_set_draft:
     \mbox{}
     \finishthispage
     \clearpage
   \group_end:
 }
\newif\ifusedframebreak
\usedframebreaktrue
\NewDocumentCommand \framebreak { O{4} }
{
  \global \usedframebreaktrue
  \group_begin:
    \dim_zero:N \parfillskip
    \pagebreak [ #1 ]
    \dim_zero:N \parskip
    \par
    \noindent
  \group_end:
}
\NewDocumentCommand \finishthispage { }
{
  \ifvmode
    \int_set_eq:NN \l__flowfram_current_frame_int \c@thisframe
    \int_set_eq:NN \l__flowfram_current_abspage_int \c@absolutepage
    \dim_compare:nNnT { \pagetotal } < { \topskip }
     {
       \hbox { }
     }
    \newpage
    \write \m@ne { }
    \vbox { }
    \penalty -\@Mi
    \int_compare:nNnT
       { \l__flowfram_current_abspage_int } = { \c@absolutepage }
     {
       \bool_while_do:nn
         {
           \bool_not_p:n
            {
              \int_compare_p:nNn
                { \l__flowfram_current_frame_int } > { \c@maxflow }
            }
         }
       {
         \__flowfram_check_if_this_page:nn
            { \g__flowfram_pagecounter_tl } { \l__flowfram_current_frame_int }
         \bool_if:NF \g__flowfram_not_this_frame_bool
          {
            \int_gset:Nn \c@thisframe { \l__flowfram_current_frame_int }
            \hbox { }
            \newpage
          }
         \int_incr:N \l__flowfram_current_frame_int
       }
     }
  \fi
}
\providecommand\cleardoublepage{}
\RenewDocumentCommand \cleardoublepage { }
{
  \clearpage
  \if@twoside
    \ifodd \c@page
    \else
      \hbox { }
      \clearpage
    \fi
  \fi
}
\NewDocumentCommand \cleartoevenpage { }
{
  \clearpage
  \if@twoside
    \ifodd \c@page
      \hbox { }
      \clearpage
    \fi
  \fi
}
\preto\newpage{\global\usedframebreaktrue}
\long\def\@topnewpage[#1]{#1}
\@mparswitchfalse
\NewDocumentCommand \globalreversemargin { }
 {
  \global \@mparbottom \z@
  \global \@reversemargintrue
 }
\NewDocumentCommand \globalnormalmargin { }
 {
  \global \@mparbottom \z@
  \global \@reversemarginfalse
 }
\cs_new:Nn \__flowfram_get_margin_pos:n
 {
  \tl_if_eq:NnTF \c_flowfram_inner_tl { #1 }
   {
     \legacy_if:nTF { @twoside }
      {
        \int_if_odd:nTF { \c@page }
         {
           \tl_set_eq:NN
             \l__flowfram_margin_tl
             \c_flowfram_left_tl
         }
         {
           \tl_set_eq:NN
             \l__flowfram_margin_tl
             \c_flowfram_right_tl
         }
      }
      {
       \tl_set_eq:NN
         \l__flowfram_margin_tl
         \c_flowfram_left_tl
      }
   }
   {
    \tl_if_eq:NnTF \c_flowfram_outer_tl { #1 }
     {
       \legacy_if:nTF { @twoside }
        {
          \int_if_odd:nTF { \c@page }
           {
             \tl_set_eq:NN
               \l__flowfram_margin_tl
               \c_flowfram_right_tl
           }
           {
             \tl_set_eq:NN
               \l__flowfram_margin_tl
               \c_flowfram_left_tl
           }
        }
        {
          \tl_set_eq:NN
            \l__flowfram_margin_tl
            \c_flowfram_right_tl
        }
     }
     {
      \tl_set:Nn \l__flowfram_margin_tl { #1 }
     }
   }
 }
\cs_generate_variant:Nn \__flowfram_get_margin_pos:n { e }
\NewDocumentCommand \setmargin { }
{
 \__flowfram_get_margin_pos:e
  {
    \flowfram_frame_use_tl:nnn { flow } { margin } { \c@thisframe }
  }
 \tl_if_eq:NNTF \l__flowfram_margin_tl \c_flowfram_left_tl
  {
    \globalreversemargin
  }
  {
    \globalnormalmargin
  }
}
\NewDocumentCommand \newflowframe
  { s O{all} m m m m O { \int_use:N \c@maxflow } }
 {
   \__flowfram_only_preamble:Nn \newflowframe
    {
      \__flowfram_new_flow:nnnnnn
       { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfBooleanT { #1 }
        {
          \flowfram_frame_set_bool_true:nnnn { flow } { hasframe } { \c@maxflow }
        }
    }
 }
\cs_new_nopar:Nn \__flowfram_new_flow:nnnnn
 {
   \__flowfram_new_flow:nnnnnn
     { #1 } { #2 } { #3 } { #4 } { #5 } { \int_use:N \c@maxflow }
 }
\cs_new:Nn  \__flowfram_new_flow:nnnnnn
{
  \__flowfram_new_frame:nnnnnnn
   { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { flow }
  \flowfram_frame_new_box:nnn { flow } { column } { \c@maxflow }
  \flowfram_frame_new_tl:nnnn { flow } { margin } { \c@maxflow } { right }
  \int_if_zero:nT { \c@thisframe }
   {
     \__flowfram_frame_get_start_page:nn { flow } { \c@maxflow }
     \int_compare:nNnT
       { \l__flowfram_range_start_int } = { \c_one_int }
      {
        \int_gset_eq:NN \c@thisframe \c@maxflow
        \__flowfram_set_column:n { \c@maxflow }
        \global\usedframebreaktrue
      }
   }
}
\newcommand*{\getflowlabel}[1]{%
  \flowfram_frame_use_tl:nnn { flow } { label } { #1 }
}
\NewDocumentCommand \getflowid { m m }
 {
  \__flowfram_get_flow_id:e { #2 }
  \tl_set:Ne #1 { \int_use:N \l__flowfram_id_int }
 }
\cs_new:Nn \__flowfram_get_flow_id:n
{
  \__flowfram_if_flow_label_exists:nF { #1 }
   {
     \__flowfram_error:eee { label-undefined } { #1 } { flow }
   }
}
\cs_generate_variant:Nn \__flowfram_get_flow_id:n { e, V }
\prg_new_conditional:Nnn \__flowfram_if_flow_label_exists:n
 { TF , T , F }
 {
   \__flowfram_if_frame_label_exists:nnNTF
      { flow } { #1 } \l__flowfram_id_int
    { \prg_return_true: }
    { \prg_return_false: }
 }
\NewDocumentCommand \setallflowframes { m }
{
  \int_step_inline:nn { \c@maxflow }
   {
     \__flowfram_set_flow_by_idn:nn { ##1 } { #1 }
   }
}
\NewDocumentCommand \setflowframe { s m m }
 {
   \IfBooleanTF { #1 }
    {
      \exp_args:Ne \clist_map_inline:nn { #2 }
       {
         \__flowfram_if_flow_label_exists:nTF { ##1 }
          {
            \__flowfram_set_flow_by_idn:nn { \l__flowfram_id_int } { #3 }
          }
          {
            \__flowfram_error:eee { label-undefined } { ##1 } { flow }
          }
       }
    }
    {
      \__flowfram_map_idns:enn { #2 } { flow }
       {
          \__flowfram_set_flow_by_idn:nn { \l__flowfram_id_int } { #3 }
       }
    }
 }
\cs_new:Nn \__flowfram_set_flow_by_idn:nn
{
  \__flowfram_set_keys_for_type:nnn { #2 } { flow } { #1 }
  \tl_if_empty:NF \l__flowfram_margin_tl
   {
     \flowfram_frame_set_tl:nnnV
       { flow } { margin } { #1 }
       \l__flowfram_margin_tl
   }
}
\NewDocumentCommand \flowsetpagelist { m m }
 {
  \flowfram_set_frame_pagelist:nne { flow } { #1 } { #2 }
 }
\NewDocumentCommand \flowsetexclusion { m m }
 {
   \flowfram_set_frame_excludelist:nne { flow } { #1 } { #2 }
 }
\NewDocumentCommand \flowaddexclusion { m m }
{
  \flowfram_concat_frame_excludelist:nne
   { flow } { #1 } { #2 }
}
\cs_new:Nn \__flowfram_flow_swap_coords:n
{
  \flowfram_frame_swap_dim:nnnn
    { flow } { posx } { evenx } { #1 }
  \flowfram_frame_swap_dim:nnnn
    { flow } { posy } { eveny } { #1 }
}
\NewDocumentCommand \ffswapoddeven { s m }
 {
   \IfValueTF { #1 }
    {
      \exp_args:Ne \clist_map_inline:nn { #2 }
       {
         \__flowfram_get_flow_id:n { ##1 }
         \__flowfram_flow_swap_coords:n { \l__flowfram_id_int }
       }
    }
    {
       \__flowfram_map_idns:enn { #2 } { flow }
        {
          \__flowfram_flow_swap_coords:n { \l__flowfram_id_int }
        }
    }
 }
\newcommand*{\flowframex}[1]{%
  \flowfram_frame_use_dim:nnn { flow } { posx } { #1 }
}
\newcommand*{\flowframey}[1]{%
  \flowfram_frame_use_dim:nnn { flow } { posy } { #1 }
}
\newcommand*{\flowframeevenx}[1]{%
  \flowfram_frame_use_dim:nnn { flow } { evenx } { #1 }
}
\newcommand*{\flowframeeveny}[1]{%
  \flowfram_frame_use_dim:nnn { flow } { eveny } { #1 }
}
\newcommand{\flowframewidth}[1]{%
  \flowfram_frame_use_dim:nnn { flow } { width } { #1 }
}
\newcommand*{\flowframeheight}[1]{%
  \flowfram_frame_use_dim:nnn { flow } { height } { #1 }
}
\NewDocumentCommand \newstaticframe
  { s O{all} m m m m O { \int_use:N \c@maxstatic } }
 {
   \__flowfram_new_static:nnnnnn
    { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
   \IfBooleanT { #1 }
     {
       \flowfram_frame_set_bool_true:nnnn
          { static } { hasframe } { \c@maxstatic }
     }
 }
\cs_new:Nn \__flowfram_new_static:nnnnn
 {
   \__flowfram_new_static:nnnnnn
    { #1 } { #2 } { #3 } { #4 } { #5 } { \int_use:N \c@maxstatic }
 }
\cs_new_nopar:Nn \__flowfram_new_static:nnnnnn
 {
  \__flowfram_new_frame:nnnnnnn
   { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { static }
  \flowfram_frame_new_box:nnn { static } { content } { \c@maxstatic }
  \flowfram_frame_new_bool:nnnN
    { static } { clear } { \c@maxstatic } \c_false_bool
  \flowfram_frame_new_bool:nnnN
    { static } { hide } { \c@maxstatic } \c_false_bool
  \flowfram_frame_new_bool:nnnN
    { static } { hidethis } { \c@maxstatic } \c_false_bool
  \flowfram_frame_new_tl:nnnn
    { static } { valign } { \c@maxstatic } { c }
  \flowfram_frame_new_tl:nnnn
    { static } { shape } { \c@maxstatic } { \relax }
  \flowfram_frame_new_tl:nnnn
    { static } { parindent } { \c@maxstatic } { \sdfparindent }
 }
\newcommand*{\getstaticlabel}[1]{%
  \flowfram_frame_use_tl:nnn { static } { label } { #1 }
}
\NewDocumentCommand \getstaticid { m m }
 {
  \__flowfram_get_static_id:e { #2 }
  \tl_set:Ne #1 { \int_use:N \l__flowfram_id_int }
 }
\cs_new:Nn \__flowfram_get_static_id:n
{
  \__flowfram_if_static_label_exists:nF { #1 }
   {
     \__flowfram_error:eee { label-undefined } { #1 } { static }
   }
}
\cs_generate_variant:Nn \__flowfram_get_static_id:n { e, V }
\prg_new_conditional:Nnn \__flowfram_if_static_label_exists:n
 { TF , T , F }
 {
   \__flowfram_if_frame_label_exists:nnNTF
      { static } { #1 } \l__flowfram_id_int
    { \prg_return_true: }
    { \prg_return_false: }
 }
\newcommand*{\staticframex}[1]{%
  \flowfram_frame_use_dim:nnn { static } { posx } { #1 }
}
\newcommand*{\staticframey}[1]{%
  \flowfram_frame_use_dim:nnn { static } { posy } { #1 }
}
\newcommand*{\staticframeevenx}[1]{%
  \flowfram_frame_use_dim:nnn { static } { evenx } { #1 }
}
\newcommand*{\staticframeeveny}[1]{%
  \flowfram_frame_use_dim:nnn { static } { eveny } { #1 }
}
\newcommand*{\staticframewidth}[1]{%
  \flowfram_frame_use_dim:nnn { static } { width } { #1 }
}
\newcommand*{\staticframeheight}[1]{%
  \flowfram_frame_use_dim:nnn { static } { height } { #1 }
}
\NewDocumentCommand \setallstaticframes { m }
 {
  \int_step_inline:nn { \c@maxstatic }
   {
     \__flowfram_set_static_by_idn:nn { ##1 } { #1 }
   }
 }
\NewDocumentCommand \setstaticframe { s m m }
 {
   \IfBooleanTF { #1 }
    {
      \exp_args:Ne \clist_map_inline:nn { #2 }
       {
         \__flowfram_if_static_label_exists:nTF { ##1 }
          {
            \__flowfram_set_static_by_idn:nn { \l__flowfram_id_int } { #3 }
          }
          {
            \__flowfram_error:eee { label-undefined } { ##1 } { static }
          }
       }
    }
    {
      \__flowfram_map_idns:enn { #2 } { static }
       {
          \__flowfram_set_static_by_idn:nn { \l__flowfram_id_int } { #3 }
       }
    }
 }
\cs_new:Nn \__flowfram_set_static_by_idn:nn
{
  \__flowfram_set_keys_for_type:nnn { #2 } { static } { #1 }
  \tl_if_empty:NF \l__flowfram_clearflag_tl
   {
     \flowfram_frame_set_bool_from_option:nnnV
      { static } { clear } { #1 }
     \l__flowfram_clearflag_tl
   }
  \tl_if_empty:NF \l__flowfram_hideflag_tl
   {
     \flowfram_frame_set_bool_from_option:nnnV
      { static } { hide } { #1 }
     \l__flowfram_hideflag_tl
   }
  \tl_if_empty:NF \l__flowfram_hidethisflag_tl
   {
     \flowfram_frame_set_bool_from_option:nnnV
      { static } { hidethis } { #1 }
     \l__flowfram_hidethisflag_tl
   }
  \exp_args:NV \tl_if_novalue:nF \l__flowfram_shape_tl
   {
     \flowfram_frame_set_tl:nnnV
      { static } { shape } { #1 } \l__flowfram_shape_tl
   }
  \exp_args:NV \tl_if_novalue:nF \l__flowfram_parindent_tl
   {
     \flowfram_frame_set_tl:nnnV
      { static } { parindent } { #1 } \l__flowfram_parindent_tl
   }
  \tl_if_empty:NF \l__flowfram_valign_tl
   {
     \flowfram_frame_set_tl:nnnV
        { static } { valign } { #1 }
       \l__flowfram_valign_tl
   }
}
\NewDocumentCommand \FLFsimpar { }
 {
  \hfill \newline
  \hspace* { \parindent }
 }
\providecommand*{\simpar}{\FLFsimpar}
\newcommand \ffpshpar { }
\let\FLForgpar\par
\tl_new:N \l__flowfram_parshape_tl
\tl_set:Nn \l__flowfram_parshape_tl { \parshape = 0 }
\tl_new:N \l__flowfram_current_pre_section_tl
\tl_new:N \@@flowfram@current@pre@section@title
\tl_new:N \l__flowfram_current_post_section_tl
\cs_new:Nn \flowfram_nonum_section:Nnn
 {
   #1 * { #3 }
 }
\cs_generate_variant:Nn \flowfram_nonum_section:Nnn { cVn }
\renewcommand \addtocontents [2]
 {
   \protected@write \@auxout
     {
       \let \label \@gobble@om
       \let \index \@gobble@som
       \let \glossary \@gobble@om
       \let \@@flowfram@current@pre@section@title \empty
       \let \theFramePageCounter \relax
     }
     {
       \string \@writefile { #1 } { #2 }
     }
 }
\bool_new:N \l__flowfram_starred_section_bool
\tl_new:N \l__flowfram_section_thumbtab_title_tl
\NewDocumentCommand \FlowFramSectionUnit { m s o o m }
 {
   \tl_clear:N \l__flowfram_section_toc_tl
   \tl_clear:N \l__flowfram_section_head_tl
   \tl_clear:N \l__flowfram_section_opti_tl
   \tl_clear:N \l__flowfram_section_optii_tl
   \tl_clear:N \l__flowfram_section_thumbtab_title_tl
   \cs_if_exist:cTF { __flowfram_org_ #1 : }
    {
      \l__flowfram_current_pre_section_tl
      \IfValueTF { #3 }
       {
         \tl_if_empty:nTF { #3 }
          {
            \tl_set:Nn \l__flowfram_section_opti_tl { #5 }
            \tl_set:Nn \l__flowfram_section_toc_tl { #5 }
          }
          {
            \tl_set:Nn \l__flowfram_section_opti_tl { #3 }
            \tl_set:Nn \l__flowfram_section_toc_tl { #3 }
          }
         \bool_if:NT \l__flowfram_section_keyval_opt_bool
          {
            \tl_if_in:NnT = { #3 }
             {
               \keys_set_known:nn { flowfram / section } { #3 }
             }
          }
       }
       {
         \tl_set:Nn \l__flowfram_section_opti_tl { #5 }
       }
      \tl_if_empty:NT \l__flowfram_section_toc_tl
       {
         \tl_set:Nn \l__flowfram_section_toc_tl { #5 }
       }
      \IfValueT { #4 }
       {
         \bool_if:NT \l__flowfram_section_header_opt_bool
          {
            \tl_set:Nn \l__flowfram_section_optii_tl { #4 }
          }
         \bool_if:NTF \l__flowfram_section_header_opt_thumbtab_bool
          {
            \tl_set:Nn \l__flowfram_section_thumbtab_title_tl { #4 }
          }
          {
            \tl_set_eq:NN
              \l__flowfram_section_thumbtab_title_tl
              \l__flowfram_section_toc_tl
          }
       }
     \tl_if_empty:NT \l__flowfram_section_head_tl
      {
         \tl_set_eq:NN
           \l__flowfram_section_head_tl
           \l__flowfram_section_toc_tl
       }
     \tl_if_empty:NT \l__flowfram_section_thumbtab_title_tl
       {
         \tl_set_eq:NN
           \l__flowfram_section_thumbtab_title_tl
           \l__flowfram_section_head_tl
       }
      \IfBooleanTF { #2 }
       {
         \bool_set_true:N \l__flowfram_starred_section_bool
         \__flowfram_if_df_chapter:nTF { #1 }
          {
            \exp_args:Nee
            \__flowfram_df_chapter_star:nn
               { \l__flowfram_section_opti_tl }
               { #5 }
          }
          {
            \flowfram_nonum_section:cVn
              { __flowfram_org_ #1 : }
               \l__flowfram_section_opti_tl
              {
                \@@flowfram@current@pre@section@title
                #5
              }
          }
       }
       {
         \bool_set_false:N \l__flowfram_starred_section_bool
         \__flowfram_if_df_chapter:nTF { #1 }
          {
             \tl_if_empty:NTF \l__flowfram_section_optii_tl
              {
                \exp_args:Nee
                \__flowfram_df_chapter:nn
                { \l__flowfram_section_opti_tl }
                { #5 }
              }
              {
                \exp_args:Neee
                \__flowfram_df_chapter:nnn
                { \l__flowfram_section_opti_tl }
                { \l__flowfram_section_optii_tl }
                { #5 }
              }
          }
          {
            \__flowfram_use_original_sec:cVVn
              { __flowfram_org_ #1 : }
              \l__flowfram_section_opti_tl
              \l__flowfram_section_optii_tl
              { #5 }
          }
       }
      \cs_if_exist:cF { __flowfram_org_end_ #1 : }
       {
         \__flowfram_post_section_unit:n { #1 }
       }
      \l__flowfram_current_post_section_tl
   }
   {
     \msg_error:nne { flowfram } { unknown-heading-cmd }
       { #1 }
   }
  \@afterheading
 }
\cs_new:Nn \__flowfram_use_original_sec:Nnnn
 {
   \tl_if_empty:nTF { #3 }
    {
      #1 [ #2 ]
        {
          \@@flowfram@current@pre@section@title
          #4
        }
    }
    {
      #1 [ #2 ] [ #3 ]
        {
          \@@flowfram@current@pre@section@title
          #4
        }
    }
 }
\cs_generate_variant:Nn \__flowfram_use_original_sec:Nnnn
  { cVVn , cVnn , cnnn }
\cs_new:Nn \__flowfram_post_section_unit:n
 {
   \__flowfram_add_thumbtab:n { #1 }
   \bool_if:NF \l__flowfram_starred_section_bool
    {
      \__flowfram_minitoc_post_section_unit:n { #1 }
    }
 }
\cs_new:Nn \__flowfram_add_thumbtab:n { }
\cs_new:Nn \__flowfram_actual_add_thumbtab:n
 {
   \tl_if_eq:eeT \g__flowfram_thumbtab_type_tl { #1 }
    {
      \bool_if:NTF \l__flowfram_starred_section_bool
       {
         \__flowfram_ttb_nonum:n { \l__flowfram_section_thumbtab_title_tl }
       }
       {
         \flowfram_if_mainmatter:TF
          {
            \__flowfram_ttb_num:n
              { \l__flowfram_section_thumbtab_title_tl }
          }
          {
            \__flowfram_ttb_notmainmatter_num:n
              { \l__flowfram_section_thumbtab_title_tl }
          }
       }
    }
 }
\cs_new:Nn \__flowfram_minitoc_post_section_unit:n
 {
 }
\cs_new:Nn \__flowfram_provide_section_unit:n
 {
   \cs_if_exist:cT { #1 }
    {
      \cs_set_eq:cc { __flowfram_org_ #1 : }  { #1 }
      \cs_set:cpn { #1 }
       {
          \FlowFramSectionUnit { #1 }
       }
      \cs_if_exist:cT { @end #1 }
       {
         \cs_set_eq:cc { __flowfram_org_end_ #1 : }  { @end #1 }
         \cs_set:cpn { @end #1 }
          {
            \__flowfram_post_section_unit:n { #1 }
            \use:c {  __flowfram_org_end_ #1 : }
          }
       }
    }
 }
\__flowfram_provide_section_unit:n { part }
\__flowfram_provide_section_unit:n { chapter }
\__flowfram_provide_section_unit:n { section }
\__flowfram_provide_section_unit:n { subsection }
\__flowfram_provide_section_unit:n { subsubsection }
\__flowfram_provide_section_unit:n { paragraph }
\__flowfram_provide_section_unit:n { subparagraph }
\cs_new:Nn \__flowfram_set_shaped_section_headings:
 {
   \tl_set:Nn \l__flowfram_current_pre_section_tl
    {
       \FLFsimpar
       \begin { minipage } { \linewidth }
       \let \par \endgraf
    }
   \tl_set:Nn \l__flowfram_current_post_section_tl
    {
       \end { minipage }
       \FLFsimpar
    }
 }
\cs_new:Nn \__flowfram_get_shape:n
 {
   \tl_if_head_eq_meaning:nNTF { #1 } \parshape
    {
      \int_set_eq:NN
        \l__flowfram_shape_int
        \c_flowfram_shape_type_parshape_int
    }
    {
      \tl_if_head_eq_meaning:nNTF { #1 } \shapepar
       {
         \int_set_eq:NN
           \l__flowfram_shape_int
           \c_flowfram_shape_type_shapepar_int
       }
       {
         \tl_if_head_eq_meaning:nNTF { #1 } \Shapepar
          {
            \int_set_eq:NN
              \l__flowfram_shape_int
              \c_flowfram_shape_type_shapepar_int
          }
          {
            \tl_if_head_eq_meaning:nNTF { #1 } \relax
             {
               \int_set_eq:NN
                \l__flowfram_shape_int
                \c_flowfram_shape_type_none_int
             }
             {
               \msg_error:nnn { flowfram } { unknown-shape } { #1 }
               \int_set_eq:NN
                 \l__flowfram_shape_int
                 \c_flowfram_shape_type_shapepar_int
             }
          }
       }
    }
 }
\cs_generate_variant:Nn \__flowfram_get_shape:n { V }
\cs_new:Nn \__flowfram_disabled_sec:NN
 {
   \msg_error:nnnn { flowfram } { forbidden-cmd-in-shape } { #1 } { #2 }
   \@gobble@som
 }
\newcommand*{\@ff@disablesec}{%
  \def\section{
    \__flowfram_disabled_sec:NN \section \shapepar
  }
  \def\subsection{
    \__flowfram_disabled_sec:NN \subsection \shapepar
  }
  \def\subsubsection{
    \__flowfram_disabled_sec:NN \subsubsection \shapepar
  }
  \def\paragraph{
    \__flowfram_disabled_sec:NN \paragraph \shapepar
  }
  \def\subparagraph{
    \__flowfram_disabled_sec:NN \subparagraph \shapepar
  }
}
\newbox\staticframe
\NewDocumentEnvironment { staticcontents } { o m }
{
  \IfValueT { #1 }
   {
     \__flowfram_set_static_by_idn:nn { #2 } { #1 }
   }
  \RenewDocumentCommand \continueonframe { o m }
    {
      \__flowfram_static_continue_idn:nn { ##1 } { ##2 }
    }
  \__flowfram_static_contents_begin:n { #2 }
}
{
  \__flowfram_static_contents_end:
  \ignorespacesafterend
}
\NewDocumentEnvironment { staticcontents* } { o m }
{
  \__flowfram_get_static_id:n { #2 }
  \IfValueT { #1 }
   {
     \__flowfram_set_static_by_idn:nn
        { \l__flowfram_id_int }
        { #1 }
   }
  \RenewDocumentCommand \continueonframe { o m }
    {
       \__flowfram_static_continue_idl:nn { ##1 } { ##2 }
    }
  \__flowfram_static_contents_begin:n { \l__flowfram_id_int }
}
{
  \__flowfram_static_contents_end:
  \ignorespacesafterend
}
\cs_new:Nn \__flowfram_static_contents_begin:n
{
  \int_zero:N \l__flowfram_current_static_int
  \box_if_exist:cTF
      { g__flowfram_static_content_ \romannumeral #1 _box }
   {
     \int_set:Nn \l__flowfram_current_static_int { #1 }
     \tl_set:Ne \l__flowfram_minipage_tl
      {
        \exp_not:N \begin { minipage }
         [ c ]
         [
           \staticframeheight { #1 }
         ]
         [
           \flowfram_frame_use_tl:nnn
            { static } { valign } { #1 }
         ]
         {
           \staticframewidth { #1 }
         }
      }
     \flowfram_set_tl_to_frame_tl:Nnnn
       \l__flowfram_parindent_tl
       { static } { parindent } { #1 }
     \flowfram_set_tl_to_frame_tl:Nnnn
       \l__flowfram_parshape_tl
       { static } { shape } { #1 }
     \__flowfram_get_shape:V \l__flowfram_parshape_tl
     \int_case:nnF { \l__flowfram_shape_int }
      {
        { \c_flowfram_shape_type_none_int }
          { }
        { \c_flowfram_shape_type_parshape_int }
         {
           \tl_put_right:NV
             \l__flowfram_minipage_tl
             \l__flowfram_parshape_tl
           \tl_put_right:Nn \l__flowfram_minipage_tl
             {
               \let \par \FLFsimpar
               \__flowfram_set_shaped_section_headings:
             }
         }
      }
      {
        \tl_put_right:Nn \l__flowfram_minipage_tl
          {
            \@ff@disablesec
          }
        \tl_put_right:NV
          \l__flowfram_minipage_tl
          \l__flowfram_parshape_tl
      }
     \UseHook { flowfram / staticbox / before }
     \begin { lrbox } { \staticframe }
       \flowfram_set_tl_to_frame_tl:Nnnn
         \l__flowfram_textcolor_tl
         { static } { textcolor } { #1 }
       \__flowfram_set_text_color:
       \noindent
       \l__flowfram_minipage_tl
       \dim_set:Nn \parindent { \l__flowfram_parindent_tl }
   }
   {
     \msg_error:nnnn { flowfram } { idn-undefined } { static } { #1 }
   }
}
\NewMirroredHookPair
 { flowfram / staticbox / before }
 { flowfram / staticbox / after }
\cs_new:Nn \__flowfram_static_contents_end:
{
  \int_if_zero:nF { \l__flowfram_current_static_int }
   {
     \endgraf
     \end { minipage }
     \end { lrbox }
     \UseHook { flowfram / staticbox / after }
     \flowfram_frame_set_box_eq:nnnN
       { static } { content } { \l__flowfram_current_static_int }
       \staticframe
   }
}
\NewDocumentCommand \setstaticcontents { s o m +m }
{
  \IfBooleanTF { #1 }
   {
     \__flowfram_get_static_id:n { #3 }
     \IfValueT { #2 }
      {
        \__flowfram_set_static_by_idn:nn
           { \l__flowfram_id_int }
           { #2 }
      }
     \begin { staticcontents } { \l__flowfram_id_int }
       #4
     \end { staticcontents }
   }
   {
     \IfValueT { #2 }
      {
        \__flowfram_set_static_by_idn:nn { #3 } { #2 }
      }
     \begin { staticcontents } { #3 }
       #4
     \end { staticcontents }
   }
}
\NewDocumentCommand \staticsetpagelist { m m }
 {
  \flowfram_set_frame_pagelist:nne { static } { #1 } { #2 }
 }
\NewDocumentCommand \staticsetexclusion { m m }
 {
   \flowfram_set_frame_excludelist:nne { static } { #1 } { #2 }
 }
\NewDocumentCommand \staticaddexclusion { m m }
 {
  \flowfram_concat_frame_excludelist:nne
   { static } { #1 } { #2 }
 }
\NewDocumentCommand \sfswapoddeven { s m }
{
   \IfValueTF { #1 }
    {
      \exp_args:Ne \clist_map_inline:nn { #2 }
       {
         \__flowfram_get_static_id:n { ##1 }
         \__flowfram_static_swap_coords:n { \l__flowfram_id_int }
       }
    }
    {
       \__flowfram_map_idns:enn { #2 } { static }
        {
          \__flowfram_static_swap_coords:n { \l__flowfram_id_int }
        }
    }
}
\cs_new:Nn \__flowfram_static_swap_coords:n
{
  \flowfram_frame_swap_dim:nnnn
    { static } { posx } { evenx } { #1 }
  \flowfram_frame_swap_dim:nnnn
    { static } { posy } { eveny } { #1 }
}
\NewDocumentCommand \continueonframe { O{} m }
 {
   \msg_error:nn { flowfram } { cant-continue }
 }
\cs_new:Nn \__flowfram_static_continue_idl:nn
 {
   \IfValueTF { #1 }
    {
      \ffcontinuedtextlayout { #1 }
    }
    {
      \ffcontinuedtextlayout
       {
         \flowfram_continue_on_static_frame_idl:Nn
           \l__flowfram_current_static_int
           { #2 }
       }
    }
   \exp_args:NnNV
   \end { staticcontents* }
   \__flowfram_set_post_continued:nnn
      \l__flowfram_current_static_int
      { \l__flowfram_current_static_int }
      { \c_flowfram_frame_type_static_int }
   \tl_put_left:Nn \l__flowfram_postcontinued_tl
     { \begin { staticcontents* } { #2 } }
   \l__flowfram_postcontinued_tl
 }
\cs_new:Nn \__flowfram_static_continue_idn:nn
 {
   \IfValueTF { #1 }
    {
      \ffcontinuedtextlayout { #1 }
    }
    {
      \ffcontinuedtextlayout
       {
         \flowfram_continue_on_static_frame_idn:Nn
           \l__flowfram_current_static_int
           { #2 }
       }
    }
   \exp_args:NnNV
   \end { staticcontents }
    \__flowfram_set_post_continued:nnn
      \l__flowfram_current_static_int
      { \l__flowfram_current_static_int }
      { \c_flowfram_frame_type_static_int }
   \tl_put_left:Nn \l__flowfram_postcontinued_tl
     { \begin { staticcontents } { #1 } }
   \l__flowfram_postcontinued_tl
 }
\tl_new:N \l__flowfram_postcontinued_tl
\cs_new:Nn \__flowfram_set_post_continued:nnn
 {
  \int_case:nnF { #3 }
   {
     { \c_flowfram_frame_type_static_int }
      {
        \tl_set:Nn \l__flowfram_postcontinued_tl
          {
            \ffstaticpostcontinued { #1 } { #2 }
          }
      }
     { \c_flowfram_frame_type_dynamic_int }
      {
        \tl_set:Nn \l__flowfram_postcontinued_tl
          {
            \ffdynamicpostcontinued { #1 } { #2 }
          }
      }
   }
   {
      \tl_clear:N \l__flowfram_postcontinued_tl
   }
 }
\cs_new:Nn \flowfram_continue_on_static_frame_idn:Nn
 {
   \ffdefaultstaticcontinuetext { #1 } { #2 }
 }
\cs_new:Nn \flowfram_continue_on_static_frame_idl:Nn
 {
   \__flowfram_get_static_id:n { #2 }
   \flowfram_continue_on_static_frame_idn:Nn #1 { \l__flowfram_id_int }
 }
\newcommand \ffdefaultstaticcontinuetext [ 2 ] { \ffdefaultcontinuetext }
\newcommand \ffdefaultdynamiccontinuetext [ 2 ] { \ffdefaultcontinuetext }
\newcommand \ffdefaultcontinuetext { }
\newcommand \ffstaticpostcontinued [ 2 ]
 {
   \ffdefaultpostcontinued
 }
\newcommand \ffdynamicpostcontinued [ 2 ]
 {
   \ffdefaultpostcontinued
 }
\newcommand{\ffdefaultpostcontinued}{%
  \par
  \noindent
  \ignorespaces
}
\newcommand{\ffcontinuedtextlayout}[1]{%
  \group_begin:
  \dim_zero:N \parfillskip
  \par
  \hfill
  \ffcontinuedtextfont { #1 }
  \par
  \group_end:
}
\newcommand*{\ffcontinuedtextfont}[1]{\emph{\small #1}}
\NewDocumentCommand \newdynamicframe
  { s O{all} m m m m O { \int_use:N \c@maxdynamic } }
 {
   \__flowfram_new_dynamic:nnnnnn
    { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
   \IfBooleanT { #1 }
     {
       \flowfram_frame_set_bool_true:nnnn
          { dynamic } { hasframe } { \c@maxdynamic }
     }
 }
\cs_new:Nn \__flowfram_new_dynamic:nnnnn
 {
   \__flowfram_new_dynamic:nnnnnn
    { #1 } { #2 } { #3 } { #4 } { #5 } { \int_use:N \c@maxdynamic }
 }
\cs_new_nopar:Nn \__flowfram_new_dynamic:nnnnnn
 {
  \__flowfram_new_frame:nnnnnnn
   { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { dynamic }
  \flowfram_frame_new_tl:nnn { dynamic } { content } { \c@maxdynamic }
  \flowfram_frame_new_bool:nnnN
    { dynamic } { clear } { \c@maxdynamic } \c_false_bool
  \flowfram_frame_new_bool:nnnN
    { dynamic } { hide } { \c@maxdynamic } \c_false_bool
  \flowfram_frame_new_bool:nnnN
    { dynamic } { hidethis } { \c@maxdynamic } \c_false_bool
  \flowfram_frame_new_tl:nnnn
    { dynamic } { valign } { \c@maxdynamic } { t }
  \flowfram_frame_new_tl:nnnn
    { dynamic } { shape } { \c@maxdynamic } { \relax }
  \flowfram_frame_new_tl:nnnn
    { dynamic } { parindent } { \c@maxdynamic } { \sdfparindent }
  \flowfram_frame_new_tl:nnnn
    { dynamic } { style } { \c@maxdynamic } { @firstofone }
}
\newcommand*{\getdynamiclabel}[1]{%
  \flowfram_frame_use_tl:nnn { dynamic } { label } { #1 }
}
\NewDocumentCommand \getdynamicid { m m }
 {
  \__flowfram_get_dynamic_id:e { #2 }
  \tl_set:Ne #1 { \int_use:N \l__flowfram_id_int }
 }
\cs_new:Nn \__flowfram_get_dynamic_id:n
{
  \__flowfram_if_dynamic_label_exists:nF { #1 }
   {
     \__flowfram_error:eee { label-undefined } { #1 } { dynamic }
   }
}
\cs_generate_variant:Nn \__flowfram_get_dynamic_id:n { e, V }
\prg_new_conditional:Nnn \__flowfram_if_dynamic_label_exists:n
 { TF , T , F }
 {
   \__flowfram_if_frame_label_exists:nnNTF
      { dynamic } { #1 } \l__flowfram_id_int
    { \prg_return_true: }
    { \prg_return_false: }
 }
\newcommand*{\dynamicframex}[1]{%
  \flowfram_frame_use_dim:nnn { dynamic } { posx } { #1 }
}
\newcommand*{\dynamicframey}[1]{%
  \flowfram_frame_use_dim:nnn { dynamic } { posy } { #1 }
}
\newcommand*{\dynamicframeevenx}[1]{%
  \flowfram_frame_use_dim:nnn { dynamic } { evenx } { #1 }
}
\newcommand*{\dynamicframeeveny}[1]{%
  \flowfram_frame_use_dim:nnn { dynamic } { eveny } { #1 }
}
\newcommand*{\dynamicframewidth}[1]{%
  \flowfram_frame_use_dim:nnn { dynamic } { width } { #1 }
}
\newcommand*{\dynamicframeheight}[1]{%
  \flowfram_frame_use_dim:nnn { dynamic } { height } { #1 }
}
\NewDocumentCommand \setalldynamicframes { m }
 {
  \int_step_inline:nn { \c@maxdynamic }
   {
     \__flowfram_set_dynamic_by_idn:nn { ##1 } { #1 }
   }
 }
\NewDocumentCommand \setdynamicframe { s m m }
 {
   \IfBooleanTF { #1 }
    {
      \exp_args:Ne \clist_map_inline:nn { #2 }
       {
         \__flowfram_if_dynamic_label_exists:nTF { ##1 }
          {
            \__flowfram_set_dynamic_by_idn:nn { \l__flowfram_id_int } { #3 }
          }
          {
            \__flowfram_error:eee { label-undefined } { ##1 } { dynamic }
          }
       }
    }
    {
      \__flowfram_map_idns:enn { #2 } { dynamic }
       {
          \__flowfram_set_dynamic_by_idn:nn { \l__flowfram_id_int } { #3 }
       }
    }
 }
\cs_new:Nn \__flowfram_set_dynamic_by_idn:nn
{
  \__flowfram_set_keys_for_type:nnn { #2 } { dynamic } { #1 }
  \tl_if_empty:NF \l__flowfram_style_tl
   {
     \flowfram_frame_set_tl:nnnV
      { dynamic } { style } { #1 } \l__flowfram_style_tl
   }
  \tl_if_empty:NF \l__flowfram_clearflag_tl
   {
     \flowfram_frame_set_bool_from_option:nnnV
      { dynamic } { clear } { #1 }
     \l__flowfram_clearflag_tl
   }
  \tl_if_empty:NF \l__flowfram_hideflag_tl
   {
     \flowfram_frame_set_bool_from_option:nnnV
      { dynamic } { hide } { #1 }
     \l__flowfram_hideflag_tl
   }
  \tl_if_empty:NF \l__flowfram_hidethisflag_tl
   {
     \flowfram_frame_set_bool_from_option:nnnV
      { dynamic } { hidethis } { #1 }
     \l__flowfram_hidethisflag_tl
   }
  \exp_args:NV \tl_if_novalue:nF \l__flowfram_shape_tl
   {
     \flowfram_frame_set_tl:nnnV
      { dynamic } { shape } { #1 } \l__flowfram_shape_tl
   }
  \exp_args:NV \tl_if_novalue:nF \l__flowfram_parindent_tl
   {
     \flowfram_frame_set_tl:nnnV
      { dynamic } { parindent } { #1 } \l__flowfram_parindent_tl
   }
  \tl_if_empty:NF \l__flowfram_valign_tl
   {
     \flowfram_frame_set_tl:nnnV
        { dynamic } { valign } { #1 }
       \l__flowfram_valign_tl
   }
}
\NewDocumentCommand \dynamicsetpagelist { m m }
 {
  \flowfram_set_frame_pagelist:nne { dynamic } { #1 } { #2 }
 }
\NewDocumentCommand \dynamicsetexclusion { m m }
{
  \flowfram_set_frame_excludelist:nne { dynamic } { #1 } { #2 }
 }
\NewDocumentCommand \dynamicaddexclusion { m m }
 {
  \flowfram_concat_frame_excludelist:nne
   { dynamic } { #1 } { #2 }
 }
\NewDocumentCommand \dfswapoddeven { s m }
{
   \IfValueTF { #1 }
    {
      \exp_args:Ne \clist_map_inline:nn { #2 }
       {
         \__flowfram_get_dynamic_id:n { ##1 }
         \__flowfram_dynamic_swap_coords:n { \l__flowfram_id_int }
       }
    }
    {
       \__flowfram_map_idns:enn { #2 } { dynamic }
        {
          \__flowfram_dynamic_swap_coords:n { \l__flowfram_id_int }
        }
    }
}
\cs_new:Nn \__flowfram_dynamic_swap_coords:n
{
  \flowfram_frame_swap_dim:nnnn
    { dynamic } { posx } { evenx } { #1 }
  \flowfram_frame_swap_dim:nnnn
    { dynamic } { posy } { eveny } { #1 }
}
\NewDocumentEnvironment { dynamiccontents } { o m +b }
 {
   \IfValueT { #1 }
    {
      \__flowfram_set_dynamic_by_idn:nn { #2 } { #1 }
    }
   \setdynamiccontents { #2 } { #3 }
 }
 { }
\NewDocumentEnvironment { dynamiccontents* } { o m +b }
 {
   \__flowfram_get_dynamic_id:n { #2 }
   \IfValueT { #1 }
    {
      \__flowfram_set_dynamic_by_idn:nn
        { \l__flowfram_id_int } { #1 }
    }
   \setdynamiccontents
        { \l__flowfram_id_int } { #3 }
 }
 { }
\NewDocumentCommand \setdynamiccontents { s o m +m }
 {
  \group_begin:
   \IfBooleanTF { #1 }
    {
      \__flowfram_get_dynamic_id:n { #3 }
      \IfValueT { #2 }
       {
         \__flowfram_set_dynamic_by_idn:nn
           { \l__flowfram_id_int } { #2 }
       }
      \RenewDocumentCommand \continueonframe { o m }
       {
         \__flowfram_dynamic_continue_idl:nn { ##1 } { ##2 }
       }
      \__flowfram_set_dynamic_contents_from_body:nn
       { \l__flowfram_id_int } { #4 }
    }
    {
      \IfValueT { #2 }
       {
         \__flowfram_set_dynamic_by_idn:nn { #3 } { #2 }
       }
      \RenewDocumentCommand \continueonframe { O{} m }
       {
         \__flowfram_dynamic_continue_idn:nn { ##1 } { ##2 }
       }
      \__flowfram_set_dynamic_contents_from_body:nn
       { #3 } { #4 }
    }
  \group_end:
 }
\cs_new:Nn \__flowfram_dynamic_continue_idn:nn
 {
   \IfValueTF { #1 }
    {
      \__flowfram_append_dynamic_contents_idn:nn
       { \l__flowfram_current_dynamic_int }
       { \ffcontinuedtextlayout { #1 } }
    }
    {
      \exp_args:Nne
      \__flowfram_append_dynamic_contents_idn:nn
       { \l__flowfram_current_dynamic_int }
       {
         \exp_not:N \ffcontinuedtextlayout
          {
            \exp_not:N \flowfram_continue_on_dynamic_frame_idn:nn
              { \int_use:N \l__flowfram_current_dynamic_int }
              { \int_eval:n { #2 } }
          }
       }
    }
   \exp_args:NV
   \__flowfram_set_post_continued:nnn
      \l__flowfram_current_dynamic_int
      { \l__flowfram_current_dynamic_int }
      { \c_flowfram_frame_type_dynamic_int }
   \int_set:Nn \l__flowfram_current_dynamic_int { #2 }
   \exp_after:wN
   \__flowfram_set_dynamic_contents_from_body:w
      \l__flowfram_postcontinued_tl
 }
\cs_new:Nn \__flowfram_dynamic_continue_idl:nn
 {
   \IfValueTF { #1 }
    {
      \__flowfram_append_dynamic_contents_idn:nn
       { \l__flowfram_current_dynamic_int }
       { \ffcontinuedtextlayout { #1 } }
    }
    {
      \exp_args:Nne
      \__flowfram_append_dynamic_contents_idn:nn
       { \l__flowfram_current_dynamic_int }
       {
         \exp_not:N \ffcontinuedtextlayout
          {
            \exp_not:N \flowfram_continue_on_dynamic_frame_idl:nn
              { \int_use:N \l__flowfram_current_dynamic_int }
              { #2 }
          }
       }
    }
   \exp_args:NV
   \__flowfram_set_post_continued:nnn
      \l__flowfram_current_dynamic_int
      { \l__flowfram_current_dynamic_int }
      { \c_flowfram_frame_type_dynamic_int }
   \__flowfram_get_dynamic_id:n { #2 }
   \int_set_eq:Nn
    \l__flowfram_current_dynamic_int
    \l__flowfram_id_int
   \exp_after:wN
   \__flowfram_set_dynamic_contents_from_body:w
      \l__flowfram_postcontinued_tl
 }
\cs_new:Nn \flowfram_continue_on_dynamic_frame_idn:nn
 {
   \ffdefaultdynamiccontinuetext { #1 } { #2 }
 }
\cs_new:Nn \flowfram_continue_on_dynamic_frame_idl:nn
 {
   \__flowfram_get_dynamic_id:n { #2 }
   \ffdefaultdynamiccontinuetext { #1 } {  \l__flowfram_id_int }
 }
\cs_new:Nn \__flowfram_set_dynamic_contents_from_body:nn
 {
   \int_set:Nn \l__flowfram_current_dynamic_int { #1 }
   \__flowfram_set_dynamic_contents_from_body:w
    #2 \continueonframe \q_nil \q_stop
 }
\cs_new:Npn \__flowfram_set_dynamic_contents_from_body:w
   #1 \continueonframe #2 \q_stop
 {
   \__flowfram_set_dynamic_contents:nn
      { \l__flowfram_current_dynamic_int }
      { #1 }
   \tl_if_head_eq_meaning:nNTF { #2 } [
    {
      \__flowfram_dynamic_continued_opt_conts:wn #2 \q_stop
    }
    {
     \quark_if_nil:nF { #2 }
      {
         \__flowfram_dynamic_continued_conts:wn
         #2
        \q_stop
      }
    }
 }
\cs_new:Npn \__flowfram_dynamic_continued_opt_conts:wn
   [ #1 ] #2 #3 \q_stop
 {
   \continueonframe [ #1 ] { #2 }
   #3 \q_stop
 }
\cs_new:Npn \__flowfram_dynamic_continued_conts:wn
   #1 #2 \q_stop
 {
   \continueonframe { #1 }
   #2 \q_stop
 }
\cs_new:Nn \__flowfram_set_dynamic_contents:nn
 {
   \flowfram_frame_set_tl:nnnn
      { dynamic } { content } { #1 } { #2 }
 }
\NewDocumentCommand \appenddynamiccontents { s o m +m }
 {
  \IfBooleanTF { #1 }
   {
      \__flowfram_get_dynamic_id:n { #3 }
      \IfValueT { #2 }
       {
         \__flowfram_set_dynamic_by_idn:nn
           { \l__flowfram_id_int } { #2 }
       }
     \__flowfram_append_dynamic_contents_idn:nn { \l__flowfram_id_int } { #4 }
   }
   {
      \IfValueT { #2 }
       {
         \__flowfram_set_dynamic_by_idn:nn { #3 } { #2 }
       }
     \__flowfram_append_dynamic_contents_idn:nn { #3 } { #4 }
   }
 }
\cs_new:Nn \__flowfram_append_dynamic_contents_idl:nn
 {
   \__flowfram_get_dynamic_id:n { #1 }
   \__flowfram_append_dynamic_contents_idn:nn
     { \l__flowfram_id_int } { #2 }
 }
\cs_new:Nn \__flowfram_append_dynamic_contents_idn:nn
 {
   \flowfram_frame_put_right_tl:nnnn
     { dynamic } { content } { #1 } { #2 }
 }
\NewDocumentCommand \computeleftedgeodd { m }
 {
   \dim_set:Nn #1 { -1in - \hoffset - \oddsidemargin }
 }
\NewDocumentCommand \computeleftedgeeven { m }
 {
   \dim_set:Nn #1 { -1in - \hoffset - \evensidemargin }
 }
\NewDocumentCommand \computetopedge { m }
 {
   \dim_set:Nn #1
    {
      \typeblockheight
    + \typeblockoffsety
    + 1in
    }
 }
\NewDocumentCommand \computebottomedge { m }
 {
   \computetopedge { #1 }
   \addtolength { #1 } { - \paperheight }
 }
\NewDocumentCommand \computerightedgeodd { m }
 {
   \computeleftedgeodd { #1 }
   \addtolength { #1 } { \paperwidth }
 }
\NewDocumentCommand \computerightedgeeven { m }
 {
   \computeleftedgeeven { #1 }
   \addtolength { #1 } { \paperwidth }
 }
\newlength\ffareawidth
\newlength\ffareaheight
\newlength\ffareax
\newlength\ffareay
\newlength\ffareaevenx
\newlength\ffareaeveny
\NewDocumentCommand \computeflowframearea { s m }
{
  \setlength \ffareax { \paperwidth }
  \setlength \ffareay { \paperheight }
  \dim_zero:N \l__flowfram_x_dim
  \dim_zero:N \l__flowfram_y_dim
  \IfBooleanTF { #1 }
   {
      \exp_args:Ne \clist_map_inline:nn { #1 }
       {
         \__flowfram_if_flow_label_exists:nTF { ##1 }
          {
            \__flowfram_compute_flow_area_by_idn:n { \l__flowfram_id_int }
          }
          {
            \__flowfram_error:eee { label-undefined } { ##1 } { flow }
          }
       }
   }
   {
      \__flowfram_map_idns:enn { #2 } { flow }
       {
          \__flowfram_compute_flow_area_by_idn:n { \l__flowfram_id_int }
       }
   }
  \dim_set:Nn \ffareawidth
   {
     \l__flowfram_x_dim -\ffareax
   }
  \dim_set:Nn \ffareaheight
   {
     \l__flowfram_y_dim - \ffareay
   }
}
\cs_new:Nn \__flowfram_compute_flow_area_by_idn:n
 {
   \dim_compare:nNnT
      { \ffareax } > { \flowframex { #1 } }
    {
      \dim_set:Nn \ffareax { \flowframex { #1 } }
    }
   \dim_compare:nNnT
      { \ffareay } > { \flowframey { #1 } }
    {
      \dim_set:Nn \ffareay { \flowframey { #1 } }
    }
   \dim_set:Nn \l__flowfram_offset_dim
     {
       \flowframex { #1 }
       + \flowframewidth { #1 }
     }
   \dim_compare:nNnT
      { \l__flowfram_x_dim } < { \l__flowfram_offset_dim }
     {
      \dim_set_eq:NN \l__flowfram_x_dim \l__flowfram_offset_dim
     }
   \dim_set:Nn \l__flowfram_offset_dim
     {
       \flowframey { #1 }
       + \flowframeheight { #1 }
     }
   \dim_compare:nNnT
      { \l__flowfram_y_dim } < { \l__flowfram_offset_dim }
     {
       \dim_set_eq:NN \l__flowfram_y_dim \l__flowfram_offset_dim
     }
 }
\cs_new:Nn \__flowfram_swap_dim:NN
 {
   \dim_set_eq:NN \l__flowfram_tmpa_dim #1
   \dim_set_eq:NN #1 #2
   \dim_set_eq:NN #2 \l__flowfram_tmpa_dim
 }
\cs_new:Nn \__flowfram_get_frame_bounds_by_typeid:nn
 {
   \int_case:nnF { #1 }
    {
      { \c_flowfram_frame_type_flow_int }
       {
         \__flowfram_get_flow_bounds:n { #2 }
       }
      { \c_flowfram_frame_type_static_int }
       {
         \__flowfram_get_static_bounds:n { #2 }
       }
      { \c_flowfram_frame_type_dynamic_int }
       {
         \__flowfram_get_dynamic_bounds:n { #2 }
       }
    }
    {
       \msg_error:nne { flowfram } { invalid-frame-typeid }
         { \int_eval:n { #1 } }
    }
 }
\cs_new:Nn \__flowfram_get_frame_bounds_by_type:nn
 {
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareax { #1 } { posx } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareay { #1 } { posy } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareaevenx { #1 } { evenx } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareaeveny { #1 } { eveny } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareawidth { #1 } { width } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareaheight { #1 } { height } { #2 }
 }
\cs_new:Nn \__flowfram_get_frame_even_bounds_by_typeid:nn
 {
   \int_case:nnF { #1 }
    {
      { \c_flowfram_frame_type_flow_int }
       {
         \__flowfram_get_flow_even_bounds:n { #2 }
       }
      { \c_flowfram_frame_type_static_int }
       {
         \__flowfram_get_static_even_bounds:n { #2 }
       }
      { \c_flowfram_frame_type_dynamic_int }
       {
         \__flowfram_get_dynamic_even_bounds:n { #2 }
       }
    }
    {
       \msg_error:nne { flowfram } { invalid-frame-typeid }
         { \int_eval:n { #1 } }
    }
 }
\cs_new:Nn \__flowfram_get_frame_even_bounds_by_type:nn
 {
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareax { #1 } { evenx } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareay { #1 } { eveny } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareawidth { #1 } { width } { #2 }
  \flowfram_set_dim_to_frame_dim:Nnnn
    \ffareaheight { #1 } { height } { #2 }
 }
\NewDocumentCommand \getstaticbounds { s m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_get_static_id:n { #2 }
      \__flowfram_get_static_bounds:n { \l__flowfram_id_int }
    }
    {
      \__flowfram_get_static_bounds:n { #2 }
    }
 }
\cs_new:Nn \__flowfram_get_static_bounds:n
 {
   \__flowfram_get_frame_bounds_by_type:nn { static } { #1 }
 }
\NewDocumentCommand \getstaticevenbounds { s m }
 {
  \IfBooleanTF { #1 }
    {
      \__flowfram_get_static_id:n { #2 }
      \__flowfram_get_static_even_bounds:n { \l__flowfram_id_int }
    }
    {
      \__flowfram_get_static_even_bounds:n { #2 }
    }
 }
\cs_new:Nn \__flowfram_get_static_even_bounds:n
 {
   \__flowfram_get_frame_even_bounds_by_type:nn { static } { #1 }
 }
\NewDocumentCommand \getflowbounds { s m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_get_flow_id:e { #2 }
      \__flowfram_get_flow_bounds:n { \l__flowfram_id_int }
    }
    {
      \__flowfram_get_flow_bounds:n { #2 }
    }
 }
\cs_new:Nn \__flowfram_get_flow_bounds:n
 {
   \__flowfram_get_frame_bounds_by_type:nn { flow } { #1 }
 }
\NewDocumentCommand \getflowevenbounds { s m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_get_flow_id:e { #1 }
      \__flowfram_get_flow_even_bounds:n { \l__flowfram_id_int }
    }
    {
      \__flowfram_get_flow_even_bounds:n { #2 }
    }
 }
\cs_new:Nn \__flowfram_get_flow_even_bounds:n
 {
   \__flowfram_get_frame_even_bounds_by_type:nn { flow } { #1 }
 }
\NewDocumentCommand \getdynamicbounds { s m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_get_dynamic_id:n { #1 }
      \__flowfram_get_dynamic_bounds:n { \l__flowfram_id_int }
    }
    {
      \__flowfram_get_dynamic_bounds:n { #2 }
    }
 }
\cs_new:Nn \__flowfram_get_dynamic_bounds:n
 {
   \__flowfram_get_frame_bounds_by_type:nn { dynamic } { #1 }
 }
\NewDocumentCommand \getdynamicevenbounds { s m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_get_dynamic_id:n { #1 }
      \__flowfram_get_dynamic_even_bounds:n { \l__flowfram_id_int }
    }
    {
      \__flowfram_get_dynamic_even_bounds:n { #2 }
    }
 }
\cs_new:Nn \__flowfram_get_dynamic_even_bounds:n
 {
   \__flowfram_get_frame_even_bounds_by_type:nn { dynamic } { #1 }
 }
\newif\ifFLFabove
\newif\ifFLFbelow
\newif\ifFLFleft
\newif\ifFLFright
\NewDocumentCommand \checkifframeabove { s m m m m }
{
  \IfBooleanTF { #1 }
   {
     \__flowframe_check_if_frame_above_by_idl:nnnn
       { #2 } { #3 } { #4 } { #5 }
   }
   {
     \__flowframe_check_if_frame_above_by_idn:nnnn
       { #2 } { #3 } { #4 } { #5 }
   }
}
\cs_new:Nn \__flowframe_check_if_frame_above_by_idl:nnnn
 {
  \int_if_odd:nTF { \c@page }
   {
     \__flowframe_check_odd_if_frame_above_by_idl:nnnn
       { #1 } { #2 } { #3 } { #4 }
   }
   {
     \__flowframe_check_even_if_frame_above_by_idl:nnnn
       { #1 } { #2 } { #3 } { #4 }
   }
 }
\cs_new:Nn \__flowframe_check_if_frame_above_by_idn:nnnn
 {
   \__flowframe_check_if_frame_above_by_idn:nnnnn
     { \c@page } { #1 } { #2 } { #3 } { #4 }
 }
\cs_new:Nn \__flowframe_check_if_frame_above_by_idn:nnnnn
 {
   \int_if_odd:nTF { #1 }
    {
      \__flowframe_check_odd_if_frame_above_by_idn:nnnn
         { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_even_if_frame_above_by_idn:nnnn
         { #2 } { #3 } { #4 } { #5 }
    }
 }
\NewDocumentCommand \oddcheckifframeabove { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_odd_if_frame_above_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_odd_if_frame_above_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_odd_if_frame_above_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } > { \ffareay }
    {
     \FLFabovetrue
    }
    {
     \FLFabovefalse
    }
 }
\cs_new:Nn \__flowframe_check_odd_if_frame_above_by_idn:nnnn
 {
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { #2 }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { #4 }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } > { \ffareay }
    {
     \FLFabovetrue
    }
    {
     \FLFabovefalse
    }
 }
\NewDocumentCommand \checkifframebelow { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_if_frame_below_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_if_frame_below_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_if_frame_below_by_idl:nnnn
 {
   \int_if_odd { \c@page }
    {
       \__flowframe_check_odd_if_frame_below_by_idl:nnnn
        { #1 } { #2 } { #3 } { #4 }
    }
    {
       \__flowframe_check_even_if_frame_below_by_idl:nnnn
        { #1 } { #2 } { #3 } { #4 }
    }
 }
\cs_new:Nn \__flowframe_check_if_frame_below_by_idn:nnnn
 {
   \__flowframe_check_if_frame_below_by_idn:nnnnn
     { \c@page } { #1 } { #2 } { #3 } { #4 }
 }
\cs_new:Nn \__flowframe_check_if_frame_below_by_idn:nnnnn
 {
   \int_if_odd:nTF { #1 }
    {
      \__flowframe_check_odd_if_frame_below_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
       \__flowframe_check_even_if_frame_below_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\NewDocumentCommand \oddcheckifframebelow { s m m m m }
{
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_odd_if_frame_below_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_odd_if_frame_below_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
}
\cs_new:Nn \__flowframe_check_odd_if_frame_below_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim} < { \ffareay }
    {
      \FLFbelowtrue
    }
    {
      \FLFbelowfalse
    }
 }
\cs_new:Nn \__flowframe_check_odd_if_frame_below_by_idn:nnnn
 {
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { #2 }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { #4 }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } < { \ffareay }
    {
      \FLFbelowtrue
    }
    {
      \FLFbelowfalse
    }
 }
\NewDocumentCommand \checkifframeleft { s m m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_if_frame_left_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_if_frame_left_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_if_frame_left_by_idl:nnnn
 {
  \int_if_odd:nTF { \c@page }
   {
     \__flowframe_check_odd_if_frame_left_by_idl:nnnn
       { #1 } { #2 } { #3 } { #4 }
   }
   {
     \__flowframe_check_even_if_frame_left_by_idl:nnnn
       { #1 } { #2 } { #3 } { #4 }
   }
 }
\cs_new:Nn \__flowframe_check_if_frame_left_by_idn:nnnn
 {
   \__flowframe_check_if_frame_left_by_idn:nnnnn
    { \c@page } { #1 } { #2 } { #3 } { #4 }
 }
\cs_new:Nn \__flowframe_check_if_frame_left_by_idn:nnnnn
 {
   \int_if_odd:nTF { #1 }
    {
      \__flowframe_check_odd_if_frame_left_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_even_if_frame_left_by_idn:nnnn
         { #2 } { #3 } { #4 } { #5 }
    }
 }
\NewDocumentCommand \oddcheckifframeleft { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_odd_if_frame_left_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_odd_if_frame_left_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_odd_if_frame_left_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } < { \ffareax }
    {
      \FLFlefttrue
    }
    {
      \FLFleftfalse
    }
 }
\cs_new:Nn \__flowframe_check_odd_if_frame_left_by_idn:nnnn
 {
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { #2 }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { #4 }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } < { \ffareax }
    {
      \FLFlefttrue
    }
    {
      \FLFleftfalse
    }
}
\NewDocumentCommand \checkifframeright { s m m m m }
 {
  \IfBooleanTF { #1 }
   {
     \__flowframe_check_if_frame_right_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
   }
   {
     \__flowframe_check_if_frame_right_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
   }
 }
\cs_new:Nn \__flowframe_check_if_frame_right_by_idl:nnnn
 {
   \int_if_odd:nTF { \c@page }
    {
      \__flowframe_check_odd_if_frame_right_by_idl:nnnn
       { #1 } { #2 } { #3 } { #4 }
    }
    {
      \__flowframe_check_even_if_frame_right_by_idl:nnnn
       { #1 } { #2 } { #3 } { #4 }
    }
 }
\cs_new:Nn \__flowframe_check_if_frame_right_by_idn:nnnn
 {
   \__flowframe_check_if_frame_right_by_idn:nnnnn
    { \c@page } { #1 } { #2 } { #3 } { #4 }
 }
\cs_new:Nn \__flowframe_check_if_frame_right_by_idn:nnnnn
 {
   \int_if_odd:nTF { #1 }
    {
      \__flowframe_check_odd_if_frame_right_by_idn:nnnn
       { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_even_if_frame_right_by_idn:nnnn
       { #2 } { #3 } { #4 } { #5 }
    }
 }
\NewDocumentCommand \oddcheckifframeright { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_odd_if_frame_right_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_odd_if_frame_right_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_odd_if_frame_right_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } > { \ffareax }
    {
      \FLFrighttrue
    }
    {
      \FLFrightfalse
    }
 }
\cs_new:Nn \__flowframe_check_odd_if_frame_right_by_idn:nnnn
 {
   \__flowfram_get_frame_bounds_by_type:nn { #1 } { #2 }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_bounds_by_type:nn { #3 } { #4 }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } > { \ffareax }
    {
      \FLFrighttrue
    }
    {
      \FLFrightfalse
    }
 }
\NewDocumentCommand \evencheckifframeabove { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_even_if_frame_above_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_even_if_frame_above_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_above_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } > { \ffareay }
    {
      \FLFabovetrue
    }
    {
      \FLFabovefalse
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_above_by_idn:nnnn
 {
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { #2 }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { #4 }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } > { \ffareay }
    {
      \FLFabovetrue
    }
    {
      \FLFabovefalse
    }
 }
\NewDocumentCommand \evencheckifframebelow { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_even_if_frame_below_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_even_if_frame_below_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_below_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } < { \ffareay }
    {
      \FLFbelowtrue
    }
    {
      \FLFbelowfalse
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_below_by_idn:nnnn
 {
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { #2 }
   \dim_add:Nn \ffareay { \ffareaheight }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareay
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { #4 }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } < { \ffareay }
    {
      \FLFbelowtrue
    }
    {
      \FLFbelowfalse
    }
 }
\NewDocumentCommand \evencheckifframeleft { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_even_if_frame_left_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_even_if_frame_left_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_left_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } < { \ffareax }
    {
      \FLFlefttrue
    }
    {
      \FLFleftfalse
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_left_by_idn:nnnn
 {
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { #2 }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { #4 }
   \dim_compare:nNnTF { \l__flowfram_tmpa_dim } < { \ffareax }
    {
      \FLFlefttrue
    }
    {
      \FLFleftfalse
    }
 }
\NewDocumentCommand \evencheckifframeright { s m m m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowframe_check_even_if_frame_right_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowframe_check_even_if_frame_right_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_right_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { \l__flowfram_id_int }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { \l__flowfram_id_int }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_compare:nNnTF {\l__flowfram_tmpa_dim } > { \ffareax }
    {
      \FLFrighttrue
    }
    {
      \FLFrightfalse
    }
 }
\cs_new:Nn \__flowframe_check_even_if_frame_right_by_idn:nnnn
 {
   \__flowfram_get_frame_even_bounds_by_type:nn { #1 } { #2 }
   \dim_set_eq:NN \l__flowfram_tmpa_dim \ffareax
   \__flowfram_get_frame_even_bounds_by_type:nn { #3 } { #4 }
   \dim_add:Nn \ffareax { \ffareawidth }
   \dim_compare:nNnTF {\l__flowfram_tmpa_dim } > { \ffareax }
    {
      \FLFrighttrue
    }
    {
      \FLFrightfalse
    }
 }
\newcommand*{\FFaboveleft}{above ~ left}
\newcommand*{\FFaboveright}{above ~ right}
\newcommand*{\FFbelowleft}{below ~ left}
\newcommand*{\FFbelowright}{below ~ right}
\newcommand*{\FFleft}{on ~ the ~ left}
\newcommand*{\FFright}{on ~ the ~ right}
\newcommand*{\FFabove}{above}
\newcommand*{\FFbelow}{below}
\newcommand*{\FFoverlap}{overlap}
\NewDocumentCommand \relativeframelocation { s m m m m }
 {
  \IfBooleanTF { #1 }
    {
      \__flowfram_relative_frame_location_by_idl:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
    {
      \__flowfram_relative_frame_location_by_idn:nnnn
        { #2 } { #3 } { #4 } { #5 }
    }
 }
\cs_new:Nn \__flowfram_relative_frame_location_by_idl:nnnn
 {
   \__flowfram_get_frame_id:nn { #1 } { #2 }
   \int_set_eq:NN \l__flowfram_tmpa_int \l__flowfram_id_int
   \__flowfram_get_frame_id:nn { #3 } { #4 }
   \int_set_eq:NN \l__flowfram_tmpb_int \l__flowfram_id_int
   \__flowfram_relative_frame_location_by_idn:nVnV
     { #1 } \l__flowfram_tmpa_int
     { #3 } \l__flowfram_tmpb_int
 }
\cs_new:Nn \__flowfram_relative_frame_location_by_idn:nnnn
 {
   \__flowfram_relative_frame_location_by_idn:nnnnn
     { \c@page } { #1 } { #2 } { #3 } { #4 }
 }
\cs_generate_variant:Nn \__flowfram_relative_frame_location_by_idn:nnnn
  { nVnV }
\cs_new:Nn \__flowfram_relative_frame_location_by_idn:nnnnn
 {
  \__flowframe_check_if_frame_above_by_idn:nnnnn
    { #1 } { #2 } { #3 } { #4 } { #5 }
  \__flowframe_check_if_frame_below_by_idn:nnnnn
    { #1 } { #2 } { #3 } { #4 } { #5 }
  \__flowframe_check_if_frame_left_by_idn:nnnnn
    { #1 } { #2 } { #3 } { #4 } { #5 }
  \__flowframe_check_if_frame_right_by_idn:nnnnn
    { #1 } { #2 } { #3 } { #4 } { #5 }
  \ifFLFabove
    \ifFLFleft
      \FFaboveleft
    \else
      \ifFLFright
        \FFaboveright
      \else
         \FFabove
      \fi
    \fi
  \else
    \ifFLFbelow
      \ifFLFleft
        \FFbelowleft
      \else
        \ifFLFright
          \FFbelowright
        \else
           \FFbelow
        \fi
      \fi
    \else
      \ifFLFleft
        \FFleft
      \else
        \ifFLFright
          \FFright
        \else
           \FFoverlap
        \fi
      \fi
    \fi
  \fi
 }
\NewDocumentCommand \SaveRelativeFrameLocation { s m m m m m }
 {
  \IfBooleanTF { #1 }
    {
      \__flowfram_get_frame_id:nn { #3 } { #4 }
      \int_set_eq:NN \l__flowfram_tmpa_int \l__flowfram_id_int
      \__flowfram_get_frame_id:nn { #5 } { #6 }
      \int_set_eq:NN \l__flowfram_tmpb_int \l__flowfram_id_int
    }
    {
      \int_set:Nn \l__flowfram_tmpa_int { #4 }
      \int_set:Nn \l__flowfram_tmpb_int { #6 }
    }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_x_dim
      { #3 } { posx } { \l__flowfram_tmpa_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_evenx_dim
      { #3 } { evenx } { \l__flowfram_tmpa_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_y_dim
      { #3 } { posy } { \l__flowfram_tmpa_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_eveny_dim
      { #3 } { eveny } { \l__flowfram_tmpa_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_width_dim
      { #3 } { width } { \l__flowfram_tmpa_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_height_dim
      { #3 } { height } { \l__flowfram_tmpa_int }
   \tl_set:Ne \l__flowfram_x_tl
      { \dim_use:N \l__flowfram_x_dim }
   \tl_set:Ne \l__flowfram_y_tl
      { \dim_use:N \l__flowfram_y_dim }
   \tl_set:Ne \l__flowfram_evenx_tl
      { \dim_use:N \l__flowfram_evenx_dim }
   \tl_set:Ne \l__flowfram_eveny_tl
      { \dim_use:N \l__flowfram_eveny_dim }
   \tl_set:Ne \l__flowfram_width_tl
      { \dim_use:N \l__flowfram_width_dim }
   \tl_set:Ne \l__flowfram_height_tl
      { \dim_use:N \l__flowfram_height_dim }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_x_dim
      { #5 } { posx } { \l__flowfram_tmpb_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_evenx_dim
      { #5 } { evenx } { \l__flowfram_tmpb_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_y_dim
      { #5 } { posy } { \l__flowfram_tmpb_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_eveny_dim
      { #5 } { eveny } { \l__flowfram_tmpb_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_width_dim
      { #5 } { width } { \l__flowfram_tmpb_int }
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_height_dim
      { #5 } { height } { \l__flowfram_tmpb_int }
   \protected@write \@auxout
    { \let \flowfram@thepagenumber \relax }
    {
      \string \@flowfram@saverelativeloc
       { #2 }
       { \flowfram@thepagenumber }
       {
          { \l__flowfram_x_tl }
          { \l__flowfram_y_tl }
          { \l__flowfram_evenx_tl }
          { \l__flowfram_eveny_tl }
          { \l__flowfram_width_tl }
          { \l__flowfram_height_tl }
       }
       {
          { \dim_use:N \l__flowfram_x_dim }
          { \dim_use:N \l__flowfram_y_dim }
          { \dim_use:N \l__flowfram_evenx_dim }
          { \dim_use:N \l__flowfram_eveny_dim }
          { \dim_use:N \l__flowfram_width_dim }
          { \dim_use:N \l__flowfram_height_dim }
       }
    }
   \tl_if_exist:cF { g__flowfram_saved_rel_loc_ #2 _tl }
    {
      \@flowframe@warn@rerun
    }
 }
\cs_new:Nn \__flowfram_fetch_odd_dimensions:nnnnnn
 {
   \dim_set:Nn \l__flowfram_x_dim { #1 }
   \dim_set:Nn \l__flowfram_y_dim { #2 }
   \dim_set:Nn \l__flowfram_width_dim { #5 }
   \dim_set:Nn \l__flowfram_height_dim { #6 }
 }
\cs_new:Nn \__flowfram_fetch_even_dimensions:nnnnnn
 {
   \dim_set:Nn \l__flowfram_x_dim { #3 }
   \dim_set:Nn \l__flowfram_y_dim { #4 }
   \dim_set:Nn \l__flowfram_width_dim { #5 }
   \dim_set:Nn \l__flowfram_height_dim { #6 }
 }
\newcommand\@flowfram@saverelativeloc [ 4 ]
 {
   \tl_if_exist:cTF { g__flowfram_saved_rel_loc_ #1 _tl }
    {
      \msg_warning:nnn { flowfram } { relloc-label-already-defined }
         { #1 }
    }
    {
      \tl_const:cn { c__flowfram_saved_data_rel_loc_ #1 _tl }
        { { #2 } { #3 } { #4 } }
      \tl_new:c { g__flowfram_saved_rel_loc_ #1 _tl }
      \int_if_odd:nTF { #2 }
       {
         \__flowfram_fetch_odd_dimensions:nnnnnn #3
       }
       {
         \__flowfram_fetch_even_dimensions:nnnnnn #3
       }
      \dim_set_eq:NN \ffareax \l__flowfram_x_dim
      \dim_set_eq:NN \ffareay \l__flowfram_y_dim
      \dim_set_eq:NN \ffareawidth \l__flowfram_width_dim
      \dim_set_eq:NN \ffareaheight \l__flowfram_height_dim
      \int_if_odd:nTF { #2 }
       {
         \__flowfram_fetch_odd_dimensions:nnnnnn #4
       }
       {
         \__flowfram_fetch_even_dimensions:nnnnnn #4
       }
      \FLFabovefalse
      \FLFbelowfalse
      \FLFleftfalse
      \FLFrightfalse
      \dim_compare:nNnTF
         { \ffareax } > { \l__flowfram_x_dim + \l__flowfram_width_dim }
       {
         \FLFrighttrue
       }
       {
         \dim_compare:nNnT
            { \ffareax + \ffareawidth } < { \l__flowfram_x_dim }
          {
            \FLFlefttrue
          }
       }
      \dim_compare:nNnTF
         { \ffareay } > { \l__flowfram_y_dim + \l__flowfram_height_dim }
       {
         \FLFabovetrue
       }
       {
         \dim_compare:nNnT
            { \ffareay + \ffareaheight } < { \l__flowfram_y_dim }
          {
            \FLFbelowtrue
          }
       }
      \ifFLFabove
        \ifFLFleft
          \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
           { \FFaboveleft }
        \else
          \ifFLFright
             \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
             { \FFaboveright }
          \else
             \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
              { \FFabove }
          \fi
        \fi
      \else
        \ifFLFbelow
          \ifFLFleft
            \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
             { \FFbelowleft }
          \else
            \ifFLFright
              \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
               { \FFbelowright }
            \else
               \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
                 { \FFbelow }
            \fi
          \fi
        \else
          \ifFLFleft
            \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
             { \FFleft }
          \else
            \ifFLFright
              \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
                { \FFright }
            \else
              \tl_gset:cn { g__flowfram_saved_rel_loc_ #1 _tl }
                { \FFoverlap }
            \fi
          \fi
        \fi
      \fi
      \bool_new:c { g__flowfram_saved_rel_loc_ #1 _above_bool }
      \bool_new:c { g__flowfram_saved_rel_loc_ #1 _below_bool }
      \bool_new:c { g__flowfram_saved_rel_loc_ #1 _left_bool }
      \bool_new:c { g__flowfram_saved_rel_loc_ #1 _right_bool }
      \ifFLFabove
        \bool_gset_true:c { g__flowfram_saved_rel_loc_ #1 _above_bool }
      \fi
      \ifFLFbelow
        \bool_gset_true:c { g__flowfram_saved_rel_loc_ #1 _below_bool }
      \fi
      \ifFLFleft
        \bool_gset_true:c { g__flowfram_saved_rel_loc_ #1 _left_bool }
      \fi
      \ifFLFright
        \bool_gset_true:c { g__flowfram_saved_rel_loc_ #1 _right_bool }
      \fi
    }
 }
\AddToHook { begindocument / end }
 {
   \cs_gset_eq:NN \@flowfram@saverelativeloc \@flowfram@checkrelativeloc
 }
\newcommand\@flowfram@checkrelativeloc [ 4 ]
 {
   \tl_if_exist:cT { c__flowfram_saved_data_rel_loc_ #1 _tl }
    {
      \tl_if_eq:cnF { c__flowfram_saved_data_rel_loc_ #1 _tl }
        { { #2 } { #3 } { #4 } }
       {
         \@flowframe@warn@rerun
       }
    }
 }
\newcommand \@flowframe@warn@rerun
 {
   \AtEndDocument
    {
       \msg_warning:nn { flowfram} { data-changed-rerun }
    }
   \global \let \@flowframe@warn@rerun \relax
 }
\NewDocumentCommand \RefSavedRelativeLocation { m }
 {
   \tl_if_exist:cTF { g__flowfram_saved_rel_loc_ #1 _tl }
    {
      \tl_use:c { g__flowfram_saved_rel_loc_ #1 _tl }
    }
    {
      ??
      \msg_warning:nnn { flowfram } { relloc-label-not-defined }
         { #1 }
    }
 }
\NewDocumentCommand \IfSavedRelativeLocationEq { m m m m }
 {
   \tl_if_exist:cTF { g__flowfram_saved_rel_loc_ #1 _tl }
    {
      \tl_if_eq:cnTF { g__flowfram_saved_rel_loc_ #1 _tl } { #2 }
       { #3 } { #4 }
    }
    { #4 }
 }
\newcommand \IfSavedRelativeLocationAbove [ 3 ]
 {
   \bool_if_exist:cTF { g__flowfram_saved_rel_loc_ #1 _above_bool }
    {
      \bool_if:cTF { g__flowfram_saved_rel_loc_ #1 _above_bool }
       { #2 } { #3 }
    }
    { #3 }
 }
\newcommand \IfSavedRelativeLocationBelow [ 3 ]
 {
   \bool_if_exist:cTF { g__flowfram_saved_rel_loc_ #1 _below_bool }
    {
      \bool_if:cTF { g__flowfram_saved_rel_loc_ #1 _below_bool }
       { #2 } { #3 }
    }
    { #3 }
 }
\newcommand \IfSavedRelativeLocationLeft [ 3 ]
 {
   \bool_if_exist:cTF { g__flowfram_saved_rel_loc_ #1 _left_bool }
    {
      \bool_if:cTF { g__flowfram_saved_rel_loc_ #1 _left_bool }
       { #2 } { #3 }
    }
    { #3 }
 }
\newcommand \IfSavedRelativeLocationRight [ 3 ]
 {
   \bool_if_exist:cTF { g__flowfram_saved_rel_loc_ #1 _right_bool }
    {
      \bool_if:cTF { g__flowfram_saved_rel_loc_ #1 _right_bool }
       { #2 } { #3 }
    }
    { #3 }
 }
\NewDocumentCommand \reldynamicloc { s m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_relative_frame_location_by_idl:nnnn
        { dynamic } { #2 } { dynamic } { #3 }
    }
    {
      \__flowfram_relative_frame_location_by_idn:nnnn
        { dynamic } { #2 } { dynamic } { #3 }
    }
 }
\NewDocumentCommand \relstaticloc { s m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_relative_frame_location_by_idl:nnnn
        { static } { #2 } { static } { #3 }
    }
    {
      \__flowfram_relative_frame_location_by_idn:nnnn
        { static } { #2 } { static } { #3 }
    }
 }
\NewDocumentCommand \relflowloc { s m m }
 {
   \IfBooleanTF { #1 }
    {
      \__flowfram_relative_frame_location_by_idl:nnnn
        { flow } { #2 } { flow } { #3 }
    }
    {
      \__flowfram_relative_frame_location_by_idn:nnnn
        { flow } { #2 } { flow } { #3 }
    }
 }
\NewDocumentCommand \setinitialframe { m }
 {
  \int_gset:Nn \c@thisframe { #1 }
  \global \usedframebreaktrue
  \__flowfram_set_column:n { #1 }
 }
\newif\if@setfr@mes
\@setfr@mesfalse
\NewDocumentCommand \setframes { }
{
  \int_if_zero:nT { \c@thisframe }
   {
    \msg_warning:nn { flowfram } { no-page1-col }
    \int_gset_eq:NN \g__flowfram_next_frame_int \c_one_int
    \int_gset_eq:NN \g__flowfram_current_page_int \c_one_int
    \__flowfram_get_next_column:N \g__flowfram_next_frame_int
    \int_gdecr:N \g__flowfram_current_page_int
    \bool_while_do:nn
      { \int_compare_p:nNn { \g__flowfram_current_page_int } > { \c_zero_int } }
      {
        \int_gdecr:N \g__flowfram_current_page_int
        \setbox \@outputbox
          \vbox_to_ht:nn { \typeblockheight }
           {
              \__flowfram_do_all_frames:
           }
        \@outputpage
      }
    \int_gset_eq:NN \c@thisframe \g__flowfram_next_frame_int
   }
  \__flowfram_set_column:n { \c@thisframe }
  \@flowfram@update@col@count { \c@thisframe }
  \@setfr@mestrue
  \flowfram_set_tl_to_frame_tl:Nnnn
     \l__flowfram_textcolor_tl
     { flow } { textcolor } { \c@thisframe }
  \__flowfram_set_text_color:
}
\NewDocumentCommand \emulatetwocolumn { O{} }
 {
   \finishthispage
   \setallflowframes { pages = none }
   \settoheight \l__flowfram_sfdf_height_dim { #1 }
   \settodepth \l__flowfram_tmpa_dim { #1 }
   \addtolength \l__flowfram_sfdf_height_dim
     { \l__flowfram_tmpa_dim }
   \dim_compare:nNnTF
     { \l__flowfram_sfdf_height_dim } > { \c_zero_dim }
    {
      \__flowfram_two_column_with_top_in_area:nnnnnnn
        { \int_eval:n { \g__flowfram_pagecounter_tl } }
        { static }
        { \dim_use:N \l__flowfram_sfdf_height_dim }
        { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \int_gset:Nn \c@thisframe { \c@maxflow - \c_one_int }
      \exp_args:Ne \__flowfram_two_columns:n
          { > \int_eval:n { \g__flowfram_pagecounter_tl } }
      \setstaticcontents { \c@maxstatic } { #1 }
    }
    {
      \__flowfram_two_columns:n { all }
      \int_gset:Nn \c@thisframe { \c@maxflow - \c_one_int }
    }
  \__flowfram_set_column:n { \c@thisframe }
  \relax
 }
\NewDocumentCommand \emulateonecolumn { O{} }
{
  \finishthispage
  \setallflowframes { pages = none }
  \settoheight \l__flowfram_sfdf_height_dim { #1 }
  \settodepth \l__flowfram_tmpa_dim { #1 }
  \addtolength \l__flowfram_sfdf_height_dim { \l__flowfram_tmpa_dim }
  \dim_compare:nNnTF
    { \l__flowfram_sfdf_height_dim } > { \c_zero_dim }
   {
     \__flowfram_one_column_with_top_in_area:nnnnnnn
       { \int_eval:n { \g__flowfram_pagecounter_tl } }
       { static }
       { \dim_use:N \l__flowfram_sfdf_height_dim }
       { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
     \int_gset:Nn \c@thisframe { \c@maxflow - \c_one_int }
     \__flowfram_new_flow:nnnnn
       { > \int_eval:n { \g__flowfram_pagecounter_tl } }
       { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
     \setstaticcontents { \c@maxstatic } { #1 }
   }
   {
    \__flowfram_one_column:n { all }
    \int_gset:Nn \c@thisframe { \c@maxflow - \c_one_int }
   }
  \__flowfram_set_column:n { \c@thisframe }
  \relax
}
\AtBeginDocument
 {
   \__flowfram_doc_init:
 }
\cs_new:Nn \__flowfram_doc_init:
 {
  \cs_set_eq:NN \__flowfram_org_starttoc: \@starttoc
  \int_gset_eq:NN \c@absolutepage \c_one_int
  \int_if_zero:nT { \c@maxflow }
   {
    \if@twocolumn
      \msg_warning:nnn { flowfram } { no-cols } { 2 }
      \__flowfram_two_columns:n { all }
    \else
      \msg_warning:nnn { flowfram } { no-cols } { 1 }
      \__flowfram_one_column:n { all }
    \fi
   }
  \setframes
  \cs_set_eq:NN \__flowfram_only_document_env:Nn \use_ii:nn
  \cs_set_eq:NN
     \__flowfram_only_preamble:Nn
     \__flowfram_forbidden:Nn
  \cs_set_eq:NN \onecolumn \__flowfram_doc_onecolumn:
  \RenewDocumentCommand \twocolumn { o }
   {
     \__flowfram_doc_twocolumn:n { ##1 }
   }
  \cs_set_eq:NN
      \__flowfram_write_html_opts:nnn
      \__flowfram_doc_write_html_opts:nnn
 }
\cs_new:Nn \__flowfram_doc_onecolumn:
 {
   \bool_if:NTF  \g__flowfram_ignore_column_changes_bool
    {
      \bool_if:NT \g__flowfram_clearpage_column_changes_bool
       {
         \clearpage
       }
    }
    {
      \flowfram_set_one_col:
    }
 }
\cs_new:Nn \__flowfram_doc_twocolumn:n
 {
   \IfValueTF { #1 }
    {
      \bool_if:NTF  \g__flowfram_ignore_column_changes_bool
       {
         \bool_if:NT \g__flowfram_clearpage_column_changes_bool
          {
            \clearpage
          }
          #1
       }
       {
         \flowfram_set_two_col_header:n { #1 }
       }
    }
    {
      \bool_if:NTF  \g__flowfram_ignore_column_changes_bool
       {
          \bool_if:NT \g__flowfram_clearpage_column_changes_bool
           {
             \clearpage
           }
       }
       {
         \flowfram_set_two_col:
       }
    }
   }

\tl_new:N \g__flowfram_one_col_id_tl
\tl_new:N \g__flowfram_two_col_i_id_tl
\tl_new:N \g__flowfram_two_col_ii_id_tl
\tl_new:N \g__flowfram_two_col_header_id_tl
\tl_new:N \g__flowfram_two_col_header_type_tl
\tl_new:N \g__flowfram_headed_two_col_i_id_tl
\tl_new:N \g__flowfram_headed_two_col_ii_id_tl
\NewDocumentCommand \SetOneColumnFrame { s m }
 {
   \tl_if_empty:nTF { #2 }
    {
      \tl_gclear:N \g__flowfram_one_col_id_tl
    }
    {
      \IfBooleanTF { #1 }
       {
         \__flowfram_get_flow_id:n { #2 }
         \tl_gset:Ne \g__flowfram_one_col_id_tl
           { \int_use:N \l__flowfram_id_int }
       }
       {
         \bool_lazy_or:nnTF
           {
             \int_compare_p:nNn { #2 } < { \c_one_int }
           }
           {
             \int_compare_p:nNn { #2 } > { \c@maxflow }
           }
          {
             \msg_error:nnnn { flowfram } { idn-undefined }
              { flow } { #2 }
          }
          {
            \tl_gset:Ne \g__flowfram_one_col_id_tl
             { \int_eval:n { #2 } }
          }
       }
    }
 }
\NewDocumentCommand \SetTwoColumnFrames { s o o m o m o }
 {
   \IfValueTF { #2 }
    {
      \cs_if_exist:cTF { __flowfram_get_ #2 _id:n }
       {
         \tl_gset:Ne \g__flowfram_two_col_header_type_tl { #2 }
         \IfValueT { #3 }
          {
            \tl_if_empty:nTF { #3 }
             {
               \tl_gclear:N \g__flowfram_two_col_header_id_tl
             }
             {
               \IfBooleanTF { #1 }
                {
                  \use:c { __flowfram_get_ #2 _id:n } { #3 }
                  \tl_gset:Ne \g__flowfram_two_col_header_id_tl
                    { \int_use:N \l__flowfram_id_int }
                }
                {
                  \bool_lazy_or:nnTF
                    {
                      \int_compare_p:nNn { #3 } < { \c_one_int }
                    }
                    {
                      \int_compare_p:nNn { #3 } > { \int_use:c { c@max #2 } }
                    }
                   {
                      \msg_error:nnnn { flowfram } { idn-undefined }
                       { #2 } { #3 }
                   }
                   {
                     \tl_gset:Ne \g__flowfram_two_col_header_id_tl
                      { \int_eval:n { #3 } }
                   }
                }
             }
          }
       }
       {
          \msg_error:nnn { flowfram } { invalid-frame-type } { #2 }
       }
   }
   \tl_if_empty:nTF { #4 }
    {
      \tl_gclear:N \g__flowfram_two_col_i_id_tl
    }
    {
      \IfBooleanTF { #1 }
       {
         \__flowfram_get_flow_id:n { #4 }
         \tl_gset:Ne \g__flowfram_two_col_i_id_tl
           { \int_use:N \l__flowfram_id_int }
       }
       {
         \bool_lazy_or:nnTF
           {
             \int_compare_p:nNn { #4 } < { \c_one_int }
           }
           {
             \int_compare_p:nNn { #4 } > { \c@maxflow }
           }
          {
             \msg_error:nnnn { flowfram } { idn-undefined }
              { flow } { #4 }
          }
          {
            \tl_gset:Ne \g__flowfram_two_col_i_id_tl
              { \int_eval:n { #4 } }
          }
       }
    }
   \IfValueT { #5 }
    {
      \tl_if_empty:nTF { #5 }
       {
         \tl_gclear:N \g__flowfram_headed_two_col_i_id_tl
       }
       {
         \IfBooleanTF { #1 }
          {
            \__flowfram_get_flow_id:n { #5 }
            \tl_gset:Ne \g__flowfram_headed_two_col_i_id_tl
              { \int_use:N \l__flowfram_id_int }
          }
          {
            \bool_lazy_or:nnTF
              {
                \int_compare_p:nNn { #5 } < { \c_one_int }
              }
              {
                \int_compare_p:nNn { #5 } > { \c@maxflow }
              }
             {
                \msg_error:nnnn { flowfram } { idn-undefined }
                 { flow } { #5 }
             }
             {
               \tl_gset:Ne \g__flowfram_headed_two_col_i_id_tl
                { \int_eval:n { #5 } }
             }
          }
       }
    }
   \tl_if_empty:nTF { #6 }
    {
      \tl_gclear:N \g__flowfram_two_col_ii_id_tl
    }
    {
      \IfBooleanTF { #1 }
       {
         \__flowfram_get_flow_id:n { #6 }
         \tl_gset:Ne \g__flowfram_two_col_ii_id_tl
           { \int_use:N \l__flowfram_id_int }
       }
       {
         \bool_lazy_or:nnTF
           {
             \int_compare_p:nNn { #6 } < { \c_one_int }
           }
           {
             \int_compare_p:nNn { #6 } > { \c@maxflow }
           }
          {
             \msg_error:nnnn { flowfram } { idn-undefined }
              { flow } { #6 }
          }
          {
            \tl_gset:Ne \g__flowfram_two_col_ii_id_tl
             { \int_eval:n { #6 } }
          }
       }
    }
   \IfValueT { #7 }
    {
      \tl_if_empty:nTF { #7 }
       {
         \tl_gclear:N \g__flowfram_headed_two_col_ii_id_tl
       }
       {
         \IfBooleanTF { #1 }
          {
            \__flowfram_get_flow_id:n { #7 }
            \tl_gset:Ne \g__flowfram_headed_two_col_ii_id_tl
              { \int_use:N \l__flowfram_id_int }
          }
          {
            \bool_lazy_or:nnTF
              {
                \int_compare_p:nNn { #7 } < { \c_one_int }
              }
              {
                \int_compare_p:nNn { #7 } > { \c@maxflow }
              }
             {
                \msg_error:nnnn { flowfram } { idn-undefined }
                 { flow } { #7 }
             }
             {
               \tl_gset:Ne \g__flowfram_headed_two_col_ii_id_tl
                { \int_eval:n { #7 } }
             }
          }
       }
    }
 }
\cs_new:Nn \flowfram_set_one_col:
 {
   \tl_if_empty:NTF \g__flowfram_one_col_id_tl
    {
      \msg_warning:nnn { flowfram } { misplaced-col-cmd } { \onecolumn }
    }
    {
      \int_step_inline:nn { \c@maxflow }
       {
          \__flowfram_check_if_this_page:nn
            { \g__flowfram_pagecounter_tl } { ##1 }
         \int_compare:nNnTF
           { ##1 } = { \g__flowfram_one_col_id_tl }
          {
            \bool_if:NT \g__flowfram_not_this_frame_bool
             {
               \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl
                 {
                    \flowsetpagelist { ##1 }
                     {
                       pages =
                        {  > \int_eval:n { \g__flowfram_pagecounter_tl } }
                     }
                 }
             }
          }
          {
            \bool_if:NF \g__flowfram_not_this_frame_bool
             {
               \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl
                 {
                    \flowsetpagelist { ##1 } { pages = none }
                 }
             }
          }
       }
    }
   \clearpage
 }
\cs_new:Nn \flowfram_set_two_col:
 {
   \bool_lazy_or:nnTF
     {
       \tl_if_empty_p:N \g__flowfram_two_col_i_id_tl
     }
     {
       \tl_if_empty_p:N \g__flowfram_two_col_ii_id_tl
     }
    {
       \msg_warning:nnn { flowfram } { misplaced-col-cmd } { \twocolumn }
    }
    {
      \int_step_inline:nn { \c@maxflow }
       {
          \__flowfram_check_if_this_page:nn
            { \g__flowfram_pagecounter_tl } { ##1 }
         \bool_lazy_or:nnTF
           {
             \int_compare_p:nNn
               { ##1 } = { \g__flowfram_two_col_i_id_tl }
           }
           {
             \int_compare_p:nNn
               { ##1 } = { \g__flowfram_two_col_ii_id_tl }
           }
          {
            \bool_if:NT \g__flowfram_not_this_frame_bool
             {
               \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl
                 {
                    \flowsetpagelist { ##1 }
                     {
                       pages =
                        { > \int_eval:n { \g__flowfram_pagecounter_tl } }
                     }
                 }
             }
          }
          {
            \bool_if:NF \g__flowfram_not_this_frame_bool
             {
               \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl
                 {
                    \flowsetpagelist { ##1 } { pages = none }
                 }
             }
          }
       }
    }
   \clearpage
 }
\cs_new:Nn \flowfram_set_two_col_header:n
 {
   \tl_if_empty:NTF \g__flowfram_two_col_header_id_tl
    {
      \flowfram_set_two_col:
      #1
    }
    {
      \bool_lazy_and:nnTF
        {
          \tl_if_empty_p:N \g__flowfram_headed_two_col_i_id_tl
        }
        {
          \tl_if_empty_p:N \g__flowfram_headed_two_col_ii_id_tl
        }
       {
         \flowfram_set_two_col:
       }
       {
         \int_step_inline:nn { \c@maxflow }
          {
             \__flowfram_check_if_this_page:nn
               { \g__flowfram_pagecounter_tl } { ##1 }
            \bool_lazy_or:nnTF
              {
                \int_compare_p:nNn
                  { ##1 } = { \g__flowfram_two_col_i_id_tl }
              }
              {
                \int_compare_p:nNn
                  { ##1 } = { \g__flowfram_two_col_ii_id_tl }
              }
             {
               \bool_if:NT \g__flowfram_not_this_frame_bool
                {
                  \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl
                    {
                       \flowsetpagelist { ##1 }
                        {
                          pages =
                           {
                             >
                              \int_eval:n
                               {
                                 \g__flowfram_pagecounter_tl
                                  + \c_one_int
                               }
                            }
                        }
                    }
                }
             }
             {
               \bool_lazy_or:nnTF
                 {
                   \int_compare_p:nNn
                     { ##1 } = { \g__flowfram_headed_two_col_i_id_tl }
                 }
                 {
                   \int_compare_p:nNn
                     { ##1 } = { \g__flowfram_headed_two_col_ii_id_tl }
                 }
                {
                  \bool_if:NT \g__flowfram_not_this_frame_bool
                   {
                     \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl
                       {
                          \flowsetpagelist { ##1 }
                           {
                             pages =
                              { \int_eval:n { \g__flowfram_pagecounter_tl } }
                           }
                       }
                   }
                }
                {
                  \bool_if:NF \g__flowfram_not_this_frame_bool
                   {
                     \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl
                       {
                          \flowsetpagelist { ##1 } { pages = none }
                       }
                   }
                }
             }
          }
         \clearpage
       }
      \cs_if_exist:cTF
           { set \g__flowfram_two_col_header_type_tl  contents }
        {
          \use:c
           { set \g__flowfram_two_col_header_type_tl  contents }
           { \g__flowfram_two_col_header_id_tl }
           { #1 }
        }
        {
          #1
        }
    }
 }
\newlength\fftolerance
\setlength\fftolerance{2pt}
\cs_new:Nn \__flowfram_set_column:n
 {
  \bool_lazy_or:nnTF
    {
      \int_compare_p:nNn { \c@maxflow } < { #1 }
    }
    {
      \int_compare_p:nNn { #1 } < { \c_one_int }
    }
   {
    \msg_error:nne { flowfram } { cant-set-column }
      { \int_eval:n { #1 } }
   }
   {
    \exp_args:Nnee
    \__flowfram_message:nnn
      { info-switching-col }
      { \int_eval:n { #1 } }
      { \int_eval:n { \g__flowfram_pagecounter_tl } }
    \dim_gset:Nn
      \columnwidth
      { \flowfram_frame_use_dim:nnn { flow } { width } { #1 } }
    \legacy_if:nF { usedframebreak }
     {
      \dim_set_eq:NN \l__flowfram_tmpb_dim \columnwidth
      \dim_sub:Nn \l__flowfram_tmpb_dim { \hsize }
      \dim_compare:nNnT { \l__flowfram_tmpb_dim  } < { \c_zero_dim }
       {
         \dim_set:Nn \l__flowfram_tmpb_dim { - \l__flowfram_tmpb_dim }
       }
      \dim_compare:nNnT { \l__flowfram_tmpb_dim } > { \fftolerance }
       {
           \msg_warning:nnee { flowfram } { unequal-cols }
            { \dim_use:N \l__flowfram_tmpb_dim }
            { \the \fftolerance }
       }
     }
    \global \usedframebreakfalse
    \global \hsize \columnwidth
    \flowfram_gset_dim_to_frame_dim:Nnnn
      \textheight { flow } { height } { #1 }
    \global \vsize \textheight
    \global \@colht \textheight
    \global \@colroom \@colht
    \int_compare:nNnTF { \@listdepth } > { \c_zero_int }
     {
       \dim_compare:nNnT { \linewidth } > { \columnwidth }
        {
          \dim_gset_eq:NN \linewidth \columnwidth
        }
     }
     {
        \dim_gset_eq:NN \linewidth \columnwidth
     }
    \setmargin
   }
  \stepcounter { displayedframe }
}
\newcommand \flowfram@header [2]
 {
   \__flowfram_header:n
    {
      \color@hbox
      \g__flowfram_headercolor_tl
      \hbox_to_wd:nn { #1 } { #2 }
      \color@endbox
    }
 }
\newcommand \flowfram@dynamicheader [2]
 {
   \g__flowfram_headercolor_tl
   \__flowfram_header:n { #2 }
 }
\tl_new:N \g__flowfram_headercolor_tl
\tl_gset:Nn \g__flowfram_headercolor_tl { \normalcolor }
\cs_new:Nn \__flowfram_header:n
 {
  \pdfannot@link@off@@
    \UseTaggingSocket
    {build/page/header}
    { }
    { #1 }
  \pdfannot@link@on@@
 }
\newcommand \flowfram@footer [2]
 {
   \__flowfram_footer:n
    {
      \color@hbox
      \g__flowfram_footercolor_tl
      \hbox_to_wd:nn { #1 } { #2 }
      \color@endbox
    }
 }
\newcommand \flowfram@dynamicfooter [2]
 {
   \g__flowfram_footercolor_tl
   \__flowfram_footer:n { #2 }
 }
\tl_new:N \g__flowfram_footercolor_tl
\tl_gset:Nn \g__flowfram_footercolor_tl { \normalcolor }
\cs_new:Nn \__flowfram_footer:n
 {
   \pdfannot@link@off@@
   \UseTaggingSocket {build/page/footer}
     { }
     { #1 }
   \pdfannot@link@on@@
 }
\newcommand{\@dothehead}{
  \vbox_to_ht:nn { \headheight }
   {
     \vfil
     \flowfram@header { \typeblockwidth }
       {
        \@thehead
       }
   }
}
\newcommand{\@dothefoot}{
  \vbox:n
   {
     \flowfram@footer { \typeblockwidth }
      {
       \@thefoot
      }
   }
}
\newcommand{\@dodynamicthehead}{}
\newcommand{\@dodynamicthefoot}{}
\cs_set_eq:NN \__flowfram_org_dblfloat: \@dblfloat
\cs_set_eq:NN \@dblfloat \@float
\cs_set_eq:NN \__flowfram_org_enddblfloat: \end@dblfloat
\cs_set_eq:NN \end@dblfloat \end@float
\cs_set_eq:NN \__flowfram_org_opcol: \@opcol
\cs_set_eq:NN \__flowfram_org_outputdblcol: \@outputdblcol
\int_new:N \g__flowfram_saved_thisframe_int
\NewDocumentCommand \FlowFramRestoreOR {  }
 {
   \__flowfram_only_document_env:Nn \FlowFramRestoreOR
    {
      \finishthispage
      \int_gset_eq:NN \g__flowfram_saved_thisframe_int \c@thisframe
      \cs_set_eq:NN \@dblfloat \__flowfram_org_dblfloat:
      \cs_set_eq:NN \end@dblfloat \__flowfram_org_enddblfloat:
      \cs_set_eq:NN \@opcol \__flowfram_org_opcol:
      \cs_set_eq:NN \@outputdblcol \__flowfram_org_outputdblcol:
      \let\@outputpage\@@flowfram@org@output@page
      \renewcommand \@flowfram@build@page@after
       {
         \stepcounter{absolutepage}%
       }
      \cs_set_eq:NN \onecolumn \__flowfram_org_onecolumn:
      \cs_set_eq:NN \twocolumn \__flowfram_org_twocolumn:
      \int_gset_eq:NN \col@number \c_one_int
      \global \@twocolumnfalse
      \global \textwidth \typeblockwidth
      \global \textheight \typeblockheight
      \global \columnwidth \textwidth
      \global \hsize \textwidth
      \global \vsize \textheight
      \global \@colht \vsize
      \global \@colroom \@colht
    }
 }
\NewDocumentCommand \FlowFramUnrestoreOR { }
 {
   \__flowfram_only_document_env:Nn \FlowFramUnrestoreOR
    {
      \clearpage
      \cs_set_eq:NN \@opcol \__flowfram_op_col:
      \cs_set_eq:NN \@outputdblcol \__flowfram_output_dbl_col:
      \let\@outputpage\@@flowfram@output@page
      \cs_set_eq:NN \@dblfloat \@float
      \cs_set_eq:NN \end@dblfloat \end@float
      \renewcommand \@flowfram@build@page@before { }
      \renewcommand \@flowfram@build@page@after { }
      \cs_set_eq:NN \onecolumn \__flowfram_doc_onecolumn:
      \RenewDocumentCommand \twocolumn { o }
       {
         \__flowfram_doc_twocolumn:n { ##1 }
       }
      \int_gzero:N \c@displayedframe
      \int_gset_eq:NN \c@thisframe \g__flowfram_saved_thisframe_int
      \int_gset_eq:NN \g__flowfram_next_frame_int \g__flowfram_saved_thisframe_int
      \__flowfram_set_column:n { \c@thisframe }
      \@flowfram@update@col@count{\c@thisframe}%
    }
 }
\renewcommand * \@opcol { \__flowfram_op_col: }
\cs_new:Nn \__flowfram_op_col:
 {
  \if@twocolumn
    \@expl@@@mark@update@dblcol@structures@@
  \else
    \@expl@@@mark@update@singlecol@structures@@
  \fi
  \@outputdblcol
  \global \@mparbottom \z@
  \global \@textfloatsheight \z@
  \@floatplacement
}
\ExplSyntaxOff
\let\@@flowfram@org@output@page\@outputpage
\def\@outputpage{\@@flowfram@output@page}
\newcommand \@@flowfram@output@page{%
 \UseHook {build/page/before}%
 \begingroup
 \let \protect \noexpand
 \language\document@default@language
 \@resetactivechars
 \nfss@catcodes
 \catcode`\$\thr@@
 \catcode`\_8\relax
 \catcode`\ 10\relax
 \catcode`\^^I10\relax
 \catcode`\~13\relax
 \catcode`\^^M5\relax
 \global\let\@@if@newlist\if@newlist
 \global\@newlistfalse
 \UseHook {build/page/reset}%
 \shipout \vbox{%
  \set@typeset@protect
  \aftergroup \endgroup
  \aftergroup \set@typeset@protect
  \if@specialpage
    \global \@specialpagefalse
    \ifcsdef {ps@special\@specialstyle}%
    {\@nameuse {ps@special\@specialstyle}}%
    {\@nameuse {ps@\@specialstyle}}%
  \fi
  \if@twoside
    \ifodd\count\z@
      \let \@thehead \@oddhead
      \let \@thefoot \@oddfoot
      \let \@themargin \oddsidemargin
    \else
      \let \@thehead \@evenhead
      \let \@thefoot \@evenfoot
      \let \@themargin \evensidemargin
    \fi
  \else
   \let \@thehead \@oddhead
   \let \@thefoot \@oddfoot
   \let \@themargin \oddsidemargin
  \fi
  \reset@font
  \normalsize
  \normalsfcodes
  \let \label \@gobble@with@sphack@om
  \let \index \@gobble@with@sphack@som
  \let \glossary \@gobble@with@sphack@om
  \let \@@flowfram@current@pre@section@title \empty
  \baselineskip \z@skip
  \lineskip \z@skip
  \lineskiplimit \z@
    \@begindvi
    \vskip \typeblockoffsety
    \moveright\@themargin \vbox {%
      \box \@outputbox
   }%
  }%
  \global \let \if@newlist \@@if@newlist
  \@flowfram@set@next@vsize
  \global \textwidth \hsize
  \global \textheight \vsize
  \global \@colht \vsize
  \global \@colroom \@colht
  \stepcounter{page}%
  \stepcounter{absolutepage}%
  \setcounter{displayedframe}{0}%
  \@flowfram@update@col@count{\c@thisframe}%
  \UseHook {build/page/after}%
}
\ExplSyntaxOn
\AddToHook {build/page/before}
 {
   \@flowfram@build@page@before
 }
\AddToHook {build/page/after}
 {
   \@flowfram@build@page@after
 }
\newcommand\@flowfram@build@page@before{}
\newcommand\@flowfram@build@page@after{}
\newcommand\@flowfram@set@next@vsize
 {
   \flowfram_gset_dim_to_frame_dim:Nnnn \vsize
      { flow } { height } { \g__flowfram_next_frame_int }
 }
\int_new:N \g__flowfram_dynamic_header_int
\int_new:N \g__flowfram_dynamic_even_header_int
\int_new:N \g__flowfram_dynamic_footer_int
\int_new:N \g__flowfram_dynamic_even_footer_int
\NewDocumentCommand \makedfheaderfooter { }
 {
   \__flowfram_new_dynamic:nnnnnn
    { all } { \typeblockwidth } { \headheight }
    { 0pt } { \typeblockheight + \headsep } { header }
   \int_set_eq:NN \g__flowfram_dynamic_header_int
     \c@maxdynamic
   \__flowfram_set_dynamic_by_idn:nn { \c@maxdynamic } { valign=c }
   \__flowfram_new_dynamic:nnnnnn
    { all } { \typeblockwidth } { \headheight }
    { 0pt } { -\footskip } { footer }
   \int_set_eq:NN \g__flowfram_dynamic_footer_int
     \c@maxdynamic
   \__flowfram_set_dynamic_by_idn:nn { \c@maxdynamic } { valign=c }
   \gdef \@dothehead { }
   \gdef \@dothefoot { }
   \gdef \@dodynamicthehead
    {
     \__flowfram_set_dynamic_contents:nn
       { \g__flowfram_dynamic_header_int }
       {
         \flowfram_dynamic_header:n
           { \g__flowfram_dynamic_header_int }
       }
    }
   \gdef \@dodynamicthefoot
    {
     \__flowfram_set_dynamic_contents:nn
       { \g__flowfram_dynamic_footer_int }
       {
          \flowfram_dynamic_footer:n
           { \g__flowfram_dynamic_footer_int }
       }
   }
  \tl_clear:N \g__flowfram_headercolor_tl
  \tl_clear:N \g__flowfram_footercolor_tl
  \__flowfram_adjust_page_styles:n
   {
      \let \ps@myheadings \ps@ffmyheadings
      \let \ps@headings \ps@ffheadings
      \let \ps@plain \ps@ffplain
      \let \ps@empty \ps@ffempty
   }
  \pagestyle { ffheadings }
  \cs_set:Nn \__flowfram_only_pre_makedfheaderfooter:nn
   {
     \msg_error:nnn { flowfram } { option-too-late } { ##1 } { \makedfheaderfooter }
   }
 }
\@onlypreamble{\makedfheaderfooter}
\NewDocumentCommand \FlowFramSetDynamicHeadFootAttributes { m }
 {
   \int_compare:nNnT
     { \g__flowfram_dynamic_header_int } > { \c_zero_int }
    {
      \__flowfram_set_dynamic_by_idn:nn
        { \g__flowfram_dynamic_header_int } { #1 }
    }
   \int_compare:nNnT
     { \g__flowfram_dynamic_even_header_int } > { \c_zero_int }
    {
      \__flowfram_set_dynamic_by_idn:nn
        { \g__flowfram_dynamic_even_header_int } { #1 }
    }
   \int_compare:nNnT
     { \g__flowfram_dynamic_footer_int } > { \c_zero_int }
    {
      \__flowfram_set_dynamic_by_idn:nn
        { \g__flowfram_dynamic_footer_int } { #1 }
    }
   \int_compare:nNnT
     { \g__flowfram_dynamic_even_footer_int } > { \c_zero_int }
    {
      \__flowfram_set_dynamic_by_idn:nn
        { \g__flowfram_dynamic_even_footer_int } { #1 }
    }
 }
\cs_new:Nn \flowfram_dynamic_header:n
 {
   \flowfram_set_dim_to_frame_dim:Nnnn
      \l__flowfram_sfdf_width_dim
       { dynamic } { width } { #1 }
  \if@twoside
    \ifodd\c@page
     \flowfram@dynamicheader
       { \l__flowfram_sfdf_width_dim }
       { \@oddhead }
    \else
     \flowfram@dynamicheader
       { \l__flowfram_sfdf_width_dim }
       { \@evenhead }
    \fi
  \else
    \flowfram@dynamicheader
      { \l__flowfram_sfdf_width_dim }
      { \@thehead }
  \fi
 }
\cs_new:Nn \flowfram_dynamic_odd_header:n
 {
   \flowfram_set_dim_to_frame_dim:Nnnn
      \l__flowfram_sfdf_width_dim
       { dynamic } { width } { #1 }
  \if@twoside
    \ifodd\c@page
     \flowfram@dynamicheader
       { \l__flowfram_sfdf_width_dim }
       { \@oddhead }
    \else
     \flowfram@dynamicheader
       { \l__flowfram_sfdf_width_dim }
       { }
    \fi
  \else
    \flowfram@dynamicheader
      { \l__flowfram_sfdf_width_dim }
      { \@thehead }
  \fi
 }
\cs_new:Nn \flowfram_dynamic_even_header:n
 {
   \flowfram_set_dim_to_frame_dim:Nnnn
      \l__flowfram_sfdf_width_dim
       { dynamic } { width } { #1 }
  \if@twoside
    \ifodd\c@page
     \flowfram@dynamicheader
       { \l__flowfram_sfdf_width_dim }
       { }
    \else
     \flowfram@dynamicheader
       { \l__flowfram_sfdf_width_dim }
       { \@evenhead }
    \fi
  \else
    \flowfram@dynamicheader
      { \l__flowfram_sfdf_width_dim }
      { }
  \fi
 }
\cs_new:Nn \flowfram_dynamic_footer:n
 {
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_sfdf_width_dim
     { dynamic } { width } { #1 }
  \if@twoside
    \ifodd\c@page
      \flowfram@dynamicfooter
       { \l__flowfram_sfdf_width_dim } { \@oddfoot }
    \else
      \flowfram@dynamicfooter
       { \l__flowfram_sfdf_width_dim } { \@evenfoot }
    \fi
  \else
    \flowfram@dynamicfooter
     { \l__flowfram_sfdf_width_dim } { \@thefoot }
  \fi
 }
\cs_new:Nn \flowfram_dynamic_odd_footer:n
 {
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_sfdf_width_dim
     { dynamic } { width } { #1 }
  \if@twoside
    \ifodd\c@page
      \flowfram@dynamicfooter
       { \l__flowfram_sfdf_width_dim } { \@oddfoot }
    \else
      \flowfram@dynamicfooter
       { \l__flowfram_sfdf_width_dim } { }
    \fi
  \else
    \flowfram@dynamicfooter
     { \l__flowfram_sfdf_width_dim } { \@thefoot }
  \fi
 }
\cs_new:Nn \flowfram_dynamic_even_footer:n
 {
   \flowfram_set_dim_to_frame_dim:Nnnn
     \l__flowfram_sfdf_width_dim
     { dynamic } { width } { #1 }
  \if@twoside
    \ifodd\c@page
      \flowfram@dynamicfooter
       { \l__flowfram_sfdf_width_dim } { }
    \else
      \flowfram@dynamicfooter
       { \l__flowfram_sfdf_width_dim } { \@evenfoot }
    \fi
  \else
    \flowfram@dynamicfooter
     { \l__flowfram_sfdf_width_dim } { }
  \fi
 }
\newcommand \dfOddHeaderStyle [ 1 ] { \hfill #1 }
\newcommand \dfEvenHeaderStyle [ 1 ] { #1 \hfill }
\newcommand \dfOddFooterStyle [ 1 ] { \hfill #1 \hfill }
\newcommand \dfEvenFooterStyle [ 1 ] { \hfill #1 \hfill }
\cs_if_exist:NTF \chapter
 {
   \cs_new:Nn \__flowfram_ps_myheadings:
    {
      \def \@oddfoot { \dfOddFooterStyle { \thepage } }
      \def \@evenfoot { \dfEvenFooterStyle { \thepage } }
      \def \@oddhead { \dfOddHeaderStyle { \rightmark } }
      \def \@evenhead { \dfEvenHeaderStyle { \leftmark } }
      \let \@mkboth \@gobbletwo
      \let \chaptermark \@gobble
      \let \sectionmark \@gobble
    }
   \cs_new:Nn \__flowfram_ps_headings:
    {
      \def \@oddfoot { \dfOddFooterStyle { \thepage } }
      \def \@evenfoot { \dfEvenFooterStyle { \thepage } }
      \def \@oddhead { \dfOddHeaderStyle { \rightmark } }
      \def \@evenhead { \dfEvenHeaderStyle { \leftmark } }
      \let \@mkboth \markboth
      \def \chaptermark ##1
       {
         \markboth
          {
            \flowframchapterheader { ##1 }
          }
          {
            \flowfram_initial_right_mark:n
             {
               \flowframchapterheader { ##1 }
             }
          }
       }
      \def \sectionmark ##1
       {
         \markright
          {
            \flowframsectionheader { ##1 }
          }
       }
    }
   \newcommand \flowframchapterheader [ 1 ]
    {
      \flowfram_header_font:n
       {
        \flowfram_header_case:n
          {
            \ifnum \c@secnumdepth >\m@ne
              \if@mainmatter
                \flowframheaderchapprefix
                \thechapter
                \flowframheadersep
              \fi
            \fi
            #1
          }
       }
    }
   \newcommand \flowframsectionheader [ 1 ]
    {
      \flowfram_subheader_font:n
       {
         \flowfram_subheader_case:n
          {
            \ifnum \c@secnumdepth >\z@
               \thesection
               \flowframheadersep
            \fi
            #1
          }
       }
    }
 }
 {
   \cs_new:Nn \__flowfram_ps_myheadings:
    {
      \def \@oddfoot { \dfOddFooterStyle { \thepage } }
      \def \@evenfoot { \dfEvenFooterStyle { \thepage } }
      \def \@oddhead { \dfOddHeaderStyle { \rightmark } }
      \def \@evenhead { \dfEvenHeaderStyle { \leftmark } }
      \let \@mkboth \@gobbletwo
      \let \sectionmark \@gobble
      \let \subsectionmark \@gobble
    }
   \cs_new:Nn \__flowfram_ps_headings:
    {
      \def \@oddfoot { \dfOddFooterStyle { \thepage } }
      \def \@evenfoot { \dfEvenFooterStyle { \thepage } }
      \def \@oddhead { \dfOddHeaderStyle { \rightmark } }
      \def \@evenhead { \dfEvenHeaderStyle { \leftmark } }
      \let \@mkboth \markboth
      \def \sectionmark ##1
        {
          \markboth
           {
             \flowframsectionheader { ##1 }
           }
           {
            \flowfram_initial_right_mark:n
             {
               \flowframsectionheader { ##1 }
             }
           }
        }
      \def \subsectionmark ##1
       {
         \markright
          {
            \flowframsubsectionheader { ##1 }
          }
       }
    }
   \newcommand \flowframsectionheader [ 1 ]
    {
      \flowfram_header_font:n
       {
         \flowfram_header_case:n
          {
            \ifnum \c@secnumdepth >\m@ne
              \thesection
              \flowframheadersep
            \fi
            #1
          }
       }
    }
   \newcommand \flowframsubsectionheader [ 1 ]
    {
      \flowfram_subheader_font:n
       {
         \flowfram_subheader_case:n
          {
            \int_compare:nNnT { \c@secnumdepth } > { 2 }
             {
              \thesubsection
              \flowframheadersep
             }
            #1
          }
       }
    }
 }
\cs_new:Nn \flowfram_initial_right_mark:n { #1 }
\newcommand \ps@ffmyheadings
 {
   \__flowfram_ps_myheadings:
   \bool_if:NT \l__flowfram_ps_ffempty_hides_bool
    {
      \FlowFramSetDynamicHeadFootAttributes
        { hide = false , hidethis = false }
    }
 }
\newcommand \ps@ffheadings
 {
   \__flowfram_ps_headings:
   \bool_if:NT \l__flowfram_ps_ffempty_hides_bool
    {
      \FlowFramSetDynamicHeadFootAttributes
        { hide = false , hidethis = false }
    }
 }
\newcommand \ps@ffplain
 {
   \__flowfram_ps_plain:
   \bool_if:NT \l__flowfram_ps_ffempty_hides_bool
    {
      \FlowFramSetDynamicHeadFootAttributes
        { hide = false , hidethis = false }
    }
 }
\cs_new:Nn \__flowfram_ps_plain:
 {
   \def \@oddfoot { \dfOddFooterStyle { \thepage } }
   \def \@evenfoot { \dfEvenFooterStyle { \thepage } }
   \def \@oddhead { }
   \def \@evenhead { }
   \let \@mkboth \@gobbletwo
   \let \sectionmark \@gobble
   \let \subsectionmark \@gobble
 }
\newcommand \ps@ffempty
 {
   \l__flowfram_ffempty_style_tl
   \bool_if:NT \l__flowfram_ps_ffempty_hides_bool
    {
      \FlowFramSetDynamicHeadFootAttributes { hide }
    }
 }
\cs_new:Nn \__flowfram_ps_empty:
 {
   \def \@oddfoot { }
   \def \@evenfoot { }
   \def \@oddhead { }
   \def \@evenhead { }
   \let \@mkboth \@gobbletwo
   \let \sectionmark \@gobble
   \let \subsectionmark \@gobble
 }
\newcommand \ps@specialffempty
 {
   \l__flowfram_ffempty_style_tl
   \bool_if:NT \l__flowfram_ps_ffempty_hides_bool
    {
      \FlowFramSetDynamicHeadFootAttributes { hidethis }
    }
 }
\newcommand \ps@specialempty { \ps@empty }
\newcommand \footnotecolor { }
\bool_new:N \g__flowfram_more_frames_bool
\cs_new:Nn \__flowfram_check_if_more_frames:n
 {
  \bool_gset_false:N \g__flowfram_more_frames_bool
  \int_set:Nn \l__flowfram_col_int { #1 }
  \bool_while_do:nn
   {
     \bool_lazy_and_p:nn
      {
        \int_compare_p:nNn { \l__flowfram_col_int } < { \c@maxflow }
      }
      {
        \bool_not_p:n
          {
            \bool_if_p:N \g__flowfram_more_frames_bool
          }
      }
   }
  {
    \int_incr:N \l__flowfram_col_int
    \exp_args:Ne
    \flowfram_if_in_frame_clist:nnnnF
       { \int_eval:n { \g__flowfram_pagecounter_tl } }
       { flow } { excludelist } { \l__flowfram_col_int }
     {
       \exp_args:Ne
       \flowfram_if_frame_has_morepages:nnnT
         { \int_eval:n { \g__flowfram_pagecounter_tl } }
         { flow } { \l__flowfram_col_int }
       {
         \bool_gset_true:N \g__flowfram_more_frames_bool
       }
     }
  }
 \bool_if:NF \g__flowfram_more_frames_bool
  {
    \int_set:Nn \l__flowfram_tmpa_int
      { \g__flowfram_pagecounter_tl }
    \int_zero:N \l__flowfram_tmpb_int
    \bool_do_while:nn
     {
       \int_compare_p:nNn { \l__flowfram_tmpb_int } < { 4 }
     }
    {
      \int_incr:N \l__flowfram_tmpa_int
      \int_zero:N \l__flowfram_col_int
      \bool_while_do:nn
        {
          \int_compare_p:nNn { \l__flowfram_col_int } < { \c@maxflow }
        }
       {
        \int_incr:N \l__flowfram_col_int
       \exp_args:NV \flowfram_if_frame_excludedpage:nnnF
          \l__flowfram_tmpa_int
          { flow } { \l__flowfram_col_int }
         {
         \exp_args:NV
         \flowfram_if_frame_has_morepages:nnnT
           \l__flowfram_tmpa_int
            { flow } { \l__flowfram_col_int }
           {
             \bool_gset_true:N \g__flowfram_more_frames_bool
           }
          \bool_if:NT \g__flowfram_more_frames_bool
           {
             \int_set_eq:NN \l__flowfram_col_int \c@maxflow
           }
         }
       }
      \bool_if:NTF \g__flowfram_more_frames_bool
       {
         \int_set:Nn \l__flowfram_tmpb_int { 4 }
       }
       {
         \int_incr:N \l__flowfram_tmpb_int
       }
    }
  }
}
\tl_new:N \g__flowfram_output_adjust_frames_tl
\NewDocumentCommand \ffaddtoadjustframeshook { m }
 {
   \tl_gput_right:Nn \g__flowfram_output_adjust_frames_tl { #1 }
 }
\bool_new:N \g__flowfram_new_page_bool
\bool_new:N \g__flowfram_not_this_frame_bool
\int_new:N \g__flowfram_current_page_int
\cs_new:Nn \__flowfram_get_next_column:N
 {
  \g__flowfram_output_adjust_frames_tl
  \tl_gclear:N \g__flowfram_output_adjust_frames_tl
  \__flowfram_check_if_more_frames:n { \c@thisframe }
  \bool_if:NF \g__flowfram_more_frames_bool
   {
    \msg_warning:nne { flowfram } { no-more-cols-on-page }
     { \int_eval:n { \g__flowfram_pagecounter_tl } }
    \flf@doifverbose
     {
      \tl_clear:N \l__flowfram_tmpa_tl
      \seq_map_indexed_inline:nn \g__flowfram_flowlabels_seq
       {
         \tl_put_right:Ne \l__flowfram_tmpa_tl
          {
            \exp_not:N \MessageBreak
              ##1 ( ##2 )
             Pages: ~
              \flowfram_frame_use_clist:nnn
                { flow } { pagelist } { ##1 }
             Exclusions: ~
              \flowfram_frame_use_clist:nnn
                { flow } { excludelist } { ##1 }
          }
       }
      \msg_info:nnV { flowfram } { info-col-list }
        \l__flowfram_tmpa_tl
     }
    \__flowfram_one_column:n { all }
    \int_gset_eq:NN #1 \c@maxflow
   }
  \bool_gset_true:N \g__flowfram_not_this_frame_bool
  \bool_gset_false:N \g__flowfram_new_page_bool
  \int_set_eq:NN \l__flowfram_col_int #1
  \int_gset:Nn \g__flowfram_current_page_int
    { \g__flowfram_pagecounter_tl }
  \bool_while_do:Nn \g__flowfram_not_this_frame_bool
   {
    \int_compare:nNnTF
       { \l__flowfram_col_int } = { \c@maxflow }
     {
       \int_set_eq:NN \l__flowfram_col_int \c_one_int
       \bool_gset_true:N \g__flowfram_new_page_bool
       \int_gincr:N \g__flowfram_current_page_int
     }
     {
       \int_incr:N \l__flowfram_col_int
     }
    \__flowfram_check_if_this_page:nn
     { \g__flowfram_current_page_int } { \l__flowfram_col_int }
   }
  \int_gset_eq:NN #1 \l__flowfram_col_int
}
\cs_new:Nn \__flowfram_check_if_this_page:nn
 {
  \bool_gset_false:N \g__flowfram_not_this_frame_bool
  \flowfram_set_clist_to_frame_clist:Nnnn
   \l__flowfram_exclude_pages_clist
   { flow } { excludelist } { #2 }
  \clist_map_inline:Nn
    \l__flowfram_exclude_pages_clist
   {
     \int_compare:nNnT { ##1 } = { #1 }
      {
        \bool_gset_true:N \g__flowfram_not_this_frame_bool
        \clist_map_break:
      }
   }
  \bool_if:NF \g__flowfram_not_this_frame_bool
   {
    \bool_gset_true:N \g__flowfram_not_this_frame_bool
    \flowfram_set_clist_to_frame_clist:Nnnn
      \l__flowfram_pages_clist
      { flow } { pagelist } { #2 }
    \__flowfram_check_if_this_page:n { #1 }
   }
}
\cs_new:Nn \__flowfram_check_if_this_page:n
 {
  \tl_if_eq:NNF \l__flowfram_pages_clist \c_flowfram_none_tl
   {
    \tl_if_eq:NNTF \l__flowfram_pages_clist \c_flowfram_all_tl
     {
       \bool_gset_false:N \g__flowfram_not_this_frame_bool
     }
     {
      \tl_if_eq:NNTF \l__flowfram_pages_clist \c_flowfram_odd_tl
       {
        \int_if_odd:nT { #1 }
         {
           \bool_gset_false:N \g__flowfram_not_this_frame_bool
         }
       }
       {
        \tl_if_eq:NNTF \l__flowfram_pages_clist \c_flowfram_even_tl
         {
          \int_if_even:nT { #1 }
           {
             \bool_gset_false:N \g__flowfram_not_this_frame_bool
           }
         }
         {
          \clist_map_inline:Nn \l__flowfram_pages_clist
           {
             \flowfram_if_in_pagerange:nnT { #1 } { ##1 }
              {
                \bool_gset_false:N \g__flowfram_not_this_frame_bool
                \clist_map_break:
              }
           }
         }
       }
     }
   }
}
\cs_new:Nn \__flowfram_static_check_if_this_page:n
 {
   \__flowfram_static_check_if_this_page:nn
    { \g__flowfram_pagecounter_tl } { #1 }
 }
\cs_new:Nn \__flowfram_static_check_if_this_page:nn
 {
   \bool_gset_true:N \g__flowfram_not_this_frame_bool
   \flowfram_set_clist_to_frame_clist:Nnnn
    \l__flowfram_pages_clist
    { static } { pagelist } { #2 }
   \__flowfram_check_if_this_page:n { #1 }
 }
\cs_new:Nn \__flowfram_dynamic_check_if_this_page:n
 {
   \__flowfram_dynamic_check_if_this_page:nn
    { \g__flowfram_pagecounter_tl } { #1 }
 }
\cs_new:Nn \__flowfram_dynamic_check_if_this_page:nn
 {
  \bool_gset_true:N \g__flowfram_not_this_frame_bool
  \flowfram_set_clist_to_frame_clist:Nnnn
   \l__flowfram_pages_clist
   { dynamic } { pagelist } { #2 }
  \__flowfram_check_if_this_page:n { #1 }
 }
\cs_new:Nn \__flowfram_set_column_box:n
 {
   \exp_args:Nne \__flowfram_message:nn
      { info-setting-col } { \int_eval:n { #1 } }
   \flowfram_frame_set_box_eq:nnnN
      { flow } { column } { #1 } \@outputbox
 }
\NewDocumentCommand \rotateframe { m m }
{
  \int_if_zero:nTF { #1 }
  { #2 }
  {
    \rotatebox { #1 } { #2 }
  }
}
\cs_new:Nn \__flowfram_do_flow_box:n
 {
  \exp_args:Nnee
  \__flowfram_message:nnn
     { info-doing-col}
     { \int_eval:n { #1 } }
     { \int_eval:n { \g__flowfram_pagecounter_tl} }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_frametype_tl
    { flow } { frametype } { #1 }
   \flowfram_set_tl_to_frame_tl:Nnnn
      \l__flowfram_bordercolor_tl
      { flow } { bordercolor } { #1 }
   \flowfram_set_tl_to_frame_tl:Nnnn
      \l__flowfram_textcolor_tl
      { flow } { textcolor } { #1 }
   \flowfram_set_tl_to_frame_tl:Nnnn
      \l__flowfram_backcolor_tl
      { flow } { backcolor } { #1 }
  \__flowfram_flow_calc_offset:n {#1}%
  \exp_args:Ne \rotateframe
   {
     \flowfram_frame_use_tl:nnn { flow } { angle } { #1 }
   }
   {
    \flowfram_if_frame_bool:nnnTF
      { flow } { hasframe } { #1 }
    {
       \__flowfram_bordered_box:nnnn
         {
          \flowfram_frame_use_dim:nnn { flow } { width } { #1 }
         }
         {
          \flowfram_frame_use_dim:nnn { flow } { height } { #1 }
         }
         {
           \flowfram_frame_use_drop_box:nnn
             { flow } { column } { #1 }
         }
         {
           \use:c { \l__flowfram_frametype_tl }
         }
    }
    {
      \__flowfram_noborder_box:nnn
        {
          \flowfram_frame_use_dim:nnn { flow } { width } { #1 }
        }
        {
          \flowfram_frame_use_dim:nnn { flow } { height } { #1 }
        }
        {
          \flowfram_frame_use_drop_box:nnn { flow } { column } { #1 }
        }
    }
   }
 }
\cs_new:Nn \__flowfram_do_flow_bounding_box:n
 {
  \__flowfram_flow_calc_offset:n { #1 }
  \tl_clear:N \l__flowfram_bordercolor_tl
  \tl_clear:N \l__flowfram_textcolor_tl
  \__flowfram_do_if_draft:nn
   {
    \__flowfram_noborder_box:nnn
      {
       \flowfram_frame_use_dim:nnn { flow } { width } { #1 }
      }
      {
       \flowfram_frame_use_dim:nnn { flow } { height } { #1 }
      }
      {
        \flowfram_frame_use_drop_box:nnn { flow } { column } { #1 }
      }
   }
   {
    \flowfram_draft_annote:nnn
     { F } { \int_eval:n { #1 } } { \getflowlabel { #1 } }
   }
 }
\cs_new:Nn \__flowfram_bordered_box:nnnn
 {
   \group_begin:
     \dim_set_eq:NN \fboxsep \flowframesep
     \dim_set_eq:NN \fboxrule \flowframerule
     \__flowfram_set_border_color:
     \kern \l__flowfram_offset_dim
     #4 { \__flowfram_noborder_box:nnn { #1 } { #2 } { #3 } }
   \group_end:
 }
\cs_new:Nn \__flowfram_noborder_box:nnn
 {
   \group_begin:
    \__flowfram_background_box:n
     {
       \vbox_to_ht:nn { #2 }
        {
          \hbox_to_wd:nn { #1 }
            { \hss { \__flowfram_set_text_color: #3 } \hss }
          \vss
          \kern\z@
        }
     }
   \group_end:
 }
\cs_new:Nn \__flowfram_put_flow_box:n
 {
  \__flowfram_check_if_this_page:nn
   { \g__flowfram_pagecounter_tl } { #1 }
  \bool_if:NT \g__flowfram_not_this_frame_bool
   {
    \flowfram_frame_if_box_empty:nnnF
      { flow } { column } { #1 }
     {
       \msg_warning:nneeee
         { flowfram } { non-void-box }
         { \int_eval:n { #1 } }
         { \int_use:N \g__flowfram_pagecounter_tl }
         { \flowfram_frame_use_clist:nnn { flow } { pagelist } { #1 } }
         { \flowfram_frame_use_clist:nnn { flow } { excludelist } { #1 } }
       \bool_gset_false:N \g__flowfram_not_this_frame_bool
     }
   }
  \bool_if:NTF \g__flowfram_not_this_frame_bool
   {
     \exp_args:Nnee
     \__flowfram_message:nnn
       { info-col-not-required }
       { \int_eval:n { #1 } }
       { \int_eval:n { \g__flowfram_pagecounter_tl } }
   }
   {
    \@killglue
    \legacy_if:nTF { @twoside }
     {
      \int_if_odd:nTF { \c@page }
       {
        \box_move_up:nn
          {
            \flowfram_frame_use_dim:nnn { flow } { posy } { #1 }
          }
          {
            \hbox_to_zero:n
             {
               \kern
                 \flowfram_frame_use_dim:nnn { flow } { posx } { #1 }
               \__flowfram_do_flow_box:n { #1 }
               \hss
             }
          }
       }
       {
        \box_move_up:nn
          {
            \flowfram_frame_use_dim:nnn { flow } { eveny } { #1 }
          }
          {
            \hbox_to_zero:n
             {
              \kern
                \flowfram_frame_use_dim:nnn { flow } { evenx } { #1 }
              \__flowfram_do_flow_box:n { #1 }
              \hss
             }
          }
       }
     }
     {
      \box_move_up:nn
        {
          \flowfram_frame_use_dim:nnn { flow } { posy } { #1 }
        }
        {
          \hbox_to_zero:n
           {
            \kern
              \flowfram_frame_use_dim:nnn { flow } { posx } { #1 }
            \__flowfram_do_flow_box:n { #1 }
            \hss
           }
        }
     }
   }
 }
\cs_new:Nn \__flowfram_put_flow_bounding_box:n
 {
  \__flowfram_check_if_this_page:nn
    { \g__flowfram_pagecounter_tl } { #1 }
  \bool_if:NF \g__flowfram_not_this_frame_bool
   {
    \@killglue
    \legacy_if:nTF { @twoside }
     {
      \int_if_odd:nTF { \c@page }
       {
         \box_move_up:nn
           {
             \flowfram_frame_use_dim:nnn { flow } { posy } { #1 }
           }
           {
             \hbox_to_zero:n
             {
               \kern
                 \flowfram_frame_use_dim:nnn { flow } { posx } { #1 }
               \__flowfram_do_flow_bounding_box:n { #1 }
               \hss
             }
           }
       }
       {
        \box_move_up:nn
         {
           \flowfram_frame_use_dim:nnn { flow } { eveny } { #1 }
         }
         {
           \hbox_to_zero:n
            {
              \kern
                \flowfram_frame_use_dim:nnn { flow } { evenx } { #1 }
              \__flowfram_do_flow_bounding_box:n {#1}
              \hss
            }
         }
       }
     }
     {
       \box_move_up:nn
        {
          \flowfram_frame_use_dim:nnn { flow } { posy } { #1 }
        }
        {
          \hbox_to_zero:n
           {
            \kern
              \flowfram_frame_use_dim:nnn { flow } { posx } { #1 }
            \__flowfram_do_flow_bounding_box:n {#1}
            \hss
           }
        }
     }
   }
 }
\cs_new:Nn \__flowfram_set_doublebox_offset:
 {
   \dim_set:Nn \l__flowfram_offset_dim
    {
       - \flowframesep
       -3.75 \flowframerule
       - 0.5pt
    }
 }
\cs_new:Nn \__flowfram_set_ovalbox_offset:
 {
   \dim_set:Nn \l__flowfram_offset_dim
    {
      - \flowframesep
      - \fontdimen 8 \tenln
    }
 }
\cs_new:Nn \__flowfram_set_Ovalbox_offset:
 {
   \dim_set:Nn \l__flowfram_offset_dim
    {
      - \flowframesep
      - \fontdimen 8 \tenlnw
    }
 }
\cs_new:Nn \__flowfram_set_default_offset:
 {
   \dim_set:Nn \l__flowfram_offset_dim
    {
      - \flowframesep
      - \flowframerule
    }
 }
\cs_new:Nn \__flowfram_flow_calc_offset:n
{
  \flowfram_if_tl_eq_frame_tl:NnnnTF
    \c_flowfram_compute_tl
    { flow } { offset } { #1 }
   {
     \flowfram_if_frame_bool:nnnTF { flow } { hasframe } { #1 }
      {
        \flowfram_set_tl_to_frame_tl:Nnnn
           \l__flowfram_frametype_tl
           { flow } { frametype } { #1 }
        \cs_if_exist_use:cF
          { __flowfram_set_ \l__flowfram_frametype_tl  _offset: }
          {
            \__flowfram_set_default_offset:
          }
      }
      {
        \dim_zero:N \l__flowfram_offset_dim
      }
   }
   {
     \flowfram_set_dim_to_frame_tl:Nnnn
      \l__flowfram_offset_dim
      { flow } { offset } { #1 }
   }
}
\cs_new:Nn \__flowfram_static_calc_offset:n
 {
  \flowfram_if_tl_eq_frame_tl:NnnnTF
    \c_flowfram_compute_tl
    { static } { offset } { #1 }
  {
    \flowfram_if_frame_bool:nnnTF { static } { hasframe } { #1 }
    {
      \flowfram_set_tl_to_frame_tl:Nnnn
          \l__flowfram_frametype_tl
          { static } { frametype } { #1 }
      \cs_if_exist_use:cF
       { __flowfram_set_ \l__flowfram_frametype_tl  _offset: }
       {
         \__flowfram_set_default_offset:
       }
    }
    {
      \dim_zero:N \l__flowfram_offset_dim
    }
  }
  {
    \flowfram_set_dim_to_frame_tl:Nnnn
     \l__flowfram_offset_dim
     { static } { offset } { #1 }
  }
}
\cs_new:Nn \__flowfram_dynamic_calc_offset:n
 {
  \flowfram_if_tl_eq_frame_tl:NnnnTF
    \c_flowfram_compute_tl
    { dynamic } { offset } { #1 }
  {
    \flowfram_if_frame_bool:nnnTF { dynamic } { hasframe } { #1 }
    {
      \flowfram_set_tl_to_frame_tl:Nnnn
          \l__flowfram_frametype_tl
          { dynamic } { frametype } { #1 }
      \cs_if_exist_use:cF
       { __flowfram_set_ \l__flowfram_frametype_tl  _offset: }
       {
         \__flowfram_set_default_offset:
       }
    }
    {
      \dim_zero:N \l__flowfram_offset_dim
    }
  }
  {
    \flowfram_set_dim_to_frame_tl:Nnnn
     \l__flowfram_offset_dim
     { dynamic } { offset } { #1 }
  }
}
\cs_new:Nn \__flowframe_put_margin_box:n
{
  \__flowfram_check_if_this_page:nn
    { \g__flowfram_pagecounter_tl } { #1 }
  \bool_if:NF \g__flowfram_not_this_frame_bool
   {
    \@killglue
    \legacy_if:nTF { @twoside }
     {
      \int_if_odd:nTF { \c@page }
       {
         \flowfram_set_dim_to_frame_dim:Nnnn
            \l__flowfram_x_dim
            { flow } { posx } { #1 }
         \flowfram_set_dim_to_frame_dim:Nnnn
            \l__flowfram_y_dim
            { flow } { posy } { #1 }
       }
       {
         \flowfram_set_dim_to_frame_dim:Nnnn
            \l__flowfram_x_dim
            { flow } { evenx } { #1 }
         \flowfram_set_dim_to_frame_dim:Nnnn
            \l__flowfram_y_dim
            { flow } { eveny } { #1 }
       }
     }
     {
       \flowfram_set_dim_to_frame_dim:Nnnn
          \l__flowfram_x_dim
          { flow } { posx } { #1 }
       \flowfram_set_dim_to_frame_dim:Nnnn
          \l__flowfram_y_dim
          { flow } { posy } { #1 }
     }
    \__flowfram_get_margin_pos:e
     {
       \flowfram_frame_use_tl:nnn { flow } { margin } { #1 }
     }
    \tl_if_eq:NNTF \l__flowfram_margin_tl \c_flowfram_left_tl
    {
      \dim_add:Nn \l__flowfram_x_dim
        {
           - \marginparwidth
           - \marginparsep
        }
    }
    {
      \dim_add:Nn \l__flowfram_x_dim
       {
          \flowfram_frame_use_dim:nnn { flow } { width } { #1 }
          + \marginparsep
       }
    }
    \box_move_up:nn { \l__flowfram_y_dim  }
     {
       \hbox_to_zero:n
       {
         \kern \l__flowfram_x_dim
         \__flowfram_do_if_draft:nn
          {
            \__flowfram_noborder_box:nnn { \marginparwidth }
             {
               \flowfram_frame_use_dim:nnn { flow } { height } { #1 }
             }
             { }
          }
          {
            \flowfram_draft_annote:nn { M } { \int_eval:n { #1 } }
          }
          \hss
       }
     }
   }
  \ignorespaces
}
\cs_new:Nn \__flowfram_draw_margins:
 {
   \int_step_inline:nn { \c@maxflow }
    {
      \makebox [ \c_zero_dim ] [ l ]
       {
         \__flowframe_put_margin_box:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_do_static_box:n
 {
  \int_set:Nn \l__flowfram_current_static_int { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_frametype_tl
    { static } { frametype } { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_bordercolor_tl
    { static } { bordercolor } { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_backcolor_tl
    { static } { backcolor } { #1 }
  \__flowfram_static_calc_offset:n {#1}%
  \exp_args:Ne \rotateframe
    {
     \flowfram_frame_use_tl:nnn { static } { angle } { #1 }
    }
    {
       \flowfram_if_frame_bool:nnnTF
        { static } { hasframe } { #1 }
       {
          \__flowfram_bordered_box:nnnn
           {
              \flowfram_frame_use_dim:nnn { static } { width } { #1 }
           }
           {
             \flowfram_frame_use_dim:nnn { static } { height } { #1 }
           }
           {
             \flowfram_frame_use_box:nnn
              { static } { content } { #1 }
           }
           {
             \use:c { \l__flowfram_frametype_tl }
           }
       }
       {
        \__flowfram_noborder_box:nnn
         {
            \flowfram_frame_use_dim:nnn { static } { width } { #1 }
         }
         {
           \flowfram_frame_use_dim:nnn { static } { height } { #1 }
         }
         {
           \flowfram_frame_use_box:nnn
            { static } { content } { #1 }
         }
       }
   }
 }
\cs_new:Nn \__flowfram_do_static_bounding_box:n
 {
  \tl_clear:N \l__flowfram_bordercolor_tl
  \__flowfram_static_calc_offset:n { #1 }
  \__flowfram_do_if_draft:nn
   {
     \__flowfram_noborder_box:nnn
      {
        \flowfram_frame_use_dim:nnn { static } { width } { #1 }
      }
      {
        \flowfram_frame_use_dim:nnn { static } { height } { #1 }
      }
      {
        \flowfram_frame_use_box:nnn
          { static } { content } { #1 }
      }
   }
   {
     \flowfram_draft_annote:nnn
      { S } { \int_eval:n { #1 } }
      {
        \flowfram_frame_use_tl:nnn { static } { label } { #1 }
      }
   }
 }
\cs_new:Nn \__flowfram_put_static_box:n
 {
  \flowfram_if_frame_bool:nnnTF
    { static } { hidethis } { #1 }
   {
     \__flowfram_message:nen
       { info-static-frame-hidden } { \int_eval:n { #1 } } { hidethis }
     \bool_gset_true:N \g__flowfram_not_this_frame_bool
     \flowfram_frame_set_bool_false:nnn
       { static } { hidethis } { #1 }
   }
   {
     \flowfram_if_frame_bool:nnnTF
       { static } { hide } { #1 }
      {
        \__flowfram_message:nen
          { info-static-frame-hidden } { \int_eval:n { #1 } } { hide }
        \bool_gset_true:N \g__flowfram_not_this_frame_bool
      }
      {
        \__flowfram_static_check_if_this_page:n { #1 }
      }
   }
  \bool_if:NF \g__flowfram_not_this_frame_bool
   {
    \@killglue
    \legacy_if:nTF { @twoside }
     {
      \int_if_odd:nTF { \c@page }
       {
        \box_move_up:nn
         {
           \flowfram_frame_use_dim:nnn { static } { posy } { #1 }
         }
         {
           \hbox_to_zero:n
            {
              \kern
                \flowfram_frame_use_dim:nnn { static } { posx } { #1 }
              \__flowfram_do_static_box:n { #1 }
              \hss
            }
         }
       }
       {
        \box_move_up:nn
         {
           \flowfram_frame_use_dim:nnn { static } { eveny } { #1 }
         }
         {
           \hbox_to_zero:n
            {
              \kern
                \flowfram_frame_use_dim:nnn { static } { evenx } { #1 }
              \__flowfram_do_static_box:n { #1 }
              \hss
            }
         }
       }
     }
     {
      \box_move_up:nn
        {
          \flowfram_frame_use_dim:nnn { static } { posy } { #1 }
        }
        {
          \hbox_to_zero:n
           {
             \kern
               \flowfram_frame_use_dim:nnn { static } { posx } { #1 }
             \__flowfram_do_static_box:n { #1 }
             \hss
           }
        }
     }
   }
 }
\cs_new:Nn \__flowfram_put_static_bounding_box:n
{
  \flowfram_if_frame_bool:nnnTF
    { static } { hidethis } { #1 }
   {
     \bool_gset_true:N \g__flowfram_not_this_frame_bool
     \flowfram_frame_set_bool_false:nnn
       { static } { hidethis } { #1 }
   }
   {
     \flowfram_if_frame_bool:nnnTF
       { static } { hide } { #1 }
      {
        \bool_gset_true:N \g__flowfram_not_this_frame_bool
      }
      {
        \__flowfram_static_check_if_this_page:n { #1 }
      }
   }
  \bool_if:NF \g__flowfram_not_this_frame_bool
   {
    \@killglue
    \legacy_if:nTF { @twoside }
     {
      \int_if_odd:nTF { \c@page }
       {
        \box_move_up:nn
          {
            \flowfram_frame_use_dim:nnn { static } { posy } { #1 }
          }
          {
            \hbox_to_zero:n
             {
              \kern
                 \flowfram_frame_use_dim:nnn { static } { posx } { #1 }
              \__flowfram_do_static_bounding_box:n { #1 }
              \hss
             }
          }
       }
       {
         \box_move_up:nn
          {
            \flowfram_frame_use_dim:nnn { static } { eveny } { #1 }
          }
          {
            \hbox_to_zero:n
             {
               \kern
                 \flowfram_frame_use_dim:nnn { static } { evenx } { #1 }
               \__flowfram_do_static_bounding_box:n { #1 }
               \hss
             }
          }
       }
     }
     {
      \box_move_up:nn
       {
         \flowfram_frame_use_dim:nnn { static } { posy } { #1 }
       }
       {
         \hbox_to_zero:n
          {
            \kern
             \flowfram_frame_use_dim:nnn { static } { posx } { #1 }
            \__flowfram_do_static_bounding_box:n { #1 }
            \hss
          }
       }
     }
    \ignorespaces
   }
}
\cs_new:Nn \__flowfram_reset_statics:
 {
   \int_step_inline:nn { \c@maxstatic }
    {
      \flowfram_if_frame_bool:nnnT
         { static } { clear } { ##1 }
       {
          \flowfram_frame_clear_box:nnn
           { static } { content } { ##1 }
       }
    }
}
\cs_new:Nn \__flowfram_reset_dynamics:
 {
   \int_step_inline:nn { \c@maxdynamic }
    {
      \flowfram_if_frame_bool:nnnT
         { dynamic } { clear } { ##1 }
       {
          \flowfram_frame_clear_tl:nnn
           { dynamic } { content } { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_parbox:nnnn
 {
   \begin { minipage }  [ c ] [ #1 ] [ #2 ] { #3 }
   #4
   \end { minipage }
 }
\cs_generate_variant:Nn \__flowfram_parbox:nnnn { eeen }
\cs_new:Nn \__flowfram_do_dynamic_content:n
 {
   \flowfram_set_tl_to_frame_tl:Nnnn
     \l__flowfram_parindent_tl
     { dynamic } { parindent } { #1 }
   \flowfram_set_tl_to_frame_tl:Nnnn
     \l__flowfram_parshape_tl
     { dynamic } { shape } { #1 }
   \__flowfram_get_shape:V \l__flowfram_parshape_tl
  \int_case:nnF { \l__flowfram_shape_int }
   {
      { \c_flowfram_shape_type_parshape_int }
       {
          \__flowfram_parbox:eeen
           {
             \dynamicframeheight { #1 }
           }
           {
             \flowfram_frame_use_tl:nnn
              { dynamic } { valign } { #1 }
           }
           {
             \dynamicframewidth { #1 }
           }
          {
            \dim_set:Nn \parindent { \l__flowfram_parindent_tl }
            \use:c { \l__flowfram_style_tl }
              {
                 \__flowfram_set_shaped_section_headings:
                 \let \par \FLFsimpar
                 \l__flowfram_parshape_tl
                 \l__flowfram_contents_tl
                 \endgraf
              }
          }
       }
      { \c_flowfram_shape_type_shapepar_int }
        {
          \__flowfram_parbox:eeen
           {
             \dynamicframeheight { #1 }
           }
           {
             \flowfram_frame_use_tl:nnn
              { dynamic } { valign } { #1 }
           }
           {
             \dynamicframewidth { #1 }
           }
           {
             \dim_set:Nn \parindent { \l__flowfram_parindent_tl }
             \use:c { \l__flowfram_style_tl }
             {
               \@ff@disablesec
               \let \par \FLFsimpar
               \l__flowfram_parshape_tl
               \l__flowfram_contents_tl
               \endgraf
             }
           }
        }
   }
   {
      \__flowfram_parbox:eeen
       {
         \dynamicframeheight { #1 }
       }
       {
         \flowfram_frame_use_tl:nnn
          { dynamic } { valign } { #1 }
       }
       {
         \dynamicframewidth { #1 }
       }
       {
         \dim_set:Nn \parindent { \l__flowfram_parindent_tl }
         \use:c { \l__flowfram_style_tl }
             \l__flowfram_contents_tl
       }
   }
 }
\cs_new:Nn \__flowfram_do_dynamic_box:n
 {
  \int_set:Nn \l__flowfram_current_dynamic_int { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_frametype_tl
    { dynamic } { frametype } { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_bordercolor_tl
    { dynamic } { bordercolor } { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_textcolor_tl
    { dynamic } { textcolor } { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_backcolor_tl
    { dynamic } { backcolor } { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_style_tl
    { dynamic } { style } { #1 }
  \flowfram_set_tl_to_frame_tl:Nnnn
    \l__flowfram_contents_tl
    { dynamic } { content } { #1 }
  \__flowfram_dynamic_calc_offset:n {#1}%
  \exp_args:Ne \rotateframe
    {
      \flowfram_frame_use_tl:nnn { dynamic } { angle } { #1 }
    }
    {
       \flowfram_if_frame_bool:nnnTF
        { dynamic } { hasframe } { #1 }
       {
          \__flowfram_bordered_box:nnnn
           {
              \flowfram_frame_use_dim:nnn { dynamic } { width } { #1 }
           }
           {
              \flowfram_frame_use_dim:nnn { dynamic } { height } { #1 }
           }
           {
              \__flowfram_do_dynamic_content:n { #1 }
           }
           {
             \use:c { \l__flowfram_frametype_tl }
           }
       }
       {
         \__flowfram_noborder_box:nnn
          {
             \flowfram_frame_use_dim:nnn { dynamic } { width } { #1 }
          }
          {
             \flowfram_frame_use_dim:nnn { dynamic } { height } { #1 }
          }
          {
             \__flowfram_do_dynamic_content:n { #1 }
          }
       }
    }
}
\cs_new:Nn \__flowfram_do_dynamic_bounding_box:n
 {
   \tl_clear:N \l__flowfram_bordercolor_tl
   \__flowfram_dynamic_calc_offset:n { #1 }
   \__flowfram_do_if_draft:nn
     {
       \__flowfram_noborder_box:nnn
        {
           \flowfram_frame_use_dim:nnn { dynamic } { width } { #1 }
        }
        {
           \flowfram_frame_use_dim:nnn { dynamic } { height } { #1 }
        }
        {
          \__flowfram_parbox:eeen
           {
             \dynamicframeheight { #1 }
           }
           {
             \flowfram_frame_use_tl:nnn
              { dynamic } { valign } { #1 }
           }
           {
             \dynamicframewidth { #1 }
           }
           { }
        }
    }
    {
      \flowfram_draft_annote:nnn
       { D } { \int_eval:n { #1 } }
       {
         \flowfram_frame_use_tl:nnn { dynamic } { label } { #1 }
       }
    }
 }
\cs_new:Nn \__flowfram_put_dynamic_box:n
 {
  \flowfram_if_frame_bool:nnnTF
    { dynamic } { hidethis } { #1 }
   {
     \__flowfram_message:nen
       { info-dynamic-frame-hidden } { \int_eval:n { #1 } } { hidethis }
     \bool_gset_true:N \g__flowfram_not_this_frame_bool
     \flowfram_frame_set_bool_false:nnn
       { dynamic } { hidethis } { #1 }
   }
   {
     \flowfram_if_frame_bool:nnnTF
       { dynamic } { hide } { #1 }
      {
        \__flowfram_message:nen
          { info-dynamic-frame-hidden } { \int_eval:n { #1 } } { hide }
        \bool_gset_true:N \g__flowfram_not_this_frame_bool
      }
      {
        \__flowfram_dynamic_check_if_this_page:n { #1 }
      }
   }
  \bool_if:NF \g__flowfram_not_this_frame_bool
   {
    \@killglue
    \legacy_if:nTF { @twoside }
     {
      \int_if_odd:nTF { \c@page }
       {
         \box_move_up:nn
          {
            \flowfram_frame_use_dim:nnn { dynamic } { posy } { #1 }
          }
          {
            \hbox_to_zero:n
             {
               \kern
                \flowfram_frame_use_dim:nnn { dynamic } { posx } { #1 }
               \__flowfram_do_dynamic_box:n { #1 }
               \hss
             }
          }
       }
       {
        \box_move_up:nn
         {
           \flowfram_frame_use_dim:nnn { dynamic } { eveny } { #1 }
         }
         {
           \hbox_to_zero:n
            {
              \kern
               \flowfram_frame_use_dim:nnn { dynamic } { evenx } { #1 }
              \__flowfram_do_dynamic_box:n { #1 }
              \hss
            }
         }
       }
     }
     {
      \box_move_up:nn
       {
         \flowfram_frame_use_dim:nnn { dynamic } { posy } { #1 }
       }
       {
         \hbox_to_zero:n
          {
            \kern
              \flowfram_frame_use_dim:nnn { dynamic } { posx } { #1 }
            \__flowfram_do_dynamic_box:n { #1 }
            \hss
          }
       }
     }
    \ignorespaces
   }
 }
\cs_new:Nn \__flowfram_put_dynamic_bounding_box:n
 {
  \flowfram_if_frame_bool:nnnTF
    { dynamic } { hidethis } { #1 }
   {
     \bool_gset_true:N \g__flowfram_not_this_frame_bool
     \flowfram_frame_set_bool_false:nnn
       { dynamic } { hidethis } { #1 }
   }
   {
     \flowfram_if_frame_bool:nnnTF
       { dynamic } { hide } { #1 }
      {
        \bool_gset_true:N \g__flowfram_not_this_frame_bool
      }
      {
        \__flowfram_dynamic_check_if_this_page:n { #1 }
      }
   }
  \bool_if:NF \g__flowfram_not_this_frame_bool
   {
    \@killglue
    \legacy_if:nTF { @twoside }
     {
      \int_if_odd:nTF { \c@page }
       {
        \box_move_up:nn
         {
           \flowfram_frame_use_dim:nnn { dynamic } { posy } { #1 }
         }
         {
           \hbox_to_zero:n
            {
              \kern
                \flowfram_frame_use_dim:nnn { dynamic } { posx } { #1 }
              \__flowfram_do_dynamic_bounding_box:n { #1 }
              \hss
            }
         }
       }
       {
        \box_move_up:nn
         {
           \flowfram_frame_use_dim:nnn { dynamic } { eveny } { #1 }
         }
         {
           \hbox_to_zero:n
            {
              \kern
                \flowfram_frame_use_dim:nnn { dynamic } { evenx } { #1 }
              \__flowfram_do_dynamic_bounding_box:n { #1 }
              \hss
            }
         }
       }
     }
     {
      \box_move_up:nn
       {
         \flowfram_frame_use_dim:nnn { dynamic } { posy } { #1 }
       }
       {
         \hbox_to_zero:n
          {
            \kern
              \flowfram_frame_use_dim:nnn { dynamic } { posx } { #1 }
            \__flowfram_do_dynamic_bounding_box:n { #1 }
            \hss
          }
       }
     }
    \ignorespaces
   }
 }
\cs_new:Nn \__flowfram_do_standard_header:
 {
   \box_move_up:nn
     {
       \typeblockheight + \headsep
     }
     {
       \vbox_to_ht:nn { \headheight }
        {
          \hbox_to_zero:n
           {
             \@dothehead \hss
           }
          \vss
        }
     }
 }
\cs_new:Nn \__flowfram_do_standard_footer:
 {
   \box_move_down:nn
     { \footskip }
     {
       \hbox_to_zero:n
        {
          \@dothefoot \hss
        }
     }
 }
\box_new:N \l__all_content_box
\dim_new:N \l__all_content_height_dim
\cs_new:Nn \__flowfram_set_frames:n
 {
   \group_begin:
     \dim_set_eq:NN \l__all_content_height_dim \typeblockheight
     \setbox
        \l__all_content_box
        \hbox_to_wd:nn
          { \typeblockwidth }
          {
            \hbox:n { #1 }
            \hss
          }
     \ht \l__all_content_box
         \l__all_content_height_dim
     \dp \l__all_content_box \c_zero_dim
     \mbox
      {
        \box_use_drop:N \l__all_content_box
      }
   \group_end:
 }
\cs_new:Nn \__flowfram_do_all_flow_frames:
 {
   \int_step_function:nN { \c@maxflow }
      \__flowfram_put_flow_box:n
 }
\cs_new:Nn \__flowfram_do_all_flow_bounding_boxes:
 {
   \int_step_function:nN { \c@maxflow }
     \__flowfram_put_flow_bounding_box:n
 }
\cs_new:Nn \__flowfram_do_all_static_frames:
 {
   \int_step_function:nN { \c@maxstatic }
    \__flowfram_put_static_box:n
   \int_zero:N \l__flowfram_current_static_int
 }
\cs_new:Nn \__flowfram_do_all_static_bounding_boxes:
 {
   \int_step_function:nN { \c@maxstatic }
    \__flowfram_put_static_bounding_box:n
}
\cs_new:Nn \__flowfram_do_all_dynamic_frames:
 {
   \int_step_function:nN { \c@maxdynamic }
    \__flowfram_put_dynamic_box:n
   \int_zero:N \l__flowfram_current_dynamic_int
 }
\cs_new:Nn \__flowfram_do_all_dynamic_bounding_boxes:
 {
   \int_step_function:nN { \c@maxdynamic }
    \__flowfram_put_dynamic_bounding_box:n
 }
\cs_new:Nn \__flowfram_do_typeblock:
 {
  \makebox [ \c_zero_dim ] [ l ]
   {
     \__flowfram_do_if_draft:nnn
      { \setffdrafttypeblockcolor }
      {
        \vbox_to_ht:nn { \typeblockheight }
         {
           \hbox_to_wd:nn \typeblockwidth { }
         }
      }
      { }
   }
}
\cs_new:Nn \__flowfram_do_all_frames:
 {
   \hbox_to_wd:nn { \typeblockwidth }
    {
      \__flowfram_set_frames:n
       {
         \__flowfram_do_all_static_frames:
         \__flowfram_do_standard_header:
         \__flowfram_do_standard_footer:
         \__flowfram_do_all_flow_frames:
         \__flowfram_do_all_dynamic_frames:
         \ifshowtypeblock
           \__flowfram_do_typeblock:
         \fi
         \ifshowframebbox
           \__flowfram_do_all_static_bounding_boxes:
           \__flowfram_do_all_flow_bounding_boxes:
           \__flowfram_do_all_dynamic_bounding_boxes:
         \fi
         \ifshowmargins
           \__flowfram_draw_margins:
         \fi
       }
      \hss
    }
 }
\int_new:N \g__flowfram_next_frame_int
\renewcommand*\@outputdblcol
 {
   \__flowfram_output_dbl_col:
 }
\cs_new:Nn \__flowfram_output_dbl_col:
 {
  \int_gset_eq:NN \g__flowfram_next_frame_int \c@thisframe
  \int_gset:Nn \g__flowfram_current_page_int
     { \g__flowfram_pagecounter_tl }
  \__flowfram_get_next_column:N \g__flowfram_next_frame_int
  \bool_if:NTF \g__flowfram_new_page_bool
   {
    \global \@firstcolumntrue
    \__flowfram_set_column_box:n { \c@thisframe }
    \legacy_if:nT { @specialpage }
     {
      \global \@specialpagefalse
      \@nameuse { ps@ \@specialstyle }
      \relax
     }
    \@dodynamicthehead
    \@dodynamicthefoot
    \vbadness=\@M
    \setbox \@outputbox
       \vbox_to_ht:nn { \typeblockheight }
         {
           \__flowfram_do_all_frames:
         }
    \@combinedblfloats
    \@outputpage
    \int_gadd:Nn \g__flowfram_current_page_int
      { - \g__flowfram_pagecounter_tl }
    \bool_while_do:nn
     {
       \int_compare_p:nNn
          { \g__flowfram_current_page_int } > { \c_zero_int }
     }
    {
      \int_gdecr:N \g__flowfram_current_page_int
      \setbox \@outputbox
       \vbox_to_ht:nn { \typeblockheight }
         {
           \__flowfram_do_all_frames:
         }
      \@outputpage
    }
    \begingroup
      \@dblfloatplacement
      \@startdblcolumn
      \@whilesw \if@fcolmade \fi
         {\@outputpage \@startdblcolumn }%
    \endgroup
    \__flowfram_reset_statics:
    \__flowfram_reset_dynamics:
  }
  {
    \global \@firstcolumnfalse
    \__flowfram_set_column_box:n { \c@thisframe }
  }
  \int_gset_eq:NN \c@thisframe \g__flowfram_next_frame_int
  \__flowfram_set_column:n { \c@thisframe }
}
\newcommand \@flowfram@update@col@count [ 1 ]
 {
   \int_gset_eq:NN \col@number \c_one_int
   \int_step_inline:nnn
      { #1 + \c_one_int } { \c@maxflow }
    {
       \exp_args:Ne
       \flowfram_if_in_frame_clist:nnnnF
          { \int_eval:n { \g__flowfram_pagecounter_tl } }
          { flow } { excludelist } { ##1 }
        {
          \exp_args:Ne
          \flowfram_if_frame_has_morepages:nnnT
            { \int_eval:n { \g__flowfram_pagecounter_tl } }
            { flow } { ##1 }
          {
            \int_gincr:N \col@number
          }
        }
    }
   \int_compare:nNnT
      { \col@number } > { \c_one_int }
    {
      \global\@twocolumntrue
    }
 }
\NewDocumentCommand \flowswitchonnext { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
         \__flowfram_get_flow_id:n { ##1 }
         \__flowfram_flow_switch_on_next:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
         \__flowfram_flow_switch_on_next:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_flow_switch_on_next:n
 {
    \__flowfram_check_if_this_page:nn
       { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
      \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
       {
         \exp_not:N \flowsetpagelist
          { \int_eval:n { #1 } }
          { > \int_eval:n { \g__flowfram_pagecounter_tl } }
       }
     }
     {
      \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
       {
         \exp_not:N \flowsetpagelist
           { \int_eval:n { #1 } }
           { \int_eval:n { \g__flowfram_pagecounter_tl } ,
             > \int_eval:n { \g__flowfram_pagecounter_tl }
           }
       }
     }
 }
\NewDocumentCommand \flowswitchonnextodd { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl }
   \int_if_odd:nT { \l__flowfram_tmpb_int }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_flow_id:n { ##1 }
          \__flowfram_flow_switch_on_next_odd:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_flow_switch_on_next_odd:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_flow_switch_on_next_odd:n
 {
    \__flowfram_check_if_this_page:nn
       { \g__flowfram_pagecounter_tl } { #1 }
    \clist_clear:N \l__flowfram_pages_clist
    \bool_if:NF \g__flowfram_not_this_frame_bool
     {
       \clist_put_right:Ne \l__flowfram_pages_clist
         { \int_eval:n { \g__flowfram_pagecounter_tl } }
     }
    \__flowfram_check_if_this_page:nn { \l__flowfram_tmpb_int } { #1 }
    \int_compare:nNnF
        { \l__flowfram_tmpb_int } { \g__flowfram_pagecounter_tl }
      {
        \bool_if:NF \g__flowfram_not_this_frame_bool
         {
           \clist_put_right:Ne \l__flowfram_pages_clist
             { \int_eval:n { \l__flowfram_tmpb_int } }
         }
      }
    \clist_put_right:Ne \l__flowfram_pages_clist
        { > \int_eval:n { \l__flowfram_tmpb_int } }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
      {
        \exp_not:N \flowsetpagelist
          { \int_eval:n { #1 } }
          { \clist_use:Nn \l__flowfram_pages_clist { , } }
      }
 }
\NewDocumentCommand \flowswitchoffnext { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_flow_id:n { ##1 }
          \__flowfram_flow_switch_off_next:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_flow_switch_off_next:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_flow_switch_off_next:n
 {
    \__flowfram_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
       \clist_set:Nn \l__flowfram_pages_clist { none }
     }
     {
       \tl_set:Ne \l__flowfram_pages_clist
         {
           \int_eval:n { \g__flowfram_pagecounter_tl }
         }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
      {
        \exp_not:N \flowsetpagelist
          { \int_eval:n { #1 } }
          { \l__flowfram_pages_clist }
      }
 }
\NewDocumentCommand \flowswitchoffnextodd { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
      { \g__flowfram_pagecounter_tl }
   \int_if_odd:nT { \g__flowfram_pagecounter_tl }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_flow_id:n { ##1 }
          \__flowfram_flow_switch_off_next_odd:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_flow_switch_off_next_odd:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_flow_switch_off_next_odd:n
 {
    \__flowfram_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
      \int_compare:nNnTF
        { \g__flowfram_pagecounter_tl } = { \l__flowfram_tmpb_int }
       {
         \tl_set:Nn \l__flowfram_next_pages_tl { none }
       }
       {
        \__flowfram_check_if_this_page:nn
          { \l__flowfram_tmpb_int } { #1 }
        \bool_if:NTF \g__flowfram_not_this_frame_bool
         {
           \tl_set:Nn \l__flowfram_next_pages_tl { none }
         }
         {
           \tl_set:Ne \l__flowfram_next_pages_tl
             { \int_use:N \l__flowfram_tmpb_int }
         }
       }
    }
    {
      \int_compare:nNnTF
        { \g__flowfram_pagecounter_tl } = { \l__flowfram_tmpb_int }
       {
         \tl_set:Ne \l__flowfram_next_pages_tl
           { \int_eval:n { \g__flowfram_pagecounter_tl } }
       }
       {
        \__flowfram_check_if_this_page:nn
           { \l__flowfram_tmpb_int } { #1 }
        \bool_if:NTF \g__flowfram_not_this_frame_bool
         {
           \tl_set:Ne \l__flowfram_next_pages_tl
             { \int_eval:n { \g__flowfram_pagecounter_tl } }
         }
         {
          \tl_set:Ne \l__flowfram_next_pages_tl
            {
              \int_eval:n { \g__flowfram_pagecounter_tl } ,
              \int_use:N \l__flowfram_tmpb_int
            }
         }
       }
    }
   \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \flowsetpagelist
         { \int_eval:n { #1 } }
         { \l__flowfram_next_pages_tl }
     }
 }
\NewDocumentCommand \flowswitchonnextonly { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl + \c_one_int }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_flow_id:n { ##1 }
          \__flowfram_flow_switch_on_next_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_flow_switch_on_next_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_flow_switch_on_next_only:n
 {
    \__flowfram_check_if_this_page:nn
       { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
       \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
        {
           \exp_not:N \flowsetpagelist
            { \int_eval:n { #1 } }
            { \int_use:N \l__flowfram_tmpb_int }
        }
     }
     {
       \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
        {
           \exp_not:N \flowsetpagelist
            { \int_eval:n { #1 } }
            {
              \int_eval:n { \g__flowfram_pagecounter_tl } ,
              \int_use:N \l__flowfram_tmpb_int
            }
        }
     }
 }
\NewDocumentCommand \flowswitchonnextoddonly { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_flow_id:n { ##1 }
          \__flowfram_flow_switch_on_next_odd_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_flow_switch_on_next_odd_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_flow_switch_on_next_odd_only:n
 {
    \__flowfram_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
      \int_if_odd:nTF { \g__flowfram_pagecounter_tl }
       {
         \int_set:Nn \l__flowfram_tmpb_int
           { \g__flowfram_pagecounter_tl + \c_one_int }
         \__flowfram_check_if_this_page:nn
           { \l__flowfram_tmpb_int } { #1 }
         \bool_if:NTF \g__flowfram_not_this_frame_bool
          {
            \int_incr:N \l__flowfram_tmpb_int
            \clist_set:Ne \l__flowfram_pages_clist
             { \int_use:N \l__flowfram_tmpb_int }
          }
          {
            \clist_set:Ne \l__flowfram_pages_clist
              { \int_use:N \l__flowfram_tmpb_int }
            \int_incr:N \l__flowfram_tmpb_int
            \clist_put_right:Ne \l__flowfram_pages_clist
              { \int_use:N \l__flowfram_tmpb_int }
          }
       }
       {
         \int_set:Nn \l__flowfram_tmpb_int
           { \g__flowfram_pagecounter_tl }
         \int_incr:N \l__flowfram_tmpb_int
         \clist_set:Ne \l__flowfram_pages_clist
          { \int_use:N \l__flowfram_tmpb_int }
       }
     }
     {
      \int_if_odd:nTF { \g__flowfram_pagecounter_tl }
       {
         \int_set:Nn \l__flowfram_tmpb_int
          {
            \g__flowfram_pagecounter_tl + \c_one_int
          }
         \__flowfram_check_if_this_page:nn
           { \l__flowfram_tmpb_int } { #1 }
         \bool_if:NTF \g__flowfram_not_this_frame_bool
          {
            \int_incr:N \l__flowfram_tmpb_int
            \clist_set:Ne \l__flowfram_pages_clist
             {
               \int_eval:n { \g__flowfram_pagecounter_tl } ,
               \int_use:N \l__flowfram_tmpb_int
             }
          }
          {
            \int_incr:N \l__flowfram_tmpb_int
            \clist_set:Ne \l__flowfram_pages_clist
              {
                \int_eval:n { \g__flowfram_pagecounter_tl } -
                \int_use:N \l__flowfram_tmpb_int
              }
          }
       }
       {
         \int_set:Nn \l__flowfram_tmpb_int
           {
             \g__flowfram_pagecounter_tl + \c_one_int
           }
         \clist_set:Ne \l__flowfram_pages_clist
           {
             \int_eval:n { \g__flowfram_pagecounter_tl } ,
             \int_use:N \l__flowfram_tmpb_int
           }
       }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \flowsetpagelist
         { \int_eval:n { #1 } }
         { \l__flowfram_pages_clist }
     }
 }
\NewDocumentCommand \flowswitchoffnextonly { s m }
{
   \int_set:Nn \l__flowfram_tmpb_int
     {
      \g__flowfram_pagecounter_tl + \c_one_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_flow_id:n { ##1 }
          \__flowfram_flow_switch_off_next_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_flow_switch_off_next_only:n { ##1 }
       }
    }
}
\cs_new:Nn \__flowfram_flow_switch_off_next_only:n
 {
   \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
    {
       \exp_not:N \flowaddexclusion
        { \int_eval:n { #1 } }
        { \int_use:N \l__flowfram_tmpb_int }
    }
 }
\NewDocumentCommand \flowswitchoffnextoddonly { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     {
       \g__flowfram_pagecounter_tl + \c_one_int
     }
   \int_if_odd:nF { \l__flowfram_tmpb_int }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_flow_id:n { ##1 }
          \__flowfram_flow_switch_off_next_odd_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_flow_switch_off_next_odd_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_flow_switch_off_next_odd_only:n
 {
   \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \flowaddexclusion
         { \int_eval:n { #1 } }
         { \int_use:N \l__flowfram_tmpb_int }
     }
 }
\NewDocumentCommand \dynamicswitchonnext { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_on_next:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_on_next:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_dynamic_switch_on_next:n
 {
    \__flowfram_dynamic_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
      \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
       {
          \exp_not:N \dynamicsetpagelist
           { \int_eval:n { #1 } }
           { > \int_eval:n { \g__flowfram_pagecounter_tl } }
       }
     }
     {
      \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
       {
         \exp_not:N \dynamicsetpagelist
           { \int_eval:n { #1 } }
           {
             \int_eval:n { \g__flowfram_pagecounter_tl } ,
             > \int_eval:n { \g__flowfram_pagecounter_tl }
           }
       }
     }
 }
\NewDocumentCommand \dynamicswitchonnextodd { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl }
   \int_if_odd:nT { \l__flowfram_tmpb_int }
     {
       \int_incr:N \l__flowfram_tmpb_int
     }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_on_next_odd:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_on_next_odd:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_dynamic_switch_on_next_odd:n
 {
    \__flowfram_dynamic_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \clist_clear:N \l__flowfram_pages_clist
    \bool_if:NF \g__flowfram_not_this_frame_bool
     {
       \clist_set:Ne \l__flowfram_pages_clist
        { \int_use:n { \g__flowfram_pagecounter_tl } }
     }
    \__flowfram_dynamic_check_if_this_page:nn
      { \l__flowfram_tmpb_int } { #1 }
    \int_compare:nNnF
      { \l__flowfram_tmpb_int } = { \g__flowfram_pagecounter_tl }
     {
       \bool_if:NF \g__flowfram_not_this_frame_bool
        {
           \clist_put_right:Ne \l__flowfram_pages_clist
            { \int_eval:n { \l__flowfram_tmpb_int } }
        }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \dynamicsetpagelist
        { \int_eval:n { #1 }}
        {
           \l__flowfram_pages_clist
            > \int_use:N \l__flowfram_tmpb_int
        }
     }
 }
\NewDocumentCommand \dynamicswitchoffnext { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_off_next:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_off_next:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_dynamic_switch_off_next:n
 {
    \__flowfram_dynamic_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
       \clist_set:Nn \l__flowfram_pages_clist { none }
     }
     {
       \clist_set:Ne \l__flowfram_pages_clist
        { \int_eval:n { \g__flowfram_pagecounter_tl } }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \dynamicsetpagelist
        { \int_eval:n { #1 } }
        { \l__flowfram_pages_clist }
     }
 }
\NewDocumentCommand \dynamicswitchoffnextodd { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl }
   \int_if_odd:nT { \g__flowfram_pagecounter_tl }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_off_next_odd:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_off_next_odd:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_dynamic_switch_off_next_odd:n
 {
    \__flowfram_dynamic_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl }  { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
       \int_compare:nNnTF
         { \g__flowfram_pagecounter_tl } = { \l__flowfram_tmpb_int }
        {
          \tl_set:Nn \l__flowfram_next_pages_tl { none }
        }
        {
          \__flowfram_dynamic_check_if_this_page:nn
            { \l__flowfram_tmpb_int } { #1 }
          \bool_if:NTF \g__flowfram_not_this_frame_bool
           {
             \tl_set:Nn \l__flowfram_next_pages_tl { none }
           }
           {
              \tl_set:Ne \l__flowfram_next_pages_tl
                { \int_use:N \l__flowfram_tmpb_int }
           }
        }
     }
     {
       \int_compare:nNnTF
          { \g__flowfram_pagecounter_tl } = { \l__flowfram_tmpb_int }
        {
          \tl_set:Ne \l__flowfram_next_pages_tl
           { \int_use:n { \g__flowfram_pagecounter_tl } }
        }
        {
          \__flowfram_dynamic_check_if_this_page:nn
            { \l__flowfram_tmpb_int } { #1 }
          \bool_if:NTF \g__flowfram_not_this_frame_bool
            {
              \tl_set:Ne \l__flowfram_next_pages_tl
                { \int_eval:n { \g__flowfram_pagecounter_tl } }
            }
            {
              \tl_set:Ne \l__flowfram_next_pages_tl
                {
                  \int_eval:n { \g__flowfram_pagecounter_tl } ,
                  \int_use:N \l__flowfram_tmpb_int
                }
            }
        }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \dynamicsetpagelist
        { \int_eval:n { #1 } }
        { \l__flowfram_next_pages_tl }
     }
 }
\NewDocumentCommand \dynamicswitchonnextonly { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl + \c_one_int }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_on_next_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_on_next_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_dynamic_switch_on_next_only:n
 {
    \__flowfram_dynamic_check_if_this_page:nn
     { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
      \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
       {
         \exp_not:N \dynamicsetpagelist
          { \int_eval:n { #1 } }
          { \int_use:N \l__flowfram_tmpb_int }
       }
     }
     {
      \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
       {
         \exp_not:N \dynamicsetpagelist
           { \int_eval:n { #1 } }
           {
             \int_eval:n { \g__flowfram_pagecounter_tl } ,
             \int_use:N \l__flowfram_tmpb_int
           }
       }
     }
 }
\NewDocumentCommand \dynamicswitchonnextoddonly { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_on_next_odd_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_on_next_odd_only:n { ##1 }
       }
    }
}
\cs_new:Nn \__flowfram_dynamic_switch_on_next_odd_only:n
 {
    \__flowfram_dynamic_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
      \int_if_odd:nTF { \g__flowfram_pagecounter_tl }
       {
        \int_set:Nn \l__flowfram_tmpb_int
          { \g__flowfram_pagecounter_tl + \c_one_int }
        \__flowfram_dynamic_check_if_this_page:nn
          { \l__flowfram_tmpb_int } { #1 }
        \bool_if:NTF \g__flowfram_not_this_frame_bool
         {
           \int_incr:N \l__flowfram_tmpb_int
           \clist_set:Ne \l__flowfram_pages_clist
             { \int_use:N \l__flowfram_tmpb_int }
         }
         {
           \clist_set:Ne \l__flowfram_pages_clist
             { \int_use:N \l__flowfram_tmpb_int }
           \int_inc:N \l__flowfram_tmpb_int
           \clist_put_right:Ne \l__flowfram_pages_clist
             { \int_use:N \l__flowfram_tmpb_int }
         }
       }
       {
         \int_set:Nn \l__flowfram_tmpb_int
           { \g__flowfram_pagecounter_tl + \c_one_int }
         \clist_set:Ne \l__flowfram_pages_clist
           { \int_use:N \l__flowfram_tmpb_int }
       }
     }
     {
       \int_if_odd:nTF { \g__flowfram_pagecounter_tl }
        {
          \int_set:Nn \l__flowfram_tmpb_int
            { \g__flowfram_pagecounter_tl + \c_one_int }
          \__flowfram_dynamic_check_if_this_page:nn
            { \l__flowfram_tmpb_int } { #1 }
          \bool_if:NTF \g__flowfram_not_this_frame_bool
           {
             \int_incr:N \l__flowfram_tmpb_int
             \clist_set:Ne \l__flowfram_pages_clist
               {
                 \int_eval:n { \g__flowfram_pagecounter_tl } ,
                 \int_use:N \l__flowfram_tmpb_int
               }
           }
           {
             \int_incr:N \l__flowfram_tmpb_int
             \clist_set:Ne \l__flowfram_pages_clist
              {
                \int_eval:n { \g__flowfram_pagecounter_tl } -
                \int_use:N \l__flowfram_tmpb_int
              }
           }
        }
        {
          \int_set:Nn \l__flowfram_tmpb_int
            { \g__flowfram_pagecounter_tl + \c_one_int }
          \clist_set:Ne \l__flowfram_pages_clist
            {
              \int_eval:n { \g__flowfram_pagecounter_tl } ,
              \int_use:N \l__flowfram_tmpb_int
            }
        }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \dynamicsetpagelist
        { \int_eval:n { #1 } }
        { \l__flowfram_pages_clist }
     }
 }
\NewDocumentCommand \dynamicswitchoffnextonly { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl + \c_one_int }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_off_next_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_off_next_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_dynamic_switch_off_next_only:n
 {
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \dynamicaddexclusion
        { \int_eval:n { #1 } }
        { \int_use:N \l__flowfram_tmpb_int }
     }
 }
\NewDocumentCommand \dynamicswitchoffnextoddonly { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl + \c_one_int }
   \int_if_odd:nF { \l__flowfram_tmpb_int }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_dynamic_id:n { ##1 }
          \__flowfram_dynamic_switch_off_next_odd_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_dynamic_switch_off_next_odd_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_dynamic_switch_off_next_odd_only:n
 {
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \dynamicaddexclusion
        { \int_eval:n { #1 } }
        { \int_use:N \l__flowfram_tmpb_int }
     }
 }
\NewDocumentCommand \staticswitchonnext { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_on_next:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_on_next:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_on_next:n
 {
    \__flowfram_static_check_if_this_page:nn
       { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
      {
        \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
         {
           \exp_not:N \staticsetpagelist
            { \int_eval:n { #1 } }
            { > \int_eval:n { \g__flowfram_pagecounter_tl } }
         }
      }
      {
        \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
         {
           \exp_not:N \staticsetpagelist
             { \int_eval:n { #1 } }
             {
               \int_eval:n { \g__flowfram_pagecounter_tl } ,
               > \int_eval:n { \g__flowfram_pagecounter_tl }
             }
         }
      }
 }
\NewDocumentCommand \staticswitchonnextodd { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl }
   \int_if_odd:nT { \l__flowfram_tmpb_int }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_on_next_odd:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_on_next_odd:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_on_next_odd:n
 {
    \__flowfram_static_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \clist_clear:N \l__flowfram_pages_clist
    \bool_if:NF \g__flowfram_not_this_frame_bool
     {
       \clist_put_right:Ne \l__flowfram_pages_clist
        { \int_eval:n { \g__flowfram_pagecounter_tl } }
     }
    \__flowfram_static_check_if_this_page:nn
       { \l__flowfram_tmpb_int } { #1 }
    \int_compare:nNnF
        { \l__flowfram_tmpb_int } = { \g__flowfram_pagecounter_tl }
      {
        \bool_if:NF \g__flowfram_not_this_frame_bool
         {
           \clist_put_right:Ne \l__flowfram_pages_clist
            { \int_use:N \l__flowfram_tmpb_int }
         }
      }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
      {
        \exp_not:N \staticsetpagelist
         { \int_eval:n { #1 } }
         {
           \l__flowfram_pages_clist ,
           > \int_use:N \l__flowfram_tmpb_int
         }
      }
 }
\NewDocumentCommand \staticswitchoffnext { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_off_next:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_off_next:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_off_next:n
 {
    \__flowfram_static_check_if_this_page:nn
       { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
       \clist_set:Nn \l__flowfram_pages_clist { none }
     }
     {
       \clist_set:Ne \l__flowfram_pages_clist
         { \int_eval:n { \g__flowfram_pagecounter_tl } }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \staticsetpagelist
        { \int_eval:n { #1 } }
        { \l__flowfram_pages_clist }
     }
 }
\NewDocumentCommand \staticswitchoffnextodd { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl }
   \int_if_odd:nT { \g__flowfram_pagecounter_tl }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_off_next_odd:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_off_next_odd:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_off_next_odd:n
 {
    \__flowfram_static_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
       \int_compare:nNnTF
         { \g__flowfram_pagecounter_tl } = { \l__flowfram_tmpb_int }
        {
          \tl_set:Nn \l__flowfram_next_pages_tl { none }
        }
        {
          \__flowfram_static_check_if_this_page:nn
            { \l__flowfram_tmpb_int } { #1 }
          \bool_if:NTF \g__flowfram_not_this_frame_bool
           {
             \tl_set:Nn \l__flowfram_next_pages_tl { none }
           }
           {
             \tl_set:Ne \l__flowfram_next_pages_tl
               { \int_use:N \l__flowfram_tmpb_int }
           }
        }
     }
     {
       \int_compare:nNnTF
         { \g__flowfram_pagecounter_tl } = { \l__flowfram_tmpb_int }
        {
          \tl_set:Ne \l__flowfram_next_pages_tl
            { \int_eval:n { \g__flowfram_pagecounter_tl } }
        }
        {
          \__flowfram_static_check_if_this_page:nn
            { \l__flowfram_tmpb_int } { #1 }
          \bool_if:NTF \g__flowfram_not_this_frame_bool
           {
             \tl_set:Ne \l__flowfram_next_pages_tl
                { \int_eval:n { \g__flowfram_pagecounter_tl } }
           }
           {
             \tl_set:Ne \l__flowfram_next_pages_tl
               {
                 \int_eval:n { \g__flowfram_pagecounter_tl } ,
                 \int_use:N \l__flowfram_tmpb_int
               }
           }
        }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \staticsetpagelist
         { \int_eval:n { #1 } }
         { \l__flowfram_next_pages_tl }
     }
 }
\NewDocumentCommand \staticswitchonnextonly { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl + \c_one_int }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_on_next_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_on_next_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_on_next_only:n
 {
    \__flowfram_static_check_if_this_page:nn
      { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
        \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
         {
           \exp_not:N \staticsetpagelist
             { \int_eval:n { #1 } }
             { \int_use:N \l__flowfram_tmpb_int }
         }
     }
     {
       \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
        {
          \exp_not:N \staticsetpagelist
            { \int_eval:n { #1 } }
            {
              \int_eval:n { \g__flowfram_pagecounter_tl } ,
              \int_use:N \l__flowfram_tmpb_int
            }
        }
     }
 }
\NewDocumentCommand \staticswitchonnextoddonly { s m }
 {
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_on_next_odd_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_on_next_odd_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_on_next_odd_only:n
 {
    \__flowfram_static_check_if_this_page:nn
       { \g__flowfram_pagecounter_tl } { #1 }
    \bool_if:NTF \g__flowfram_not_this_frame_bool
     {
       \int_if_odd:nTF { \g__flowfram_pagecounter_tl }
        {
          \int_set:Nn \l__flowfram_tmpb_int
            { \g__flowfram_pagecounter_tl + \c_one_int }
          \__flowfram_static_check_if_this_page:nn
            { \l__flowfram_tmpb_int } { #1 }
          \bool_if:NTF \g__flowfram_not_this_frame_bool
           {
             \int_incr:N \l__flowfram_tmpb_int
             \clist_set:Ne \l__flowfram_pages_clist
                { \int_use:N \l__flowfram_tmpb_int }
           }
           {
             \clist_set:Ne \l__flowfram_pages_clist
               { \int_use:N \l__flowfram_tmpb_int }
             \int_incr:N \l__flowfram_tmpb_int
             \clist_put_right:Ne \l__flowfram_pages_clist
               {
                  \int_use:N \l__flowfram_tmpb_int
               }
           }
        }
        {
          \int_set:Nn \l__flowfram_tmpb_int
            { \g__flowfram_pagecounter_tl + \c_one_int }
          \clist_set:Ne \l__flowfram_pages_clist
            { \int_use:N \l__flowfram_tmpb_int }
        }
     }
     {
       \int_if_odd:nTF { \g__flowfram_pagecounter_tl }
        {
          \int_set:Nn \l__flowfram_tmpb_int
            { \g__flowfram_pagecounter_tl + \c_one_int }
          \__flowfram_static_check_if_this_page:nn
            { \l__flowfram_tmpb_int } { #1 }
          \bool_if:NTF \g__flowfram_not_this_frame_bool
           {
             \int_incr:N \l__flowfram_tmpb_int
             \clist_set:Ne \l__flowfram_pages_clist
               {
                 \int_eval:n { \g__flowfram_pagecounter_tl } ,
                 \int_use:N \l__flowfram_tmpb_int
               }
           }
           {
            \int_incr:N \l__flowfram_tmpb_int
            \clist_set:Ne \l__flowfram_pages_clist
              {
                \int_eval:n { \g__flowfram_pagecounter_tl } -
                \int_use:N \l__flowfram_tmpb_int
              }
           }
        }
        {
          \int_set:Nn \l__flowfram_tmpb_int
            { \g__flowfram_pagecounter_tl + \c_one_int }
          \clist_set:Ne \l__flowfram_pages_clist
            {
              \int_eval:n { \g__flowfram_pagecounter_tl } ,
              \int_use:N \l__flowfram_tmpb_int
            }
        }
     }
    \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
     {
       \exp_not:N \staticsetpagelist
         { \int_eval:n { #1 } }
         { \l__flowfram_pages_clist }
     }
 }
\NewDocumentCommand \staticswitchoffnextonly { s m }
 {
    \int_set:Nn \l__flowfram_tmpb_int
      { \g__flowfram_pagecounter_tl + \c_one_int }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_off_next_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_off_next_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_off_next_only:n
 {
   \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
    {
      \exp_not:N \staticaddexclusion
        { \int_eval:n { #1 } }
        { \int_use:N \l__flowfram_tmpb_int }
    }
 }
\NewDocumentCommand \staticswitchoffnextoddonly { s m }
 {
   \int_set:Nn \l__flowfram_tmpb_int
     { \g__flowfram_pagecounter_tl + \c_one_int }
   \int_if_odd:nF { \l__flowfram_tmpb_int }
    {
      \int_incr:N \l__flowfram_tmpb_int
    }
   \IfBooleanTF { #1 }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_get_static_id:n { ##1 }
          \__flowfram_static_switch_off_next_odd_only:n { \l__flowfram_id_int }
       }
    }
    {
      \clist_map_inline:nn { #2 }
       {
          \__flowfram_static_switch_off_next_odd_only:n { ##1 }
       }
    }
 }
\cs_new:Nn \__flowfram_static_switch_off_next_odd_only:n
 {
   \tl_gput_right:Ne \g__flowfram_output_adjust_frames_tl
    {
      \exp_not:N \staticaddexclusion
        { \int_eval:n { #1 } }
        { \int_use:N \l__flowfram_tmpb_int }
    }
 }
\newenvironment{statictable}
 {\par\def\@captype{table}\ignorespaces}
 {\par\ignorespacesafterend}
\newenvironment{staticfigure}
 {\def\@captype{figure}\ignorespaces}
 {\par\ignorespacesafterend}
\newif\ifffvadjust
\ffvadjusttrue
\cs_set_eq:NN \__flowfram_org_onecolumn: \onecolumn
\RenewDocumentCommand \onecolumn { O{all} o }
 {
   \__flowfram_only_preamble:Nn \onecolumn
    {
      \__flowfram_one_column:n { #1 }
      \IfValueT { #2 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #2 }
       }
    }
 }
\cs_new:Nn \__flowfram_one_column:n
 {
   \__flowfram_one_column_in_area:nnnnn
    { #1 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
 }
\NewDocumentCommand \onecolumninarea { O { all } m m m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumninarea
    {
      \__flowfram_one_column_in_area:nnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 }
      \IfValueT { #6 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #6 }
       }
    }
 }
\cs_new:Nn \__flowfram_one_column_in_area:nnnnn
 {
  \dim_set:Nn \l__flowfram_height_dim { #3 }
  \ifffvadjust
    \adjustheight \l__flowfram_height_dim
  \fi
  \__flowfram_new_flow:nnnnn
     { #1 } { #2 } { \l__flowfram_height_dim } { #4 } { #5 }
  \tl_if_empty:NT \g__flowfram_one_col_id_tl
   {
     \tl_gset:Ne \g__flowfram_one_col_id_tl { \int_use:N \c@maxflow }
   }
 }
\cs_set_eq:NN \__flowfram_org_twocolumn: \twocolumn
\RenewDocumentCommand \twocolumn { O { all } o }
 {
   \__flowfram_only_preamble:Nn \twocolumn
    {
      \__flowfram_two_columns:n { #1 }
      \IfValueT { #2 }
       {
         \clist_set:Ne \l__flowfram_tmp_clist { #2 }
         \int_compare:nNnTF
           { \clist_count:N \l__flowfram_tmp_clist } = { 2 }
          {
            \__flowfram_set_frame_id:nnn { flow } { \c@maxflow }
              { \clist_item:Nn \l__flowfram_tmp_clist { 2 } }
            \__flowfram_set_frame_id:nnn { flow }
              { \int_eval:n { \c@maxflow - \c_one_int } }
              { \clist_item:Nn \l__flowfram_tmp_clist { 1 } }
          }
          {
            \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #2 }
          }
       }
    }
 }
\cs_new:Nn \__flowfram_two_columns:n
 {
   \__flowfram_two_columns_in_area:nnnnn
    { #1 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
 }
\NewDocumentCommand \twocolumninarea { O{all} m m m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumninarea
    {
      \__flowfram_two_columns_in_area:nnnnn
        { #1 } { #2 } { #3 } { #4 } { #5 }
      \IfValueT { #6 }
       {
         \clist_set:Ne \l__flowfram_tmp_clist { #6 }
         \int_compare:nNnTF
           { \clist_count:N \l__flowfram_tmp_clist } = { 2 }
          {
            \__flowfram_set_frame_id:nnn { flow } { \c@maxflow }
              { \clist_item:Nn \l__flowfram_tmp_clist { 2 } }
            \__flowfram_set_frame_id:nnn { flow }
              { \int_eval:n { \c@maxflow - \c_one_int } }
              { \clist_item:Nn \l__flowfram_tmp_clist { 1 } }
          }
          {
            \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #6 }
          }
       }
    }
 }
\cs_new:Nn \__flowfram_two_columns_in_area:nnnnn
 {
  \dim_set:Nn \l__flowfram_height_dim { #3 }
  \ifffvadjust
    \adjustheight \l__flowfram_height_dim
  \fi
  \dim_set:Nn \l__flowfram_width_dim { ( #2 - \columnsep ) / 2 }
  \dim_set:Nn \l__flowfram_x_dim
    {
      #4 + \l__flowfram_width_dim + \columnsep
    }
  \iflefttorightcolumns
    \__flowfram_new_flow:nnnnn
     { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim } { #4 } { #5 }
    \setflowframe{\c@maxflow}{margin=left}%
  \else
    \__flowfram_new_flow:nnnnn
     { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
     { \l__flowfram_x_dim  } { #5 }
    \setflowframe{\c@maxflow}{margin=right}%
  \fi
  \iflefttorightcolumns
    \__flowfram_new_flow:nnnnn
    { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
    { \l__flowfram_x_dim  } { #5 }
    \setflowframe{\c@maxflow}{margin=right}%
  \else
    \__flowfram_new_flow:nnnnn
     { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
     { #4 } { #5 }
    \setflowframe{\c@maxflow}{margin=left}%
  \fi
   \cs_if_eq:NNT
      \flowfram_set_two_col:
      \__flowfram_set_two_col_warning:
    {
      \cs_set:Ne \flowfram_set_two_col:
       {
         \exp_not:N \setallflowframes{pages=none}
         \exp_not:N \__flowfram_set_flow_by_idn:nn
           { \int_eval:n { \c@maxflow - \c_one_int } } { pages=all }
         \exp_not:N \__flowfram_set_flow_by_idn:nn
           { \int_use:N \c@maxflow } { pages=all }
       }
    }
  \bool_lazy_and:nnT
    {
      \tl_if_empty_p:N \g__flowfram_two_col_i_id_tl
    }
    {
      \tl_if_empty_p:N \g__flowfram_two_col_ii_id_tl
    }
   {
     \tl_gset:Ne \g__flowfram_two_col_i_id_tl
       {
         \int_eval:n { \c@maxflow - \c_one_int }
       }
     \tl_gset:Ne \g__flowfram_two_col_ii_id_tl { \int_use:N \c@maxflow }
   }
}
\NewDocumentCommand \Ncolumn { O{ all } m o }
 {
   \__flowfram_only_preamble:Nn \Ncolumn
    {
     \Ncolumninarea
        [ #1 ] { #2 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
     \IfValueT { #3 }
      {
       \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
      }
    }
 }
\NewDocumentCommand \Ncolumninarea { O { all } m m m m m o }
 {
   \__flowfram_only_preamble:Nn \Ncolumninarea
    {
      \int_case:nnF { #2 }
       {
         { \c_one_int }
          {
            \__flowfram_one_column_in_area:nnnnn
            { #1 } { #3 } { #4 } { #5 } { #6 }
          }
         { 2 }
          {
            \__flowfram_two_columns_in_area:nnnnn
              { #1 } { #3 } { #4 } { #5 } { #6 }
          }
       }
       {
         \int_compare:nNnTF { #2 } < { \c_one_int }
          {
            \msg_error:nnne { flowfram } { invalid-num-frames }
              { flow } { \int_eval:n { #2 } }
          }
          {
            \__flowfram_n_columns_in_area:nnnnnn
              { #1 } { #2 } { #3 } { #4 } { #5 } { #6 }
          }
       }
     \IfValueT { #7 }
      {
        \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
      }
    }
 }
\cs_new:Nn \__flowfram_n_columns_in_area:nnnnnn
 {
  \int_set:Nn \l__flowfram_col_int { #2 - \c_one_int }
  \dim_set:Nn \l__flowfram_width_dim
   {
     ( #3 - \l__flowfram_col_int \columnsep ) / ( #2 )
   }
  \dim_set:Nn \l__flowfram_x_dim { #5 }
  \iflefttorightcolumns
  \else
    \dim_add:Nn \l__flowfram_x_dim { #3 - \l__flowfram_width_dim }
  \fi
  \dim_set:Nn \l__flowfram_height_dim { #4 }
  \ifffvadjust
    \adjustheight \l__flowfram_height_dim
  \fi
  \int_step_inline:nn { #2 }
   {
      \__flowfram_new_flow:nnnnn
         { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
         { \l__flowfram_x_dim } { #6 }
      \iflefttorightcolumns
        \dim_add:Nn \l__flowfram_x_dim { \l__flowfram_width_dim + \columnsep }
      \else
        \dim_add:Nn \l__flowfram_x_dim { - \l__flowfram_width_dim - \columnsep }
      \fi
   }
}
\newlength{\vcolumnsep}
\setlength{\vcolumnsep}{\columnsep}
\NewDocumentCommand \onecolumntop { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumntop
    {
      \__flowfram_one_column_with_top_in_area:nnnnnnn
        { #1 } { #2 } { #3 }{ \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
 }
\NewDocumentCommand \onecolumnStop { O {all } m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnStop
    {
      \__flowfram_one_column_with_top_in_area:nnnnnnn
        { #1 } { static } { #2 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \onecolumnDtop { O { all } m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnDtop
    {
      \__flowfram_one_column_with_top_in_area:nnnnnnn
        { #1 } { dynamic } { #2 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \newframe { s O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \newframe
    {
      \cs_if_exist:cTF
         { __flowfram_new_ #3 :nnnnnn }
       {
         \IfValueTF { #8 }
          {
            \use:c { __flowfram_new_ #3 :nnnnnn }
             { #2 } { #4 } { #5 } { #6 } { #7 } { #8 }
          }
          {
            \use:c { __flowfram_new_ #3 :nnnnnn }
             { #2 } { #4 } { #5 } { #6 } { #7 } { \int_use:c { c@max #3 } }
          }
        \IfBooleanT { #1 }
          {
            \flowfram_frame_set_bool_true:nnnn
              { #3 } { hasframe } { \value { max #3 } }
          }
       }
       {
         \msg_error:nne { flowfram } { invalid-frame-type } { #3 }
       }
    }
 }
\NewDocumentCommand \onecolumntopinarea { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumntopinarea
    {
      \__flowfram_one_column_with_top_in_area:nnnnnnn
        { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
 }
\cs_new:Nn \__flowfram_one_column_with_top_in_area:nnnnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #3 }
  \dim_set:Nn \l__flowfram_y_dim
    { #5 - \l__flowfram_sfdf_height_dim }
  \dim_set:Nn \l__flowfram_height_dim
    { \l__flowfram_y_dim - \vcolumnsep }
  \dim_add:Nn \l__flowfram_y_dim { #7 }
  \newframe
     [ #1 ] { #2 }
     { #4 } { \l__flowfram_sfdf_height_dim }
     { #6 } { \l__flowfram_y_dim }
  \ifffvadjust
    \adjustheight \l__flowfram_height_dim
  \fi
  \__flowfram_new_flow:nnnnn
    { #1 } { #4 } { \l__flowfram_height_dim } { #6 } { #7 }
}
\NewDocumentCommand \onecolumnStopinarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnStopinarea
    {
      \__flowfram_one_column_with_top_in_area:nnnnnnn
        { #1 } { static } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \onecolumnDtopinarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnStopinarea
    {
      \__flowfram_one_column_with_top_in_area:nnnnnnn
        { #1 } { dynamic } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \twocolumntop { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumntop
    {
      \__flowfram_two_column_top_in_area:nnnnnnn
       { #1 } { #2 } { #3 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
 }
\NewDocumentCommand \twocolumnStop { O{all} m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnStop
    {
      \__flowfram_two_column_with_top_in_area:nnnnnnn
       { #1 } { static }{ #2 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \twocolumnDtop { O{all} m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnDtop
    {
      \__flowfram_two_column_with_top_in_area:nnnnnnn
       { #1 } { dynamic }{ #2 } { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \twocolumntopinarea { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumntopinarea
    {
      \__flowfram_two_column_with_top_in_area:nnnnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
 }
\cs_new:Nn \__flowfram_two_column_with_top_in_area:nnnnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #3 }
  \dim_set:Nn \l__flowfram_y_dim
    { #5 - \l__flowfram_sfdf_height_dim }
  \dim_set:Nn \l__flowfram_height_dim
    { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_y_dim { #7 }
  \newframe
    [ #1 ] { #2 }
    { #4 } { \l__flowfram_sfdf_height_dim }
    { #6 } { \l__flowfram_y_dim }
  \tl_if_empty:NT \g__flowfram_two_col_header_id_tl
   {
     \bool_lazy_and:nnT
       {
         \tl_if_empty_p:N \g__flowfram_headed_two_col_i_id_tl
       }
       {
         \tl_if_empty_p:N \g__flowfram_headed_two_col_ii_id_tl
       }
      {
       \tl_gset:Ne \g__flowfram_two_col_header_type_tl { #2 }
       \tl_gset:Ne \g__flowfram_two_col_header_id_tl
        {
          \int_use:c { c@max #2 }
        }
     }
   }
  \dim_sub:Nn \l__flowfram_height_dim { \vcolumnsep }
  \ifffvadjust
     \adjustheight { \l__flowfram_height_dim }
  \fi
  \dim_set:Nn \l__flowfram_width_dim
    { ( #4 - \columnsep ) / 2 }
  \dim_set:Nn \l__flowfram_x_dim
    { \l__flowfram_width_dim + \columnsep + #6 }
  \iflefttorightcolumns
    \__flowfram_new_flow:nnnnn
      { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim } { #6 } { #7 }
    \setflowframe { \c@maxflow } { margin = left }
    \__flowfram_new_flow:nnnnn
     { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim } { \l__flowfram_x_dim } { #7 }
    \setflowframe { \c@maxflow } { margin = right }
  \else
    \__flowfram_new_flow:nnnnn
     { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim } { \l__flowfram_x_dim } { #7 }
    \setflowframe { \c@maxflow } { margin = right }
    \__flowfram_new_flow:nnnnn
     { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim } { #6 } { #7 }
    \setflowframe { \c@maxflow } { margin = left }
  \fi
  \bool_lazy_and:nnT
    {
      \tl_if_empty_p:N \g__flowfram_headed_two_col_i_id_tl
    }
    {
      \tl_if_empty_p:N \g__flowfram_headed_two_col_ii_id_tl
    }
   {
     \tl_gset:Ne \g__flowfram_headed_two_col_i_id_tl
       {
         \int_eval:n { \c@maxflow - \c_one_int }
       }
     \tl_gset:Ne \g__flowfram_headed_two_col_ii_id_tl { \int_use:N \c@maxflow }
   }
}
\NewDocumentCommand \twocolumnStopinarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnStopinarea
    {
      \__flowfram_two_column_with_top_in_area:nnnnnnn
       { #1 } { static } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \twocolumnDtopinarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnStopinarea
    {
      \__flowfram_two_column_with_top_in_area:nnnnnnn
       { #1 } { dynamic } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \Ncolumntop { O{all} m m m o }
 {
   \__flowfram_only_preamble:Nn \Ncolumntop
    {
      \__flowfram_n_column_with_top_in_area:nnnnnnnn
       { #1 } { #2 } { #3 } { #4 }
       { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #5 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #5 }
       }
    }
 }
\NewDocumentCommand \NcolumnStop { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnStop
    {
      \__flowfram_n_column_with_top_in_area:nnnnnnnn
       { #1 } { static} { #2 } { #3 }
       { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
 }
\NewDocumentCommand \NcolumnDtop { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnDtop
    {
      \__flowfram_n_column_with_top_in_area:nnnnnnnn
       { #1 } { dynamic} { #2 } { #3 }
       { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
}
\NewDocumentCommand \Ncolumntopinarea { O{all} m m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \Ncolumntopinarea
    {
      \__flowfram_n_column_with_top_in_area:nnnnnnnn
       { #1 } { #2 } { #4 } { #5 } { #6 } { #7 } { #8 }
      \IfValueT { #9 }
       {
        \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #9 }
      }
    }
 }
\cs_new:Nn \__flowfram_n_column_with_top_in_area:nnnnnnnn
 {
    \int_case:nnF { #3 }
      {
         { \c_one_int }
           {
             \__flowfram_one_column_with_top_in_area:nnnnnnn
              { #1 } { #2 } { #4 } { #5 } { #6 } { #7 } { #8 }
           }
         { 2 }
           {
             \__flowfram_two_column_with_top_in_area:nnnnnnn
              { #1 } { #2 } { #4 } { #5 } { #6 } { #7 } { #8 }
           }
      }
      {
        \int_compare:nNnTF { #3 } < { \c_one_int }
          {
            \msg_error:nnne { flowfram } { invalid-num-frames }
              { flow } { \int_eval:n { #3 } }
          }
          {
            \__flowfram_N_column_with_top_in_area:nnnnnnnn
              { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 }
          }
      }
}
\cs_new:Nn \__flowfram_N_column_with_top_in_area:nnnnnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #4 }
  \dim_set:Nn \l__flowfram_y_dim
    { #6 - \l__flowfram_sfdf_height_dim }
  \dim_set_eq:NN \l__flowfram_height_dim \l__flowfram_y_dim
  \dim_add:Nn \l__flowfram_y_dim { #8 }
  \newframe
    [ #1 ] { #2 }
    { #5 } { \l__flowfram_sfdf_height_dim }
    { #7 } { \l__flowfram_y_dim }
  \dim_sub:Nn \l__flowfram_height_dim { \vcolumnsep }
  \ifffvadjust
    \adjustheight{\l__flowfram_height_dim}%
  \fi
  \int_set:Nn \l__flowfram_col_int { #3 - \c_one_int }
  \dim_set:Nn \l__flowfram_width_dim
     { ( #5 -\l__flowfram_col_int \columnsep ) / ( #3 ) }
  \dim_set:Nn \l__flowfram_x_dim { #7 }
  \iflefttorightcolumns
  \else
    \dim_add:Nn \l__flowfram_x_dim { #5 - \l__flowfram_width_dim }
  \fi
  \int_step_inline:nn { #3 }
   {
     \__flowfram_new_flow:nnnnn
      { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
      { \l__flowfram_x_dim } { #8 }
    \iflefttorightcolumns
      \dim_add:Nn \l__flowfram_x_dim { \l__flowfram_width_dim + \columnsep }
    \else
      \dim_add:Nn \l__flowfram_x_dim { - \l__flowfram_width_dim - \columnsep }
    \fi
   }
}
\NewDocumentCommand \NcolumnStopinarea { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnStopinarea
    {
      \__flowfram_n_column_with_top_in_area:nnnnnnnn
        { #1 } { static } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
 }
\NewDocumentCommand \NcolumnDtopinarea { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnDtopinarea
    {
      \__flowfram_n_column_with_top_in_area:nnnnnnnn
        { #1 } { dynamic } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
 }
\NewDocumentCommand \onecolumnbottom { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnbottom
    {
      \__flowfram_one_column_with_bottom_in_area:nnnnnnn
        { #1 } { #2 } { #3 }
        { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
 }
\NewDocumentCommand \onecolumnSbottom { O{all} m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnbottom
    {
      \__flowfram_one_column_with_bottom_in_area:nnnnnnn
        { #1 } { static } { #2 }
        { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \onecolumnDbottom { O{all} m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnbottom
    {
      \__flowfram_one_column_with_bottom_in_area:nnnnnnn
        { #1 } { dynamic } { #2 }
        { \typeblockwidth } { \typeblockheight } { 0pt } { 0pt }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \onecolumnbottominarea
  { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnbottominarea
    {
      \__flowfram_one_column_with_bottom_in_area:nnnnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
          \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
 }
\cs_new:Nn \__flowfram_one_column_with_bottom_in_area:nnnnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #3 }
  \dim_set:Nn \l__flowfram_height_dim
    {
      #5
      - \l__flowfram_sfdf_height_dim
      - \vcolumnsep
    }
  \ifffvadjust
    \adjustheight { \l__flowfram_height_dim }
  \fi
  \dim_set:Nn \l__flowfram_tmpa_dim
    {
      #5 - \l__flowfram_height_dim + #7
    }
  \newframe [ #1 ] { #2 }
     { #4 } { \l__flowfram_sfdf_height_dim }
     { #6 } { #7 }
  \__flowfram_new_flow:nnnnn
    { #1 } { #4 } { \l__flowfram_height_dim } { #6 } { \l__flowfram_tmpa_dim }
}
\NewDocumentCommand \onecolumnSbottominarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnSbottominarea
    {
      \__flowfram_one_column_with_bottom_in_area:nnnnnnn
       { #1 } { static } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \onecolumnDbottominarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \onecolumnDbottominarea
    {
      \__flowfram_one_column_with_bottom_in_area:nnnnnnn
       { #1 } { dynamic } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \twocolumnbottom { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnbottom
    {
      \__flowfram_two_column_with_bottom_in_area:nnnnnnn
        { #1 } { #2 } { #3 } { \typeblockwidth } { \typeblockheight }
        { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
 }
\NewDocumentCommand \twocolumnSbottom { O{all} m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnDbottom
    {
      \__flowfram_two_column_with_bottom_in_area:nnnnnnn
        { #1 } { static } { #2 }
         { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \twocolumnDbottom { O{all} m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnDbottom
    {
      \__flowfram_two_column_with_bottom_in_area:nnnnnnn
        { #1 } { dynamic } { #2 }
         { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #3 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #3 }
       }
    }
 }
\NewDocumentCommand \twocolumnbottominarea { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnbottominarea
    {
      \__flowfram_two_column_with_bottom_in_area:nnnnnnn
        { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
 }
\cs_new:Nn \__flowfram_two_column_with_bottom_in_area:nnnnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_width_dim { #4 }
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #3 }
  \dim_set:Nn \l__flowfram_height_dim
    { #5 - \l__flowfram_sfdf_height_dim - \vcolumnsep }
  \ifffvadjust
    \adjustheight { \l__flowfram_height_dim }
  \fi
  \newframe
   [ #1 ] { #2 }
   { \l__flowfram_sfdf_width_dim } { \l__flowfram_sfdf_height_dim }
   { #6 } { #7 }
  \dim_set:Nn \l__flowfram_y_dim { #5 - \l__flowfram_height_dim + #7 }
  \dim_set:Nn \l__flowfram_width_dim
   {
     ( \l__flowfram_sfdf_width_dim - \columnsep ) /2
   }
  \dim_set:Nn \l__flowfram_x_dim
    {
      \l__flowfram_width_dim + \columnsep + #6
    }
  \iflefttorightcolumns
    \__flowfram_new_flow:nnnnn
      { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
      { #6 } { \l__flowfram_y_dim }
    \setflowframe{\c@maxflow}{margin=left}%
    \__flowfram_new_flow:nnnnn
      { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
      { \l__flowfram_x_dim } { \l__flowfram_y_dim }
    \setflowframe{\c@maxflow}{margin=right}%
  \else
    \__flowfram_new_flow:nnnnn
      { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
      { \l__flowfram_x_dim } { \l__flowfram_y_dim }
    \setflowframe{\c@maxflow}{margin=right}%
    \__flowfram_new_flow:nnnnn
      { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
      { #6 } { \l__flowfram_y_dim }
    \setflowframe{\c@maxflow}{margin=left}%
  \fi
}
\NewDocumentCommand \twocolumnSbottominarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnSbottominarea
    {
      \__flowfram_two_column_with_bottom_in_area:nnnnnnn
        { #1 } { static } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \twocolumnDbottominarea { O{all} m m m m m o }
 {
   \__flowfram_only_preamble:Nn \twocolumnDbottominarea
    {
      \__flowfram_two_column_with_bottom_in_area:nnnnnnn
        { #1 } { dynamic } { #2 } { #3 } { #4 } { #5 } { #6 }
      \IfValueT { #7 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #7 }
       }
    }
 }
\NewDocumentCommand \Ncolumnbottom { O{all} m m m o }
 {
   \__flowfram_only_preamble:Nn \Ncolumnbottominarea
    {
      \__flowfram_n_column_with_bottom_in_area:nnnnnnnn
        { #1 } { #2 } { #3 } { #4 }
        { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #5 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #5 }
       }
    }
 }
\NewDocumentCommand \NcolumnSbottom { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnSbottom
    {
      \__flowfram_n_column_with_bottom_in_area:nnnnnnnn
        { #1 } { static } { #2 } { #3 }
        { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
 }
\NewDocumentCommand \NcolumnDbottom { O{all} m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnDbottom
    {
      \__flowfram_n_column_with_bottom_in_area:nnnnnnnn
        { #1 } { dynamic } { #2 } { #3 }
        { \typeblockwidth } { \typeblockheight } { \c_zero_dim } { \c_zero_dim }
      \IfValueT { #4 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #4 }
       }
    }
 }
\NewDocumentCommand \Ncolumnbottominarea { O{all} m m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \Ncolumnbottominarea
    {
      \__flowfram_n_column_with_bottom_in_area:nnnnnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 }
      \IfValueT { #9 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #9 }
       }
    }
 }
\cs_new:Nn \__flowfram_n_column_with_bottom_in_area:nnnnnnnn
 {
   \int_case:nnF { #3 }
    {
      { \c_one_int }
       {
         \__flowfram_one_column_with_bottom_in_area:nnnnnnn
          { #1 } { #2 } { #4 } { #5 } { #6 } { #7 } { #8 }
       }
      { 2 }
       {
         \__flowfram_two_column_with_bottom_in_area:nnnnnnn
          { #1 } { #2 } { #4 } { #5 } { #6 } { #7 } { #8 }
       }
    }
    {
      \int_compare:nNnTF { #3 } > { 2 }
       {
         \__flowfram_N_column_with_bottom_in_area:nnnnnnnn
          { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 }
       }
       {
         \msg_error:nnne { flowfram } { invalid-num-frames }
           { flow } { \int_eval:n { #3 } }
       }
    }
}
\cs_new:Nn \__flowfram_N_column_with_bottom_in_area:nnnnnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #4 }
  \dim_set:Nn \l__flowfram_height_dim
    { #6 - \l__flowfram_sfdf_height_dim - \vcolumnsep }
  \ifffvadjust
    \adjustheight { \l__flowfram_height_dim }
  \fi
  \newframe
    [ #1 ] { #2 }
    { #5 } { \l__flowfram_sfdf_height_dim } { #7 } { #8 }
  \dim_set:Nn \l__flowfram_y_dim
    { #6 - \l__flowfram_height_dim + #8 }
  \int_set:Nn \l__flowfram_col_int { #3 - \c_one_int }
  \dim_set:Nn \l__flowfram_width_dim
    { ( #5 -\l__flowfram_col_int \columnsep ) / ( #3 ) }
  \dim_set:Nn \l__flowfram_x_dim { #7 }
  \iflefttorightcolumns
  \else
    \dim_add:Nn \l__flowfram_x_dim { #5 - \l__flowfram_width_dim }
  \fi
  \int_step_inline:nn { #3 }
   {
    \__flowfram_new_flow:nnnnn
     { #1 } { \l__flowfram_width_dim } { \l__flowfram_height_dim }
     { \l__flowfram_x_dim } { \l__flowfram_y_dim }
    \iflefttorightcolumns
      \dim_add:Nn \l__flowfram_x_dim { \l__flowfram_width_dim + \columnsep }
    \else
      \dim_add:Nn \l__flowfram_x_dim { - \l__flowfram_width_dim -\columnsep }
    \fi
   }
}
\NewDocumentCommand \NcolumnSbottominarea { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnSbottominarea
    {
      \__flowfram_n_column_with_bottom_in_area:nnnnnnnn
       { #1 } { static } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
}
\NewDocumentCommand \NcolumnDbottominarea { O{all} m m m m m m o }
 {
   \__flowfram_only_preamble:Nn \NcolumnDbottominarea
    {
      \__flowfram_n_column_with_bottom_in_area:nnnnnnnn
       { #1 } { dynamic } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 }
      \IfValueT { #8 }
       {
         \__flowfram_set_frame_id:nnn { flow } { \c@maxflow } { #8 }
       }
    }
 }
\int_new:N \l__flowfram_adjust_height_int
\newcommand*{\adjustheight}[1]{%
  \int_set:Nn \l__flowfram_adjust_height_int
    {
      \int_div_round:nn
        { \dim_to_decimal_in_sp:n { #1 } }
        { \dim_to_decimal_in_sp:n { \baselineskip } }
    }
  \dim_set:Nn #1 { \l__flowfram_adjust_height_int \baselineskip }
}
\newcommand*{\adjustcolsep}{%
  \dim_set:Nn \columnsep { 2 \columnsep + \marginparwidth }
}
\NewDocumentCommand \vtwotone
  { O{all} O {\c_zero_dim} m m m m m m }
 {
   \__flowfram_only_preamble:Nn \vtwotone
    {
      \__flowfram_v_two_tone_bottom:nnnnnnnnn
       { #1 } { #2 } { \paperheight } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 }
    }
 }
\cs_new:Nn \__flowfram_v_two_tone_bottom:nnnnnnnnn
 {
  \computeleftedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computeleftedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_set_eq:NN \l__flowfram_evenx_dim \l__flowfram_x_dim
  \fi
  \computebottomedge { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_x_dim { #2 }
  \dim_add:Nn \l__flowfram_evenx_dim { #2 }
  \__flowfram_next_v_band:nnnnn { #1 } { #3 } { #4 } { #5 } { #6 }
  \__flowfram_next_v_band:nnnnn { #1 } { #3 } { #7 } { #8 } { #9 }
}
\NewDocumentCommand \vtwotonebottom
  { O{all} O {\c_zero_dim} m m m m m m m }
 {
   \__flowfram_only_preamble:Nn \vtwotonebottom
    {
      \__flowfram_v_two_tone_bottom:nnnnnnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 } { #9 }
    }
 }
\NewDocumentCommand \vtwotonetop
  { O{all} O {\c_zero_dim} m m m m m m m }
 {
   \__flowfram_only_preamble:Nn \vtwotonebottom
    {
      \__flowfram_v_two_tone_top:nnnnnnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 } { #9 }
    }
 }
\cs_new:Nn \__flowfram_v_two_tone_top:nnnnnnnnn
 {
  \computeleftedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computeleftedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_set:Nn \l__flowfram_evenx_dim { \l__flowfram_x_dim }
  \fi
  \computetopedge { \l__flowfram_y_dim }
  \dim_sub:Nn \l__flowfram_y_dim { #3 }
  \dim_add:Nn \l__flowfram_x_dim { #2 }
  \dim_add:Nn \l__flowfram_evenx_dim { #2 }
  \__flowfram_next_v_band:nnnnn { #1 } { #3 } { #4 } { #5 } { #6 }
  \__flowfram_next_v_band:nnnnn { #1 } { #3 } { #7 } { #8 } { #9 }
}
\cs_new:Nn \__flowfram_next_v_band:nnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_width_dim { #3 }
  \tl_if_empty:nTF { #5 }
   {
     \__flowfram_new_static:nnnnn
      { #1 } { \l__flowfram_sfdf_width_dim } { #2 }
      { \l__flowfram_x_dim } { \l__flowfram_y_dim }
   }
   {
     \__flowfram_new_static:nnnnnn
      { #1 } { \l__flowfram_sfdf_width_dim } { #2 }
      { \l__flowfram_x_dim } { \l__flowfram_y_dim } { #5 }
   }
  \flowfram_frame_set_dim:nnnn { static} { evenx } { \c@maxstatic }
       { \l__flowfram_evenx_dim }
  \__flowfram_set_frame_color:w
    #4 \q_stop { static } { backcolor } { \c@maxstatic }
  \dim_add:Nn \l__flowfram_x_dim { \l__flowfram_sfdf_width_dim }
  \dim_add:Nn \l__flowfram_evenx_dim { \l__flowfram_sfdf_width_dim }
 }
\int_new:N \l__flowfram_this_strip_int
\NewDocumentCommand \vNtone { O{all} O {\c_zero_dim} m }
 {
   \clist_set:Nn \l__flowfram_pages_clist { #1 }
   \__flowfram_v_N_tone_bottom:nnn  { #2 } { #3 } { \paperheight }
 }
\@onlypreamble{\vNtone}
\cs_new:Nn \__flowfram_v_N_tone_bottom:nnn
 {
  \computeleftedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computeleftedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_set_eq:NN \l__flowfram_evenx_dim \l__flowfram_x_dim
  \fi
  \computebottomedge { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_x_dim { #1 }
  \dim_add:Nn \l__flowfram_evenx_dim { #1 }
  \int_set:Nn \l__flowfram_this_strip_int { #2 }
  \dim_set:Nn\l__flowfram_sfdf_height_dim { #3 }
  \__flowfram_next_v_N_band:
 }
\cs_new:Nn \__flowfram_next_v_N_band:
 {
   \int_compare:nNnTF { \l__flowfram_this_strip_int } > { \c_zero_int }
    {
      \let \flf@next \@@nextvNband
    }
    {
      \let \flf@next \relax
    }
  \int_decr:N \l__flowfram_this_strip_int
  \flf@next
 }
\newcommand*{\@@nextvNband}[3]{%
  \__flowfram_next_v_band:nnnnn
    { \l__flowfram_pages_clist } { \l__flowfram_sfdf_height_dim }
    { #1 } { #2 } { #3 }
  \__flowfram_next_v_N_band:
}
\NewDocumentCommand \vNtonebottom { O{all} O{\c_zero_dim} m m }
{
  \clist_set:Nn \l__flowfram_pages_clist { #1 }
  \__flowfram_v_N_tone_bottom:nnn { #2 } { #3 } { #4 }
}
\@onlypreamble{\vNtonebottom}
\NewDocumentCommand \vNtonetop { O{all} O{\c_zero_dim} m m }
 {
  \clist_set:Nn \l__flowfram_pages_clist { #1 }
  \__flowfram_v_N_tone_top:nnn { #2 } { #3 } { #4 }
 }
\@onlypreamble{\vNtonetop}
\cs_new:Nn \__flowfram_v_N_tone_top:nnn
 {
  \computeleftedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computeleftedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_set_eq:NN \l__flowfram_evenx_dim \l__flowfram_x_dim
  \fi
  \computetopedge { \l__flowfram_y_dim }
  \dim_sub:Nn \l__flowfram_y_dim { #3 }
  \dim_add:Nn \l__flowfram_x_dim { #1 }
  \dim_add:Nn \l__flowfram_evenx_dim { #1 }
  \int_set:Nn \l__flowfram_this_strip_int { #2 }
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #3 }
  \__flowfram_next_v_N_band:
 }
\NewDocumentCommand \htwotone
  { O{all} O {\c_zero_dim} m m m m m m }
 {
   \__flowfram_only_preamble:Nn \htwotone
    {
      \__flowfram_h_two_tone_left:nnnnnnnnn
       { #1 } { #2 } { \paperwidth } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 }
    }
 }
\@onlypreamble{\htwotone}
\cs_new:Nn \__flowfram_h_two_tone_left:nnnnnnnnn
 {
  \computeleftedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computeleftedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_set:Nn \l__flowfram_evenx_dim { \l__flowfram_x_dim }
  \fi
  \computebottomedge { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_y_dim { #2 }
  \__flowfram_h_two_tone_left:nnnnnnnnn  { #1 } { #3 } { #4 } { #5 } { #6 }
  \__flowfram_h_two_tone_left:nnnnnnnnn  { #1 } { #3 } { #7 } { #8 } { #9 }
}

\NewDocumentCommand \htwotoneleft
  { O{all} O {\c_zero_dim} m m m m m m m }
 {
   \__flowfram_only_preamble:Nn \htwotoneleft
    {
      \__flowfram_h_two_tone_left:nnnnnnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 } { #9 }
    }
 }
\@onlypreamble{\htwotoneleft}
\NewDocumentCommand \htwotoneright
  { O{all} O {\c_zero_dim} m m m m m m m }
 {
   \__flowfram_only_preamble:Nn \htwotoneright
    {
      \__flowfram_h_two_tone_right:nnnnnnnnn
       { #1 } { #2 } { #3 } { #4 } { #5 } { #6 } { #7 } { #8 } { #9 }
    }
 }
\@onlypreamble{\htwotoneright}
\cs_new:Nn \__flowfram_h_two_tone_right:nnnnnnnnn
 {
  \computerightedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computerightedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_set:Nn \l__flowfram_evenx_dim { \l__flowfram_x_dim }
  \fi
  \computebottomedge { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_y_dim { #2 }
  \dim_sub:Nn \l__flowfram_x_dim { #3 }
  \dim_sub:Nn \l__flowfram_evenx_dim { #3 }
  \__flowfram_h_two_tone_left:nnnnnnnnn { #1 } { #3 } { #4 } { #5 } { #6 }
  \__flowfram_h_two_tone_left:nnnnnnnnn { #1 } { #3 } { #7 } { #8 } { #9 }
}
\NewDocumentCommand \hNtone { O{all} O {\c_zero_dim} m }
 {
   \clist_set:Nn \l__flowfram_pages_clist { #1 }
   \__flowfram_h_N_tone_left:nnn  { #2 } { #3 } { \paperwidth }
 }
\@onlypreamble{\hNtone}
\cs_new:Nn \__flowfram_h_N_tone_left:nnn
 {
  \computeleftedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computeleftedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_add:Nn \l__flowfram_evenx_dim { \l__flowfram_x_dim }
  \fi
  \computebottomedge { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_y_dim { #1 }
  \int_set:Nn \l__flowfram_this_strip_int { #2 }
  \dim_set:Nn l__flowfram_static_width_dim { #3 }
  \__flowfram_next_h_N_band:
}
\NewDocumentCommand \hNtoneleft { O{all} O {\c_zero_dim} m m }
 {
   \clist_set:Nn \l__flowfram_pages_clist { #1 }
   \__flowfram_h_N_tone_left:nnn  { #2 } { #3 } { #4 }
 }
\@onlypreamble{\hNtoneleft}
\NewDocumentCommand \hNtoneright { O{all} O {\c_zero_dim} m m }
 {
   \clist_set:Nn \l__flowfram_pages_clist { #1 }
   \__flowfram_h_N_tone_right:nnn  { #2 } { #3 } { #4 }
 }
\@onlypreamble{\hNtoneright}
\cs_new:Nn \__flowfram_h_N_tone_right:nnn
{
  \computerightedgeodd { \l__flowfram_x_dim }
  \if@twoside
    \computerightedgeeven { \l__flowfram_evenx_dim }
  \else
    \dim_set:Nn \l__flowfram_evenx_dim { \l__flowfram_x_dim }
  \fi
  \computebottomedge { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_y_dim { #1 }
  \dim_sub:Nn \l__flowfram_x_dim { #3 }
  \dim_sub:Nn \l__flowfram_evenx_dim { #3 }
  \int_set:Nn \l__flowfram_this_strip_int { #2 }
  \dim_set:Nn \l__flowfram_sfdf_width_dim { #3 }
  \__flowfram_next_h_N_band:
}
\cs_new:Nn \__flowfram_next_h_band:nnnnn
 {
  \dim_set:Nn \l__flowfram_sfdf_height_dim { #3 }
  \tl_if_empty:nTF { #5 }
   {
    \__flowfram_new_static:nnnnn
     { #1 } { #2 } { \l__flowfram_sfdf_height_dim }
     { \l__flowfram_x_dim } { \l__flowfram_y_dim }
   }
   {
    \__flowfram_new_static:nnnnnn
     { #1 } { #2 } { \l__flowfram_sfdf_height_dim }
     { \l__flowfram_x_dim } { \l__flowfram_y_dim }
   }
  \flowfram_frame_set_dim:nnnn { static} { evenx } { \c@maxstatic }
       { \l__flowfram_evenx_dim }
  \__flowfram_set_frame_color:w
    #4 \q_stop { static } { backcolor } { \c@maxstatic }
  \dim_add:Nn \l__flowfram_y_dim { \l__flowfram_sfdf_height_dim }
}
\cs_new:Nn \__flowfram_next_h_N_band:
 {
   \int_compare:nNnTF
      { \l__flowfram_this_strip_int } > { \c_zero_int }
    {
      \let \flf@next \@@nexthNband
    }
    {
      \let \flf@next \relax
    }
  \int_decr:N \l__flowfram_this_strip_int
  \flf@next
 }
\newcommand*{\@@nexthNband}[3]{%
  \__flowfram_h_two_tone_left:nnnnnnnnn
    { \l__flowfram_pages_clist } { \l__flowfram_sfdf_width_dim }
    { #1 } { #2 } { #3 }
  \__flowfram_next_h_N_band:
}
\NewDocumentCommand \makebackgroundframe { O{all} o }
 {
   \__flowfram_only_preamble:Nn \NcolumnDbottominarea
    {
      \int_if_zero:nF { \c@maxstatic }
       {
         \msg_warning:nn { flowfram } { background-not-first }
       }
      \computeleftedgeodd { \l__flowfram_x_dim }
      \if@twoside
        \computeleftedgeeven { \l__flowfram_evenx_dim }
      \else
        \dim_set:Nn \l__flowfram_evenx_dim { \l__flowfram_x_dim }
      \fi
      \computebottomedge { \l__flowfram_y_dim }
       \IfValueTF { #2 }
        {
          \__flowfram_new_static:nnnnnn
            { #1 } { \paperwidth }{ \paperheight }
            { \l__flowfram_x_dim } { \l__flowfram_y_dim }
            { #2 }
        }
        {
          \__flowfram_new_static:nnnnn
            { #1 } { \paperwidth } { \paperheight }
            { \l__flowfram_x_dim } { \l__flowfram_y_dim }
        }
      \flowfram_frame_set_dim:nnnn { static} { evenx } { \c@maxstatic }
        { \l__flowfram_evenx_dim }
   }
}
\newlength\ffcolumnseprule
\setlength{\ffcolumnseprule}{2pt}
\newcommand*{\ffruledeclarations}{}
\NewDocumentCommand \insertvrule
   { s O { \c_zero_dim } O { \c_zero_dim } m m m m }
 {
   \__flowfram_only_preamble:Nn \insertvrule
    {
      \__flowfram_get_frame_type:n { #4 }
      \__flowfram_get_frame_type:Nn
          \l__flowfram_type_ii_int
          { #6 }
      \bool_lazy_or:nnF
         {
           \int_compare_p:nNn
             { \l__flowfram_type_int } = { -\c_one_int }
         }
         {
           \int_compare_p:nNn
             { \l__flowfram_type_ii_int } = { -\c_one_int }
         }
       {
         \IfBooleanTF { #1 }
          {
            \use:c { __flowfram_get_ #6 _id:e } { #7 }
            \int_set_eq:NN \l__flowfram_id_ii_int \l__flowfram_id_int
            \use:c { __flowfram_get_ #4 _id:e } { #5 }
            \__flowfram_insert_v_rule:nnNnNn
              { #2 } { #3 }
              \l__flowfram_type_int { \l__flowfram_id_int }
              \l__flowfram_type_ii_int { \l__flowfram_id_ii_int }
          }
          {
            \__flowfram_insert_v_rule:nnNnNn
              { #2 } { #3 }
              \l__flowfram_type_int { #5 }
              \l__flowfram_type_ii_int { #7 }
          }
       }
    }
 }
\dim_new:N \l__flowfram_left_x_dim
\dim_new:N \l__flowfram_left_y_dim
\dim_new:N \l__flowfram_left_evenx_dim
\dim_new:N \l__flowfram_left_eveny_dim
\dim_new:N \l__flowfram_left_width_dim
\dim_new:N \l__flowfram_left_height_dim
\cs_new:Nn \__flowfram_insert_v_rule:nnNnNn
 {
  \__flowfram_get_frame_bounds_by_typeid:nn { #3 } { #4 }
  \dim_set_eq:NN \l__flowfram_left_x_dim \ffareax
  \dim_set_eq:NN \l__flowfram_left_y_dim \ffareay
  \dim_set_eq:NN \l__flowfram_left_width_dim \ffareawidth
  \dim_set_eq:NN \l__flowfram_left_height_dim \ffareaheight
  \__flowfram_get_frame_bounds_by_typeid:nn { #5 } { #6 }
  \dim_compare:nNnT
     { \l__flowfram_left_x_dim } > { \ffareax }
   {
     \__flowfram_swap_dim:NN \l__flowfram_left_x_dim \ffareax
     \__flowfram_swap_dim:NN \l__flowfram_left_y_dim \ffareax
     \__flowfram_swap_dim:NN \l__flowfram_left_evenx_dim \ffareaevenx
     \__flowfram_swap_dim:NN \l__flowfram_left_eveny_dim \ffareaevenx
     \__flowfram_swap_dim:NN \l__flowfram_left_width_dim \ffareawidth
     \__flowfram_swap_dim:NN \l__flowfram_left_height_dim \ffareaheight
   }
  \dim_set:Nn \l__flowfram_x_dim
    {
        \l__flowfram_left_x_dim
      + \l__flowfram_left_width_dim
    }
  \dim_set:Nn \l__flowfram_sfdf_width_dim
    {
       \ffareax - \l__flowfram_x_dim
    }
  \dim_set:Nn \l__flowfram_sfdf_height_dim
    {
        \l__flowfram_left_y_dim
      + \l__flowfram_left_height_dim
    }
  \dim_set:Nn \l__flowfram_y_dim
    {
      \ffareay + \ffareaheight
    }
  \dim_compare:nNnT
     { \l__flowfram_y_dim } > { \l__flowfram_sfdf_height_dim }
   {
     \dim_set_eq:NN \l__flowfram_sfdf_height_dim \l__flowfram_y_dim
   }
  \dim_compare:nNnTF
     { \l__flowfram_left_y_dim } < { \ffareay }
   {
     \dim_set_eq:NN \l__flowfram_y_dim \l__flowfram_left_y_dim
   }
   {
     \dim_set_eq:NN \l__flowfram_y_dim \ffareay
   }
  \dim_add:Nn \l__flowfram_sfdf_height_dim
    {
      - \l__flowfram_y_dim
    }
  \__flowfram_new_static:nnnnn
    { all }
    { \l__flowfram_sfdf_width_dim }
    { \l__flowfram_sfdf_height_dim }
    { \l__flowfram_x_dim }
    { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_sfdf_height_dim
    {
      #1 + #2
    }
  \setstaticcontents { \c@maxstatic }
   {
     \ffruledeclarations
     \ffvrule { #2 } { \ffcolumnseprule }
     { \l__flowfram_sfdf_height_dim }
   }
  \int_case:nn { #3 }
   {
     { \c_flowfram_frame_type_flow_int }
       {
         \flowfram_set_clist_to_frame_clist:Nnnn
           \l__flowfram_pages_clist
           { flow } { pagelist } { #4 }
       }
     { \c_flowfram_frame_type_static_int }
       {
         \flowfram_set_clist_to_frame_clist:Nnnn
           \l__flowfram_pages_clist
           { static } { pagelist } { #4 }
       }
     { \c_flowfram_frame_type_dynamic_int }
       {
       \flowfram_set_clist_to_frame_clist:Nnnn
         \l__flowfram_pages_clist
         { dynamic } { pagelist } { #4 }
     }
   }
  \setstaticframe { \c@maxstatic }
    { pages = \l__flowfram_pages_clist }
  \dim_add:Nn \l__flowfram_x_dim
   {
       \l__flowfram_left_evenx_dim
     - \l__flowfram_left_x_dim
   }
  \dim_add:Nn \l__flowfram_y_dim
   {
      \l__flowfram_left_eveny_dim
    - \l__flowfram_left_y_dim
   }
  \setstaticframe { \c@maxstatic }
    {
      evenx=\l__flowfram_x_dim ,
      eveny=\l__flowfram_y_dim
    }
}
\newcommand*{\ffvrule}[3]{%
  \hfill
  \rule [ - #1 ] { #2 } { #3 }
  \hfill
  \mbox { }
}
\NewDocumentCommand \inserthrule
   { s O { \c_zero_dim } O { \c_zero_dim } m m m m }
 {
   \__flowfram_only_preamble:Nn \inserthrule
    {
      \__flowfram_get_frame_type:n { #4 }
      \__flowfram_get_frame_type:Nn
          \l__flowfram_type_ii_int
          { #6 }
      \bool_lazy_or:nnF
         {
           \int_compare_p:nNn
             { \l__flowfram_type_int } = { -\c_one_int }
         }
         {
           \int_compare_p:nNn
             { \l__flowfram_type_ii_int } = { -\c_one_int }
         }
       {
         \IfBooleanTF { #1 }
          {
            \use:c { __flowfram_get_ #6 _id:e } { #7 }
            \int_set_eq:NN \l__flowfram_id_ii_int \l__flowfram_id_int
            \use:c { __flowfram_get_ #4 _id:e } { #5 }
            \__flowfram_insert_h_rule:nnNnNn
              { #2 } { #3 }
              \l__flowfram_type_int { \l__flowfram_id_int }
              \l__flowfram_type_ii_int { \l__flowfram_id_ii_int }
          }
          {
            \__flowfram_insert_h_rule:nnNnNn
              { #2 } { #3 }
              \l__flowfram_type_int { #5 }
              \l__flowfram_type_ii_int { #7 }
          }
       }
    }
 }
\cs_new:Nn \__flowfram_insert_h_rule:nnNnNn
 {
  \__flowfram_get_frame_bounds_by_typeid:nn { #3 } { #4 }
  \dim_set_eq:NN \l__flowfram_left_x_dim \ffareax
  \dim_set_eq:NN \l__flowfram_left_y_dim \ffareay
  \dim_set_eq:NN \l__flowfram_left_width_dim \ffareawidth
  \dim_set_eq:NN \l__flowfram_left_height_dim \ffareaheight
  \__flowfram_get_frame_bounds_by_typeid:nn { #5 } { #6 }
  \dim_compare:nNnT
      { \l__flowfram_left_y_dim } > { \ffareay }
   {
    \__flowfram_swap_dim:NN \l__flowfram_left_x_dim \ffareax
    \__flowfram_swap_dim:NN \l__flowfram_left_y_dim \ffareay
    \__flowfram_swap_dim:NN \l__flowfram_left_width_dim \ffareawidth
    \__flowfram_swap_dim:NN \l__flowfram_left_height_dim \ffareaheight
   }
  \dim_set:Nn \l__flowfram_y_dim
    {
      \l__flowfram_left_y_dim
      + \l__flowfram_left_height_dim
    }
  \dim_set:Nn \l__flowfram_sfdf_height_dim
    {
      \ffareay - \l__flowfram_y_dim
    }
  \dim_set:Nn \l__flowfram_sfdf_width_dim
    {
        \l__flowfram_left_x_dim
      + \l__flowfram_left_width_dim
    }
  \dim_set:Nn \l__flowfram_x_dim
    {
      \ffareax + \ffareawidth
    }
  \dim_compare:nNnT
      { \l__flowfram_x_dim }  > { \l__flowfram_sfdf_width_dim }
   {
     \dim_set:Nn \l__flowfram_sfdf_width_dim { \l__flowfram_x_dim }
   }
  \dim_compare:nNnTF
      { \l__flowfram_left_x_dim } < { \ffareax }
   {
     \dim_set:Nn \l__flowfram_x_dim { \l__flowfram_left_x_dim }
   }
   {
     \dim_set:Nn \l__flowfram_x_dim { \ffareax }
   }
  \dim_add:Nn \l__flowfram_sfdf_width_dim
   {
      - \l__flowfram_x_dim
   }
  \__flowfram_new_static:nnnnn
    { all }
    { \l__flowfram_sfdf_width_dim }
    { \l__flowfram_sfdf_height_dim }
    { \l__flowfram_x_dim }
    { \l__flowfram_y_dim }
  \dim_add:Nn \l__flowfram_sfdf_width_dim
    { #1 + #2 }
  \setstaticcontents { \c@maxstatic }
   {
     \ffruledeclarations
     \ffhrule { #1 } { \l__flowfram_sfdf_width_dim } { \ffcolumnseprule }
   }
  \int_case:nn { #3 }
   {
     { \c_flowfram_frame_type_flow_int }
       {
         \flowfram_set_clist_to_frame_clist:Nnnn
           \l__flowfram_pages_clist
            { flow } { pagelist } { #4 }
       }
     { \c_flowfram_frame_type_static_int }
       {
         \flowfram_set_clist_to_frame_clist:Nnnn
           \l__flowfram_pages_clist
           { static } { pagelist } { #4 }
       }
     { \c_flowfram_frame_type_dynamic_int }
       {
         \flowfram_set_clist_to_frame_clist:Nnnn
           \l__flowfram_pages_clist
           { dynamic } { pagelist } { #4 }
       }
   }
  \setstaticframe { \c@maxstatic }
    { pages = \clist_use:N \l__flowfram_pages_clist }
  \dim_add:Nn \l__flowfram_x_dim
    {
       \l__flowfram_left_evenx_dim
     - \l__flowfram_left_x_dim
    }
  \dim_add:Nn \l__flowfram_y_dim
    {
        \l__flowfram_left_eveny_dim
      - \l__flowfram_left_y_dim
    }
  \setstaticframe {\c@maxstatic}
    {
      evenx = \l__flowfram_x_dim ,
      eveny = \l__flowfram_y_dim
    }
}
\newcommand*{\ffhrule}[3]{%
  \hspace* { -#1 } \rule { #2 } { #3 }
}
\NewDocumentCommand \dfchaphead { s m }
{
  \cs_if_exist:NTF \chapter
   {
     \IfBooleanTF { #1 }
      {
        \__flowfram_get_dynamic_id:n { #2 }
      }
      {
        \int_set:Nn \l__flowfram_id_int { #2 }
      }
       \let\@ff@OLDmakechapterhead\@makechapterhead
       \let\@ff@OLDmakeschapterhead\@makeschapterhead
       \renewcommand{\DFchapterstyle}[1]{\@ff@OLDmakechapterhead{##1}}%
       \renewcommand{\DFschapterstyle}[1]{\@ff@OLDmakeschapterhead{##1}}%
       \xdef\@makechapterhead##1{%
         \exp_not:N
            \__flowfram_set_dynamic_contents:nn
           { \int_use:N \l__flowfram_id_int }
         {
           \noexpand\DFchapterstyle { ##1 }
         }
       }
       \xdef\@makeschapterhead##1{%
         \exp_not:N \__flowfram_set_dynamic_contents:nn
           { \int_use:N \l__flowfram_id_int }
         {
           \noexpand \DFschapterstyle { ##1 }
         }
       }
   }
   {
     \msg_error:nn { flowfram } { no-chapters }
   }
}
\newcommand{\DFchapterstyle}[1]{#1}
\newcommand{\DFschapterstyle}[1]{#1}
\int_new:N \g__flowfram_chaphead_frame_id
\NewDocumentCommand \ChapterInDynamic { s m }
{
  \cs_if_exist:NTF \chapter
   {
     \IfBooleanTF { #1 }
      {
        \__flowfram_get_dynamic_id:e { #2 }
         \int_gset_eq:NN
           \g__flowfram_chaphead_frame_id
           \l__flowfram_id_int
      }
      {
        \int_gset:Nn \g__flowfram_chaphead_frame_id { #2 }
      }
     \__flowfram_make_chapter_head:n { \g__flowfram_chaphead_frame_id }
   }
   {
     \msg_error:nn { flowfram } { no-chapters }
   }
}
\ExplSyntaxOff
\newcommand*\@flowfram@standard@makechapterhead[1]{%
 \vspace *{50\p@ }%
 {\parindent \z@ \raggedright \normalfont
   \ifnum \c@secnumdepth >\m@ne
     \if@mainmatter \huge \bfseries \@chapapp \space \thechapter
       \par
       \nobreak \vskip 20\p@
     \fi
   \fi
   \interlinepenalty \@M
   \Huge \bfseries #1\par
   \nobreak
   \vskip 40\p@
}}
\ExplSyntaxOn
\cs_if_exist:NTF \chapter
 {
   \cs_if_eq:NNT \@makechapterhead \@flowfram@standard@makechapterhead
    {
       \newcommand \ffchapterpreheadskip
        {
          \vspace *{50\p@ }
        }
       \newcommand \ffchapterpostheadskip
        {
          \vspace *{40\p@ }
        }
       \newcommand \ffchapterheadstyle
       {
         \parindent \z@ \raggedright
       }
       \newcommand \ffchapternamenumfont [ 1 ] { { \huge #1 } }
       \newcommand \ffchapternamenum [ 2 ]
        {
          #1 \space #2
        }
       \newcommand \ffchapterpostnamenum
        {
          \par
          \nobreak
          \vspace *{20\p@ }
        }
       \newcommand \ffchaptertitlefont [ 1 ] { { \Huge #1 } }
       \newcommand{\ffchapterdefaultfont}{\normalfont \bfseries}
      \renewcommand*\@makechapterhead[1]
       {
        \ffchapterpreheadskip
        {
          \ffchapterheadstyle
          \ffchapterdefaultfont
          \ifnum \c@secnumdepth >\m@ne
           \if@mainmatter
              \ffchapternamenumfont
               {
                 \ffchapternamenum { \@chapapp } { \thechapter }
                 \ffchapterpostnamenum
               }
           \fi
         \fi
         \interlinepenalty \@M
         \ffchaptertitlefont { #1 \par }
         \nobreak
         \ffchapterpostheadskip
        }
       }
      \renewcommand*\@makeschapterhead[1]
       {
        \ffchapterpreheadskip
        {
          \ffchapterheadstyle
          \ffchapterdefaultfont
          \interlinepenalty \@M
          \ffchaptertitlefont { #1 \par }
          \nobreak
          \ffchapterpostheadskip
        }
       }
    }
   \cs_if_exist:NTF \if@openright
    {
      \newcommand \dfchapterclearpage
       {
         \legacy_if:nTF { @openright }
           {
             \cleardoublepage
           }
           {
             \clearpage
           }
       }
    }
    {
      \newcommand \dfchapterclearpage
       {
         \clearpage
       }
    }
   \newsavebox \flowfram@dfchap@sbox
   \NewMirroredHookPair
     { flowfram / chaphead / before }
     { flowfram / chaphead / after }
   \NewMirroredHookPair
     { flowfram / chaphead / box / before }
     { flowfram / chaphead / box / after }
   \cs_if_exist:NT \ffchapterpreheadskip
    {
      \AddToHook
       { flowfram / chaphead / box / before }
       {
         \let \ffchapterpreheadskip \relax
       }
    }
   \tl_new:N \g__flowfram_df_chapter_lines_tl
   \cs_new:Nn \__flowfram_df_addcontentsline:nnn
    {
      \tl_gput_right:Nn \g__flowfram_df_chapter_lines_tl
       {
         \addcontentsline { #1 } { #2 } { #3 }
       }
    }
   \cs_new:Nn \__flowfram_df_markright:n
    {
      \tl_gput_right:Nn \g__flowfram_df_chapter_lines_tl
       {
         \markright { #1 }
       }
    }
   \cs_new:Nn \__flowfram_df_markboth:nn
    {
      \tl_gput_right:Nn \g__flowfram_df_chapter_lines_tl
       {
         \markboth { #1 } { #2 }
       }
    }
   \dim_new:N \l__flowfram_df_chapbox_head_width_dim
   \cs_new:Nn \__flowfram_df_chapter:n
    {
      \dfchapterclearpage
      \tl_gclear:N \g__flowfram_df_chapter_lines_tl
      \flowfram_set_dim_to_frame_dim:Nnnn
        \l__flowfram_df_chapbox_head_width_dim
         { dynamic } { width } { \g__flowfram_chaphead_id_int }
      \UseHook { flowfram / chaphead / before }
      \sbox \flowfram@dfchap@sbox
       {
         \flowfram_set_tl_to_frame_tl:Nnnn
           \l__flowfram_textcolor_tl
           { dynamic } { textcolor } { \g__flowfram_chaphead_id_int }
         \__flowfram_set_text_color:
         \parbox
           { \l__flowfram_df_chapbox_head_width_dim }
           {
             \let \clearpage \relax
             \let \cleardoublepage \relax
             \let \onecolumn \relax
             \@twocolumnfalse
             \let \addcontentsline \__flowfram_df_addcontentsline:nnn
             \let \markright \__flowfram_df_markright:n
             \let \markboth \__flowfram_df_markboth:nn
             \UseHook { flowfram / chaphead / box / before }
             #1
             \tl_if_exist:NT \@currenttocentry
              {
                \tl_gset:Ne \@currenttocentry { \@currenttocentry }
              }
             \UseHook { flowfram / chaphead / box / after }
           }
       }
      \__flowfram_set_dynamic_contents:nn
        { \g__flowfram_chaphead_id_int }
        {
          \box_use_drop:N \flowfram@dfchap@sbox
          \@afterheading
        }
      \g__flowfram_df_chapter_lines_tl
      \tl_gclear:N \g__flowfram_df_chapter_lines_tl
      \UseHook { flowfram / chaphead / after }
    }
   \cs_new:Nn \__flowfram_df_chapter:nn
    {
      \__flowfram_df_chapter:n
       {
          \__flowfram_org_chapter: [ #1 ] { #2 }
       }
    }
   \cs_new:Nn \__flowfram_df_chapter:nnn
    {
      \__flowfram_df_chapter:n
       {
          \__flowfram_org_chapter: [ #1 ] [ #2 ] { #3 }
       }
    }
   \cs_new:Nn \__flowfram_df_chapter_star:nn
    {
      \__flowfram_df_chapter:n
       {
          \flowfram_nonum_section:Nnn
           \__flowfram_org_chapter:  { #1 } { #2 }
       }
    }
   \prg_new_conditional:Nnn \__flowfram_if_df_chapter:n
     { T, F, TF }
    {
      \int_if_zero:nTF { \g__flowfram_chaphead_id_int }
       { \prg_return_false: }
       {
         \tl_if_eq:nnTF { #1 } { chapter }
          { \prg_return_true: }
          { \prg_return_false: }
       }
    }
 }
 {
   \prg_new_conditional:Nnn \__flowfram_if_df_chapter:n
     { T, F, TF }
    {
      \prg_return_false:
    }
 }
\cs_new:Nn \__flowfram_make_chapter_head:n
 {
   \int_set:Nn \g__flowfram_chaphead_id_int { #1 }
 }
\int_new:N \g__flowfram_chaphead_id_int
\NewDocumentCommand \NoChapterInDynamic { }
 {
   \int_zero:N \g__flowfram_chaphead_id_int
 }
\newcounter{maxthumbtabs}
\cs_if_exist:NTF \chapter
 {
   \newcommand*{\defaultthumbtabtype}{chapter}
 }
 {
   \newcommand*{\defaultthumbtabtype}{section}
 }
\tl_new:N \g__flowfram_thumbtab_type_tl
\tl_gset:Nn \g__flowfram_thumbtab_type_tl
   { \defaultthumbtabtype }
\cs_new:Nn \__flowfram_ttb_num:n
 {
   \addtocontents {ttb}
    {
      \protect \thumbtab
       { \theFramePageCounter }
       { \arabic { \g__flowfram_thumbtab_type_tl } }
       { #1 }
       { \@currentHref }
    }
 }
\newcounter{thumbtabnonum}
\cs_new:Nn \__flowfram_ttb_nonum:n
 {
   \bool_if:NT \g__flowfram_save_nonum_thumbtabs_bool
    {
      \refstepcounter { thumbtabnonum }
      \addtocontents { ttb }
       {
        \protect \thumbtab
          { \theFramePageCounter }
          { }
          { #1 }
          { thumbtabnonum . \thethumbtabnonum }
       }
    }
 }
\NewDocumentCommand \makethumbtabs
  { O { \c_zero_dim } m O { \defaultthumbtabtype } }
 {
   \exp_args:Nnne
    \__flowfram_make_thumbtabs:nnn { #1 } { #2 } { #3 }
   \cs_set:Nn \__flowfram_make_thumbtabs:nnn
    {
      \msg_note:nn { flowfram } { ignoring-multiple-makethumbtabs }
    }
 }
\cs_new:Nn \__flowfram_make_thumbtabs:nnn
 {
  \cs_if_exist:cTF { #3 }
   {
      \tl_gset:Ne \g__flowfram_thumbtab_type_tl  { #3 }
      \@starttoc { ttb }
      \__flowfram_create_thumbtabs:nn { #1 } { #2 }
      \cs_set:Nn \__flowfram_write_backmatter_ttb:
       {
         \addtocontents {ttb}
          {
            \protect \thumbtab@backmatter
              { \theFramePageCounter }
          }
       }
    \cs_set:Nn \__flowfram_no_thumbtabs_warn:
     {
       \msg_warning:nn { flowfram } { no-thumbtabs-rerun }
     }
   }
   {
     \msg_error:nnn { flowfram } { section-unit-not-defined } { #3 }
   }
}
\cs_new:Nn \__flowfram_no_thumbtabs_warn:
 {
   \msg_warning:nn { flowfram } { no-thumbtabs-missing-makethumbtabs }
 }
\cs_new:Nn \__flowfram_write_backmatter_ttb:
 {
 }
\newcommand{\thumbtab}[4]{%
  \stepcounter { maxthumbtabs }
  \__flowfram_message:nnnnn { info-found-thumbtab }
    { #1 } { #2 } { #3 } { #4 }
  \tl_new:c { g__thumbtab_ \romannumeral \c@maxthumbtabs _pages_tl }
  \int_new:c { g__thumbtab_ \romannumeral \c@maxthumbtabs _start_int }
  \int_gset:cn { g__thumbtab_ \romannumeral \c@maxthumbtabs _start_int }
    { #1 }
  \tl_new:c { g__thumbtab_ \romannumeral \c@maxthumbtabs _unitnum_tl }
  \tl_gset:cn
    { g__thumbtab_ \romannumeral \c@maxthumbtabs _unitnum_tl }
    { #2 }
  \tl_new:c { g__thumbtab_ \romannumeral \c@maxthumbtabs _title_tl }
  \tl_gset:cn { g__thumbtab_ \romannumeral \c@maxthumbtabs _title_tl }
    { #3 }
  \tl_new:c { g__thumbtab_ \romannumeral \c@maxthumbtabs _link_tl }
  \tl_gset:cn { g__thumbtab_ \romannumeral \c@maxthumbtabs _link_tl }
    { #4 }
  \tl_gclear:N \g__flowfram_ttb_endpage_tl
}
\tl_new:N \g__flowfram_ttb_endpage_tl
\newcommand{\thumbtab@backmatter}[1]{%
  \tl_gset:Ne \g__flowfram_ttb_endpage_tl { \int_eval:n { #1 - \c_one_int } }
}
\cs_new:Nn \__flowfram_thumbtab_start:n
 {
   \int_use:c { g__thumbtab_ \romannumeral #1 _start_int }
 }
\cs_new:Nn \__flowfram_thumbtab_unitnum:n
 {
   \tl_use:c { g__thumbtab_ \romannumeral #1 _unitnum_tl }
 }
\cs_new:Nn \__flowfram_thumbtab_pages:n
 {
   \tl_use:c { g__thumbtab_ \romannumeral #1 _pages_tl }
 }
\cs_new:Nn \__flowfram_thumbtab_set_pages:nn
 {
   \tl_gset:cn { g__thumbtab_ \romannumeral #1 _pages_tl }
     { #2 }
 }
\cs_generate_variant:Nn \__flowfram_thumbtab_set_pages:nn { ne }
\cs_new:Nn \__flowfram_thumbtab_title:n
 {
   \tl_use:c { g__thumbtab_ \romannumeral #1 _title_tl }
 }
\NewDocumentCommand \SetThumbTabTitle { m m }
 {
   \tl_if_exist:cTF { g__thumbtab_ \romannumeral #1 _title_tl }
    {
      \tl_gset:cn { g__thumbtab_ \romannumeral #1 _title_tl } { #2 }
    }
    {
      \msg_warning:nnn { flowfram } { cant-find-thumbtab } { #1 }
    }
 }
\cs_new:Nn \__flowfram_thumbtab_link:n
 {
   \tl_use:c { g__thumbtab_ \romannumeral #1 _link_tl }
 }
\cs_new:Nn \__flowfram_create_thumbtabs:nn
 {
   \dim_set:Nn \l__flowfram_y_dim
     {
       \typeblockheight - ( #2 ) - ( #1 )
     }
   \computerightedgeodd { \l__flowfram_x_dim }
   \dim_sub:Nn \l__flowfram_x_dim { \thumbtabwidth }
   \computeleftedgeeven { \l__flowfram_evenx_dim }
   \int_step_inline:nn { \c@maxthumbtabs }
    {
      \int_set:Nn \l__flowfram_range_start_int
        {
          \__flowfram_thumbtab_start:n { ##1 }
        }
      \int_compare:nNnTF { ##1 } = { \c@maxthumbtabs }
        {
          \tl_if_empty:NTF \g__flowfram_ttb_endpage_tl
           {
             \__flowfram_thumbtab_set_pages:ne { ##1 }
               {
                  \int_use:N \l__flowfram_range_start_int ,
                  > \int_use:N \l__flowfram_range_start_int
               }
           }
           {
             \__flowfram_thumbtab_set_pages:ne { ##1 }
               {
                  \int_use:N \l__flowfram_range_start_int
                  - \g__flowfram_ttb_endpage_tl
               }
           }
        }
        {
          \int_set:Nn \l__flowfram_range_end_int
            {
              \__flowfram_thumbtab_start:n
                { \int_eval:n {  ##1 + \c_one_int } }
            }
          \int_decr:N \l__flowfram_range_end_int
          \int_compare:nNnTF
              { \l__flowfram_range_end_int }
               >
              { \l__flowfram_range_start_int }
            {
              \__flowfram_thumbtab_set_pages:ne { ##1 }
               {
                 \int_use:N \l__flowfram_range_start_int
                 - \int_use:N \l__flowfram_range_end_int
               }
            }
            {
              \__flowfram_thumbtab_set_pages:ne { ##1 }
               {
                 \int_use:N \l__flowfram_range_start_int
               }
            }
        }
     \__flowfram_create_thumbtab:nn { ##1 } { #2 }
   }
   \bool_if:NTF \g__flowfram_has_bespoke_thumbtabs_bool
    {
      \int_step_inline:nn { \c@maxthumbtabs }
       {
         \exp_args:Nnee
         \__flowfram_set_thumbtab_pagelist:nnn { ##1 }
          {
            \seq_item:Nn \g__flowfram_thumbtab_seq { ##1 }
          }
          {
            \seq_item:Nn \g__flowfram_even_thumbtab_seq { ##1 }
          }
         \flowfram_frame_set_bool_true:nnn
           { dynamic } { hide }
           {
             \seq_item:Nn \g__flowfram_thumbtab_seq { ##1 }
           }
         \flowfram_frame_set_bool_true:nnn
           { dynamic } { hide }
           {
             \seq_item:Nn \g__flowfram_even_thumbtab_seq { ##1 }
           }
       }
    }
    {
      \seq_map_indexed_inline:Nn \g__flowfram_thumbtab_seq
       {
         \clist_set:Ne \l__flowfram_pages_clist
          {
            \__flowfram_thumbtab_pages:n
              { ##1 }
          }
          \flowfram_frame_set_clist:nnnV
           { dynamic } { pagelist } { ##2 }
            \l__flowfram_pages_clist
          \flowfram_frame_set_bool_true:nnn
           { dynamic } { hide } { ##2 }
        }
     }
}
\cs_new:Nn \__flowfram_set_thumbtab_pagelist:nnn
 {
   \clist_set:Ne \l__flowfram_pages_clist
    {
      \__flowfram_thumbtab_pages:n { #1 }
    }
   \__flowfram_separate_odd_even:
   \__flowfram_set_thumbtab_pages:nn { #2 } { #3 }
 }
\newlength{\thumbtabwidth}
\setlength{\thumbtabwidth}{1cm}
\NewDocumentCommand \thumbtabnumtitle { m m }
 {
   #1 \c_space_tl #2
 }
\newcommand{\thumbtabformat}[2]{%
  \__flowfram_thumbtab_fmt:nn { #1 } { #2 }
}
\cs_new:Nn \flowfram_thumbtab_stack:n
 {
   \tl_clear:N \l__flowfram_tmpa_tl
   \exp_args:Ne \text_map_inline:nn { \text_purify:n { #1 } }
    {
      \tl_if_empty:NF \l__flowfram_tmpa_tl
       {
         \tl_put_right:Nn \l__flowfram_tmpa_tl { \\ }
       }
      \tl_put_right:Nn \l__flowfram_tmpa_tl { ##1 }
    }
   \tl_put_left:Nn \l__flowfram_tmpa_tl { \begin { tabular } { l } }
   \tl_put_right:Nn \l__flowfram_tmpa_tl { \end { tabular } }
   \l__flowfram_tmpa_tl
 }
\fp_new:N \l__flowfram_greyscale_fp
\seq_new:N \g__flowfram_thumbtab_seq
\seq_new:N \g__flowfram_thumbtab_index_seq
\seq_new:N \g__flowfram_even_thumbtab_seq
\seq_new:N \g__flowfram_even_thumbtab_index_seq
\bool_new:N \g__flowfram_has_bespoke_thumbtabs_bool
\bool_gset_false:N \g__flowfram_has_bespoke_thumbtabs_bool
\cs_new:Nn \__flowfram_create_thumbtab:nn
 {
   \fp_set:Nn \l__flowfram_greyscale_fp
    {
       0.01 * ( ( 60 * ( #1 ) / \c@maxthumbtabs ) + 25 )
    }
    \__flowfram_if_frame_label_exists:nnNTF
        { dynamic }
        { thumbtab \int_eval:n { #1 } }
        \l__flowfram_id_int
     {
       \bool_set_true:N \g__flowfram_has_bespoke_thumbtabs_bool
       \flowfram_set_dim_to_frame_dim:Nnnn
         \l__flowfram_y_dim
         { dynamic } { posy } { \l__flowfram_id_int }
     }
     {
       \__flowfram_new_dynamic:nnnnnn
        { none } { \thumbtabwidth } { #2 }
        { \l__flowfram_x_dim } { \l__flowfram_y_dim }
        { thumbtab \int_eval:n { #1 } }
       \int_set_eq:NN \l__flowfram_id_int \c@maxdynamic
       \flowfram_frame_set_dim:nnnn { dynamic } { evenx }
         { \l__flowfram_id_int }
         { \l__flowfram_evenx_dim }
       \flowfram_frame_set_tl:nnne
        { dynamic } { backcolor } { \l__flowfram_id_int }
        { [gray] { \fp_to_decimal:N \l__flowfram_greyscale_fp } }
     }
   \__flowfram_message:neee { info-thumbtab }
     { \int_eval:n { #1 } }
     { thumbtab \int_eval:n { #1 } }
     { \int_use:N \l__flowfram_id_int }
   \seq_put_right:NV \g__flowfram_thumbtab_seq
      \l__flowfram_id_int
   \__flowfram_set_thumbtab_content:NVneen
     \thumbtabregularformat
     \l__flowfram_id_int
     { \__flowfram_thumbtab_link:n { #1 } }
     { \__flowfram_thumbtab_unitnum:n { #1 } }
     { \exp_not:N \__flowfram_thumbtab_title:n { #1 } }
     { #2 }
    \__flowfram_if_frame_label_exists:nnNTF
        { dynamic }
        { eventhumbtab \int_eval:n { #1 } }
        \l__flowfram_id_ii_int
     {
       \bool_set_true:N \g__flowfram_has_bespoke_thumbtabs_bool
       \seq_put_right:NV \g__flowfram_even_thumbtab_seq
        \l__flowfram_id_ii_int
       \__flowfram_set_thumbtab_content:NVneen
         \thumbtabregularformat
         \l__flowfram_id_ii_int
         { \__flowfram_thumbtab_link:n { #1 } }
         { \__flowfram_thumbtab_unitnum:n { #1 } }
         { \exp_not:N \__flowfram_thumbtab_title:n { #1 } }
         { #2 }
     }
     {
       \seq_put_right:NV \g__flowfram_even_thumbtab_seq
        \l__flowfram_id_int
     }
    \__flowfram_if_frame_label_exists:nnNTF
        { dynamic }
        { thumbtabindex \int_eval:n { #1 } }
        \l__flowfram_id_int
     {
       \bool_set_true:N \g__flowfram_has_bespoke_thumbtabs_bool
     }
     {
       \__flowfram_new_dynamic:nnnnnn
        { none } { \thumbtabwidth } { #2 }
        { \l__flowfram_x_dim } { \l__flowfram_y_dim }
        { thumbtabindex \int_eval:n { #1 } }
       \int_set_eq:NN \l__flowfram_id_int \c@maxdynamic
       \flowfram_frame_set_dim:nnnn { dynamic } { evenx }
         { \l__flowfram_id_int }
         { \l__flowfram_evenx_dim }
       \flowfram_frame_set_tl:nnne
        { dynamic } { backcolor } { \l__flowfram_id_int }
        { [gray] { \fp_to_decimal:N \l__flowfram_greyscale_fp } }
     }
   \__flowfram_message:neee {info-thumbtab-index}
     { \int_eval:n { #1 } }
     { thumbtabindex \int_eval:n { #1 } }
     { \int_use:N \l__flowfram_id_int }
   \seq_put_right:NV \g__flowfram_thumbtab_index_seq
      \l__flowfram_id_int
   \__flowfram_set_thumbtab_content:NVeeen
     \thumbtabindexformat
     \l__flowfram_id_int
     { \__flowfram_thumbtab_link:n { #1 } }
     { \__flowfram_thumbtab_unitnum:n { #1 } }
     { \exp_not:N \__flowfram_thumbtab_title:n { #1 } }
     { #2 }
    \__flowfram_if_frame_label_exists:nnNTF
        { dynamic }
        { eventhumbtabindex \int_eval:n { #1 } }
        \l__flowfram_id_ii_int
     {
       \bool_set_true:N \g__flowfram_has_bespoke_thumbtabs_bool
       \seq_put_right:NV \g__flowfram_even_thumbtab_index_seq
        \l__flowfram_id_ii_int
       \__flowfram_set_thumbtab_content:NVneen
         \thumbtabindexformat
         \l__flowfram_id_ii_int
         { \__flowfram_thumbtab_link:n { #1 } }
         { \__flowfram_thumbtab_unitnum:n { #1 } }
         { \exp_not:N \__flowfram_thumbtab_title:n { #1 } }
         { #2 }
     }
     {
       \seq_put_right:NV \g__flowfram_even_thumbtab_index_seq
        \l__flowfram_id_int
     }
   \dim_sub:Nn \l__flowfram_y_dim { #2 }
 }
\cs_new:Nn \__flowfram_set_thumbtab_content:Nnnnnn
 {
   \tl_clear:N \l__flowfram_contents_tl
   \tl_if_empty:nTF { #4 }
    {
      \tl_set:Ne \l__flowfram_contents_tl
       {
          \exp_not:N #1
           { #3 }
           { \exp_not:n { #5 } }
           { \dim_eval:n { #6 } }
       }
    }
    {
      \bool_if:NTF \l__flowfram_ttb_show_number_bool
        {
          \bool_if:NTF \l__flowfram_ttb_show_title_bool
            {
              \tl_set:Ne \l__flowfram_contents_tl
               {
                  \exp_not:N #1
                   { #3 }
                   {
                     \exp_not:N \thumbtabnumtitle
                      { #4 } { \exp_not:n { #5 } }
                   }
                   { \dim_eval:n { #6 } }
               }
            }
            {
              \tl_set:Ne \l__flowfram_contents_tl
               {
                  \exp_not:N #1
                   { #3 }
                   { #4 } { \dim_eval:n { #6 } }
               }
            }
        }
        {
           \tl_set:Ne \l__flowfram_contents_tl
            {
               \exp_not:N #1
                { #3 }
                { \exp_not:n { #5 } }
                { \dim_eval:n { #6 } }
            }
        }
     }
   \exp_args:NnV \__flowfram_set_dynamic_contents:nn
     { #2 }
     \l__flowfram_contents_tl
 }
\cs_generate_variant:Nn  \__flowfram_set_thumbtab_content:Nnnnnn
 { NVneen , NVeeen }
\NewDocumentCommand \enablethumbtabs { }
 {
   \cs_set_eq:NN
     \__flowfram_add_thumbtab:n
     \__flowfram_actual_add_thumbtab:n
   \int_if_zero:nTF
    { \seq_count:N \g__flowfram_thumbtab_seq }
    {
      \__flowfram_no_thumbtabs_warn:
    }
    {
      \seq_map_inline:Nn \g__flowfram_thumbtab_seq
       {
         \flowfram_frame_set_bool_false:nnn
          { dynamic } { hide } { ##1 }
       }
     \bool_if:NT \g__flowfram_has_bespoke_thumbtabs_bool
       {
         \seq_map_inline:Nn \g__flowfram_even_thumbtab_seq
          {
            \flowfram_frame_set_bool_false:nnn
             { dynamic } { hide } { ##1 }
          }
       }
    }
}
\NewDocumentCommand \disablethumbtabs { }
 {
   \cs_set_eq:NN
     \__flowfram_add_thumbtab:n
     \use_none:n
   \seq_map_inline:Nn \g__flowfram_thumbtab_seq
    {
      \flowfram_frame_set_bool_true:nnn
       { dynamic } { hide } { ##1 }
    }
   \seq_map_inline:Nn \g__flowfram_thumbtab_index_seq
    {
      \flowfram_frame_set_clist:nnnn
       { dynamic } { pagelist } { ##1 } { none }
    }
   \bool_if:NT \g__flowfram_has_bespoke_thumbtabs_bool
    {
      \seq_map_inline:Nn \g__flowfram_even_thumbtab_seq
       {
         \flowfram_frame_set_clist:nnnn
          { dynamic } { hide } { ##1 } \c_true_bool
       }
      \seq_map_inline:Nn \g__flowfram_even_thumbtab_index_seq
       {
         \flowfram_frame_set_clist:nnnn
          { dynamic } { pagelist } { ##1 } { none }
       }
    }
 }
\NewDocumentCommand \thumbtabindex { o }
{
 \IfValueTF { #1 }
  {
    \clist_set:Ne \l__flowfram_pages_clist { #1 }
    \bool_if:NT \g__flowfram_has_bespoke_thumbtabs_bool
     {
       \__flowfram_separate_odd_even:
     }
  }
  {
    \clist_set:Ne \l__flowfram_pages_clist
     {
       \int_eval:n { \g__flowfram_pagecounter_tl }
     }
    \bool_if:NT \g__flowfram_has_bespoke_thumbtabs_bool
     {
       \int_if_odd:nTF { \g__flowfram_pagecounter_tl }
        {
          \clist_set_eq:NN \l__flowfram_odd_pages_clist
             \l__flowfram_pages_clist
          \clist_set:Nn \l__flowfram_even_pages_clist { none }
        }
        {
          \clist_set_eq:NN \l__flowfram_even_pages_clist
             \l__flowfram_pages_clist
          \clist_set:Nn \l__flowfram_odd_pages_clist { none }
        }
     }
  }
 \bool_if:NTF \g__flowfram_has_bespoke_thumbtabs_bool
  {
    \seq_map_pairwise_function:NNN
      \g__flowfram_thumbtab_index_seq
      \g__flowfram_even_thumbtab_index_seq
      \__flowfram_set_thumbtab_pages:nn
  }
  {
    \seq_map_inline:Nn \g__flowfram_thumbtab_index_seq
     {
       \flowfram_frame_set_clist:nnnV
         { dynamic } { pagelist } { ##1 }
         \l__flowfram_pages_clist
     }
  }
}
\cs_new:Nn \__flowfram_separate_odd_even:
 {
   \clist_if_empty:NTF \l__flowfram_pages_clist
    {
      \clist_set:Nn \l__flowfram_pages_clist { none }
      \clist_set:Nn \l__flowfram_even_pages_clist { none }
      \clist_set:Nn \l__flowfram_odd_pages_clist { none}
    }
    {
      \exp_args:Ne \__flowfram_get_range:n
        { \clist_item:Nn \l__flowfram_pages_clist { \c_one_int } }
      \clist_clear:N \l__flowfram_even_pages_clist
      \clist_clear:N \l__flowfram_odd_pages_clist
      \int_compare:nNnTF
         { \l__flowfram_range_end_int} < { \c_flowfram_max_page_int }
       {
          \int_step_inline:nnn
             { \l__flowfram_range_start_int } { \l__flowfram_range_end_int }
           {
             \int_if_odd:nTF { ##1 }
               {
                 \clist_put_right:Nn
                    \l__flowfram_odd_pages_clist { ##1 }
               }
               {
                 \clist_put_right:Nn
                    \l__flowfram_even_pages_clist { ##1 }
               }
           }
          \clist_if_empty:NT \l__flowfram_odd_pages_clist
           {
             \clist_set:Nn \l__flowfram_odd_pages_clist { none }
           }
          \clist_if_empty:NT \l__flowfram_even_pages_clist
           {
             \clist_set:Nn \l__flowfram_even_pages_clist { none }
           }
       }
       {
         \clist_set:Nn \l__flowfram_even_pages_clist { even }
         \clist_set:Nn \l__flowfram_odd_pages_clist { odd }
       }
    }
 }
\cs_new:Nn \__flowfram_set_thumbtab_pages:nn
 {
   \int_compare:nNnTF { #1 } = { #2 }
    {
      \flowfram_frame_set_clist:nnnV
        { dynamic } { pagelist } { #1 }
        \l__flowfram_pages_clist
    }
    {
      \flowfram_frame_set_clist:nnnV
        { dynamic } { pagelist } { #1 }
        \l__flowfram_odd_pages_clist
      \flowfram_frame_set_clist:nnnV
        { dynamic } { pagelist } { #2 }
        \l__flowfram_even_pages_clist
    }
 }
\NewDocumentCommand \setthumbtab { m m }
 {
   \tl_if_eq:nnTF { #1 } { all }
    {
      \int_step_inline:nn { \c@maxthumbtabs }
       {
         \__flowfram_set_thumbtab:nn { ##1 } { #2 }
       }
    }
    {
      \clist_map_inline:nn { #1 }
       {
         \int_compare:nNnTF { ##1 } < { \c_one_int }
          {
            \msg_error:nnn { flowfram }
              { invalid-thumbtab-index }
              { ##1 }
          }
          {
            \int_compare:nNnTF
              { ##1 } >
              { \seq_count:N \g__flowfram_thumbtab_seq }
             {
               \msg_warning:nnn {flowfram} {cant-find-thumbtab} { ##1 }
             }
             {
               \__flowfram_set_thumbtab:nn { ##1 } { #2 }
             }
          }
       }
    }
 }
\cs_new:Nn \__flowfram_set_thumbtab:nn
 {
   \int_set:Nn \l__flowfram_id_int
     {
       \seq_item:Nn
         \g__flowfram_thumbtab_index_seq
         { #1 }
     }
   \__flowfram_set_dynamic_by_idn:nn
     {
       \l__flowfram_id_int
     }
     { #2 }
   \bool_if:NT \g__flowfram_has_bespoke_thumbtabs_bool
    {
      \int_set:Nn \l__flowfram_id_ii_int
        {
          \seq_item:Nn
            \g__flowfram_even_thumbtab_index_seq
            { #1 }
        }
      \int_compare:nNnF
        {
          \l__flowfram_id_int
        }
         =
        {
          \l__flowfram_id_ii_int
        }
       {
         \__flowfram_set_dynamic_by_idn:nn
           {
             \l__flowfram_id_ii_int
           }
           { #2 }
       }
    }
   \int_set:Nn \l__flowfram_id_int
     {
       \seq_item:Nn
         \g__flowfram_thumbtab_seq
         { #1 }
     }
   \__flowfram_set_dynamic_by_idn:nn
     {
       \l__flowfram_id_int
     }
     { #2 }
   \bool_if:NT \g__flowfram_has_bespoke_thumbtabs_bool
    {
      \int_set:Nn \l__flowfram_id_ii_int
        {
          \seq_item:Nn
            \g__flowfram_even_thumbtab_seq
            { #1 }
        }
      \int_compare:nNnF
        {
          \l__flowfram_id_int
        }
         =
        {
          \l__flowfram_id_ii_int
        }
       {
         \__flowfram_set_dynamic_by_idn:nn
           {
             \l__flowfram_id_ii_int
           }
           { #2 }
       }
    }
 }
\NewDocumentCommand \setthumbtabindex { m m }
 {
   \tl_if_eq:nnTF { #1 } { all }
    {
      \int_step_inline:nn { \c@maxthumbtabs }
       {
         \__flowfram_set_thumbtab_index:nn { ##1 } { #2 }
       }
    }
    {
      \clist_map_inline:nn { #1 }
       {
         \int_compare:nNnTF { ##1 } < { \c_one_int }
          {
            \msg_error:nnn { flowfram }
              { invalid-thumbtab-index }
              { ##1 }
          }
          {
            \int_compare:nNnTF
              { ##1 } >
              { \seq_count:N \g__flowfram_thumbtab_seq }
             {
               \msg_warning:nnn {flowfram} {cant-find-thumbtab} { ##1 }
             }
             {
               \__flowfram_set_thumbtab_index:nn { ##1 } { #2 }
             }
          }
       }
    }
 }
\cs_new:Nn \__flowfram_set_thumbtab_index:nn
 {
   \int_set:Nn \l__flowfram_id_int
     {
       \seq_item:Nn
         \g__flowfram_thumbtab_index_seq
         { #1 }
     }
   \__flowfram_set_dynamic_by_idn:nn
     {
       \l__flowfram_id_int
     }
     { #2 }
   \bool_if:NT \g__flowfram_has_bespoke_thumbtabs_bool
    {
      \int_set:Nn \l__flowfram_id_ii_int
        {
          \seq_item:Nn
            \g__flowfram_even_thumbtab_index_seq
            { #1 }
        }
      \int_compare:nNnF
        {
          \l__flowfram_id_int
        }
         =
        {
          \l__flowfram_id_ii_int
        }
       {
         \__flowfram_set_dynamic_by_idn:nn
           {
             \l__flowfram_id_ii_int
           }
           { #2 }
       }
    }
 }
\NewDocumentCommand \tocandthumbtabindex { }
 {
   \aligntoctrue
   \bool_set_true:N \l__flowfram_thumbtabs_in_toc_bool
   \tableofcontents
   \aligntocfalse
 }
\tl_new:N \g__flowfram_minitoc_type_tl
\cs_new:Nn \__flowfram_starttoc:n
 {
   \__flowfram_store_toc:n { #1 }
 }
\cs_new:Nn \__flowfram_store_toc:n
 {
  \begingroup
    \makeatletter
    \__flowfram_parse_toc:n { \jobname . #1 }
    \if@filesw
      \RerunFileCheck { \jobname . #1 }
       {
        \@ifundefined{tf@#1}{}
         {
           \immediate\closeout\csname tf@#1  \endcsname
         }
       }
       { }
      \@ifundefined{tf@#1}
       {
        \expandafter\newwrite\csname tf@#1\endcsname
       }
       { }
      \immediate\openout\csname tf@#1\endcsname\jobname.#1\relax
    \fi
    \@nobreakfalse
  \endgroup
 }
\ior_new:N \g__flowfram_toc_ior
\int_new:N \g__flowfram_minitoc_level_int
\cs_new:Nn \__flowfram_parse_toc:n
 {
   \ior_open:NnTF \g__flowfram_toc_ior { #1 }
    {
      \int_if_exist:cTF
         {
            c_flowfram_level_
            \g__flowfram_minitoc_type_tl
            _int
         }
       {
         \int_gset_eq:Nc \g__flowfram_minitoc_level_int
           {
              c_flowfram_level_
              \g__flowfram_minitoc_type_tl
              _int
           }
       }
       {
         \int_gset:Nn \g__flowfram_minitoc_level_int  { 6 }
       }
      \int_gzero:N \c@maxtocunits
      \int_gzero:N \c@maxminitoc
      \int_gzero:N \g__flowfram_toc_level_int
      \ior_map_inline:Nn \g__flowfram_toc_ior
        {
          \__flowfram_add_to_toc_list:Nn
            \c@maxtocunits { ##1 }
        }
      \ior_close:N \g__flowfram_toc_ior
    }
    {
      \msg_info:nnn { flowfram } { info-no-file } { #1 }
    }
 }
\newcount\c@maxtocunits
\newcount\c@maxminitoc
\int_new:N \g__flowfram_toc_level_int
\tl_new:N \g__flowfram_table_of_contents_tl
\cs_new:Nn \__flowfram_add_to_toc_list:Nn
 {
   \tl_gput_right:Nn \g__flowfram_table_of_contents_tl { #2 }
   \tl_if_head_eq_meaning:nNT
      { #2 } \contentsline
    {
      \tl_set:Ne \l__flowfram_remainder_tl
        {
          \tl_tail:n { #2 }
        }
      \tl_set:Ne \l__flowfram_contents_tl
        {
          \tl_head:N \l__flowfram_remainder_tl
        }
      \int_if_exist:cTF
        {
          c_flowfram_level_
          \l__flowfram_contents_tl
          _int
        }
       {
         \int_gset_eq:Nc \g__flowfram_toc_level_int
           {
             c_flowfram_level_
             \l__flowfram_contents_tl
             _int
           }
       }
       {
         \int_gset:Nn \g__flowfram_toc_level_int
           { \c_flowfram_level_subparagraph_int + \c_one_int }
       }
      \tl_if_eq:eeT
        { \g__flowfram_thumbtab_type_tl }
        { \l__flowfram_contents_tl }
       {
         \int_gincr:N #1
       }
      \tl_if_exist:cF
        { g__flowfram_toc_level_ \romannumeral #1 _tl }
       {
         \tl_new:c
          { g__flowfram_toc_level_ \romannumeral #1 _tl }
       }
      \tl_gput_right:cn
        { g__flowfram_toc_level_ \romannumeral #1 _tl }
        { #2 }
    }
   \bool_if:NT \g__flowfram_minitocs_enabled_bool
    {
    \int_compare:nNnTF
        { \g__flowfram_toc_level_int }
        =
        { \g__flowfram_minitoc_level_int }
      {
        \int_gincr:N \c@maxminitoc
        \tl_clear_new:c { g__flowfram_minitoc_ \romannumeral \c@maxminitoc _tl }
      }
      {
        \int_compare:nNnT
          { \g__flowfram_toc_level_int }
            >
          { \g__flowfram_minitoc_level_int }
         {
           \tl_if_exist:cF { g__flowfram_minitoc_ \romannumeral \c@maxminitoc _tl }
            {
              \tl_new:c { g__flowfram_minitoc_ \romannumeral \c@maxminitoc _tl }
            }
           \tl_gput_right:cn
             { g__flowfram_minitoc_ \romannumeral \c@maxminitoc _tl }
            { #2 }
         }
      }
    }
 }
\int_const:Nn \c_flowfram_level_part_int { -1 }
\int_const:Nn \c_flowfram_level_chapter_int { 0 }
\int_const:Nn \c_flowfram_level_section_int { 1 }
\int_const:Nn \c_flowfram_level_subsection_int { 2 }
\int_const:Nn \c_flowfram_level_subsubsection_int { 3 }
\int_const:Nn \c_flowfram_level_paragraph_int { 4 }
\int_const:Nn \c_flowfram_level_subparagraph_int { 5 }
\cs_new:Nn \__flowfram_tableofcontents:
{
  \cs_set_eq:NN \@starttoc \__flowfram_starttoc:n
  \flowfram_toc:
  \bool_lazy_and:nnTF
    {
      \bool_not_p:n
       {
         \tl_if_empty_p:N \g__flowfram_table_of_contents_tl
       }
    }
    {
      \bool_if_p:N \l__flowfram_thumbtabs_in_toc_bool
    }
   {
     \bool_if:NTF \l__flowfram_thumbtabs_span_toc_bool
      {
        \thumbtabindex[all]
      }
      {
        \thumbtabindex
      }
     \legacy_if:nTF { aligntoc }
      {
       \__flowfram_print_aligned_toc:
      }
      {
        \__flowfram_print_toc:
      }
     \bool_if:NT \l__flowfram_thumbtabs_span_toc_bool
      {
       \afterpage
        {
          \thumbtabindex[none]
        }
      }
   }
   {
     \__flowfram_print_toc:
   }
  \cs_set_eq:NN \@starttoc \__flowfram_org_starttoc:
  \int_gzero:N \c@minitoc
}
\newlength\beforeminitocskip
\setlength{\beforeminitocskip}{0pt}
\newlength\afterminitocskip
\setlength{\afterminitocskip}{\baselineskip}
\NewDocumentCommand \dominitoc { m }
 {
   \flowfram_do_minitoc:n { #1 }
 }
\cs_new:Nn \flowfram_do_minitoc:n
 {
   \flowfram_use_minitoc:n { #1 }
 }
\newcommand{\minitocstyle}[1]{%
  \normalfont\normalsize\normalcolor
  #1%
}
\cs_new:Nn \flowfram_use_minitoc:n
 {
  \bool_lazy_and:nnT
    {
      \tl_if_exist_p:c { g__flowfram_minitoc_ \romannumeral #1 _tl }
    }
    {
      \bool_not_p:n
       { \tl_if_empty_p:c { g__flowfram_minitoc_ \romannumeral #1 _tl } }
    }
   {
     \vskip \beforeminitocskip
     \group_begin:
       \minitocstyle
        {
          \tl_use:c { g__flowfram_minitoc_ \romannumeral #1 _tl }
        }
     \group_end:
     \vskip \afterminitocskip
   }
}
\cs_new:Nn \flowfram_clear_do_minitoc:
 {
   \int_compare:nNnF
     { \g__flowfram_minitoc_frame_id }
       =
     { \g__flowfram_chaphead_frame_id }
    {
      \flowfram_if_frame_bool:nnnF
         { dynamic } { clear } { \g__flowfram_minitoc_frame_id }
       {
         \cs_gset_eq:NN \flowfram_do_minitoc:n \use_none:n
       }
    }
 }
\int_new:N \g__flowfram_minitoc_frame_id
\NewDocumentCommand \appenddfminitoc { s m }
 {
   \renewcommand{\beforeminitocskip}{\baselineskip}%
   \IfBooleanTF { #1 }
    {
      \__flowfram_get_dynamic_id:e { #2 }
      \int_gset_eq:NN
         \g__flowfram_minitoc_frame_id
         \l__flowfram_id_int
    }
    {
      \int_gset:Nn \g__flowfram_minitoc_frame_id { #2 }
    }
   \cs_set:Nn \flowfram_do_minitoc:n
    {
      \__flowfram_append_dynamic_contents_idn:nn
       { \g__flowfram_minitoc_frame_id }
       {
         \flowfram_use_minitoc:n { ##1 }
       }
      \flowfram_clear_do_minitoc:
    }
 }
\cs_new:Nn \__flowfram_print_toc_units:
 {
   \int_step_inline:nn { \c@maxtocunits }
    {
      \tl_use:c { g__flowfram_toc_level_ \romannumeral ##1 _tl }
    }
 }
\cs_new:Nn \__flowfram_print_toc:
 {
    \g__flowfram_table_of_contents_tl
 }
\cs_new:Nn \__flowfram_print_aligned_toc:
 {
   \tl_if_exist:NT \g__flowfram_toc_level__tl
    {
       \g__flowfram_toc_level__tl
       \par
       \noindent
       \hrulefill
    }
   \int_step_inline:nn { \c@maxtocunits }
    {
      \int_compare:nNnTF { ##1 } > { \c@maxthumbtabs }
       {
         \tl_use:c { g__flowfram_toc_level_ \romannumeral ##1 _tl }
       }
       {
         \__flowfram_get_dynamic_id:n
           { thumbtabindex ##1 }
         \flowfram_set_dim_to_frame_dim:Nnnn
           \l__flowfram_x_dim
           { dynamic } { width } { \l__flowfram_id_int }
         \flowfram_set_dim_to_frame_dim:Nnnn
           \l__flowfram_y_dim
           { dynamic } { height } { \l__flowfram_id_int }
         \vbox_to_ht:nn { \l__flowfram_y_dim }
           {
             \noindent
             \parbox { \linewidth }
              {
                \tl_use:c { g__flowfram_toc_level_ \romannumeral ##1 _tl }
              }
             \vfill
             \par
             \noindent
             \hrulefill
           }
       }
    }
 }
\bool_new:N \g__flowfram_minitocs_enabled_bool
\bool_gset_false:N \g__flowfram_minitocs_enabled_bool
\newcounter{minitoc}
\NewDocumentCommand \enableminitoc
    { O { \g__flowfram_thumbtab_type_tl } }
 {
  \bool_gset_true:N \g__flowfram_minitocs_enabled_bool
  \int_gzero:N \c@minitoc
  \cs_if_exist:cTF { c_flowfram_level_ #1 _int }
   {
    \tl_gset:Ne \g__flowfram_minitoc_type_tl  { #1 }
    \cs_set:Nn \__flowfram_minitoc_post_section_unit:n
     {
       \tl_if_eq:NnT \g__flowfram_minitoc_type_tl { ##1 }
        {
          \stepcounter { minitoc }
          \dominitoc { \c@minitoc }
        }
     }
   }
   {
     \msg_error:nne { flowfram } { section-unit-not-defined } { #1 }
   }
}
\@onlypreamble{\enableminitoc}
\ExplSyntaxOff
\endinput
%%
%% End of file `flowfram.sty'.
