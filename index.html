<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>expl3 issues</title>
  <link rel="stylesheet" href="node_modules/datatables.net-dt/css/dataTables.dataTables.min.css">
  <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">

  <script src="node_modules/jquery/dist/jquery.min.js"></script>
  <script src="node_modules/datatables.net/js/dataTables.min.js"></script>
  <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.js"></script>
</head>

<body>
  <div class="container">
    <h1>expl3 issues</h1>

    <table id="issuesTable">
    </table>

    <!-- Button to Open Modal -->
    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
      Filter Issues
    </button>

    <span style="float: right">
      <a href="errors.txt.bz2">Full list of errors (bzip2 compressed)</a>
    </span>

    <p>
      Generated by <a href="https://github.com/Witiko/expltools/">expltools</a>. Report issues at <a
        href="https://github.com/koppor/explcheck-issues/issues">explcheck-issues</a>. This site is hosted using
      GitHub pages. <a
        href="https://docs.github.com/en/site-policy/privacy-policies/github-general-privacy-statement#github-privacy-statement">GitHub's
        General Privacy Statement</a> applies.
    </p>

  </div>

  <div class="modal fade" id="filterModal" tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="filterModalLabel">Filter Issues</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="checkbox-container"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="clearFilter">Clear Filter</button>
          <button type="button" class="btn btn-primary" id="applyFilter">Apply Filter</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const selectedErrors = [];

    function render_issues(data, type, row) {
      if (['display', 'sort', 'type'].includes(type)) {
        if (data === undefined) {
          data = [];
        }
        if (selectedErrors.length > 0) {
          data = data.filter((identifier) => selectedErrors.includes(identifier));
        }
        return data.length;
      }
      return data;
    }

    $(document).ready(function () {
      table = $('#issuesTable').DataTable({
        stateSave: true,
        ajax: {
          url: 'errors-summarized.json',
          dataSrc: '' // Data is a direct array at the root of the JSON
        },
        columns: [
          {
            data: 'filename',
            title: 'Filename',
            render: function (data, type, row) { // Make filename clickable
              if (type === 'display') {
                return `<a href="${data}#${selectedErrors.join(',')}" target="_blank">${data}</a>`;
              }
              return data;
            }
          },
          {
            data: 'errors',
            title: '# Errors',
            defaultContent: [],
            render: render_issues,
          },
          {
            data: 'warnings',
            title: '# Warnings',
            defaultContent: [],
            render: render_issues,
          },
          {
            data: function (row) {
              return row.identifiers.join(' ');
            },
            title: 'Issue Identifiers',
            searchable: true,
            visible: false
          }
        ]
      });
    });

    $(document).ready(function () {
      $.getJSON('errors-list.json', function (issuesList) {
        let checkboxContainer = $('#checkbox-container');
        issuesList.forEach(issue => {
          let issueClass = issue.startsWith('s') ? 'issue-type-style' : '';
          let checkbox = `
            <div class="form-check">
                <input class="form-check-input issue-filter ${issueClass}" type="checkbox" value="${issue}" id="error-${issue}">
                <label class="form-check-label" for="error-${issue}">
                    ${issue}
                </label>
            </div>
          `;
          checkboxContainer.append(checkbox);
        });

        checkWarnungsAndErrorsOnly();
        applyFilter();
      });
    });

    $('#clearFilter').on('click', function () {
      // Uncheck all checkboxes
      $('.issue-filter').prop('checked', false);
    });

    function checkWarnungsAndErrorsOnly() {
      $('.issue-filter').prop('checked', function () {
        return !$(this).hasClass('issue-type-style');
      });
    }

    function applyFilter() {
      selectedErrors.length = 0;
      $('.issue-filter:checked').each(function () {
        let identifier = $(this).val().split(" ")[0];
        selectedErrors.push(identifier);
      });

      // Apply filter to the last column
      table.column(3).search(selectedErrors.join('|'), true, false).rows().invalidate().draw();
    }

    $('#applyFilter').on('click', function () {
      applyFilter();
      $('#filterModal').modal('hide');
    });

  </script>
</body>

</html>
